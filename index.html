<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√©m spr√°vy n√°hradn√≠ch d√≠l≈Ø v13</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- Z√°kladn√≠ styly a promƒõnn√© --- */
        :root {
            --bg-color: #f0f2f5;
            --bg-secondary-color: #ffffff;
            --bg-tertiary-color: #f5f5f7;
            --text-primary-color: #1c1c1e;
            --text-secondary-color: #6a6a6a;
            --text-tertiary-color: #8e8e93;
            --border-color: #e5e5ea;
            --border-light-color: #d1d1d6;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --shadow-hover-color: rgba(0, 0, 0, 0.08);
            --accent-blue: #007aff;
            --accent-green: #34c759;
            --accent-red: #ff3b30;
            --accent-orange: #ff9500;
            --accent-yellow: #ffcc00;
            --accent-purple: #af52de;
        }

        .dark-mode {
            --bg-color: #000000;
            --bg-secondary-color: #1c1c1e;
            --bg-tertiary-color: #2c2c2e;
            --text-primary-color: #ffffff;
            --text-secondary-color: #aeaeb2;
            --text-tertiary-color: #8e8e93;
            --border-color: #3a3a3c;
            --border-light-color: #48484a;
            --shadow-color: rgba(255, 255, 255, 0.05);
            --shadow-hover-color: rgba(255, 255, 255, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            background-color: var(--bg-color);
            color: var(--text-primary-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        /* --- P≈ôihla≈°ovac√≠ obrazovka --- */
        #login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100%;
        }
        .login-box {
            width: 100%;
            max-width: 400px;
            padding: 40px;
            background: var(--bg-secondary-color);
            border-radius: 16px;
            box-shadow: 0 8px 24px var(--shadow-color);
            text-align: center;
        }
        .login-box h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .login-box p {
            color: var(--text-secondary-color);
            margin-bottom: 24px;
        }
        .login-box .form-group {
            text-align: left;
            margin-bottom: 16px;
        }
        #login-error {
            color: var(--accent-red);
            margin-top: 16px;
            font-size: 0.875rem;
            min-height: 1.2em;
        }


        /* --- Hlaviƒçka --- */
        .header {
            background: var(--bg-secondary-color);
            border-radius: 12px;
            box-shadow: 0 1px 2px var(--shadow-color), 0 0 0 1px var(--shadow-color);
            padding: 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary-color);
            margin-bottom: 8px;
        }
        .header p {
            color: var(--text-secondary-color);
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-info {
            text-align: right;
        }
        .user-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        .user-role {
            font-size: 0.875rem;
            color: var(--text-tertiary-color);
        }
        .user-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* --- Tmav√Ω re≈æim a Notifikace --- */
        .theme-switcher, .notifications-bell {
            background: var(--bg-tertiary-color);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-secondary-color);
            transition: all 0.2s ease;
        }
        .theme-switcher:hover, .notifications-bell:hover {
            background: var(--border-color);
            color: var(--text-primary-color);
        }
        .notifications-bell {
            position: relative;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-secondary-color);
        }
        .notifications-panel {
            position: absolute;
            top: 50px;
            right: 0;
            width: 320px;
            background: var(--bg-secondary-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid var(--border-color);
            z-index: 1001;
            overflow: hidden;
        }
        .notifications-panel-header {
            padding: 12px 16px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
        }
        .notifications-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
            color: var(--text-secondary-color);
            cursor: pointer;
        }
        .notification-item:hover {
            background: var(--bg-tertiary-color);
        }
        .notification-item.unread {
            background: var(--bg-tertiary-color);
            color: var(--text-primary-color);
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .notification-item .time {
            font-size: 0.75rem;
            color: var(--text-tertiary-color);
            display: block;
            margin-top: 4px;
        }

        /* --- Hlavn√≠ navigace --- */
        .main-nav {
            background: var(--bg-secondary-color);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px var(--shadow-color), 0 0 0 1px var(--shadow-color);
        }
        .main-nav-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .main-nav-button {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            color: var(--text-secondary-color);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
        }
        .main-nav-button:hover {
            background: var(--bg-tertiary-color);
            color: var(--text-primary-color);
        }
        .main-nav-button.active {
            background: var(--border-color);
            color: var(--text-primary-color);
            font-weight: 600;
        }

        /* --- Statistiky & Dashboard --- */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: var(--bg-secondary-color);
            border-radius: 12px;
            box-shadow: 0 1px 2px var(--shadow-color), 0 0 0 1px var(--shadow-color);
            padding: 24px;
            display: flex;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: none;
            cursor: pointer;
            position: relative;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-hover-color), 0 0 0 1px var(--shadow-color);
        }
        .stat-icon {
            width: 48px;
            height: 48px;
            margin-right: 16px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: var(--bg-tertiary-color);
        }
        .stat-content h3 {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-tertiary-color);
            margin-bottom: 4px;
        }
        .stat-content p {
            font-size: 1.875rem;
            font-weight: 600;
        }
        .stat-blue { color: var(--accent-blue); }
        .stat-red { color: var(--accent-red); }
        .stat-orange { color: var(--accent-orange); }
        .stat-green { color: var(--accent-green); }
        #personalized-dashboard h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        /* --- Filtry a Vyhled√°v√°n√≠ --- */
        .filters {
            background: var(--bg-secondary-color);
            border-radius: 12px;
            box-shadow: 0 1px 2px var(--shadow-color), 0 0 0 1px var(--shadow-color);
            padding: 24px;
            margin-bottom: 24px;
        }
        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
        }
        .filters-left {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }
        .search-box {
            position: relative;
        }
        .search-input {
            padding: 12px 12px 12px 44px;
            border: 1px solid var(--border-light-color);
            border-radius: 10px;
            width: 320px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background-color: var(--bg-tertiary-color);
            color: var(--text-primary-color);
        }
        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            background-color: var(--bg-secondary-color);
        }
        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary-color);
            font-size: 1.1rem;
        }
        .filter-select {
            padding: 12px 16px;
            border: 1px solid var(--border-light-color);
            border-radius: 10px;
            background: var(--bg-tertiary-color);
            font-size: 0.875rem;
            min-width: 140px;
            transition: all 0.2s ease;
            color: var(--text-primary-color);
        }
        .filter-select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            background-color: var(--bg-secondary-color);
        }
        .filters-right {
             display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }

        /* --- Tabulka --- */
        .table-container {
            background: var(--bg-secondary-color);
            border-radius: 12px;
            box-shadow: 0 1px 2px var(--shadow-color), 0 0 0 1px var(--shadow-color);
            overflow-x: auto;
        }
        .table-header {
            background: var(--bg-tertiary-color);
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary-color);
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }
        .table th {
            background: var(--bg-tertiary-color);
            padding: 16px 24px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-tertiary-color);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: color 0.2s;
        }
        .table th:hover {
            color: var(--text-primary-color);
        }
        .table th .sort-indicator {
            margin-left: 8px;
            opacity: 0.5;
        }
        .table th.sorted .sort-indicator {
            opacity: 1;
        }
        .table td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--bg-tertiary-color);
            vertical-align: middle;
            color: var(--text-primary-color);
        }
        .table tr:hover {
            background: var(--bg-tertiary-color);
        }
        .table tr.low-stock {
            background: rgba(255, 149, 0, 0.1);
        }
        .table tr.out-of-stock {
            background: rgba(255, 59, 48, 0.1);
        }
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* --- Mod√°ly --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
            backdrop-filter: blur(8px);
        }
        .modal {
            background: var(--bg-secondary-color);
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
            position: relative;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1), 0 0 0 1px var(--shadow-color);
            display: flex;
            flex-direction: column;
        }
        .modal-content-wrapper {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 32px;
            flex-grow: 1;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary-color);
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-tertiary-color);
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .modal-close:hover {
            color: var(--text-primary-color);
            background: var(--bg-tertiary-color);
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-light-color);
            border-radius: 10px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background-color: var(--bg-tertiary-color);
            color: var(--text-primary-color);
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            background-color: var(--bg-secondary-color);
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
            justify-content: flex-end;
        }
        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        /* --- Ostatn√≠ komponenty --- */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary-color);
            margin-bottom: 6px;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            text-decoration: none;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-primary:hover { background: #005bb5; }
        .btn-success { background: var(--accent-green); color: white; }
        .btn-warning { background: var(--accent-orange); color: white; }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-secondary { background: var(--border-color); color: var(--text-primary-color); }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 16px;
        }
        .badge-gray { background: var(--bg-tertiary-color); color: var(--text-primary-color); }
        .badge-red { background: rgba(255, 59, 48, 0.2); color: var(--accent-red); }
        .badge-orange { background: rgba(255, 149, 0, 0.2); color: var(--accent-orange); }
        .badge-green { background: rgba(52, 199, 89, 0.2); color: var(--accent-green); }
        .badge-blue { background: rgba(0, 122, 255, 0.2); color: var(--accent-blue); }
        .badge-purple { background: rgba(175, 82, 222, 0.2); color: var(--accent-purple); }
        .inventory-status { display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot-green { background: var(--accent-green); }
        .status-dot-yellow { background: var(--accent-orange); }
        .status-dot-red { background: var(--accent-red); }
        .hidden { display: none !important; }
        .font-medium { font-weight: 500; }
        .text-gray-500 { color: var(--text-tertiary-color); }
        .no-results { text-align: center; padding: 48px 24px; color: var(--text-tertiary-color); }
        .no-results .icon { font-size: 4rem; margin-bottom: 20px; display: block; opacity: 0.5; }

        /* Detail d√≠lu - Nov√© styly */
        .part-detail-media {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .part-detail-image-container {
            width: 100%;
            height: 250px;
            background-color: var(--bg-tertiary-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px dashed var(--border-light-color);
        }
        .part-detail-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .part-detail-image-placeholder {
            font-size: 4rem;
            color: var(--text-tertiary-color);
            opacity: 0.5;
        }
        #part-qr-code { text-align: center; }
        #part-qr-code img { max-width: 150px; margin: 0 auto; }
        .file-upload-label {
            display: block;
            padding: 10px 15px;
            background-color: var(--border-color);
            color: var(--text-primary-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-upload-label:hover {
            background-color: var(--border-light-color);
        }
        .doc-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-tertiary-color);
            padding: 8px 12px;
            border-radius: 8px;
        }
        .doc-info span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .part-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px 24px; margin-bottom: 24px; }
        .detail-item h4 { font-size: 0.875rem; color: var(--text-tertiary-color); font-weight: 500; margin-bottom: 4px; }
        .detail-item p { font-size: 1rem; font-weight: 600; color: var(--text-primary-color); }
        .history-section { margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color); }
        .history-section h3 { font-size: 1.125rem; font-weight: 600; color: var(--text-primary-color); margin-bottom: 16px; }
        .history-list { max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; background-color: var(--bg-tertiary-color); }
        .history-item { padding: 8px 0; border-bottom: 1px dashed var(--border-light-color); font-size: 0.875rem; color: var(--text-primary-color); }
        .history-item:last-child { border-bottom: none; }
        .history-item .date { color: var(--text-tertiary-color); margin-right: 8px; }
        .history-item .type-add { color: var(--accent-green); }
        .history-item .type-remove { color: var(--accent-orange); }
        
        /* Objedn√°vky */
        .order-item-row { display: grid; grid-template-columns: 2fr 1fr 1fr 40px; gap: 10px; align-items: center; margin-bottom: 10px; }
        .order-item-labels { display: grid; grid-template-columns: 2fr 1fr 1fr 40px; gap: 10px; padding: 0 10px; margin-bottom: 5px; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary-color); }
        .order-item-labels > div { padding-bottom: 5px; }
        .order-item-row .form-group { margin-bottom: 0; }
        .order-total { text-align: right; font-size: 1.2rem; font-weight: 600; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .remove-item-btn { background: none; border: none; color: var(--accent-red); font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 50%; line-height: 1; height: 30px; width: 30px; }
        .remove-item-btn:hover { background-color: var(--bg-tertiary-color); }

        /* Opr√°vnƒõn√≠ */
        .permissions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .permissions-grid label { display: flex; align-items: center; gap: 8px; }


        /* Reporty */
        #reports-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; }
        .report-card { 
            background: var(--bg-secondary-color); 
            border-radius: 12px; 
            padding: 24px; 
            box-shadow: 0 1px 2px var(--shadow-color), 0 0 0 1px var(--shadow-color);
            position: relative;
        }
        .report-card h3 { margin-bottom: 20px; font-weight: 600; }
        .report-list { list-style: none; padding: 0; }
        .report-list li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .report-list li:last-child { border-bottom: none; }
        .pin-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .pin-btn:hover { opacity: 1; }
        .pin-btn.pinned { opacity: 1; color: var(--accent-blue); }
        
        /* Nov√° z√°lo≈æka Nastaven√≠ */
        #tab-settings .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }
        .settings-card {
            background: var(--bg-secondary-color);
            border-radius: 12px;
            box-shadow: 0 1px 2px var(--shadow-color), 0 0 0 1px var(--shadow-color);
            padding: 24px;
        }
        .settings-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary-color);
            margin-bottom: 16px;
        }
        #dispense-reasons-list .reason-item, .core-data-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        /*
         * Pole v ≈ô√°dc√≠ch "D≈Øvody v√Ωdeje" a v dal≈°√≠ch ƒç√≠seln√≠c√≠ch jsou
         * v√Ωchoz√≠ ≈°√≠≈ôky 100 %, co≈æ ve flex kontejnerech zp≈Øsobuje p≈ôet√©k√°n√≠
         * a p≈ôekr√Ωv√°n√≠. Uprav√≠me jejich flex chov√°n√≠, aby se ≈°√≠≈ôka
         * p≈ôizp≈Øsobila dostupn√©mu prostoru a text se nezkracoval.
         */
        #dispense-reasons-list .reason-item input.form-input,
        .core-data-item input.form-input {
            flex: 1 1 auto;
            width: auto;
            min-width: 0;
        }

        /* Uprav√≠me tak√© pole pro p≈ôid√°n√≠ nov√©ho d≈Øvodu v√Ωdeje, aby se
         * chovala flexibilnƒõ. D√≠ky flex hodnot√°m se vstupy rozt√°hnou
         * rovnomƒõrnƒõ podle dostupn√© ≈°√≠≈ôky a nebudou p≈ôesahovat.
         */
        #new-reason-key,
        #new-reason-value {
            flex: 1 1 auto;
            width: auto;
            min-width: 0;
        }

        /* Inventura */
        #inventory-session-view .inventory-item {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr;
            gap: 16px;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
         #inventory-session-view .inventory-item:last-child {
            border-bottom: none;
        }
        .discrepancy-plus { color: var(--accent-green); }
        .discrepancy-minus { color: var(--accent-red); }

        /* Responzivn√≠ design */
        @media (max-width: 920px) {
            .modal-content-wrapper {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            .container { padding: 16px; }
            .header { flex-direction: column; text-align: center; gap: 16px; }
            .filters-row, .form-row, .form-row-3 { flex-direction: column; align-items: stretch; grid-template-columns: 1fr; }
            .filters-left { flex-direction: column; }
            .search-input { width: 100%; }
            .stats, #reports-container, #pinned-items-container { grid-template-columns: 1fr; }
            .main-nav-buttons { flex-direction: column; }
            .login-box { padding: 24px; }
        }

        /* Jazykov√Ω p≈ôep√≠naƒç na p≈ôihla≈°ovac√≠ obrazovce */
        .lang-selector {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-bottom: 8px;
        }
        .lang-selector span {
            cursor: pointer;
            font-size: 24px;
        }
        .lang-selector span.active {
            filter: grayscale(0);
        }
        .lang-selector span.inactive {
            filter: grayscale(1);
            opacity: 0.6;
        }
    </style>

<!-- CHATGPT PATCH G-CAL-UI -->
<style>
  .events-toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px; }
  .events-toolbar .month { font-weight:600; }
  .events-filters { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .events-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
  .events-cell { border:1px solid #e6e6e6; border-radius:8px; padding:6px; min-height:76px; position:relative; background:#fff; }
  .events-cell .daynum { font-size:12px; color:#666; position:absolute; top:6px; right:8px; }
  .events-cell .dots { display:flex; gap:4px; flex-wrap:wrap; margin-top:16px; }
  .dot { width:8px; height:8px; border-radius:50%; display:inline-block; }
  .dot.revize { background:#7c4dff; }
  .dot.udrzba { background:#ff9800; }
  .dot.servis { background:#2e7d32; }
  .dot.protokol { background:#1565c0; }
  .events-cell.today { outline:2px solid #00000022; }
  .events-cell.overdue { background:#fff2f2; }
  .events-legend { display:flex; gap:12px; align-items:center; margin:6px 0 10px; }
  .events-legend span { display:flex; align-items:center; gap:6px; font-size:12px; color:#555; }
  .events-list { margin-top:10px; border:1px solid #eee; border-radius:8px; padding:8px; background:#fafafa; }
  .events-list .item { border-bottom:1px dashed #e6e6e6; padding:6px 0; font-size:14px; }
  .events-list .item:last-child { border-bottom:none; }
  .tag { display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; border:1px solid #ddd; background:#f5f5f5; margin-right:6px; }
  .tag.revize { background:#efe8ff; border-color:#d5c8ff; color:#4527a0; }
  .tag.udrzba { background:#fff3e0; border-color:#ffd180; color:#ef6c00; }
  .tag.servis { background:#e8f5e9; border-color:#c8e6c9; color:#2e7d32; }
  .tag.protokol { background:#e3f2fd; border-color:#bbdefb; color:#1565c0; }
  .devchip { font-size:11px; color:#666; }
</style>


<!-- CHATGPT PATCH 14: Calendar badge + week view styles -->
<style>
  .nav-badge { display:inline-block; min-width:18px; padding:0 6px; height:18px; line-height:18px; font-size:11px; border-radius:999px; background:#ff3b30; color:#fff; text-align:center; vertical-align:middle; margin-left:6px; }
  .nav-badge.hidden { display:none; }
  .view-toggle { margin-left:auto; display:flex; gap:6px; }
  .week-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
  .week-col { border:1px solid #e6e6e6; border-radius:8px; background:#fff; min-height:120px; }
  .week-col .head { padding:6px 8px; font-weight:600; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
  .week-col .body { padding:6px 8px; display:flex; flex-direction:column; gap:6px; }
  .week-item { background:#f7f7f7; border:1px solid #e6e6e6; border-radius:6px; padding:4px 6px; font-size:12px; display:flex; justify-content:space-between; align-items:center; }
  .week-item .left { display:flex; gap:6px; align-items:center; }
  .muted { color:#777; font-size:12px; }
  .add-inline { margin-top:8px; display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  .add-inline input, .add-inline select { min-width:140px; }
  .btn-small { padding:4px 8px; font-size:12px; }
</style>


<!-- CHATGPT PATCH 15: Calendar edit styles + counters -->
<style>
  .edit-inline { display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-top:6px; }
  .edit-inline input, .edit-inline select { min-width:120px; }
  .count-badge { font-size:11px; background:#00000010; border:1px solid #00000018; padding:1px 6px; border-radius:999px; margin-left:6px; }
</style>


<!-- CHATGPT PATCH 16: Preventive plans manager styles -->
<style>
  .preventive-panel { margin-top:16px; border:1px solid #e6e6e6; border-radius:12px; background:#fff; }
  .preventive-head { display:flex; gap:8px; align-items:center; padding:10px; border-bottom:1px solid #eee; }
  .preventive-body { padding:10px; display:none; }
  .preventive-panel.open .preventive-body { display:block; }
  .preventive-panel .spacer { flex:1; }
  .table { width:100%; border-collapse:collapse; }
  .table th, .table td { border-bottom:1px solid #f0f0f0; padding:8px; text-align:left; }
  .table th { font-weight:600; background:#fafafa; }
  .table input { width:100%; }
  .btn-small { padding:4px 8px; font-size:12px; }
  .muted-note { color:#666; font-size:12px; }
</style>


<!-- CHATGPT PATCH 18: Drag & Drop styles -->
<style>
  .drop-hover { outline:2px dashed #4caf50; outline-offset:-4px; background:#e8f5e9 !important; }
  .dragging { opacity:.7; }
</style>


<!-- CHATGPT PATCH 21: Notifications banner styles -->
<style>
  .notif-banner { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:10px 12px; border:1px solid #ffe0b2; background:#fff8e1; border-radius:10px; margin-bottom:10px; }
  .notif-banner .txt { font-size:14px; }
  .notif-banner .actions { display:flex; gap:8px; }
  .hidden { display:none; }
</style>


<!-- CHATGPT PATCH 22: Backup styles -->
<style>
  .code-block { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; white-space: pre-wrap; background:#0f172a; color:#e2e8f0; border-radius:10px; padding:10px; max-height:280px; overflow:auto; }
  .btn-danger { background:#b91c1c; color:#fff; border-color:#7f1d1d; }
</style>


<!-- CHATGPT PATCH 23: Roles & Permissions styles -->
<style>
  .role-chip { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; background:#f9fafb; }
  .role-admin { background:#eef2ff; border-color:#c7d2fe; }
  .role-technik { background:#ecfeff; border-color:#a5f3fc; }
  .role-viewer { background:#f3f4f6; border-color:#e5e7eb; }
  .btn[disabled], .btn.disabled { opacity:.5; cursor:not-allowed; pointer-events:none; }
  .muted { color:#6b7280; }
</style>

<!-- CHATGPT PATCH 20: Photo editor PRO styles -->
<style>
  .photo-editor { margin-top:10px; display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:10px; }
  .photo-item { border:1px solid var(--border-color); border-radius:10px; background:#fff; overflow:hidden; display:flex; flex-direction:column; }
  .photo-item .thumb { position:relative; aspect-ratio: 4 / 3; background:#f5f5f5; display:flex; align-items:center; justify-content:center; }
  .photo-item img { width:100%; height:100%; object-fit:cover; cursor:zoom-in; }
  .photo-item .drag-handle { position:absolute; top:6px; left:6px; background:#00000066; color:#fff; padding:2px 6px; border-radius:8px; font-size:12px; cursor:grab; }
  .photo-item .delete-btn { position:absolute; top:6px; right:6px; background:#00000066; color:#fff; padding:2px 6px; border-radius:8px; font-size:12px; cursor:pointer; }
  .photo-item .meta { padding:8px; display:flex; flex-direction:column; gap:6px; }
  .photo-item input.caption { width:100%; font-size:12px; padding:6px 8px; border:1px solid #eee; border-radius:8px; }
  .photo-item input.tags { width:100%; font-size:12px; padding:6px 8px; border:1px dashed #ddd; border-radius:8px; }
  .photo-item.dragging { opacity:0.7; }
  .photo-item.drop-hover { outline:2px dashed #4caf50; outline-offset:-6px; }
  .zoom-modal { position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:9999; }
  .zoom-modal.open { display:flex; }
  .zoom-card { background:#111; padding:10px; border-radius:12px; width:min(92vw, 1200px); max-height:90vh; display:flex; flex-direction:column; gap:8px; }
  .zoom-card img { max-width:100%; max-height:72vh; object-fit:contain; }
  .zoom-head { display:flex; align-items:center; justify-content:space-between; color:#fff; }
  .zoom-head .caption { color:#ddd; font-size:14px; }
  .zoom-head .close { background:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; }
</style>
<!-- CHATGPT PATCH 10: Service checklist styles -->
<style>
  .svc-checklist { border:1px solid var(--border-color); border-radius:10px; padding:10px; margin:10px 0; background: var(--card-bg, #fff); }
  .svc-checklist .row { display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; margin-bottom:8px; }
  .svc-checklist ul { list-style: none; padding:0; margin:0; }
  .svc-checklist li { display:flex; align-items:center; gap:8px; padding:6px 4px; border-bottom:1px solid #eee; }
  .svc-checklist li:last-child { border-bottom:none; }
  .svc-checklist .rm { margin-left:auto; cursor:pointer; opacity:.7; }
  .svc-checklist .rm:hover { opacity:1; }
  .svc-badges { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #ddd; background:#f5f5f5; }
</style>
<!-- CHATGPT PATCH 19: Stock movements modal styles -->
<style>
  .stock-modal { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999; }
  .stock-modal.open { display:flex; }
  .stock-card { background:#fff; border-radius:12px; width:min(720px, 92vw); max-height:80vh; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,.25); }
  .stock-card .head { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #eee; }
  .stock-card .body { padding:12px 14px; }
  .stock-table { width:100%; border-collapse:collapse; }
  .stock-table th, .stock-table td { border-bottom:1px solid #f0f0f0; padding:8px; text-align:left; }
  .stock-chip { display:inline-block; padding:2px 8px; border-radius:999px; background:#f5f5f5; border:1px solid #ddd; font-size:12px; }
  .stock-chip.deduct { background:#fff3e0; border-color:#ffd180; }
  .stock-chip.restock { background:#e8f5e9; border-color:#c8e6c9; }
</style>

</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <!-- Jazykov√Ω p≈ôep√≠naƒç: umo≈æn√≠ u≈æivateli vybrat ƒçe≈°tinu nebo angliƒçtinu -->
            <div class="lang-selector">
                <!-- ƒåesk√° vlajka üá®üáø (unicode U+1F1E8 U+1F1FF) -->
                <span id="flag-cs" onclick="setLanguage('cs')">üá®üáø</span>
                <!-- Britsk√° vlajka üá¨üáß (unicode U+1F1EC U+1F1E7) -->
                <span id="flag-en" onclick="setLanguage('en')">üá¨üáß</span>
            </div>
            <h1 data-i18n="login_title">P≈ôihl√°≈°en√≠</h1>
            <p data-i18n="login_welcome">V√≠tejte v syst√©mu spr√°vy n√°hradn√≠ch d√≠l≈Ø</p>
            <div class="form-group">
                <label for="login-email" data-i18n="login_email_label">Email</label>
                <input type="email" id="login-email" class="form-input" data-placeholder-i18n="login_email_placeholder" placeholder="vas.email@firma.cz">
            </div>
            <div class="form-group">
                <label for="login-password" data-i18n="login_password_label">Heslo</label>
                <input type="password" id="login-password" class="form-input" data-placeholder-i18n="login_password_placeholder" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn btn-primary" style="width: 100%; padding: 12px;" onclick="handleLogin()" data-i18n="login_button">P≈ôihl√°sit se</button>
            <p id="login-error"></p>
            <p style="margin-top:8px; font-size:0.875rem; text-align:center;">
                <a href="#" onclick="showForgotPasswordDialog(); return false;" data-i18n="forgot_password" style="color: var(--accent-blue); text-decoration: underline;">Zapomnƒõli jste heslo?</a>
            </p>
        </div>
    </div>

    <div id="app-container" class="container hidden">
        <div class="header">
            <div>
                <h1 data-i18n="app_title">Syst√©m spr√°vy n√°hradn√≠ch d√≠l≈Ø v13</h1>
                <p data-i18n="app_description">Kompletn√≠ ≈ôe≈°en√≠ pro evidenci, hl√≠d√°n√≠ a spr√°vu skladov√Ωch z√°sob</p>
            </div>
            <div class="header-right">
                <div class="notifications-bell" onclick="toggleNotifications()">
                    üîî
                    <div id="notification-badge" class="notification-badge hidden">0</div>
                    <div id="notifications-panel" class="notifications-panel hidden">
                        <div class="notifications-panel-header" data-i18n="notifications_header">Ozn√°men√≠</div>
                        <div class="notifications-list" id="notifications-list"></div>
                    </div>
                </div>
                <div class="theme-switcher" onclick="toggleDarkMode()">üåì</div>
                <div class="user-info">
                    <div class="user-name" id="current-user-name"></div>
                    <div class="user-role" id="current-user-role"></div>
                    <div class="user-actions">
                        <button class="btn btn-secondary" onclick="showChangePasswordModal()" style="padding: 4px 8px; font-size: 0.75rem;" data-i18n="change_password">
                            Zmƒõnit heslo
                        </button>
                        <button class="btn btn-secondary" onclick="handleLogout()" style="padding: 4px 8px; font-size: 0.75rem;" data-i18n="logout">
                            Odhl√°sit
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-nav">
            <div class="main-nav-buttons">
                <button class="main-nav-button active" onclick="showTab('dashboard')">üìä <span data-i18n="nav_dashboard">Dashboard</span></button>
                <button class="main-nav-button" onclick="showTab('inventory')">üì¶ <span data-i18n="nav_inventory">Sklad</span></button>
                <button class="main-nav-button" onclick="showTab('machines')">üèóÔ∏è <span data-i18n="nav_machines">Za≈ô√≠zen√≠</span></button>
                <button class="main-nav-button" onclick="showTab('suppliers')">üè≠ <span data-i18n="nav_suppliers">Dodavatel√©</span></button>
                <button class="main-nav-button" onclick="showTab('orders')">üõí <span data-i18n="nav_orders">Objedn√°vky</span></button>
                <button class="main-nav-button" onclick="showTab('transfers')">üîÑ <span data-i18n="nav_transfers">P≈ôesuny</span></button>
                <button class="main-nav-button" onclick="showTab('inventory-module')">‚úîÔ∏è <span data-i18n="nav_inventory_module">Inventura</span></button>
                <button class="main-nav-button" onclick="showTab('transactions')">üìã <span data-i18n="nav_transactions">Transakce</span></button>
                <button class="main-nav-button" onclick="showTab('reports')">üìà <span data-i18n="nav_reports">Reporty</span></button>
                <button class="main-nav-button" onclick="showTab('users')">üë• <span data-i18n="nav_users">U≈æivatel√©</span></button>
                <button class="main-nav-button" onclick="showTab('audit-log')">üõ°Ô∏è <span data-i18n="nav_audit_log">Audit Log</span></button>
                                <button class="main-nav-button" onclick="showTab('revisions')">üóìÔ∏è <span data-i18n="nav_revisions">Revize</span></button>
                <button class="main-nav-button" onclick="showTab('calendar')"></button>
                <button class="main-nav-button" onclick="showTab('calendar')">üóìÔ∏è <span data-i18n="nav_calendar">Kalend√°≈ô</span> <span id="calendar-badge" class="nav-badge hidden">0</span></button>
                <button class="main-nav-button" onclick="showTab('settings')">‚öôÔ∏è <span data-i18n="nav_settings">Nastaven√≠</span></button>
            </div>
        </div>

        
        <div id="tab-revisions" class="tab-content hidden">
            <div class="table-container">
                <div class="table-header">
                    <h3>Pl√°n reviz√≠ & √∫dr≈æby</h3>
                    <div>
                        <button class="btn btn-outline btn-slim" onclick="exportTableToCSV('revisions-table','revize_udrzba.csv')">‚¨áÔ∏è CSV</button>
                        <button class="btn btn-outline btn-slim" onclick="exportTableToXLSX('revisions-table','revize_udrzba.xlsx')">‚¨áÔ∏è XLSX</button>
                    </div>
                </div>
                <div class="filters">
                    <div class="filters-row">
                        <div class="filters-left">
                            <div id="rev-smart-chips" class="smart-chips">
                                <button class="smart-chip" data-mode="all">V≈°e</button>
                                <button class="smart-chip" data-mode="overdue">Po term√≠nu</button>
                                <button class="smart-chip" data-mode="7">Do 7 dn√≠</button>
                                <button class="smart-chip" data-mode="30">Do 30 dn√≠</button>
                                <button class="smart-chip" data-mode="later">Pozdƒõji</button>
                                <button class="smart-chip" data-mode="nodate">Bez data</button>
                                <button class="smart-chip" data-mode="selected">Vybran√©</button>
                            </div>
                            <div id="rev-type-chips" class="smart-chips" style="margin-top:8px;">
                                <button class="smart-chip" data-type="all">V≈°e</button>
                                <button class="smart-chip" data-type="Revize">Revize</button>
                                <button class="smart-chip" data-type="√ödr≈æba">√ödr≈æba</button>
                            </div>
                        </div>
                        <div class="filters-right">
                            <div class="search-box">
                                <input type="text" class="search-input" placeholder="Hledat za≈ô√≠zen√≠/√∫kon/odpovƒõdn√©ho..." id="rev-search-input">
                                <div class="search-icon">üîç</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="rev-bulkbar" class="hidden">
                    <span class="count">0 vybr√°no</span>
                    <button class="btn btn-success" onclick="bulkMarkToday()">‚úîÔ∏è Provedeno dnes</button>
                    <div class="sep" style="width:1px;height:22px;background:#e5e7eb;margin:0 6px;"></div>
                    <input type="date" id="rev-bulk-date" class="form-input" style="height:32px; padding:4px 8px;">
                    <button class="btn" onclick="bulkSetDate()">üìÖ Nastavit datum</button>
                    <div class="sep" style="width:1px;height:22px;background:#e5e7eb;margin:0 6px;"></div>
                    <input type="text" id="rev-bulk-resp" class="form-input" placeholder="Odpovƒõdn√° osoba" style="height:32px; padding:4px 8px; min-width:160px;">
                    <button class="btn" onclick="bulkSetResponsible()">üë§ P≈ôi≈ôadit</button>
                    <div class="sep" style="width:1px;height:22px;background:#e5e7eb;margin:0 6px;"></div>
                    <button class="btn" onclick="bulkExportSelectedCSV()">‚¨áÔ∏è Export vybran√Ωch (CSV)</button>
                    <button class="btn btn-secondary" onclick="bulkDownloadProtocols()">üì• St√°hnout protokoly</button>
                    <button class="btn btn-danger" onclick="bulkDeleteSelected()">üóëÔ∏è Smazat vybran√© √∫kony</button>
                    <button class="btn btn-danger" onclick="bulkClear()">‚úñ Zru≈°it v√Ωbƒõr</button>
                </div>
                <table class="table" id="revisions-table">
                    <thead>
                        <tr>
                            <th class="sel"><input type="checkbox" id="rev-master"></th>
                            <th>Za≈ô√≠zen√≠ / Typ</th>
                            <th>√ökon</th>
                            <th>Odpovƒõdn√° osoba</th>
                            <th>Periodicita / Frekvence</th>
                            <th>Posledn√≠</th>
                            <th>P≈ô√≠≈°t√≠</th>
                            <th>Stav</th>
                            <th>Pozn√°mka</th>
                        </tr>
                    </thead>
                    <tbody id="revisions-table-body"></tbody>
                </table>
                <div id="revisions-no-results" class="empty-state hidden">≈Ω√°dn√© polo≈æky k zobrazen√≠.</div>
            </div>
        </div>
<div id="tab-dashboard" class="tab-content">
            <div class="stats">
                <div class="stat-card" onclick="showTab('inventory')">
                    <div class="stat-icon stat-blue">üì¶</div>
                    <div class="stat-content"><h3 data-i18n="stat_total_parts">Celkem d√≠l≈Ø na skladƒõ</h3><p class="stat-blue" id="total-parts">0</p></div>
                </div>
                <div class="stat-card" onclick="showLowStockReport()">
                    <div class="stat-icon stat-red">‚ö†Ô∏è</div>
                    <div class="stat-content"><h3 data-i18n="stat_low_stock">N√≠zk√Ω stav</h3><p class="stat-red" id="low-stock-parts">0</p></div>
                </div>
                <div class="stat-card" onclick="showCriticalPartsReport()">
                    <div class="stat-icon stat-orange">üö®</div>
                    <div class="stat-content"><h3 data-i18n="stat_critical_parts">Kritick√© d√≠ly</h3><p class="stat-orange" id="critical-parts">0</p></div>
                </div>
                <div class="stat-card" onclick="showTotalValueDetails()">
                    <div class="stat-icon stat-green">üí∞</div>
                    <div class="stat-content"><h3 data-i18n="stat_total_value">Hodnota skladu</h3><p class="stat-green" id="total-value">0 Kƒç</p></div>
                </div>
            </div>
            <div id="personalized-dashboard" class="hidden" style="margin-top: 24px;">
                <h2 data-i18n="pinned_items_heading">P≈ôipnut√© polo≈æky</h2>
                <div id="pinned-items-container" class="stats"></div>
            </div>
        </div>

        <div id="tab-inventory" class="tab-content hidden">
            <div class="filters">
                <div class="filters-row">
                    <div class="filters-left">
                        <div class="search-box">
                            <input type="text" class="search-input" data-placeholder-i18n="search_placeholder" placeholder="Hledat podle n√°zvu, k√≥du..." id="search-input">
                            <div class="search-icon">üîç</div>
                        </div>
                        <select class="filter-select" id="warehouse-filter"></select>
                        <select class="filter-select" id="category-filter"></select>
                        <select class="filter-select" id="machine-filter"></select>
                    </div>
                    <div class="filters-right">
                        <button id="new-part-btn" class="btn btn-primary" onclick="showPartModal()">‚ûï <span data-i18n="add_part_button">Zav√©st nov√Ω typ d√≠lu</span></button>
                        <button class="btn btn-success" onclick="showAssignPartModal()">üì• <span data-i18n="stock_in_button">Naskladnit d√≠l</span></button>
                    </div>
                </div>
            </div>
            <div class="table-container">
                 <div class="table-header">
                    <h3>P≈ôehled skladu</h3>
                    <div class="filters-right">
                        <button class="btn" onclick="openBulkEditor()">üõ†Ô∏è Hromadn√Ω editor</button>
    
                        <button class="btn" onclick="openBulkWarehouse()">üè∑Ô∏è Doplnit sklad</button>
    
                        <button class="btn" onclick="resetSorting()">‚ÜïÔ∏è Reset t≈ô√≠dƒõn√≠</button>

                        <button class="btn btn-secondary" onclick="exportTableToCSV('parts-table', 'sklad.csv')">üìÑ Export do CSV</button>
                        <button class="btn btn-success" onclick="exportTableToXLSX('parts-table', 'sklad.xlsx')">üìä Export do Excel</button>
                    
<style>
.smart-chips { display:flex; gap:8px; padding:10px 0 6px 0; flex-wrap:wrap; }
.smart-chip { padding:6px 10px; border:1px solid #d8dde4; border-radius:999px; background:#fff; cursor:pointer; font-size:13px; }
.smart-chip.active { background:#4f46e5; color:#fff; border-color:#4f46e5; }
</style>
<div class="smart-chips" id="smart-chips">
  <button class="smart-chip" data-mode="all" onclick="setSmartFilter('all')">V≈°e</button>
  <button class="smart-chip" data-mode="missing" onclick="setSmartFilter('missing')">Chyb√≠ √∫daje</button>
  <button class="smart-chip" data-mode="low" onclick="setSmartFilter('low')">N√≠zk√Ω stav</button>
  <button class="smart-chip" data-mode="recent" onclick="setSmartFilter('recent')">Naposledy importovan√©</button>
</div>
<style>
#missing-filter-panel{ display:none; padding:8px 0 10px 0; }
#missing-filter-panel.active{ display:block; }
.missing-row{ display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
.mf-chip{ display:inline-flex; gap:6px; align-items:center; background:#f8fafc; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:13px; cursor:pointer; }
.mf-chip input{ margin:0; }
.mf-count{ font-size:12px; color:#6b7280; }
</style>
<div id="missing-filter-panel">
  <div class="missing-row">
    <label class="mf-chip"><input type="checkbox" id="mf-warehouse"> Sklad <span class="mf-count" id="mf-warehouse-count"></span></label>
    <label class="mf-chip"><input type="checkbox" id="mf-category"> Kategorie <span class="mf-count" id="mf-category-count"></span></label>
    <label class="mf-chip"><input type="checkbox" id="mf-supplier"> Dodavatel <span class="mf-count" id="mf-supplier-count"></span></label>
    <label class="mf-chip"><input type="checkbox" id="mf-min"> Min <span class="mf-count" id="mf-min-count"></span></label>
    <label class="mf-chip"><input type="checkbox" id="mf-max"> Max <span class="mf-count" id="mf-max-count"></span></label>
    <label class="mf-chip"><input type="checkbox" id="mf-umisteni"> Um√≠stƒõn√≠ <span class="mf-count" id="mf-umisteni-count"></span></label>
    <button class="btn" id="mf-clear">Vymazat v√Ωbƒõr</button>
  </div>
  <div class="missing-row" style="margin-top:8px; font-size:12px; color:#6b7280;">
    Kdy≈æ nic neza≈°krtnete, zobraz√≠ se polo≈æky, kter√Ωm chyb√≠ <em>cokoliv</em> z v√Ω≈°e uveden√©ho.
  </div>
</div>

</div>
                </div>
                <table class="table" id="parts-table"><thead id="parts-table-head"></thead><tbody id="parts-table-body"></tbody></table>
                <div id="no-results-message" class="no-results hidden">
                    <div class="icon">üîç</div><h3>≈Ω√°dn√© v√Ωsledky</h3><p>Zkuste upravit krit√©ria vyhled√°v√°n√≠.</p>
                </div>
            </div>
        </div>
        
        
        <div id="tab-machines" class="tab-content hidden">
            <div class="section-header">
                <h2>Za≈ô√≠zen√≠</h2>
                <div class="table-actions">
                    <button class="btn btn-primary" onclick="showCreateMachineModal()">‚ûï Nov√© za≈ô√≠zen√≠</button>
                    <button class="btn btn-secondary" onclick="showTab('settings')">‚öôÔ∏è Spravovat za≈ô√≠zen√≠</button>
                    <button class="btn btn-outline" onclick="exportMachinesToCSV()">‚¨áÔ∏è Export CSV</button>
                </div>
            </div>
            <div class="filters">
                <div class="filters-row">
                    <div class="filters-left">
                        <div class="search-box">
                            <input type="text" class="search-input" data-placeholder-i18n="search_machines_placeholder" placeholder="Hledat za≈ô√≠zen√≠..." id="machine-search-input">
                            <div class="search-icon">üîç</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <table class="table" id="machines-table">
                    <thead>
                        <tr>
                            <th data-i18n="th_name">N√°zev</th>
                            <th data-i18n="th_num_parts">Poƒçet d√≠l≈Ø</th>
                            <th data-i18n="th_critical">Kritick√©</th>
                            <th data-i18n="th_inventory_value">Hodnota z√°sob</th>
                            <th data-i18n="th_revision">Revize</th>
                            <th data-i18n="th_actions">Akce</th>
                        </tr>
                    </thead>
                    <tbody id="machines-table-body"></tbody>
                </table>
                <div id="machines-no-results" class="empty-state hidden" data-i18n="machines_no_results">≈Ω√°dn√° za≈ô√≠zen√≠ k zobrazen√≠.</div>
            </div>
        </div>
<div id="tab-suppliers" class="tab-content hidden">
            <div class="table-container">
                <div class="table-header">
                    <h3>Seznam dodavatel≈Ø</h3>
                    <button class="btn btn-primary" onclick="showSupplierModal()">‚ûï Nov√Ω dodavatel</button>
                </div>
                <table class="table">
                    <thead><tr><th data-i18n="th_name">N√°zev</th><th data-i18n="th_ico">IƒåO</th><th data-i18n="th_contact">Kontakt</th><th data-i18n="th_email">Email</th><th data-i18n="th_actions">Akce</th></tr></thead>
                    <tbody id="suppliers-table-body"></tbody>
                </table>
                 <div id="no-suppliers-message" class="no-results hidden"><div class="icon">üè≠</div><h3>≈Ω√°dn√≠ dodavatel√©</h3><p>Zat√≠m jste nezadali ≈æ√°dn√©ho dodavatele.</p></div>
            </div>
        </div>

        <div id="tab-orders" class="tab-content hidden">
            <div class="table-container">
                <div class="table-header">
                    <h3>Objedn√°vky</h3>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="showCreateOrderModal()">‚ûï Nov√° objedn√°vka</button>
                        <button class="btn btn-success" onclick="generateAutoOrders()">ü§ñ Auto objedn√°vky</button>
                    </div>
                </div>
                <table class="table">
                    <thead><tr><th data-i18n="th_number">ƒå√≠slo</th><th data-i18n="th_supplier">Dodavatel</th><th data-i18n="th_items">Polo≈æky</th><th data-i18n="th_price">Cena</th><th data-i18n="th_status">Stav</th><th data-i18n="th_created">Vytvo≈ôeno</th><th data-i18n="th_actions">Akce</th></tr></thead>
                    <tbody id="orders-table-body"></tbody>
                </table>
                <div id="no-orders-message" class="no-results hidden"><div class="icon">üõí</div><h3>≈Ω√°dn√© objedn√°vky</h3></div>
            </div>
        </div>

        <div id="tab-transfers" class="tab-content hidden">
            <div class="table-container">
                <div class="table-header">
                    <h3>P≈ôesuny mezi sklady</h3>
                    <div class="table-actions"><button class="btn btn-primary" onclick="showCreateTransferModal()">‚ûï Nov√Ω p≈ôesun</button></div>
                </div>
                <table class="table">
                    <thead><tr><th data-i18n="th_number">ƒå√≠slo</th><th data-i18n="th_part">D√≠l</th><th data-i18n="th_from">Z</th><th data-i18n="th_to">Do</th><th data-i18n="th_quantity">Mno≈æstv√≠</th><th data-i18n="th_status">Stav</th><th data-i18n="th_date">Datum</th><th data-i18n="th_actions">Akce</th></tr></thead>
                    <tbody id="transfers-table-body"></tbody>
                </table>
                <div id="no-transfers-message" class="no-results hidden"><div class="icon">üîÑ</div><h3>≈Ω√°dn√© p≈ôesuny</h3></div>
            </div>
        </div>

        <div id="tab-inventory-module" class="tab-content hidden">
             <div id="inventory-start-view">
                <div class="table-container">
                    <div class="table-header">
                        <h3>Prob√≠haj√≠c√≠ a dokonƒçen√© inventury</h3>
                        <button class="btn btn-primary" onclick="showStartInventoryModal()">‚ûï Nov√° inventura</button>
                    </div>
                    <table class="table">
                        <thead><tr><th data-i18n="th_warehouse">Sklad</th><th data-i18n="th_start_date">Datum zah√°jen√≠</th><th data-i18n="th_status">Stav</th><th data-i18n="th_processed_by">Zpracoval</th><th data-i18n="th_actions">Akce</th></tr></thead>
                        <tbody id="inventory-list-body"></tbody>
                    </table>
                    <div id="no-inventory-message" class="no-results hidden"><div class="icon">‚úîÔ∏è</div><h3>≈Ω√°dn√© inventury</h3><p>Zahajte novou inventuru pro kontrolu skladu.</p></div>
                </div>
            </div>
            <div id="inventory-session-view" class="hidden"></div>
        </div>

        <div id="tab-transactions" class="tab-content hidden">
             <div class="filters">
                <div class="filters-row">
                    <div class="filters-left">
                        <label for="transaction-date-from">Od:</label>
                        <input type="date" id="transaction-date-from" class="form-input" style="width: auto;">
                        <label for="transaction-date-to">Do:</label>
                        <input type="date" id="transaction-date-to" class="form-input" style="width: auto;">
                        <button class="btn btn-secondary" onclick="renderTransactionsTable()">Filtrovat</button>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <div class="table-header"><h3>Historie transakc√≠</h3>
                    <div class="filters-right">
                        <button class="btn btn-secondary" onclick="exportTableToCSV('transactions-table', 'transakce.csv')">üìÑ Export do CSV</button>
                        <button class="btn btn-success" onclick="exportTableToXLSX('transactions-table', 'transakce.xlsx')">üìä Export do Excel</button>
                    </div>
                </div>
                <table class="table" id="transactions-table">
                    <thead><tr><th data-i18n="th_date">Datum</th><th data-i18n="th_type">Typ</th><th data-i18n="th_part">D√≠l</th><th data-i18n="th_quantity">Mno≈æstv√≠</th><th data-i18n="th_reason_note">D≈Øvod/Pozn√°mka</th><th data-i18n="th_user">U≈æivatel</th></tr></thead>
                    <tbody id="transactions-table-body"></tbody>
                </table>
                <div id="no-transactions-message" class="no-results hidden"><div class="icon">üìã</div><h3>≈Ω√°dn√© transakce</h3></div>
            </div>
        </div>

        <div id="tab-reports" class="tab-content hidden">
            <div id="reports-container">
                <div class="report-card" data-chart-id="parts-by-category"><h3>D√≠ly podle kategorie</h3><canvas id="parts-by-category-chart"></canvas></div>
                <div class="report-card" data-chart-id="value-by-category"><h3>Hodnota skladu podle kategorie</h3><canvas id="value-by-category-chart"></canvas></div>
                <div class="report-card" data-chart-id="top-used-parts">
                    <h3>TOP 10 nejpou≈æ√≠vanƒõj≈°√≠ch d√≠l≈Ø (posledn√≠ rok)</h3>
                    <ul id="top-used-parts-list" class="report-list"></ul>
                </div>
                <div class="report-card" data-chart-id="shelf-warmers">
                    <h3>Skladov√© "le≈æ√°ky" (bez v√Ωdeje za posledn√≠ rok)</h3>
                    <ul id="shelf-warmers-list" class="report-list"></ul>
                </div>
            </div>
        </div>

        <div id="tab-users" class="tab-content hidden">
            <div class="table-container">
                <div class="table-header">
                    <h3>Spr√°va u≈æivatel≈Ø</h3>
                    <div class="table-actions"><button class="btn btn-primary" onclick="showAddUserModal()">‚ûï P≈ôidat u≈æivatele</button></div>
                </div>
                <table class="table">
                    <thead><tr><th data-i18n="th_name">Jm√©no</th><th data-i18n="th_email">Email</th><th data-i18n="th_role">Role</th><th data-i18n="th_warehouses">Sklady</th><th data-i18n="th_actions">Akce</th></tr></thead>
                    <tbody id="users-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-audit-log" class="tab-content hidden">
            <div class="table-container">
                <div class="table-header">
                    <h3>Audit Log - Z√°znamy o zmƒõn√°ch</h3>
                    <div class="filters-right">
                        <select id="audit-log-user-filter" class="filter-select" onchange="renderAuditLogTable()"></select>
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th data-i18n="th_date">Datum</th>
                            <th data-i18n="th_user">U≈æivatel</th>
                            <th data-i18n="th_actions">Akce</th>
                            <th data-i18n="th_detail">Detail</th>
                        </tr>
                    </thead>
                    <tbody id="audit-log-table-body"></tbody>
                </table>
                <div id="no-audit-log-message" class="no-results hidden">
                    <div class="icon">üõ°Ô∏è</div>
                    <h3>≈Ω√°dn√© z√°znamy</h3>
                    <p>Zat√≠m nebyly provedeny ≈æ√°dn√© sledovan√© zmƒõny.</p>
                </div>
            </div>
        </div>
        
        
<div id="tab-calendar" class="tab-content hidden">
  <div class="section">
    <div class="section-header">
      <div class="section-title">Kalend√°≈ô ud√°lost√≠</div>
      <div class="section-actions">
        <button id="events-export-ics" class="btn">Export ICS</button>
        <button id="notify-toggle-btn" class="btn">üîî Zapnout notifikace</button>
        <button id="notify-test-btn" class="btn">Test</button>
      </div>
    </div>
    <div class="section-body">
      <div id="notify-banner" class="notif-banner hidden"><div class="txt">M√°te ud√°losti <b>dnes</b> nebo <b>po term√≠nu</b>. Zapnƒõte notifikace a≈• na nƒõ nezapomenete.</div><div class="actions"><button id="notify-cta" class="btn btn-small">Povolit notifikace</button> <button id="notify-dismiss" class="btn btn-small">Skr√Ωt</button></div></div>
      <div class="events-toolbar"><div class="view-toggle"><button id="view-month" class="btn btn-small">Mƒõs√≠c</button><button id="view-week" class="btn btn-small">T√Ωden</button></div>
        <div class="events-nav">
          <button id="ev-prev" class="btn">‚óÄ</button>
          <button id="ev-today" class="btn">Dnes</button>
          <button id="ev-next" class="btn">‚ñ∂</button>
        </div>
        <div class="month" id="ev-month-label">‚Äî</div>
      </div>
      <div class="events-legend">
        <span><span class="dot revize"></span> Revize</span>
        <span><span class="dot udrzba"></span> √ödr≈æba</span>
        <span><span class="dot servis"></span> Servis</span>
        <span><span class="dot protokol"></span> Protokol</span>
      </div>
      <div class="events-filters">
        <label><input type="checkbox" class="ev-type" value="revize" checked> Revize <span id="cnt-revize" class="count-badge">0</span></label>
        <label><input type="checkbox" class="ev-type" value="udrzba" checked> √ödr≈æba <span id="cnt-udrzba" class="count-badge">0</span></label>
        <label><input type="checkbox" class="ev-type" value="servis" checked> Servis <span id="cnt-servis" class="count-badge">0</span></label>
        <label><input type="checkbox" class="ev-type" value="protokol" checked> Protokol <span id="cnt-protokol" class="count-badge">0</span></label>
        <select id="ev-device" class="form-input"><option value="">V≈°echna za≈ô√≠zen√≠</option></select>
        <input id="ev-q" class="form-input" placeholder="Hledat‚Ä¶">
      </div>
      <div class="events-grid" id="events-grid"></div>
      <div class="events-list" id="events-list"><div class="small-muted">Klikni na den v kalend√°≈ôi pro detail ud√°lost√≠.</div></div>
<div class="preventive-panel" id="preventive-panel">
  <div class="preventive-head">
    <strong>Spr√°va preventivn√≠ch pl√°n≈Ø</strong>
    <button id="prev-toggle" class="btn btn-small">Zobrazit / skr√Ωt</button>
    <div class="spacer"></div>
    <button id="prev-export" class="btn btn-small">Export JSON</button>
    <label class="btn btn-small" for="prev-import-input">Import JSON</label>
    <input type="file" id="prev-import-input" accept="application/json" style="display:none">
  </div>
  <div class="preventive-body">
    <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
      <label>Za≈ô√≠zen√≠:</label>
      <select id="prev-device" class="form-input" style="min-width:200px"></select>
      <button id="prev-add" class="btn btn-small">P≈ôidat ≈ô√°dek</button>
      <button id="prev-save" class="btn btn-small">Ulo≈æit zmƒõny</button>
      <span class="muted-note">Pole <i>Posledn√≠</i> ve form√°tu YYYY-MM-DD.</span>
    </div>
    <table class="table" id="prev-table">
      <thead><tr><th>√ökon</th><th>Frekvence (dny)</th><th>Posledn√≠</th><th>Next due</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

    </div>
  </div>
</div>

<div id="tab-settings" class="tab-content hidden">
    <!-- Roles selector: moved inside Settings tab to prevent it from appearing globally.
         This section allows users to pick their role (admin, technik, viewer) and is only visible when the Settings tab is active. -->
    <div class="section" id="sec-roles">
      <div class="section-header">
        <div class="section-title">Role &amp; pr√°va</div>
        <div class="section-actions">
          <span id="role-chip" class="role-chip">Role: <b id="role-chip-name">‚Äî</b></span>
        </div>
      </div>
      <div class="section-body">
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <label>Vyber roli:</label>
          <select id="role-select" class="form-input">
            <option value="admin">Admin</option>
            <option value="technik">Technik</option>
            <option value="viewer">Viewer</option>
          </select>
          <div class="muted">Role se ukl√°d√° do tohoto prohl√≠≈æeƒçe a ovlivn√≠, co lze v aplikaci dƒõlat.</div>
        </div>
      </div>
    </div>

    <!-- Backups / Export & Import: moved inside Settings tab to consolidate data management sections. -->
    <div class="section" id="sec-backups">
      <div class="section-header">
        <div class="section-title">Z√°lohy / Export &amp; Import</div>
        <div class="section-actions">
          <label class="form-inline" style="display:flex; align-items:center; gap:6px;">
            <input type="checkbox" id="backup-include-inventory" checked>
            <span>Vƒçetnƒõ invent√°≈ôe</span>
          </label>
          <button class="btn" id="backup-export">Export JSON</button>
          <label for="backup-import-input" class="btn">Import (Slouƒçit)</label>
          <label for="backup-import-replace-input" class="btn btn-danger">Import (Nahradit)</label>
          <input type="file" id="backup-import-input" accept="application/json" style="display:none">
          <input type="file" id="backup-import-replace-input" accept="application/json" style="display:none">
        </div>
      </div>
      <div class="section-body">
        <div class="small-muted" id="backup-stats">‚Äî</div>
        <div id="backup-preview" class="code-block" style="margin-top:10px; display:none;"></div>
      </div>
    </div>
            <div class="settings-grid">
                <div class="settings-card">
                    <h3>Spr√°va dat</h3>
                    <p class="text-secondary-color" style="margin-bottom: 16px;">Z√°lohujte v≈°echna data aplikace do souboru nebo je obnovte ze z√°lohy.</p>
                    <!-- Z√°lohov√°n√≠: dvƒõ tlaƒç√≠tka vedle sebe a skryt√© input pole -->
                    <div class="backup-buttons" style="display: flex; gap: 12px;">
                        <button class="btn btn-success" onclick="backupData()" style="flex: 1;">üíæ St√°hnout z√°lohu</button>
                        <button class="btn btn-warning" onclick="document.getElementById('restore-input').click()" style="flex: 1;">üì§ Nahr√°t ze z√°lohy</button>
                        <input type="file" id="restore-input" class="hidden" accept=".json" onchange="restoreData(event)">
                    </div>
                    <!-- Karta pro nastaven√≠ SKU um√≠stƒõn√° pod tlaƒç√≠tky, aby nedoch√°zelo k p≈ôekr√Ωv√°n√≠ -->
                    <div class="card" style="margin-top: 16px; padding: 16px; border: 1px solid var(--border-light-color); border-radius: 12px; background: var(--bg-tertiary-color);">
                        <h3 style="margin: 0 0 8px 0;">Nastaven√≠ SKU</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end;">
                            <div>
                                <label>Prefix</label>
                                <input id="sku-prefix-input" class="input" placeholder="nap≈ô. SKU-">
                            </div>
                            <div>
                                <label>Poƒçet ƒç√≠slic</label>
                                <input id="sku-digits-input" class="input" type="number" min="1" max="12" placeholder="nap≈ô. 6">
                            </div>
                            <div>
                                <button class="btn btn-primary" onclick="saveSkuSettings()">Ulo≈æit</button>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 13px;">Dal≈°√≠ v ≈ôadƒõ: <strong id="sku-next-preview">‚Äî</strong></div>
                    </div>
<script>
(function(){
  function ensureSkuSettings(){
    if (!state.settings) state.settings = {};
    if (!state.settings.skuPrefix) state.settings.skuPrefix = 'SKU-';
    if (state.settings.skuDigits == null) state.settings.skuDigits = 6;
  }
  function escRe(s){ return String(s).replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
  window.computeNextSkuSeed = function(){
    ensureSkuSettings();
    const re = new RegExp('^' + escRe(state.settings.skuPrefix) + '(\\d+)$', 'i');
    let maxNum = 0;
    for (const p of (state.parts || [])) {
      const m = (p.code || '').trim().match(re);
      if (m && m[1]) {
        const n = parseInt(m[1],10);
        if (!isNaN(n) && n > maxNum) maxNum = n;
      }
    }
    if (state.settings.nextSku && state.settings.nextSku - 1 > maxNum) maxNum = state.settings.nextSku - 1;
    return maxNum + 1;
  };
  function pad(n,w){ const s=String(n); return s.length>=w?s:'0'.repeat(w-s.length)+s; }
  window.updateSkuPreview = function(){
    try {
      ensureSkuSettings();
      const next = computeNextSkuSeed();
      const sample = state.settings.skuPrefix + pad(next, state.settings.skuDigits);
      const el = document.getElementById('sku-next-preview'); if (el) el.textContent = sample;
    } catch(e){}
  };
  window.saveSkuSettings = function(){
    ensureSkuSettings();
    const prefEl = document.getElementById('sku-prefix-input');
    const digEl = document.getElementById('sku-digits-input');
    if (prefEl && prefEl.value) state.settings.skuPrefix = prefEl.value;
    if (digEl && digEl.value) state.settings.skuDigits = Math.max(1, Math.min(12, parseInt(digEl.value,10) || 6));
    try { saveStateToLocalStorage(); } catch(_){}
    updateSkuPreview();
    try { showAlert('Ulo≈æeno','Nastaven√≠ SKU aktualizov√°no.','success'); } catch(_){}
  };
  document.addEventListener('DOMContentLoaded', function(){
    ensureSkuSettings();
    const prefEl = document.getElementById('sku-prefix-input');
    const digEl = document.getElementById('sku-digits-input');
    if (prefEl) prefEl.value = state.settings.skuPrefix;
    if (digEl) digEl.value = state.settings.skuDigits;
    updateSkuPreview();
  });
})();
</script>


</div>
                </div>
                 <div class="settings-card">
                    <h3>Obecn√© nastaven√≠</h3>
                    <div class="form-group">
                        <label for="setting-low-stock-threshold">Hranice pro n√≠zk√Ω stav (v % nad min. stav)</label>
                        <input type="number" id="setting-low-stock-threshold" class="form-input" value="20" min="0">
                        <p class="text-tertiary-color" style="font-size: 0.75rem; margin-top: 4px;">D√≠l bude oznaƒçen jako "n√≠zk√Ω stav", kdy≈æ jeho mno≈æstv√≠ klesne pod `minStock * (1 + threshold / 100)`.</p>
                    </div>
                    <div class="form-group">
                        <label for="dashboard-scope-select">Zobrazen√≠ dat na Dashboardu</label>
                        <select id="dashboard-scope-select" class="form-select"></select>
                    </div>
                     <button class="btn btn-primary" onclick="saveSettings()">Ulo≈æit nastaven√≠</button>
                </div>
                <div class="settings-card">
                    <h3>D≈Øvody v√Ωdeje</h3>
                    <p class="text-secondary-color" style="margin-bottom: 16px;">Spravujte p≈ôeddefinovan√© mo≈ænosti pro d≈Øvod v√Ωdeje d√≠lu ze skladu.</p>
                    <div id="dispense-reasons-list"></div>
                    <div style="display: flex; gap: 12px; margin-top: 16px;">
                        <!-- Zkr√°cen√© n√°zvy, aby se v √∫zk√©m sloupci nep≈ôet√©kaly -->
                        <input type="text" id="new-reason-key" placeholder="Kl√≠ƒç" class="form-input">
                        <input type="text" id="new-reason-value" placeholder="Popis" class="form-input">
                        <button class="btn btn-success" onclick="addDispenseReason()">‚ûï</button>
                    </div>
                </div>
                 <div class="settings-card">
                    <h3>Kmenov√° data aplikace</h3>
                    <p class="text-secondary-color" style="margin-bottom: 16px;">Spravujte z√°kladn√≠ ƒç√≠seln√≠ky aplikace.</p>
                    
                    <!-- Spr√°va sklad≈Ø -->
                    <h4>Sklady</h4>
                    <div id="warehouses-settings-list"></div>
                    <div class="core-data-item">
                        <!-- Allow warehouse keys to be longer; minimum length enforced in script -->
                        <input type="text" id="new-warehouses-key" placeholder="Kl√≠ƒç" class="form-input" maxlength="12">
                        <input type="text" id="new-warehouses-value" placeholder="N√°zev skladu" class="form-input" oninput="autoGenerateKey('warehouses')">
                        <button class="btn btn-success" onclick="addCoreDataItem('warehouses')">‚ûï</button>
                    </div>

                    <!-- Spr√°va kategori√≠ -->
                    <h4 style="margin-top: 16px;">Kategorie</h4>
                    <div id="categories-settings-list"></div>
                    <div class="core-data-item">
                        <input type="text" id="new-categories-key" placeholder="Kl√≠ƒç" class="form-input">
                        <input type="text" id="new-categories-value" placeholder="N√°zev kategorie" class="form-input" oninput="autoGenerateKey('categories')">
                        <button class="btn btn-success" onclick="addCoreDataItem('categories')">‚ûï</button>
                    </div>

                    
                    <!-- Spr√°va za≈ô√≠zen√≠/stroj≈Ø -->
                    <h4 style="margin-top: 16px;">Za≈ô√≠zen√≠ / Stroje</h4>
                    <div id="machines-settings-list"></div>
                    <div class="core-data-item">
                        <input type="text" id="new-machines-key" placeholder="Kl√≠ƒç" class="form-input">
                        <input type="text" id="new-machines-value" placeholder="N√°zev za≈ô√≠zen√≠" class="form-input" oninput="autoGenerateKey('machines')">
                        <button class="btn btn-success" onclick="addCoreDataItem('machines')">‚ûï</button>
                    </div>
                    <!-- Spr√°va priorit -->
                    <h4 style="margin-top: 16px;">Priority</h4>
                    <div id="priorities-settings-list"></div>
                    <div class="core-data-item">
                        <input type="text" id="new-priorities-key" placeholder="Kl√≠ƒç" class="form-input" maxlength="1">
                        <input type="text" id="new-priorities-value" placeholder="N√°zev priority" class="form-input" oninput="autoGenerateKey('priorities')">
                        <button class="btn btn-success" onclick="addCoreDataItem('priorities')">‚ûï</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="part-modal" class="modal-overlay hidden"></div>
    <div id="assign-part-modal" class="modal-overlay hidden"></div>
    <div id="user-modal" class="modal-overlay hidden"></div>
    <div id="order-modal" class="modal-overlay hidden"></div>
    <div id="transfer-modal" class="modal-overlay hidden"></div>
    <div id="part-detail-modal" class="modal-overlay hidden"></div>
    <div id="receive-modal" class="modal-overlay hidden"></div>
    <div id="dispense-modal" class="modal-overlay hidden"></div>
    <div id="alert-modal" class="modal-overlay hidden"></div>
    <div id="supplier-modal" class="modal-overlay hidden"></div>
    <div id="inventory-modal" class="modal-overlay hidden"></div>
    <div id="change-password-modal" class="modal-overlay hidden"></div>
    <div id="machine-detail-modal" class="modal-overlay hidden"></div>
    <div id="machine-create-modal" class="modal-overlay hidden"></div>
<!-- CHATGPT PATCH 24: Service & History modal (merged from device detail) -->
<div id="svc-modal" class="modal-overlay hidden" data-machine-id="">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Servis &amp; Historie</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="toggleFullModal(this)">‚§¢ Roz≈°√≠≈ôit</button>
            <button class="btn btn-primary" onclick="openServiceForMachine('`+machineId+`')">üõ†Ô∏è Servis &amp; Historie</button>
      </div>
      <button class="modal-close" onclick="hideModal('svc-modal')" aria-label="Zav≈ô√≠t">√ó</button>
    </div>
    <div class="modal-content">
      <!-- BEGIN imported service+history sections -->
      <section id="sec-service" class="section">
              <div class="section-header">
                <div class="section-title">Servis <span id="role-badge" class="role-badge role-viewer">Viewer</span><span id="user-badge" class="user-badge" title="Klikni pro nastaven√≠ jm√©na">u≈æivatel: nezn√°m√Ω</span></div>
                <div class="section-actions"><button id="inv-map-toggle" class="btn btn-ghost" title="Nastavit mapov√°n√≠ skladu pro odeƒçet">‚öôÔ∏è Sklad ‚Äì mapov√°n√≠</button><div class="order-profile-actions"><button id="order-save-default" class="btn btn-ghost" title="Nastavit aktu√°ln√≠ po≈ôad√≠ sekc√≠ jako v√Ωchoz√≠ pro toto za≈ô√≠zen√≠">Ulo≈æit v√Ωchoz√≠ po≈ôad√≠</button><button id="order-save-user" class="btn btn-ghost" title="Ulo≈æit po≈ôad√≠ jako m≈Øj profil pro toto za≈ô√≠zen√≠">Ulo≈æit m≈Øj profil</button><button id="order-reset-default" class="btn btn-ghost" title="Obnovit v√Ωchoz√≠ po≈ôad√≠">Obnovit v√Ωchoz√≠</button></div>
                  <button class="btn-icon drag-handle" title="P≈ôesunout (t√°hni)">‚Üï</button>
                  <button class="btn-icon" onclick="toggleSectionCollapse('sec-service')" title="Sbalit/rozbalit">‚ñæ</button>
                </div>
              </div>
              <div class="section-body">
                
    <div class="svc-templates">
      <label><b>≈†ablona:</b></label>
      <select id="svc-template"></select>
      <button id="svc-template-save" class="btn btn-small" title="Ulo≈æit jako novou ≈°ablonu">Ulo≈æit ≈°ablonu</button>
    </div>
    
<div class="inv-map-panel" id="inv-map-panel">
  <div class="inv-map-grid">
    <div class="form-group">
      <label>LocalStorage kl√≠ƒç (pole d√≠l≈Ø)</label>
      <input id="inv-key" class="form-input" list="ls-keys" placeholder="nap≈ô. parts">
      <datalist id="ls-keys"></datalist>
      <div class="inline-note">Vyber kl√≠ƒç, pod kter√Ωm je ulo≈æeno pole s d√≠ly.</div>
    </div>
    <div class="form-group">
      <label>Identifik√°tor polo≈æky (id/partId/sku)</label>
      <input id="inv-id" class="form-input" placeholder="id">
    </div>
    <div class="form-group">
      <label>N√°zev (name/title)</label>
      <input id="inv-name" class="form-input" placeholder="name">
    </div>
    <div class="form-group">
      <label>SKU (sku)</label>
      <input id="inv-sku" class="form-input" placeholder="sku">
    </div>
    <div class="form-group">
      <label>Mno≈æstv√≠ (qty/stock)</label>
      <input id="inv-qty" class="form-input" placeholder="qty">
    </div>
    <div class="form-group">
      <label><input type="checkbox" id="inv-per-device"> Ukl√°dat nastaven√≠ <b>pro toto za≈ô√≠zen√≠</b></label>
    </div>
  </div>
  <div class="inline-actions" style="margin-top:8px;">
    <button id="inv-save" class="btn btn-success">Ulo≈æit mapov√°n√≠</button>
    <button id="inv-preview" class="btn">N√°hled dat</button>
  </div>
  <div class="inv-preview" id="inv-preview-box"></div>
</div>

<div class="service-form">
    
                  <div class="form-row">
                    <div class="form-group">
                      <label>Datum</label>
                      <input id="svc-date" class="form-input" type="date">
                    </div>
                    <div class="form-group">
                      <label>Technik / provedl</label>
                      <input id="svc-person" class="form-input" type="text" placeholder="Jm√©no / firma">
                    </div>
                  </div>
                  <div class="form-group"><label>Popis <span class="req" title="povinn√©">*</span></label>
                    <textarea id="svc-desc" class="form-input" placeholder="Co se dƒõlalo, z√°vada, pozn√°mky‚Ä¶"></textarea>
                  </div>
                  <div class="form-group">
                    <label>Fotodokumentace (JPG/PNG) ‚Äì obr√°zky budou komprimov√°ny kv≈Øli limitu LocalStorage</label>
                    <input id="svc-photos" class="form-input" type="file" accept="image/*" multiple>
<div id="svc-photo-editor" class="photo-editor"></div>
<div class="form-group" style="margin-top:8px;">
  <label>Poƒçet povinn√Ωch fotek</label>
  <input id="svc-required-photos" class="form-input" type="number" min="0" step="1" value="0">
</div>
                  </div>
                  
    <div class="used-parts">
      <div class="row">
        <input id="used-part-search" class="form-input" placeholder="Hledat d√≠l (n√°zev nebo SKU)" list="parts-list">
        <datalist id="parts-list"></datalist>
        <input id="used-part-sku" class="form-input" placeholder="SKU (voliteln√©)">
        <input id="used-part-qty" class="form-input" type="number" min="1" step="1" value="1">
        <button id="used-part-add" class="btn">P≈ôidat d√≠l</button>
      </div>
      <table id="used-parts-table"><thead><tr><th>N√°zev</th><th>SKU</th><th>Mno≈æstv√≠</th><th></th></tr></thead><tbody></tbody></table>
    </div>
    <div class="svc-checklist">
  <div class="row">
    <input id="svc-checklist-new" class="form-input" placeholder="Polo≈æka checklistu‚Ä¶">
    <button id="svc-checklist-add" class="btn">P≈ôidat polo≈æku</button>
  </div>
  <ul id="svc-checklist-list"></ul>
  <div class="inline-actions"><button id="svc-checklist-clear" class="btn btn-ghost">Vyƒçistit checklist</button></div>
</div>
<div class="modal-actions" style="justify-content:flex-start;">
    
                    <button class="btn btn-success" onclick="addServiceRecord()">‚ûï P≈ôidat z√°znam</button>
                  </div>
                </div>
                
    <div class="filters" id="svc-filters">
      <div class="form-group"><label>Od</label><input type="date" id="svc-from"></div>
      <div class="form-group"><label>Do</label><input type="date" id="svc-to"></div>
      <div class="form-group"><label>Technik</label><input type="text" id="svc-tech" placeholder="Jm√©no firmy/technika"></div>
      <div class="form-group"><label>Hledat</label><input type="text" id="svc-q" placeholder="text v popisu‚Ä¶"></div>
    </div>
    <div class="inline-actions" style="margin: 4px 0 8px;">
      <button id="svc-pdf-btn" class="btn">Export servisn√≠ karta (PDF)</button>
    </div>
    <div class="svc-list" id="svc-list"></div>
    
              </div>
            </section>

            <!-- History section -->
            
      <section id="sec-history" class="section">
              <div class="section-header">
                <div class="section-title">Historie</div>
                <div class="section-actions"><button id="inv-map-toggle" class="btn btn-ghost" title="Nastavit mapov√°n√≠ skladu pro odeƒçet">‚öôÔ∏è Sklad ‚Äì mapov√°n√≠</button><div class="order-profile-actions"><button id="order-save-default" class="btn btn-ghost" title="Nastavit aktu√°ln√≠ po≈ôad√≠ sekc√≠ jako v√Ωchoz√≠ pro toto za≈ô√≠zen√≠">Ulo≈æit v√Ωchoz√≠ po≈ôad√≠</button><button id="order-save-user" class="btn btn-ghost" title="Ulo≈æit po≈ôad√≠ jako m≈Øj profil pro toto za≈ô√≠zen√≠">Ulo≈æit m≈Øj profil</button><button id="order-reset-default" class="btn btn-ghost" title="Obnovit v√Ωchoz√≠ po≈ôad√≠">Obnovit v√Ωchoz√≠</button></div>
                  <button class="btn-icon drag-handle" title="P≈ôesunout (t√°hni)">‚Üï</button>
                  <button class="btn-icon" onclick="toggleSectionCollapse('sec-history')" title="Sbalit/rozbalit">‚ñæ</button>
                </div>
              </div>
              <div class="section-body">
                
    <div class="filters" id="hist-filters">
      <div class="form-group"><label>Od</label><input type="date" id="hist-from"></div>
      <div class="form-group"><label>Do</label><input type="date" id="hist-to"></div>
      <div class="form-group"><label>Typ</label>
        <div class="type-checks">
          <label><input type="checkbox" class="hist-type" value="Servis" checked> Servis</label>
          <label><input type="checkbox" class="hist-type" value="√ödr≈æba" checked> √ödr≈æba</label>
          <label><input type="checkbox" class="hist-type" value="Revize" checked> Revize</label>
          <label><input type="checkbox" class="hist-type" value="Protokol" checked> Protokol</label>
        </div>
      </div>
      <div class="form-group"><label>Hledat</label><input type="text" id="hist-q" placeholder="text‚Ä¶"></div>
    </div>
    
    <div class="audit-actions">
      <button id="audit-toggle-btn" class="btn">Zobrazit Audit</button>
      <button id="audit-export-btn" class="btn">Export Audit (CSV)</button>
    </div>
    <div class="audit-panel" id="audit-panel"></div>
    <div class="history-list" id="history-list"></div>
    
    
              </div>
            </section>
      <!-- END imported service+history sections -->
    </div>
  </div>
</div>


    <script>
        // --- Glob√°ln√≠ stav aplikace ---
        let state = {
            parts: [], users: [], transactions: [], orders: [], transfers: [], notifications: [],
            suppliers: [], inventorySessions: [], auditLog: [],
            warehouses: {}, categories: {}, priorities: {}, dispenseReasons: {}, machines: {},
            machineMeta: {},
            settings: { lowStockThreshold: 20 },
            currentUser: null, // U≈æivatel se nastav√≠ po p≈ôihl√°≈°en√≠
            currentEditingId: null,
            sortConfig: { key: 'name', direction: 'ascending' }
        };


// --- Revize & √ödr≈æba: datov√Ω model a helpery ---
if (!state.machineMeta) state.machineMeta = {}; // { [machineId]: { revision:{...}, maintenance:{tasks:[]}, protocols:[] } }

function ensureMachineMeta(machineId){
  if (!state.machineMeta) state.machineMeta = {};
  const def = {
    revision: { periodicityDays: 365, last: null, next: null, responsible: '', note: '' },
    maintenance: { tasks: [] },
    protocols: []
  };
  let cur = state.machineMeta[machineId] || {};
  // Merge defaults safely
  if (!cur.revision) cur.revision = { ...def.revision };
  else {
    cur.revision.periodicityDays = (cur.revision.periodicityDays ?? 365);
    cur.revision.last = (cur.revision.last ?? null);
    cur.revision.next = (cur.revision.next ?? null);
    cur.revision.responsible = (cur.revision.responsible ?? '');
    cur.revision.note = (cur.revision.note ?? '');
  }
  if (!cur.maintenance) cur.maintenance = { tasks: [] };
  if (!Array.isArray(cur.maintenance.tasks)) cur.maintenance.tasks = [];
  if (!Array.isArray(cur.protocols)) cur.protocols = [];
  state.machineMeta[machineId] = cur;
}

function addDays(isoDate, days){
  if (!isoDate) return null;
  const d = new Date(isoDate); d.setDate(d.getDate() + (days||0)); 
  return d.toISOString().slice(0,10);
}

function recomputeRevision(machineId){
  if (!state.machineMeta) state.machineMeta = {};
  if (!state.machineMeta[machineId]) ensureMachineMeta(machineId);
  const m = state.machineMeta[machineId];
  if (!m || !m.revision) { ensureMachineMeta(machineId); return; }
  m.revision.next = m.revision.last ? addDays(m.revision.last, m.revision.periodicityDays || 365) : null;
}

function revStatus(machineId){
  const next = state.machineMeta?.[machineId]?.revision?.next;
  if (!next) return {label:'‚Äî', cls:'badge-gray', days:null};
  const diff = Math.ceil((new Date(next) - new Date())/(1000*60*60*24));
  if (diff < 0) return {label:`Po term√≠nu ${Math.abs(diff)} d`, cls:'badge-red', days:diff};
  if (diff <= 7) return {label:`Za ${diff} d`, cls:'badge-orange', days:diff};
  if (diff <= 30) return {label:`Za ${diff} d`, cls:'badge-yellow', days:diff};
  return {label: next, cls:'badge-green', days:diff};
}

function upgradeMachineMeta(){
  // Ensure for all known machines
  Object.keys(state.machines || {}).forEach(id => {
    ensureMachineMeta(id);
    recomputeRevision(id);
  });
  // Also normalize any legacy machineMeta entries that don't exist in machines
  Object.keys(state.machineMeta || {}).forEach(id => {
    ensureMachineMeta(id);
    recomputeRevision(id);
  });
}
// Doƒçasn√Ω p≈ôep√≠naƒç p≈ôihl√°≈°en√≠ ‚Äì bƒõhem testov√°n√≠ zapnuto
// Pro ostr√Ω provoz je nutn√© m√≠t p≈ôihla≈°ov√°n√≠ aktivn√≠, proto je hodnota nastavena na false.
const AUTH_DISABLED = false; // p≈ôihl√°≈°en√≠ je povoleno pro ostr√Ω provoz

        // --- Jazykov√© p≈ôeklady a p≈ôep√≠naƒç ---
        // Definice p≈ôeklad≈Ø pro jednotliv√© kl√≠ƒçe. ƒåe≈°tina (cs) a angliƒçtina (en).
        const translations = {
            cs: {
                login_title: 'P≈ôihl√°≈°en√≠',
                login_welcome: 'V√≠tejte v syst√©mu spr√°vy n√°hradn√≠ch d√≠l≈Ø',
                login_email_label: 'Email',
                login_email_placeholder: 'vas.email@firma.cz',
                login_password_label: 'Heslo',
                login_password_placeholder: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
                login_button: 'P≈ôihl√°sit se',
                app_title: 'Syst√©m spr√°vy n√°hradn√≠ch d√≠l≈Ø v13',
                app_description: 'Kompletn√≠ ≈ôe≈°en√≠ pro evidenci, hl√≠d√°n√≠ a spr√°vu skladov√Ωch z√°sob',
                notifications_header: 'Ozn√°men√≠',
                change_password: 'Zmƒõnit heslo',
                logout: 'Odhl√°sit',
                nav_dashboard: 'Dashboard',
                nav_inventory: 'Sklad',
                nav_machines: 'Za≈ô√≠zen√≠',
                nav_suppliers: 'Dodavatel√©',
                nav_orders: 'Objedn√°vky',
                nav_transfers: 'P≈ôesuny',
                nav_inventory_module: 'Inventura',
                nav_transactions: 'Transakce',
                nav_reports: 'Reporty',
                nav_users: 'U≈æivatel√©',
                nav_audit_log: 'Audit Log',
                nav_settings: 'Nastaven√≠',
                stat_total_parts: 'Celkem d√≠l≈Ø na skladƒõ',
                stat_low_stock: 'N√≠zk√Ω stav',
                stat_critical_parts: 'Kritick√© d√≠ly',
                stat_total_value: 'Hodnota skladu',
                pinned_items_heading: 'P≈ôipnut√© polo≈æky',
                search_placeholder: 'Hledat podle n√°zvu, k√≥du...',
                add_part_button: 'Zav√©st nov√Ω typ d√≠lu',
                stock_in_button: 'Naskladnit d√≠l'
                ,filter_all_warehouses: 'V≈°echny sklady'
                ,filter_all_categories: 'V≈°echny kategorie'
                ,filter_all_machines: 'V≈°echna za≈ô√≠zen√≠'
                ,th_name: 'N√°zev'
                ,th_num_parts: 'Poƒçet d√≠l≈Ø'
                ,th_critical: 'Kritick√©'
                ,th_inventory_value: 'Hodnota z√°sob'
                ,th_revision: 'Revize'
                ,th_actions: 'Akce'
                ,th_ico: 'IƒåO'
                ,th_contact: 'Kontakt'
                ,th_email: 'Email'
                ,th_number: 'ƒå√≠slo'
                ,th_supplier: 'Dodavatel'
                ,th_items: 'Polo≈æky'
                ,th_price: 'Cena'
                ,th_status: 'Stav'
                ,th_created: 'Vytvo≈ôeno'
                ,th_part: 'D√≠l'
                ,th_from: 'Z'
                ,th_to: 'Do'
                ,th_quantity: 'Mno≈æstv√≠'
                ,th_date: 'Datum'
                ,th_warehouse: 'Sklad'
                ,th_start_date: 'Datum zah√°jen√≠'
                ,th_processed_by: 'Zpracoval'
                ,th_type: 'Typ'
                ,th_reason_note: 'D≈Øvod/Pozn√°mka'
                ,th_user: 'U≈æivatel'
                ,th_role: 'Role'
                ,th_warehouses: 'Sklady'
                ,th_detail: 'Detail'
                ,machines_no_results: '≈Ω√°dn√° za≈ô√≠zen√≠ k zobrazen√≠.'
                ,search_machines_placeholder: 'Hledat za≈ô√≠zen√≠...'
                ,col_part: 'D√≠l'
                ,col_sku_inv: 'SKU / Inv.ƒç.'
                ,col_category: 'Kategorie'
                ,col_machine: 'Za≈ô√≠zen√≠'
                ,col_location: 'Um√≠stƒõn√≠'
                ,col_stock_status: 'Stav skladu'
                ,col_value: 'Hodnota'
                ,forgot_password: 'Zapomnƒõli jste heslo?'
                ,forgot_password_prompt: 'Zadejte sv≈Øj e-mail:'
                ,forgot_password_no_user: 'U≈æivatel s t√≠mto e-mailem nebyl nalezen.'
                ,forgot_password_title: 'Reset hesla'
                ,forgot_password_new_pass: 'Va≈°e nov√© doƒçasn√© heslo je:'
                ,forgot_password_instructions: 'P≈ôihlaste se s nov√Ωm heslem a zmƒõ≈àte si ho v nastaven√≠.'
            },
            en: {
                login_title: 'Login',
                login_welcome: 'Welcome to the spare parts management system',
                login_email_label: 'Email',
                login_email_placeholder: 'your.email@company.com',
                login_password_label: 'Password',
                login_password_placeholder: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
                login_button: 'Log in',
                app_title: 'Spare Parts Management System v13',
                app_description: 'Complete solution for tracking, monitoring and managing stock inventory',
                notifications_header: 'Notifications',
                change_password: 'Change password',
                logout: 'Log out',
                nav_dashboard: 'Dashboard',
                nav_inventory: 'Inventory',
                nav_machines: 'Machines',
                nav_suppliers: 'Suppliers',
                nav_orders: 'Orders',
                nav_transfers: 'Transfers',
                nav_inventory_module: 'Stocktaking',
                nav_transactions: 'Transactions',
                nav_reports: 'Reports',
                nav_users: 'Users',
                nav_audit_log: 'Audit Log',
                nav_settings: 'Settings',
                nav_revisions: 'Revisions',
                stat_total_parts: 'Total items in stock',
                stat_low_stock: 'Low stock',
                stat_critical_parts: 'Critical parts',
                stat_total_value: 'Warehouse value',
                pinned_items_heading: 'Pinned items',
                search_placeholder: 'Search by name, code...',
                add_part_button: 'Add new part type',
                stock_in_button: 'Stock in part'
                ,filter_all_warehouses: 'All warehouses'
                ,filter_all_categories: 'All categories'
                ,filter_all_machines: 'All machines'
                ,th_name: 'Name'
                ,th_num_parts: 'Number of parts'
                ,th_critical: 'Critical'
                ,th_inventory_value: 'Inventory value'
                ,th_revision: 'Revision'
                ,th_actions: 'Actions'
                ,th_ico: 'Company ID'
                ,th_contact: 'Contact'
                ,th_email: 'Email'
                ,th_number: 'Number'
                ,th_supplier: 'Supplier'
                ,th_items: 'Items'
                ,th_price: 'Price'
                ,th_status: 'Status'
                ,th_created: 'Created'
                ,th_part: 'Part'
                ,th_from: 'From'
                ,th_to: 'To'
                ,th_quantity: 'Quantity'
                ,th_date: 'Date'
                ,th_warehouse: 'Warehouse'
                ,th_start_date: 'Start date'
                ,th_processed_by: 'Processed by'
                ,th_type: 'Type'
                ,th_reason_note: 'Reason/Note'
                ,th_user: 'User'
                ,th_role: 'Role'
                ,th_warehouses: 'Warehouses'
                ,th_detail: 'Detail'
                ,machines_no_results: 'No machines to display.'
                ,search_machines_placeholder: 'Search machines...'
                ,col_part: 'Part'
                ,col_sku_inv: 'SKU / Inv.no.'
                ,col_category: 'Category'
                ,col_machine: 'Machine'
                ,col_location: 'Location'
                ,col_stock_status: 'Stock status'
                ,col_value: 'Value'
                ,forgot_password: 'Forgot password?'
                ,forgot_password_prompt: 'Enter your email:'
                ,forgot_password_no_user: 'No user found with that email.'
                ,forgot_password_title: 'Password reset'
                ,forgot_password_new_pass: 'Your new temporary password is:'
                ,forgot_password_instructions: 'Log in with the new password and change it in settings.'
            }
        };

        // Aktu√°ln√≠ jazyk, naƒçte se z localStorage nebo nastav√≠ v√Ωchoz√≠ ƒçe≈°tina
        let currentLang = (function(){ try { return localStorage.getItem('lang') || 'cs'; } catch (e) { return 'cs'; } })();

        /**
         * P≈ôepne jazyk a ulo≈æ√≠ volbu do localStorage.
         * @param {string} lang K√≥d jazyka ('cs' nebo 'en')
         */
        function setLanguage(lang) {
            currentLang = lang;
            try { localStorage.setItem('lang', lang); } catch (e) {}
            applyTranslations();
            // P≈ôegenerujeme filtry s lokalizovan√Ωmi n√°zvy, pokud funkce existuje
            try {
                if (typeof renderFilters === 'function') renderFilters();
            } catch (_) {}
            // P≈ôekresl√≠me tabulku s d√≠ly, pokud existuje renderPartsTable
            try {
                if (typeof renderPartsTable === 'function') renderPartsTable();
            } catch (_) {}
        }

        /**
         * Aplikuje textov√© p≈ôeklady na v≈°echny elementy, kter√© maj√≠ data-i18n nebo data-placeholder-i18n atributy.
         */
        function applyTranslations() {
            // p≈ôelo≈æen√≠ textov√©ho obsahu
            document.querySelectorAll('[data-i18n]').forEach((el) => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang] && translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });
            // p≈ôelo≈æen√≠ placeholder≈Ø u vstup≈Ø
            document.querySelectorAll('[data-placeholder-i18n]').forEach((el) => {
                const key = el.getAttribute('data-placeholder-i18n');
                if (translations[currentLang] && translations[currentLang][key]) {
                    el.placeholder = translations[currentLang][key];
                }
            });
            // nastaven√≠ aktivn√≠/inaktivn√≠ t≈ô√≠dy na vlajky
            const flagCs = document.getElementById('flag-cs');
            const flagEn = document.getElementById('flag-en');
            if (flagCs && flagEn) {
                if (currentLang === 'cs') {
                    flagCs.classList.add('active');
                    flagCs.classList.remove('inactive');
                    flagEn.classList.add('inactive');
                    flagEn.classList.remove('active');
                } else {
                    flagEn.classList.add('active');
                    flagEn.classList.remove('inactive');
                    flagCs.classList.add('inactive');
                    flagCs.classList.remove('active');
                }
            }
        }



        const permissionPresets = {
            admin: { canEditParts: true, canDeleteParts: true, canCreateOrders: true, canCreateTransfers: true, canManageUsers: true, canViewReports: true, canAddMasterPart: true, canManageSettings: true, canManageSuppliers: true, canPerformInventory: true },
            vedouci_skladu: { canEditParts: true, canDeleteParts: false, canCreateOrders: true, canCreateTransfers: true, canManageUsers: false, canViewReports: true, canAddMasterPart: true, canManageSettings: false, canManageSuppliers: true, canPerformInventory: true },
            technik: { canEditParts: false, canDeleteParts: false, canCreateOrders: false, canCreateTransfers: true, canManageUsers: false, canViewReports: false, canAddMasterPart: false, canManageSettings: false, canManageSuppliers: false, canPerformInventory: false },
        };

        // --- Glob√°ln√≠ stav pro focus management ---
        let lastFocusedElement;

        // --- Inicializace ---
        document.addEventListener('DOMContentLoaded', () => {

            // Nastav jazyky a p≈ôelo≈æ okam≈æitƒõ po naƒçten√≠ str√°nky
            try { applyTranslations(); } catch (_) {}

// --- AUTH_DISABLED: auto-login jako Test Admin ---
if (typeof AUTH_DISABLED !== 'undefined' && AUTH_DISABLED) {
  try { loadStateFromLocalStorage(); } catch (e) {}
  try { if (localStorage.getItem('darkMode') === 'true') { document.body.classList.add('dark-mode'); } } catch (e) {}
  window.state = window.state || {};
  state.currentUser = {
    id: -999,
    name: 'Test Admin',
    email: 'test@local',
    role: 'admin',
    permissions: (typeof permissionPresets !== 'undefined' && permissionPresets && permissionPresets.admin) ? permissionPresets.admin : {
      canEditParts: true, canDeleteParts: true, canCreateOrders: true, canCreateTransfers: true,
      canManageUsers: true, canViewReports: true, canAddMasterPart: true, canManageSettings: true,
      canManageSuppliers: true, canPerformInventory: true
    },
    warehouses: null,
    forcePasswordChange: false,
    dashboard: { pinnedParts: [], pinnedCharts: [], dashboardScope: 'all' }
  };
  var ls = document.getElementById('login-screen'); if (ls) ls.classList.add('hidden');
  var app = document.getElementById('app-container'); if (app) app.classList.remove('hidden');
  if (typeof initializeApp === 'function') { initializeApp(); }
  try { console.warn('‚ö†Ô∏è AUTH DISABLED: bƒõ≈æ√≠m jako Test Admin'); } catch (e) {}
  return;
}

            loadStateFromLocalStorage();
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
            }
            // Zobraz√≠ p≈ôihla≈°ovac√≠ obrazovku m√≠sto p≈ô√≠m√©ho spu≈°tƒõn√≠ aplikace
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
            
            // Event listener pro stisk Enter v poli hesla
            document.getElementById('login-password').addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleLogin();
                }
            });
            console.log("Aplikace v13 inicializov√°na s p≈ôihla≈°ovac√≠ obrazovkou!");
        });
        
        function initializeApp() {
            renderAll();
            setupEventListeners();
            checkForcePasswordChange();
        }

        function renderAll() {
            if (!state.currentUser) return; // Nespou≈°tƒõt renderov√°n√≠ bez p≈ôihl√°≈°en√©ho u≈æivatele
            // P≈ôed vykreslen√≠m aktualizujeme optim√°ln√≠ z√°soby podle transakc√≠
            if (typeof updateOptimalStock === 'function') updateOptimalStock();
            updateUserInterface();
            renderPartsTable();
            renderSuppliersTable();
            renderOrdersTable();
            renderTransfersTable();
            renderInventoryList();
            renderTransactionsTable();
            renderUsersTable();
            renderFilters();
            renderNotifications();
            updateStats();
            // Zajist√≠, ≈æe se dashboard a dal≈°√≠ z√°lo≈æky vykresl√≠ p≈ôi prvn√≠m naƒçten√≠
            const activeTab = document.querySelector('.main-nav-button.active').getAttribute('onclick').match(/'(.*?)'/)[1];
            showTab(activeTab);
        }

        // --- Spr√°va dat a LocalStorage ---
        function loadStateFromLocalStorage() {
            const savedState = localStorage.getItem('sparePartsState_v13'); // Zmƒõna verze na v13
            if (savedState) {
                const loaded = JSON.parse(savedState);
                // Naƒçteme v≈°e kromƒõ currentUser, ten se nastav√≠ a≈æ po p≈ôihl√°≈°en√≠
                const { currentUser, ...restOfState } = loaded;
                state = { ...state, ...restOfState };
                
                // Migraƒçn√≠ skripty pro star≈°√≠ verze
                if (state.users && state.users.length > 0) {
                    state.users.forEach(u => {
                        if (typeof u.forcePasswordChange === 'undefined') {
                            u.forcePasswordChange = false;
                        }
                        if (!u.dashboard) {
                            u.dashboard = { pinnedParts: [], pinnedCharts: [], dashboardScope: 'all' };
                        }
                    });
                } else {
                    loadSampleData(); // Pokud nejsou u≈æivatel√©, naƒçteme vzorov√° data
                    return;
                }

                if (state.parts) {
                    state.parts.forEach(p => {
                        if (p.price && !p.priceHistory) {
                            p.priceHistory = [{ date: new Date().toISOString(), price: p.price }];
                            delete p.price;
                        } else if (!p.priceHistory) {
                             p.priceHistory = [];
                        }
                        if (typeof p.imageData === 'undefined') p.imageData = null;
                        if (typeof p.docName === 'undefined') p.docName = null;
                    });
                }

                if (!state.dispenseReasons) state.dispenseReasons = { 'oprava': 'Oprava za≈ô√≠zen√≠', 'udrzba': 'Pl√°novan√° √∫dr≈æba', 'jine': 'Jin√© (specifikovat)' };
                if (!state.suppliers) state.suppliers = [];
                if (!state.inventorySessions) state.inventorySessions = [];
                if (!state.auditLog) state.auditLog = [];
                if (state.notifications) {
                    state.notifications.forEach(n => n.timestamp = new Date(n.timestamp));
                } else {
                    state.notifications = [];
                }

            } else {
                loadSampleData();
            }
        
            try { upgradeMachineMeta(); } catch(_) {}
        }


        function saveStateToLocalStorage() {
            try {
                // Ukl√°d√°me v≈°e kromƒõ currentUser, aby se u≈æivatel musel v≈ædy p≈ôihl√°sit
                const stateToSave = { ...state };
                delete stateToSave.currentUser; 
                localStorage.setItem('sparePartsState_v13', JSON.stringify(stateToSave));
            } catch (e) {
                console.error("Chyba p≈ôi ukl√°d√°n√≠ do LocalStorage:", e);
                showAlert('Chyba', 'Chyba p≈ôi ukl√°d√°n√≠ dat. Je mo≈æn√©, ≈æe je √∫lo≈æi≈°tƒõ pln√©.', 'error');
            }
        }

        function loadSampleData() {
            state.warehouses = { 'lib': 'Liboc', 'bro': 'Brno', 'poc': 'Poƒçernice' };
            state.categories = { 'elektro': 'Elektro', 'mechanicke': 'Mechanick√©', 'spotrebni': 'Spot≈ôebn√≠' };
            if (!state.machines || Object.keys(state.machines).length===0) { state.machines = { dopA: 'Dopravn√≠k A', sklVez1: 'Skladovac√≠ vƒõ≈æ 1' }; }
            state.priorities = { 'a': 'A - Kritick√Ω d√≠l', 'b': 'B - Vysok√°', 'c': 'C - St≈ôedn√≠', 'd': 'D - N√≠zk√°' };
            state.dispenseReasons = { 'oprava': 'Oprava za≈ô√≠zen√≠', 'udrzba': 'Pl√°novan√° √∫dr≈æba', 'prodej': 'Prodej z√°kazn√≠kovi', 'testovani': 'Testov√°n√≠ / V√Ωvoj', 'jine': 'Jin√© (specifikovat)' };
            state.suppliers = [
                { id: 1, name: 'Nord', ico: '12345678', contactPerson: 'Pan Nov√°k', email: 'nord@email.cz' },
                { id: 2, name: 'Interroll', ico: '87654321', contactPerson: 'Pan√≠ Svobodov√°', email: 'interroll@email.cz' },
            ];
            state.users = [
                { id: 1, name: 'David Rok', email: 'david.rok@firma.cz', password: 'admin', role: 'admin', permissions: permissionPresets.admin, warehouses: null, dashboard: { pinnedParts: [], pinnedCharts: [], dashboardScope: 'all' }, forcePasswordChange: true },
                { id: 2, name: 'Jan Technik', email: 'jan.technik@firma.cz', password: 'tech', role: 'technik', permissions: permissionPresets.technik, warehouses: ['lib'], dashboard: { pinnedParts: [], pinnedCharts: [], dashboardScope: 'all' }, forcePasswordChange: true },
                { id: 3, name: 'Petr Skladn√≠k', email: 'petr.skladnik@firma.cz', password: 'sklad', role: 'vedouci_skladu', permissions: permissionPresets.vedouci_skladu, warehouses: ['lib', 'poc'], dashboard: { pinnedParts: [], pinnedCharts: [], dashboardScope: 'all' }, forcePasswordChange: true },
            ];
            state.parts = [
                { id: 1, name: 'Elektrop≈ôevodovka Nord 0,37kW', code: 'VP-0001', description: 'i=12,5 + h≈ô√≠del + ≈ôemenice √ò100', category: 'elektro', supplierId: 1, priority: 'a', priceHistory: [{date: new Date().toISOString(), price: 9587}], manufacturerNumber: 'NORD-037-125', warehouse: null, umisteni: null, currentStock: 0, minStock: 2, maxStock: 5, inventoryNumber: null, imageData: null, docName: null },
                { id: 2, name: 'Interroll 24V RollerDrive EC5000', code: 'VP-0002', description: 'EL=450', category: 'elektro', supplierId: 2, priority: 'b', priceHistory: [{date: new Date().toISOString(), price: 7819}], manufacturerNumber: 'IR-EC5000-450', warehouse: null, umisteni: null, currentStock: 0, minStock: 3, maxStock: 10, inventoryNumber: null, imageData: null, docName: null },
                { id: 101, name: 'Elektrop≈ôevodovka Nord 0,37kW', code: 'VP-0001', inventoryNumber: 'LIB-0001', description: 'i=12,5 + h≈ô√≠del + ≈ôemenice √ò100', category: 'elektro', supplierId: 1, priority: 'a', warehouse: 'lib', umisteni: 'A1 / 15-A', currentStock: 1, minStock: 2, maxStock: 5, priceHistory: [{date: new Date().toISOString(), price: 9587}], manufacturerNumber: 'NORD-037-125', imageData: null, docName: null },
                { id: 102, name: 'Interroll 24V RollerDrive EC5000', code: 'VP-0002', inventoryNumber: 'BRO-0001', description: 'EL=450', category: 'elektro', supplierId: 2, priority: 'b', warehouse: 'bro', umisteni: 'Sekce 2 / 8-B', currentStock: 3, minStock: 3, maxStock: 10, priceHistory: [{date: new Date().toISOString(), price: 7819}], manufacturerNumber: 'IR-EC5000-450', imageData: null, docName: null },
                { id: 103, name: 'Hydraulick√Ω ventil Parker', code: 'VP-0003', inventoryNumber: 'POC-0001', description: 'D1VW020B, 4/3 cestn√Ω', category: 'mechanicke', supplierId: null, priority: 'c', warehouse: 'poc', umisteni: 'Z√≥na A / 3-C', currentStock: 7, minStock: 3, maxStock: 8, priceHistory: [{date: new Date().toISOString(), price: 4250}], manufacturerNumber: 'PKR-D1VW020B', imageData: null, docName: null },
            ];
            state.orders = [];
            state.transfers = [];
            state.transactions = [];
            state.notifications = [];
            state.inventorySessions = [];
            state.auditLog = [];
            state.settings = { lowStockThreshold: 20 };
            saveStateToLocalStorage(); // Ulo≈æ√≠ vzorov√° data bez p≈ôihl√°≈°en√©ho u≈æivatele
        }

        // --- P≈ôihl√°≈°en√≠ / Odhl√°≈°en√≠ ---
        function handleLogin() {
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');

            const user = state.users.find(u => u.email.toLowerCase() === email && u.password === password);

            if (user) {
                state.currentUser = user;
                logAuditEvent('P≈ôihl√°≈°en√≠', `U≈æivatel ${user.name} se √∫spƒõ≈°nƒõ p≈ôihl√°sil.`);
                saveStateToLocalStorage(); // Ulo≈æ√≠me stav (bez currentUser)

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                errorElement.textContent = '';
                document.getElementById('login-password').value = '';

                initializeApp(); // Inicializujeme aplikaci pro p≈ôihl√°≈°en√©ho u≈æivatele
            } else {
                errorElement.textContent = 'Nespr√°vn√Ω email nebo heslo.';
                state.currentUser = null;
            }
        }

        function handleLogout() {
            logAuditEvent('Odhl√°≈°en√≠', `U≈æivatel ${state.currentUser.name} se odhl√°sil.`);
            state.currentUser = null;
            
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-email').focus();
        }

        /**
         * Zobraz√≠ dialog pro reset zapomenut√©ho hesla. U≈æivatel zad√° sv≈Øj e-mail a
         * pokud je nalezen, vygenerujeme nov√© doƒçasn√© heslo, kter√© se zobraz√≠ v hl√°≈°en√≠.
         * Nov√© heslo je nastavov√°no na u≈æivatelsk√©m √∫ƒçtu a u≈æivatel je po≈æ√°d√°n, aby si jej po p≈ôihl√°≈°en√≠ zmƒõnil.
         */
        function showForgotPasswordDialog() {
            // Po≈æ√°d√°me u≈æivatele o e-mail pomoc√≠ vestavƒõn√©ho promptu
            let email = prompt((translations[currentLang] && translations[currentLang].forgot_password_prompt) || 'Enter your email:');
            if (!email) {
                return;
            }
            email = email.trim().toLowerCase();
            const user = state.users.find(u => u.email.toLowerCase() === email);
            if (!user) {
                // U≈æivatel nenalezen
                showAlert((translations[currentLang] && translations[currentLang].forgot_password_title) || 'Reset hesla', (translations[currentLang] && translations[currentLang].forgot_password_no_user) || 'User not found.', 'error');
                return;
            }
            // Vygenerujeme nov√© heslo (8 znak≈Ø, p√≠smena+ƒç√≠sla)
            const newPass = Math.random().toString(36).slice(-8);
            user.password = newPass;
            user.forcePasswordChange = true;
            try { saveStateToLocalStorage(); } catch (_) {}
            const message = `${(translations[currentLang] && translations[currentLang].forgot_password_new_pass) || 'Your new temporary password is:'} <strong>${newPass}</strong><br>${(translations[currentLang] && translations[currentLang].forgot_password_instructions) || 'Please log in with the new password and change it in settings.'}`;
            showAlert((translations[currentLang] && translations[currentLang].forgot_password_title) || 'Password reset', message, 'success');
        }

        // Expose the forgot password dialog function globally so it can be called
        // from inline onclick handlers on the login screen. Without this, some
        // browsers may not resolve the function from the global scope due to
        // script scoping. Assigning it on the `window` object ensures it is
        // accessible from HTML attributes.
        window.showForgotPasswordDialog = showForgotPasswordDialog;

        // --- Audit Log ---
        function logAuditEvent(action, details) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                userName: state.currentUser ? state.currentUser.name : 'Syst√©m',
                action: action,
                details: details
            };
            state.auditLog.unshift(logEntry);
            if (state.auditLog.length > 500) { // Omezen√≠ d√©lky logu
                state.auditLog.pop();
            }
        }

        function renderAuditLogTable() {
            const tbody = document.getElementById('audit-log-table-body');
            const noResultsMessage = document.getElementById('no-audit-log-message');
            const userFilter = document.getElementById('audit-log-user-filter');

            // Populate user filter if not already populated
            if (userFilter.options.length <= 1) { // Check to prevent re-populating
                userFilter.innerHTML = '<option value="all">V≈°ichni u≈æivatel√©</option>';
                state.users.forEach(user => {
                    userFilter.innerHTML += `<option value="${user.name}">${user.name}</option>`;
                });
            }

            const selectedUser = userFilter.value;
            let filteredLog = state.auditLog;

            if (selectedUser !== 'all') {
                filteredLog = state.auditLog.filter(entry => entry.userName === selectedUser);
            }

            noResultsMessage.classList.toggle('hidden', filteredLog.length > 0);

            tbody.innerHTML = filteredLog.map(entry => `
                <tr>
                    <td>${new Date(entry.timestamp).toLocaleString('cs-CZ')}</td>
                    <td>${entry.userName}</td>
                    <td>${entry.action}</td>
                    <td>${entry.details}</td>
                </tr>
            `).join('');
        }
        
        // --- Pomocn√© funkce pro data ---
        function getLatestPrice(part) {
            if (!part.priceHistory || part.priceHistory.length === 0) return 0;
            return part.priceHistory[part.priceHistory.length - 1].price;
        }

        function getLowStockThreshold(part) {
            return part.minStock * (1 + (state.settings.lowStockThreshold || 20) / 100);
        }
        
        function getDashboardParts() {
            const scope = state.currentUser.dashboard.dashboardScope || 'all';
            const accessibleParts = getAccessible(state.parts).filter(p => p.warehouse !== null);

            if (scope === 'all') {
                return accessibleParts;
            }
            return accessibleParts.filter(p => p.warehouse === scope);
        }

        function updateStats() {
            const stockedParts = getDashboardParts();
            document.getElementById('total-parts').textContent = stockedParts.length;
            const lowStockParts = stockedParts.filter(p => p.currentStock <= getLowStockThreshold(p) && p.minStock > 0).length;
            document.getElementById('low-stock-parts').textContent = lowStockParts;
            const criticalParts = stockedParts.filter(p => p.priority === 'a').length;
            document.getElementById('critical-parts').textContent = criticalParts;
            const totalValue = stockedParts.reduce((sum, part) => sum + (part.currentStock * getLatestPrice(part)), 0);
            document.getElementById('total-value').textContent = `${totalValue.toLocaleString('cs-CZ')} Kƒç`;
        }

        function showLowStockReport() {
            const lowStockParts = getDashboardParts().filter(p => p.warehouse !== null && p.currentStock <= getLowStockThreshold(p) && p.minStock > 0);
            if (lowStockParts.length === 0) {
                return showAlert('Info', 'V≈°echny d√≠ly maj√≠ dostateƒçn√Ω stav!');
            }
            let reportText = `D√çLY S N√çZK√ùM STAVEM (${lowStockParts.length}):\n\n`;
            lowStockParts.forEach(part => {
                reportText += `${part.name} (Skladem: ${part.currentStock} / Min: ${part.minStock})\n`;
            });
            showAlert('Report n√≠zk√Ωch stav≈Ø', reportText, 'info');
        }

        function showCriticalPartsReport() {
            const criticalParts = getDashboardParts().filter(p => p.warehouse !== null && p.priority === 'a');
            if (criticalParts.length === 0) {
                return showAlert('Info', '≈Ω√°dn√© kritick√© d√≠ly nebyly nalezeny.');
            }
            let reportText = `KRITICK√â D√çLY (${criticalParts.length}):\n\n`;
            criticalParts.forEach(part => {
                reportText += `${part.name} (Skladem: ${part.currentStock})\n`;
            });
            showAlert('Report kritick√Ωch d√≠l≈Ø', reportText, 'info');
        }

        function showTotalValueDetails() {
            const accessibleParts = getDashboardParts();
            const totalValue = accessibleParts.reduce((sum, part) => sum + (part.currentStock * getLatestPrice(part)), 0);
            showAlert('Info', `Celkov√° hodnota skladu je: ${totalValue.toLocaleString('cs-CZ')} Kƒç.`);
        }

        // --- Spr√°va UI (z√°lo≈æky, u≈æivatel, tmav√Ω re≈æim) ---
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('.main-nav-button').forEach(btn => btn.classList.remove('active'));
            const activeButton = document.querySelector(`.main-nav-button[onclick*="'${tabName}'"]`);
            if (activeButton) activeButton.classList.add('active');
            
            if (tabName === 'dashboard') renderDashboard();
            if (tabName === 'reports') renderReports();
            if (tabName === 'machines') renderMachinesTable();
            if (tabName === 'revisions') renderRevisionsTab();
            if (tabName === 'settings') renderSettings();
            if (tabName === 'audit-log') renderAuditLogTable();
            if (tabName === 'inventory-module') {
                document.getElementById('inventory-start-view').classList.remove('hidden');
                document.getElementById('inventory-session-view').classList.add('hidden');
            }
        }

        function updateUserInterface() {
            const user = state.currentUser;
            if (!user) return;
            document.getElementById('current-user-name').textContent = user.name;
            const roleMap = { admin: 'Administr√°tor', vedouci_skladu: 'Vedouc√≠ skladu', technik: 'Technik' };
            document.getElementById('current-user-role').textContent = roleMap[user.role] || user.role;
            
            var _btn = document.getElementById('new-part-btn'); if (_btn) { _btn.style.display = userCan('canAddMasterPart') ? 'flex' : 'none'; }
            document.querySelector('.filters-right button[onclick*="showAssignPartModal"]').style.display = userCan('canEditParts') ? 'flex' : 'none';
            document.querySelector('#tab-orders .table-actions').style.display = userCan('canCreateOrders') ? 'flex' : 'none';
            document.querySelector('#tab-transfers .table-actions').style.display = userCan('canCreateTransfers') ? 'flex' : 'none';
            document.querySelector('#tab-users .table-actions').style.display = userCan('canManageUsers') ? 'flex' : 'none';
            document.querySelector('.main-nav-button[onclick*="users"]').style.display = userCan('canManageUsers') ? 'flex' : 'none';
            document.querySelector('.main-nav-button[onclick*="reports"]').style.display = userCan('canViewReports') ? 'flex' : 'none';
            document.querySelector('.main-nav-button[onclick*="settings"]').style.display = userCan('canManageSettings') ? 'flex' : 'none';
            document.querySelector('.main-nav-button[onclick*="suppliers"]').style.display = userCan('canManageSuppliers') ? 'flex' : 'none';
            document.querySelector('.main-nav-button[onclick*="inventory-module"]').style.display = userCan('canPerformInventory') ? 'flex' : 'none';
            document.querySelector('.main-nav-button[onclick*="audit-log"]').style.display = userCan('canManageUsers') ? 'flex' : 'none'; // Jen pro adminy
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            renderAll();
        }

        // --- Opr√°vnƒõn√≠ a Zmƒõna Hesla ---
        function userCan(permission) {
            const user = state.currentUser;
            if (!user) return false;
            if (user.role === 'admin') return true;
            return user.permissions && user.permissions[permission];
        }

        function hasAccess(warehouseId) {
            const user = state.currentUser;
            if (!user) return false;
            if (user.role === 'admin' || !user.warehouses || user.warehouses.length === 0) return true;
            return user.warehouses.includes(warehouseId);
        }

        function getAccessible(items) {
            if (!state.currentUser || state.currentUser.role === 'admin') return items;
            return items.filter(item => {
                if (item.warehouse === null) return true; // Master d√≠ly jsou v≈ædy p≈ô√≠stupn√©
                return 'warehouse' in item ? hasAccess(item.warehouse) : true;
            });
        }

        function checkForcePasswordChange() {
            if (state.currentUser && state.currentUser.forcePasswordChange) {
                showChangePasswordModal(true);
            }
        }

        function showChangePasswordModal(isForced = false) {
            const title = isForced ? 'Vytvo≈ôte si nov√© heslo' : 'Zmƒõnit heslo';
            const message = isForced ? 'Pro pokraƒçov√°n√≠ si mus√≠te nastavit nov√© heslo. Toto je va≈°e prvn√≠ p≈ôihl√°≈°en√≠.' : 'Zadejte nov√© heslo pro v√°≈° √∫ƒçet.';
            
            const html = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2 class="modal-title">${title}</h2>
                        ${!isForced ? `<button class="modal-close" onclick="hideModal('change-password-modal')" aria-label="Zav≈ô√≠t">√ó</button>` : ''}
                    </div>
                    <p class="text-secondary-color" style="margin-bottom: 24px;">${message}</p>
                    <div class="form-group">
                        <label for="new-password">Nov√© heslo*</label>
                        <input type="password" id="new-password" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Potvrƒète nov√© heslo*</label>
                        <input type="password" id="confirm-password" class="form-input">
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="saveNewPassword()">Ulo≈æit nov√© heslo</button>
                    </div>
                </div>`;
            showModal('change-password-modal', html);
        }

        function saveNewPassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!newPassword || !confirmPassword) {
                return showAlert('Chyba', 'Obƒõ pole pro heslo jsou povinn√°.', 'error');
            }
            if (newPassword !== confirmPassword) {
                return showAlert('Chyba', 'Zadan√° hesla se neshoduj√≠.', 'error');
            }
            if (newPassword.length < 4) {
                return showAlert('Chyba', 'Heslo mus√≠ m√≠t alespo≈à 4 znaky.', 'error');
            }
            
            // Naƒçteme cel√Ω stav, abychom mohli upravit pole u≈æivatel≈Ø
            const savedStateJSON = localStorage.getItem('sparePartsState_v13');
            if (!savedStateJSON) {
                return showAlert('Chyba', 'Nelze naƒç√≠st data pro ulo≈æen√≠ hesla.', 'error');
            }
            const fullState = JSON.parse(savedStateJSON);

            const userIndex = fullState.users.findIndex(u => u.id === state.currentUser.id);
            if (userIndex > -1) {
                fullState.users[userIndex].password = newPassword;
                fullState.users[userIndex].forcePasswordChange = false;
                
                // Aktualizujeme i aktu√°ln√≠ho u≈æivatele v pamƒõti
                state.currentUser.password = newPassword;
                state.currentUser.forcePasswordChange = false;

                logAuditEvent('Zmƒõna hesla', `U≈æivatel ${state.currentUser.name} si zmƒõnil heslo.`);
                
                // Ulo≈æ√≠me cel√Ω aktualizovan√Ω stav zpƒõt
                localStorage.setItem('sparePartsState_v13', JSON.stringify(fullState));
                
                hideModal('change-password-modal');
                showAlert('√öspƒõch', 'Va≈°e heslo bylo √∫spƒõ≈°nƒõ zmƒõnƒõno.', 'success');
            } else {
                showAlert('Chyba', 'Nepoda≈ôilo se naj√≠t u≈æivatele pro zmƒõnu hesla.', 'error');
            }
        }

        // --- Filtry a ≈ôazen√≠ ---
        function renderFilters() {
            const createOptions = (selectId, data, allKey) => {
                const select = document.getElementById(selectId);
                // Z√≠sk√°me lokalizovan√Ω popisek pro ‚Äûv≈°echny" polo≈æky; pokud nen√≠ v p≈ôekladech, pou≈æijeme allKey jako fallback
                let label;
                try {
                    label = (translations[currentLang] && translations[currentLang][allKey]) ? translations[currentLang][allKey] : allKey;
                } catch (_) {
                    label = allKey;
                }
                select.innerHTML = `<option value="all">${label}</option>`;
                for (const id in data) {
                    select.innerHTML += `<option value="${id}">${data[id]}</option>`;
                }
            };
            createOptions('warehouse-filter', state.warehouses, 'filter_all_warehouses');
            createOptions('category-filter', state.categories, 'filter_all_categories');
            createOptions('machine-filter', state.machines, 'filter_all_machines');
        }

        function getFilteredParts() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const warehouseFilter = document.getElementById('warehouse-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const machineFilter = document.getElementById('machine-filter') ? document.getElementById('machine-filter').value : 'all';

            return getAccessible(state.parts).filter(part => part.warehouse !== null).filter(part => {
                const searchIn = [part.name, part.code, part.description, part.inventoryNumber].join(' ').toLowerCase();
                if (searchTerm && !searchIn.includes(searchTerm)) return false;
                if (warehouseFilter !== 'all' && part.warehouse !== warehouseFilter) return false;
                if (categoryFilter !== 'all' && part.category !== categoryFilter) return false;
                if (machineFilter !== 'all' && part.machineId !== machineFilter) return false;
                return true;
            });
        }
        
        function requestSort(key) {
            if (state.sortConfig.key === key && state.sortConfig.direction === 'ascending') {
                state.sortConfig.direction = 'descending';
            } else {
                state.sortConfig.key = key;
                state.sortConfig.direction = 'ascending';
            }
            renderPartsTable();
        }

        // --- Vykreslov√°n√≠ tabulek ---
        function renderPartsTable() {
            const tbody = document.getElementById('parts-table-body');
            const thead = document.getElementById('parts-table-head');
            const noResultsMessage = document.getElementById('no-results-message');
            
            const headers = [
                { key: 'name', label: (translations[currentLang] && translations[currentLang].col_part) || 'D√≠l' },
                { key: 'code', label: (translations[currentLang] && translations[currentLang].col_sku_inv) || 'SKU / Inv.ƒç.' },
                { key: 'category', label: (translations[currentLang] && translations[currentLang].col_category) || 'Kategorie' },
                { key: 'machine', label: (translations[currentLang] && translations[currentLang].col_machine) || 'Za≈ô√≠zen√≠' },
                { key: 'warehouse', label: (translations[currentLang] && translations[currentLang].col_location) || 'Um√≠stƒõn√≠' },
                { key: 'currentStock', label: (translations[currentLang] && translations[currentLang].col_stock_status) || 'Stav skladu' },
                { key: 'price', label: (translations[currentLang] && translations[currentLang].col_value) || 'Hodnota' },
            ];
            thead.innerHTML = '<tr>' + headers.map(h => {
                const isSorted = state.sortConfig.key === h.key;
                const indicator = isSorted ? (state.sortConfig.direction === 'ascending' ? '‚ñ≤' : '‚ñº') : '‚Üï';
                return `<th onclick="requestSort('${h.key}')" class="${isSorted ? 'sorted' : ''}">${h.label} <span class="sort-indicator">${indicator}</span></th>`;
            }).join('') + '</tr>';

            const filteredParts = getFilteredParts();
            const { key, direction } = state.sortConfig;
            filteredParts.sort((a, b) => {
                let valA = a[key], valB = b[key];
                if (key === 'price') {
                    valA = getLatestPrice(a) * a.currentStock;
                    valB = getLatestPrice(b) * b.currentStock;
                }
                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                if (valA < valB) return direction === 'ascending' ? -1 : 1;
                if (valA > valB) return direction === 'ascending' ? 1 : -1;
                return 0;
            });

            noResultsMessage.classList.toggle('hidden', filteredParts.length > 0);
            
            tbody.innerHTML = filteredParts.map(part => {
                 const lowStockThreshold = getLowStockThreshold(part);
                 const stockStatusClass = part.currentStock === 0 ? 'out-of-stock' : (part.currentStock <= lowStockThreshold ? 'low-stock' : '');
                 let statusDotClass = 'status-dot-green';
                 if (part.currentStock === 0) statusDotClass = 'status-dot-red';
                 else if (part.currentStock <= lowStockThreshold) statusDotClass = 'status-dot-yellow';
                 const currentPrice = getLatestPrice(part);

                return `<tr class="${stockStatusClass}" style="cursor: pointer;" onclick="showPartDetailModal(${part.id})">
                    <td><span class="font-medium">${part.name}</span></td>
                    <td><div>${part.code || ''}</div><div class="text-gray-500">${part.inventoryNumber || ''}</div></td>
                    <td><span class="badge badge-gray">${state.categories[part.category] || ''}</span></td>
                    <td><span class=\"badge badge-blue\">${state.machines[part.machineId] || ''}</span></td>
                    <td><div>${state.warehouses[part.warehouse] || ''}</div><div class="text-gray-500">${part.umisteni || ''}</div></td>
                    <td><div class="inventory-status"><div class="status-dot ${statusDotClass}"></div><span>${part.currentStock} ks</span></div></td>
                    <td>${(currentPrice * part.currentStock) ? (currentPrice * part.currentStock).toLocaleString('cs-CZ') + ' Kƒç' : '-'}</td>
                </tr>`;
            }).join('');
        }

        function renderUsersTable() {
            const tbody = document.getElementById('users-table-body');
            const roleMap = { admin: 'Administr√°tor', vedouci_skladu: 'Vedouc√≠ skladu', technik: 'Technik' };
            const roleBadgeMap = { admin: 'badge-blue', vedouci_skladu: 'badge-purple', technik: 'badge-green' };
            tbody.innerHTML = state.users.map(user => {
                const warehouses = user.warehouses && user.warehouses.length > 0 ? user.warehouses.map(wh => state.warehouses[wh]).join(', ') : 'V≈°echny';
                return `<tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="badge ${roleBadgeMap[user.role]}">${roleMap[user.role]}</span></td>
                    <td>${warehouses}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="showEditUserModal(${user.id})">‚úèÔ∏è</button>
                        ${state.currentUser.id !== user.id ? `<button class="btn btn-danger" onclick="deleteUser(${user.id})">üóëÔ∏è</button>` : ''}
                    </td>
                </tr>`;
            }).join('');
        }
        
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            document.getElementById('no-orders-message').classList.toggle('hidden', state.orders.length > 0);
            tbody.innerHTML = state.orders.map(order => {
                const statusBadgeMap = { 'ƒåek√° na dod√°n√≠': 'badge-yellow', 'Dokonƒçeno': 'badge-green', 'Zru≈°eno': 'badge-red' };
                const supplier = state.suppliers.find(s => s.id === order.supplierId);
                return `
                <tr>
                    <td>${order.orderNumber}</td>
                    <td>${supplier ? supplier.name : 'Nezn√°m√Ω'}</td>
                    <td>${order.items.length}</td>
                    <td>${order.totalPrice.toLocaleString('cs-CZ')} Kƒç</td>
                    <td><span class="badge ${statusBadgeMap[order.status] || 'badge-gray'}">${order.status}</span></td>
                    <td>${new Date(order.dateCreated).toLocaleDateString('cs-CZ')}</td>
                    <td class="action-buttons">
                        ${order.status === 'ƒåek√° na dod√°n√≠' ? `<button class="btn btn-success" onclick="receiveOrder(${order.id})">‚úÖ P≈ôijmout</button>` : ''}
                        <button class="btn btn-secondary" onclick="viewOrderFromTransaction('${order.orderNumber}')">üëÅÔ∏è</button>
                        <button class="btn btn-danger" onclick="deleteOrder(${order.id})">üóëÔ∏è</button>
                    </td>
                </tr>`
            }).join('');
        }

        function renderTransfersTable() {
            const tbody = document.getElementById('transfers-table-body');
            document.getElementById('no-transfers-message').classList.toggle('hidden', state.transfers.length > 0);
            tbody.innerHTML = state.transfers.map(t => {
                const canConfirm = hasAccess(t.toWarehouse) && t.status === 'V procesu';
                return `<tr>
                    <td>${t.transferNumber}</td>
                    <td>${t.partName}</td>
                    <td>${state.warehouses[t.fromWarehouse]}</td>
                    <td>${state.warehouses[t.toWarehouse]}</td>
                    <td>${t.quantity}</td>
                    <td><span class="badge ${t.status === 'Dokonƒçeno' ? 'badge-green' : 'badge-yellow'}">${t.status}</span></td>
                    <td>${new Date(t.date).toLocaleDateString('cs-CZ')}</td>
                    <td>
                        ${canConfirm ? `<button class="btn btn-success" onclick="approveTransfer(${t.id})">Potvrdit p≈ô√≠jem</button>` : ''}
                        <button class="btn btn-secondary" onclick="viewTransferFromTransaction('${t.transferNumber}')">üëÅÔ∏è</button>
                    </td>
                </tr>`
            }).join('');
        }

        function renderTransactionsTable() {
            const tbody = document.getElementById('transactions-table-body');
            const noResultsMessage = document.getElementById('no-transactions-message');
            const fromDate = document.getElementById('transaction-date-from').value;
            const toDate = document.getElementById('transaction-date-to').value;

            let filteredTransactions = [...state.transactions];

            if (fromDate) {
                filteredTransactions = filteredTransactions.filter(t => new Date(t.date) >= new Date(fromDate));
            }
            if (toDate) {
                const toDateObj = new Date(toDate);
                toDateObj.setHours(23, 59, 59, 999);
                filteredTransactions = filteredTransactions.filter(t => new Date(t.date) <= toDateObj);
            }

            noResultsMessage.classList.toggle('hidden', filteredTransactions.length > 0);
            const typeMap = { prijem: 'P≈ô√≠jem', vydej: 'V√Ωdej', presun_odeslani: 'P≈ôesun (odesl√°n√≠)', presun_prijem: 'P≈ôesun (p≈ô√≠jem)', uprava: '√öprava', korekce: 'Korekce' };
            const typeColor = { prijem: 'stat-green', vydej: 'stat-orange', presun_odeslani: 'stat-orange', presun_prijem: 'stat-green', uprava: 'stat-blue', korekce: 'stat-purple' };
            
            tbody.innerHTML = filteredTransactions.reverse().map(t => `
                <tr>
                    <td>${new Date(t.date).toLocaleString('cs-CZ')}</td>
                    <td class="${typeColor[t.type]}">${typeMap[t.type]}</td>
                    <td>${t.partName}</td>
                    <td>${t.quantity}</td>
                    <td>${t.notes || ''}</td>
                    <td>${t.userName}</td>
                </tr>
            `).join('');
        }

        function renderSuppliersTable() {
            const tbody = document.getElementById('suppliers-table-body');
            const noResultsMessage = document.getElementById('no-suppliers-message');
            noResultsMessage.classList.toggle('hidden', state.suppliers.length > 0);

            tbody.innerHTML = state.suppliers.map(supplier => `
                <tr>
                    <td>${supplier.name}</td>
                    <td>${supplier.ico || '-'}</td>
                    <td>${supplier.contactPerson || '-'}</td>
                    <td>${supplier.email || '-'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-secondary" onclick="showSupplierModal(${supplier.id})">‚úèÔ∏è Upravit</button>
                        <button class="btn btn-danger" onclick="deleteSupplier(${supplier.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderInventoryList() {
            const tbody = document.getElementById('inventory-list-body');
            const noResultsMessage = document.getElementById('no-inventory-message');
            noResultsMessage.classList.toggle('hidden', state.inventorySessions.length > 0);
            
            tbody.innerHTML = [...state.inventorySessions].reverse().map(session => {
                const statusBadge = session.status === 'Dokonƒçeno' ? 'badge-green' : 'badge-yellow';
                return `
                    <tr>
                        <td>${state.warehouses[session.warehouseId]}</td>
                        <td>${new Date(session.startDate).toLocaleDateString('cs-CZ')}</td>
                        <td><span class="badge ${statusBadge}">${session.status}</span></td>
                        <td>${session.userName}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="continueInventory(${session.id})">${session.status === 'Dokonƒçeno' ? 'Zobrazit' : 'Pokraƒçovat'}</button>
                        </td>
                    </tr>
                `
            }).join('');
        }

        // --- Mod√°ln√≠ okna a CRUD operace ---
        function showModal(modalId, innerHTML) {
            lastFocusedElement = document.activeElement; 

            const modal = document.getElementById(modalId);
            modal.innerHTML = innerHTML;
            modal.classList.remove('hidden');

            const modalContent = modal.querySelector('.modal');
            const modalTitle = modal.querySelector('.modal-title');
            
            if (modalContent && modalTitle) {
                const titleId = 'modal-title-' + modalId;
                modalTitle.id = titleId;
                modalContent.setAttribute('role', 'dialog');
                modalContent.setAttribute('aria-modal', 'true');
                modalContent.setAttribute('aria-labelledby', titleId);
            }
            
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstFocusableElement = focusableElements[0];
            const lastFocusableElement = focusableElements[focusableElements.length - 1];

            if (firstFocusableElement) {
                firstFocusableElement.focus();
            }

            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const closeButton = modal.querySelector('.modal-close');
                    if (closeButton) {
                        closeButton.click();
                    }
                }
                const isTabPressed = e.key === 'Tab' || e.keyCode === 9;
                if (!isTabPressed) return;

                if (e.shiftKey) { 
                    if (document.activeElement === firstFocusableElement) {
                        lastFocusableElement.focus();
                        e.preventDefault();
                    }
                } else { 
                    if (document.activeElement === lastFocusableElement) {
                        firstFocusableElement.focus();
                        e.preventDefault();
                    }
                }
            });
        }

        function hideModal(modalId) {
            const chartCanvas = document.querySelector(`#${modalId} #price-history-chart`);
            if (chartCanvas && charts.priceHistory) {
                charts.priceHistory.destroy();
            }
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                modal.innerHTML = ''; 
            }
            
            if (lastFocusedElement) {
                lastFocusedElement.focus(); 
            }
        }

        /**
         * Hide and clear all currently visible modals. This ensures that when a new
         * modal is opened (e.g. editing a part or stocking from a machine detail),
         * it is not obscured by any previously opened modals. Without clearing
         * other modals, their overlay remains in the DOM and may appear above
         * newly opened modals due to stacking context. This helper safely hides
         * every `.modal-overlay` that is not hidden and empties its HTML.
         */
        function hideAllModals() {
            const openModals = document.querySelectorAll('.modal-overlay:not(.hidden)');
            openModals.forEach(modalEl => {
                modalEl.classList.add('hidden');
                modalEl.innerHTML = '';
            });
        }

        // Expose hideAllModals globally so it can be called from inline events if needed.
        window.hideAllModals = hideAllModals;
        
        function showPartModal(id = null) {
            // Before rendering, ensure all other modals are hidden. This prevents
            // the edit/new modal from being obscured by a previously open modal (e.g. part detail).
            try { hideAllModals(); } catch(e) {}
            const part = id ? state.parts.find(p => p.id === id) : null;
            const isMasterPart = part ? part.warehouse === null : true;
            state.currentEditingId = id;
            const currentPrice = part ? getLatestPrice(part) : 0;

            let title = 'Upravit d√≠l';
            if (!id) title = 'Zav√©st nov√Ω typ d√≠lu';
            else if (isMasterPart) title = 'Upravit master d√≠l';

            const createSelect = (data, selected, placeholder = null) => {
                let options = placeholder ? `<option value="">${placeholder}</option>` : '';
                options += Object.entries(data).map(([key, val]) => `<option value="${key}" ${ (key === selected) ? 'selected' : ''}>${val}</option>`).join('');
                return options;
            };

            const supplierOptions = '<option value="">Bez dodavatele</option>' + state.suppliers.map(s => `<option value="${s.id}" ${part && s.id === part.supplierId ? 'selected' : ''}>${s.name}</option>`).join('');

            const html = `
                <div class="modal">
                    <div class="modal-header"><h2 class="modal-title">${title}</h2><button class="modal-close" onclick="hideModal('part-modal')" aria-label="Zav≈ô√≠t">√ó</button></div>
                    <div class="form-group"><label>N√°zev d√≠lu*</label><input type="text" id="part-name" class="form-input" value="${part ? part.name : ''}"></div>
                    <div class="form-row">
                        <div class="form-group"><label>SKU</label><input type="text" id="part-code" class="form-input" value="${part ? part.code : '(bude vygenerov√°no)'}" disabled></div>
                        <div class="form-group"><label>ƒå√≠slo v√Ωrobce</label><input type="text" id="part-manufacturerNumber" class="form-input" value="${part ? part.manufacturerNumber : ''}"></div>
                    </div>
                    <div class="form-group"><label>Popis d√≠lu</label><textarea id="part-description" class="form-textarea">${part ? part.description : ''}</textarea></div>
                    <div class="form-row">
                        <div class="form-group"><label>Kategorie</label><select id="part-category" class="form-select">${createSelect(state.categories, part ? part.category : null)}</select></div>
                        <div class="form-group"><label>Dodavatel</label><select id="part-supplierId" class="form-select">${supplierOptions}</select></div>
                    </div>
                    <div class=\"form-row\">
                        <div class=\"form-group\"><label>Za≈ô√≠zen√≠ / Stroj</label><select id=\"part-machineId\" class=\"form-select\">${createSelect(state.machines, part ? part.machineId : null, 'Vyberte za≈ô√≠zen√≠/stroj')}</select></div>
                        <div class=\"form-group\"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Priorita</label><select id="part-priority" class="form-select">${createSelect(state.priorities, part ? part.priority : null, 'Vyberte prioritu')}</select></div>
                        <div class="form-group"><label>Cena/ks (Kƒç)</label><input type="number" id="part-price" class="form-input" value="${currentPrice}" min="0" step="0.01"></div>
                    </div>
                    ${isMasterPart ? `
                    <div class="form-row">
                        <div class="form-group"><label>Minim√°ln√≠ z√°soba*</label><input type="number" id="part-minStock" class="form-input" value="${part ? part.minStock : 1}" min="0" step="1"></div>
                        <div class="form-group"><label>Optim√°ln√≠ z√°soba</label><input type="number" id="part-optimalStock" class="form-input" value="${(part && part.optimalStock !== undefined) ? part.optimalStock : ''}" min="0" step="1"></div>
                    </div>` : `
                    <div class="form-row">
                         <div class="form-group"><label>Sklad</label><select id="part-warehouse" class="form-select" disabled>${createSelect(state.warehouses, part ? part.warehouse : null)}</select></div>
                         <div class="form-group"><label>Um√≠stƒõn√≠</label><input type="text" id="part-umisteni" class="form-input" value="${part ? part.umisteni : ''}" placeholder="nap≈ô. A1 / 15-C"></div>
                    </div>`}
                    <div class="modal-actions"><button class="btn btn-primary" onclick="savePart()">Ulo≈æit</button></div>
                </div>`;
            showModal('part-modal', html);
        }

        function savePart() {
            const id = state.currentEditingId;
            const newPrice = parseFloat(document.getElementById('part-price').value) || 0;
            const partData = {
                name: document.getElementById('part-name').value.trim(),
                description: document.getElementById('part-description').value.trim(),
                category: document.getElementById('part-category').value,
                supplierId: parseInt(document.getElementById('part-supplierId').value) || null,
                priority: document.getElementById('part-priority').value,
                manufacturerNumber: document.getElementById('part-manufacturerNumber').value.trim(),
                machineId: (document.getElementById('part-machineId') && document.getElementById('part-machineId').value) || null,
            };

            if (!partData.name) {
                return showAlert('Chyba', 'N√°zev d√≠lu je povinn√© pole.', 'error');
            }

            if (id) {
                const index = state.parts.findIndex(p => p.id === id);
                const oldPart = { ...state.parts[index] };
                const part = state.parts[index];
                const currentPrice = getLatestPrice(part);
                if (newPrice !== currentPrice) {
                    part.priceHistory.push({ date: new Date().toISOString(), price: newPrice });
                }
                const isMasterPart = part.warehouse === null;
                if (isMasterPart) {
                    // master d√≠l: v≈ædy aktualizujeme minim√°ln√≠ a optim√°ln√≠ z√°sobu
                    partData.minStock = parseInt(document.getElementById('part-minStock').value) || 0;
                    // naƒçti zadanou optim√°ln√≠ z√°sobu (p≈ô√≠padnƒõ ponech st√°vaj√≠c√≠ nebo minim√°ln√≠)
                    const optInput = document.getElementById('part-optimalStock');
                    if (optInput) {
                        const parsedOpt = parseInt(optInput.value);
                        partData.optimalStock = isNaN(parsedOpt) ? (part.optimalStock || partData.minStock) : parsedOpt;
                    } else {
                        partData.optimalStock = part.optimalStock || partData.minStock;
                    }
                    // nastav maxStock podle optim√°ln√≠ nebo minim√°ln√≠ z√°soby (pro kompatibilitu s existuj√≠c√≠ logikou)
                    partData.maxStock = partData.optimalStock || (partData.minStock * 2);
                } else {
                    partData.umisteni = document.getElementById('part-umisteni').value.trim();
                }
                state.parts[index] = { ...part, ...partData };
                logAuditEvent('√öprava d√≠lu', `Upraven d√≠l: ${partData.name} (ID: ${id}).`);
            } else {
                if (!userCan('canAddMasterPart')) {
                    return showAlert('Chyba', 'Pro tuto akci nem√°te opr√°vnƒõn√≠.', 'error');
                }
                const existingPartByName = state.parts.find(p => p.name.toLowerCase() === partData.name.toLowerCase() && p.warehouse === null);
                if (existingPartByName) {
                    return showAlert('Chyba', 'Master d√≠l s t√≠mto n√°zvem ji≈æ existuje.', 'error');
                }
                const vpParts = state.parts.filter(p => p.code && p.code.startsWith('VP-'));
                const maxVpNum = Math.max(0, ...vpParts.map(p => parseInt(p.code.split('-')[1] || 0)));
                partData.code = `VP-${String(maxVpNum + 1).padStart(4, '0')}`;
                
                const newId = (Math.max(0, ...state.parts.map(p => p.id)) + 1);
                // sestav nov√Ω master d√≠l (bez skladov√© pozice)
                // naƒçti minim√°ln√≠ a optim√°ln√≠ z√°sobu
                const minVal = parseInt(document.getElementById('part-minStock').value) || 0;
                const optInput = document.getElementById('part-optimalStock');
                const optVal = optInput ? parseInt(optInput.value) : NaN;
                const optimalVal = isNaN(optVal) ? minVal : optVal;
                const newPart = { 
                    id: newId, 
                    ...partData,
                    priceHistory: [{ date: new Date().toISOString(), price: newPrice }],
                    // ulo≈æ minim√°ln√≠ a optim√°ln√≠ z√°sobu
                    minStock: minVal,
                    optimalStock: optimalVal,
                    // maxStock pro kompatibilitu vyu≈æ√≠v√° optim√°ln√≠ hodnotu nebo dvojn√°sobek minima
                    maxStock: optimalVal || (minVal * 2),
                    warehouse: null, 
                    inventoryNumber: null,
                    umisteni: null,
                    currentStock: 0,
                    imageData: null, 
                    docName: null,
                };
                state.parts.push(newPart);
                logAuditEvent('Zaveden√≠ d√≠lu', `Zaveden nov√Ω master d√≠l: ${partData.name}.`);
                showAlert('√öspƒõch', 'Nov√Ω typ d√≠lu byl zaveden. Nyn√≠ jej m≈Ø≈æete naskladnit.', 'success');
            }
            
            saveStateToLocalStorage();
            renderAll();
            hideModal('part-modal');
        }

        function showAssignPartModal() {
            // P≈ôed naƒçten√≠m formul√°≈ôe skryj v≈°echny otev≈ôen√© mod√°ly, vƒçetnƒõ detailu stroje nebo d√≠lu.
            // V opaƒçn√©m p≈ô√≠padƒõ by novƒõ otev≈ôen√Ω formul√°≈ô mohl z≈Østat pod star√Ωmi mod√°ly.
            try { hideAllModals(); } catch(e) {}
            const masterParts = state.parts.filter(p => p.warehouse === null);
            if (masterParts.length === 0) {
                return showAlert('Info', 'Neexistuj√≠ ≈æ√°dn√© master d√≠ly k naskladnƒõn√≠. Nejprve mus√≠te nƒõjak√Ω zav√©st do syst√©mu.');
            }
            const createSelect = (data, placeholder) => `<option value="">${placeholder}</option>` + Object.entries(data).map(([key, val]) => `<option value="${key}">${val}</option>`).join('');
            const masterPartOptions = '<option value="">Vyberte typ d√≠lu...</option>' + masterParts.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');

            const html = `
            <div class="modal">
                <div class="modal-header"><h2 class="modal-title">Naskladnit d√≠l</h2><button class="modal-close" onclick="hideModal('assign-part-modal')" aria-label="Zav≈ô√≠t">√ó</button></div>
                <div class="form-group"><label>Typ d√≠lu*</label><select id="assign-master-part" class="form-select">${masterPartOptions}</select></div>
                <div class="form-row">
                    <div class="form-group"><label>Sklad*</label><select id="assign-warehouse" class="form-select">${createSelect(state.warehouses, 'Vyberte sklad...')}</select></div>
                    <div class="form-group"><label>Poƒçet kus≈Ø*</label><input type="number" id="assign-quantity" class="form-input" min="1" value="1" step="1"></div>
                </div>
                <div class="form-group"><label>Um√≠stƒõn√≠ ve skladu</label><input type="text" id="assign-location" class="form-input" placeholder="nap≈ô. Reg√°l A1, pozice 5C"></div>
                <div class="modal-actions"><button class="btn btn-primary" onclick="saveAssignPart()">Naskladnit</button></div>
            </div>`;
            showModal('assign-part-modal', html);
        }

        function saveAssignPart() {
            const masterPartId = parseInt(document.getElementById('assign-master-part').value);
            const warehouse = document.getElementById('assign-warehouse').value;
            const quantity = parseInt(document.getElementById('assign-quantity').value);
            const location = document.getElementById('assign-location').value.trim();

            if (!masterPartId || !warehouse || !quantity || quantity <= 0) {
                return showAlert('Chyba', 'V≈°echna pole s * jsou povinn√°.', 'error');
            }

            const masterPart = state.parts.find(p => p.id === masterPartId);
            if (!masterPart) return showAlert('Chyba', 'Master d√≠l nebyl nalezen.', 'error');
            
            const existingStockedPart = state.parts.find(p => p.code === masterPart.code && p.warehouse === warehouse);
            if (existingStockedPart) {
                return showAlert('Chyba', 'Tento typ d√≠lu ji≈æ na vybran√©m skladu existuje. Pro nav√Ω≈°en√≠ poƒçtu kus≈Ø pou≈æijte akci v detailu d√≠lu.', 'error');
            }
            
            const warehousePrefix = warehouse.toUpperCase();
            const warehouseParts = state.parts.filter(p => p.warehouse === warehouse && p.inventoryNumber);
            const maxInvNum = Math.max(0, ...warehouseParts.map(p => {
                const num = p.inventoryNumber.split('-')[1];
                return num ? parseInt(num) : 0;
            }));
            const inventoryNumber = `${warehousePrefix}-${String(maxInvNum + 1).padStart(4, '0')}`;

            const newId = (Math.max(0, ...state.parts.map(p => p.id)) + 1);
            const newStockedPart = {
                ...masterPart,
                id: newId,
                warehouse: warehouse,
                currentStock: quantity,
                umisteni: location,
                inventoryNumber: inventoryNumber
            };
            
            state.parts.push(newStockedPart);
            createTransaction('prijem', newStockedPart, quantity, 'Prvotn√≠ naskladnƒõn√≠ nov√©ho typu d√≠lu');
            logAuditEvent('Naskladnƒõn√≠ d√≠lu', `Naskladnƒõno ${quantity} ks d√≠lu ${masterPart.name} do skladu ${state.warehouses[warehouse]}.`);

            saveStateToLocalStorage();
            renderAll();
            hideModal('assign-part-modal');
        }

        function showReceiveModal(id) {
            const part = state.parts.find(p => p.id === id);
            if (!part) return;
            state.currentEditingId = id;
            const currentPrice = getLatestPrice(part);
            const html = `
            <div class="modal">
                <div class="modal-header"><h2 class="modal-title">P≈ô√≠jem d√≠lu: ${part.name}</h2><button class="modal-close" onclick="hideModal('receive-modal')" aria-label="Zav≈ô√≠t">√ó</button></div>
                <p>Aktu√°lnƒõ skladem: ${part.currentStock} ks</p>
                <div class="form-group"><label>Poƒçet k naskladnƒõn√≠*</label><input type="number" id="receive-quantity" class="form-input" value="1" min="1" step="1"></div>
                <div class="form-group"><label>Nov√° cena/ks (aktu√°ln√≠: ${currentPrice} Kƒç)</label><input type="number" id="receive-price" class="form-input" placeholder="${currentPrice}" step="0.01"></div>
                <div class="form-group"><label>Pozn√°mka</label><input type="text" id="receive-notes" class="form-input" placeholder="nap≈ô. z objedn√°vky OBJ-12345"></div>
                <div class="modal-actions"><button class="btn btn-success" onclick="saveReceive()">Naskladnit</button></div>
            </div>`;
            showModal('receive-modal', html);
        }

        function saveReceive() {
            const id = state.currentEditingId;
            const quantity = parseInt(document.getElementById('receive-quantity').value);
            const newPriceInput = document.getElementById('receive-price');
            const newPrice = newPriceInput.value ? parseFloat(newPriceInput.value) : null;
            const notes = document.getElementById('receive-notes').value.trim();

            if (isNaN(quantity) || quantity <= 0) {
                return showAlert('Chyba', 'Zadejte platn√© mno≈æstv√≠.', 'error');
            }

            const index = state.parts.findIndex(p => p.id === id);
            if (index === -1) return;
            const part = state.parts[index];

            part.currentStock += quantity;
            if (newPrice !== null && !isNaN(newPrice) && newPrice !== getLatestPrice(part)) {
                part.priceHistory.push({ date: new Date().toISOString(), price: newPrice });
            }

            createTransaction('prijem', part, quantity, notes || 'Naskladnƒõn√≠');
            logAuditEvent('P≈ô√≠jem na sklad', `P≈ôijato ${quantity} ks d√≠lu ${part.name}. Pozn√°mka: ${notes}`);
            saveStateToLocalStorage();
            renderAll();
            hideModal('receive-modal');
            showPartDetailModal(id);
        }

        function showDispenseModal(id) {
            const part = state.parts.find(p => p.id === id);
            if (!part) return;
            state.currentEditingId = id;

            const reasonOptions = Object.entries(state.dispenseReasons).map(([key, value]) => 
                `<option value="${key}">${value}</option>`
            ).join('');

            const html = `
            <div class="modal">
                <div class="modal-header"><h2 class="modal-title">V√Ωdej d√≠lu: ${part.name}</h2><button class="modal-close" onclick="hideModal('dispense-modal')" aria-label="Zav≈ô√≠t">√ó</button></div>
                <p>Aktu√°lnƒõ skladem: ${part.currentStock} ks</p>
                <div class="form-group"><label>Poƒçet k vyd√°n√≠*</label><input type="number" id="dispense-quantity" class="form-input" value="1" min="1" max="${part.currentStock}" step="1"></div>
                <div class="form-group">
                    <label for="dispense-reason-select">D≈Øvod v√Ωdeje*</label>
                    <select id="dispense-reason-select" class="form-select" onchange="toggleCustomReason(this.value)">
                        ${reasonOptions}
                    </select>
                </div>
                <div class="form-group hidden" id="custom-reason-group">
                    <label for="dispense-reason-custom">Specifikujte d≈Øvod*</label>
                    <input type="text" id="dispense-reason-custom" class="form-input">
                </div>
                <div class="modal-actions"><button class="btn btn-warning" onclick="saveDispense()">Vydat ze skladu</button></div>
            </div>`;
            showModal('dispense-modal', html);
        }

        function toggleCustomReason(selectedValue) {
            document.getElementById('custom-reason-group').classList.toggle('hidden', selectedValue !== 'jine');
        }

        function saveDispense() {
            const id = state.currentEditingId;
            const quantity = parseInt(document.getElementById('dispense-quantity').value);
            const reasonSelect = document.getElementById('dispense-reason-select');
            let reason = reasonSelect.options[reasonSelect.selectedIndex].text;
            
            if (reasonSelect.value === 'jine') {
                const customReason = document.getElementById('dispense-reason-custom').value.trim();
                if (!customReason) {
                    return showAlert('Chyba', 'Pokud zvol√≠te "Jin√©", mus√≠te specifikovat d≈Øvod.', 'error');
                }
                reason = customReason;
            }

            const index = state.parts.findIndex(p => p.id === id);
            if (index === -1) return;
            const part = state.parts[index];

            if (isNaN(quantity) || quantity <= 0) return showAlert('Chyba', 'Zadejte platn√© mno≈æstv√≠.', 'error');
            if (!reason) return showAlert('Chyba', 'D≈Øvod v√Ωdeje je povinn√Ω.', 'error');
            if (quantity > part.currentStock) return showAlert('Chyba', `Nelze vydat v√≠ce kus≈Ø, ne≈æ je na skladƒõ (${part.currentStock} ks).`, 'error');

            part.currentStock -= quantity;
            createTransaction('vydej', part, quantity, reason);
            logAuditEvent('V√Ωdej ze skladu', `Vyd√°no ${quantity} ks d√≠lu ${part.name}. D≈Øvod: ${reason}`);
            saveStateToLocalStorage();
            renderAll();
            hideModal('dispense-modal');
            showPartDetailModal(id);
        }

        function deletePart(id) {
            showAlert('Potvrzen√≠', 'Opravdu chcete smazat tento d√≠l? T√≠mto sma≈æete jeho z√°znam ze skladu. Pro smaz√°n√≠ master d√≠lu jej mus√≠te upravit.', 'confirm', () => {
                const partToDelete = state.parts.find(p => p.id === id);
                logAuditEvent('Smaz√°n√≠ d√≠lu', `Smaz√°n d√≠l: ${partToDelete.name} (Inv. ƒç.: ${partToDelete.inventoryNumber}).`);
                state.parts = state.parts.filter(p => p.id !== id);
                saveStateToLocalStorage();
                hideModal('part-detail-modal');
                renderAll();
            });
        }

        function showPartDetailModal(id) {
            const part = state.parts.find(p => p.id === id);
            if (!part) return;

            const partTransactions = [...state.transactions].reverse().filter(t => t.partId === id);
            const priorityBadgeMap = { a: 'badge-red', b: 'badge-orange', c: 'badge-yellow', d: 'badge-green' };
            const supplier = state.suppliers.find(s => s.id === part.supplierId);
            const currentPrice = getLatestPrice(part);
            const isPinned = state.currentUser.dashboard.pinnedParts.includes(part.id);
            
            const html = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">${part.name}</h2>
                        <button class="modal-close" onclick="hideModal('part-detail-modal')" aria-label="Zav≈ô√≠t">√ó</button>
                    </div>
                    <div class="modal-content-wrapper">
                        <div class="part-detail-media">
                            <div class="part-detail-image-container">
                                ${part.imageData ? `<img src="${part.imageData}" alt="Fotka d√≠lu" class="part-detail-image">` : `<div class="part-detail-image-placeholder">üì∑</div>`}
                            </div>
                            <div id="part-qr-code"></div>
                            <div class="form-group">
                                <label for="image-upload-${part.id}" class="file-upload-label">üñºÔ∏è Zmƒõnit fotku</label>
                                <input type="file" id="image-upload-${part.id}" class="hidden" accept="image/*" onchange="handleImageUpload(event, ${part.id})">
                            </div>
                            <div class="form-group">
                                <label>Dokumentace</label>
                                ${part.docName ? `
                                    <div class="doc-info">
                                        <span>üìÑ ${part.docName}</span>
                                        <button class="btn btn-danger" style="padding: 2px 8px;" onclick="deletePartDoc(${part.id})">üóëÔ∏è</button>
                                    </div>
                                ` : `
                                    <label for="doc-upload-${part.id}" class="file-upload-label">‚ûï Nahr√°t dokument</label>
                                    <input type="file" id="doc-upload-${part.id}" class="hidden" accept=".pdf,.doc,.docx,.txt" onchange="handleDocUpload(event, ${part.id})">
                                `}
                            </div>
                        </div>
                        <div>
                            <div class="part-detail-grid">
                                <div class="detail-item"><h4>SKU</h4><p>${part.code || '-'}</p></div>
                                <div class="detail-item"><h4>Invent√°rn√≠ ƒç√≠slo</h4><p>${part.inventoryNumber || '-'}</p></div>
                                <div class="detail-item"><h4>Sklad</h4><p>${state.warehouses[part.warehouse]}</p></div>
                                <div class="detail-item"><h4>Um√≠stƒõn√≠</h4><p>${part.umisteni || '-'}</p></div>
                                <div class="detail-item"><h4>Aktu√°ln√≠ poƒçet</h4><p>${part.currentStock} ks</p></div>
                                <div class="detail-item"><h4>Min. poƒçet</h4><p>${part.minStock} ks</p></div>
                                <div class="detail-item"><h4>Opt. poƒçet</h4><p>${(part.optimalStock !== undefined && part.optimalStock !== null) ? part.optimalStock : '-'} ks</p></div>
                                <div class="detail-item"><h4>Priorita</h4><p><span class="badge ${priorityBadgeMap[part.priority] || 'badge-gray'}">${state.priorities[part.priority] || '-'}</span></p></div>
                                <div class="detail-item"><h4>Cena/ks</h4><p>${currentPrice.toLocaleString('cs-CZ')} Kƒç</p></div>
                                <div class="detail-item"><h4>Dodavatel</h4><p>${supplier ? supplier.name : 'Nen√≠'}</p></div>
                            </div>
                             <div class="history-section">
                                <h3>Historie ceny</h3>
                                <canvas id="price-history-chart"></canvas>
                            </div>
                            <div class="history-section">
                                <h3>Historie transakc√≠</h3>
                                <div class="history-list">
                                    ${partTransactions.length > 0 ? partTransactions.map(t => `<div class="history-item">
                                        <span class="date">${new Date(t.date).toLocaleString('cs-CZ')}</span> - ${t.userName} - 
                                        <span class="${t.type.includes('prijem') ? 'type-add' : 'type-remove'}">${t.type} (${t.quantity}ks)</span>
                                        <div class="text-gray-500">${t.notes}</div>
                                    </div>`).join('') : '<p>≈Ω√°dn√° historie.</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="togglePinPart(${part.id})">${isPinned ? 'üìå Odepnout z dashboardu' : 'üìå P≈ôipnout na dashboard'}</button>
                        ${userCan('canEditParts') ? `
                        <button class="btn btn-success" onclick="showReceiveModal(${part.id})">üì• P≈ô√≠jem</button>
                        <button class="btn btn-warning" onclick="showDispenseModal(${part.id})">üì§ V√Ωdej</button>
                        <button class="btn btn-secondary" onclick=\"editPartFromDetail(${part.id})\">‚úèÔ∏è Upravit</button>` : ''}
                        ${userCan('canDeleteParts') ? `<button class="btn btn-danger" onclick="deletePart(${part.id})">üóëÔ∏è Smazat</button>` : ''}
                    </div>
                </div>`;
            showModal('part-detail-modal', html);
            displayQRCode('part-qr-code', `PART_INV:${part.inventoryNumber}`);
            renderPriceHistoryChart(part);
        }

        function displayQRCode(elementId, text) {
            try {
                const typeNumber = 4;
                const errorCorrectionLevel = 'L';
                const qr = qrcode(typeNumber, errorCorrectionLevel);
                qr.addData(text);
                qr.make();
                document.getElementById(elementId).innerHTML = qr.createImgTag(4);
            } catch (e) {
                console.error("Chyba p≈ôi generov√°n√≠ QR k√≥du:", e);
                document.getElementById(elementId).innerHTML = "QR k√≥d nelze zobrazit.";
            }
        }

        function handleImageUpload(event, partId) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const partIndex = state.parts.findIndex(p => p.id === partId);
                if (partIndex > -1) {
                    state.parts[partIndex].imageData = e.target.result;
                    logAuditEvent('Zmƒõna obr√°zku', `Zmƒõnƒõn obr√°zek pro d√≠l ${state.parts[partIndex].name}.`);
                    saveStateToLocalStorage();
                    showPartDetailModal(partId);
                }
            };
            reader.readAsDataURL(file);
        }

        function handleDocUpload(event, partId) {
            const file = event.target.files[0];
            if (!file) return;
            const partIndex = state.parts.findIndex(p => p.id === partId);
            if (partIndex > -1) {
                state.parts[partIndex].docName = file.name;
                logAuditEvent('Nahr√°n√≠ dokumentu', `Nahr√°n dokument ${file.name} pro d√≠l ${state.parts[partIndex].name}.`);
                saveStateToLocalStorage();
                showPartDetailModal(partId);
            }
        }

        function deletePartDoc(partId) {
            const partIndex = state.parts.findIndex(p => p.id === partId);
            if (partIndex > -1) {
                logAuditEvent('Smaz√°n√≠ dokumentu', `Smaz√°n dokument ${state.parts[partIndex].docName} pro d√≠l ${state.parts[partIndex].name}.`);
                state.parts[partIndex].docName = null;
                saveStateToLocalStorage();
                showPartDetailModal(partId);
            }
        }

        function showAddUserModal() { showUserModal(); }
        function showEditUserModal(id) { showUserModal(id); }
        function showUserModal(id = null) {
            const user = id ? state.users.find(u => u.id === id) : null;
            state.currentEditingId = id;
            const title = id ? 'Upravit u≈æivatele' : 'P≈ôidat nov√©ho u≈æivatele';
            const roles = { admin: 'Administr√°tor', vedouci_skladu: 'Vedouc√≠ skladu', technik: 'Technik' };
            
            const permissions = user ? user.permissions : permissionPresets.technik;

            const html = `
                <div class="modal">
                    <div class="modal-header"><h2 class="modal-title">${title}</h2><button class="modal-close" onclick="hideModal('user-modal')" aria-label="Zav≈ô√≠t">√ó</button></div>
                    <div class="form-row">
                        <div class="form-group"><label>Jm√©no*</label><input type="text" id="user-name" class="form-input" value="${user ? user.name : ''}"></div>
                        <div class="form-group"><label>Email*</label><input type="email" id="user-email" class="form-input" value="${user ? user.email : ''}"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Heslo*</label><input type="password" id="user-password" class="form-input" ${id ? 'placeholder="Zadejte pro zmƒõnu"' : ''}></div>
                        <div class="form-group"><label>Role</label><select id="user-role" class="form-select" onchange="updatePermissionsForRole(this.value)">${Object.entries(roles).map(([key, val]) => `<option value="${key}" ${user && key === user.role ? 'selected' : ''}>${val}</option>`).join('')}</select></div>
                    </div>
                    <hr style="margin: 20px 0; border-color: var(--border-color);">
                    <div class="form-group">
                        <label>Detailn√≠ opr√°vnƒõn√≠</label>
                        <div class="permissions-grid" id="permissions-container">
                            <label><input type="checkbox" data-permission="canAddMasterPart" ${permissions.canAddMasterPart ? 'checked' : ''}> M≈Ø≈æe zakl√°dat nov√© typy d√≠l≈Ø</label>
                            <label><input type="checkbox" data-permission="canEditParts" ${permissions.canEditParts ? 'checked' : ''}> M≈Ø≈æe upravovat d√≠ly a nasklad≈àovat</label>
                            <label><input type="checkbox" data-permission="canDeleteParts" ${permissions.canDeleteParts ? 'checked' : ''}> M≈Ø≈æe mazat d√≠ly</label>
                            <label><input type="checkbox" data-permission="canCreateOrders" ${permissions.canCreateOrders ? 'checked' : ''}> M≈Ø≈æe vytv√°≈ôet objedn√°vky</label>
                            <label><input type="checkbox" data-permission="canCreateTransfers" ${permissions.canCreateTransfers ? 'checked' : ''}> M≈Ø≈æe vytv√°≈ôet p≈ôesuny</label>
                            <label><input type="checkbox" data-permission="canManageUsers" ${permissions.canManageUsers ? 'checked' : ''}> M≈Ø≈æe spravovat u≈æivatele</label>
                            <label><input type="checkbox" data-permission="canViewReports" ${permissions.canViewReports ? 'checked' : ''}> M≈Ø≈æe vidƒõt reporty</label>
                            <label><input type="checkbox" data-permission="canManageSettings" ${permissions.canManageSettings ? 'checked' : ''}> M≈Ø≈æe spravovat nastaven√≠</label>
                             <label><input type="checkbox" data-permission="canManageSuppliers" ${permissions.canManageSuppliers ? 'checked' : ''}> M≈Ø≈æe spravovat dodavatele</label>
                            <label><input type="checkbox" data-permission="canPerformInventory" ${permissions.canPerformInventory ? 'checked' : ''}> M≈Ø≈æe prov√°dƒõt inventuru</label>
                        </div>
                    </div>
                     <div class="form-group"><label>P≈ô√≠stup ke sklad≈Øm (pr√°zdn√© = v≈°echny)</label>
                        <div class="permissions-grid">
                        ${Object.entries(state.warehouses).map(([key, val]) => `
                            <label><input type="checkbox" name="user-warehouses" value="${key}" ${user && user.warehouses && user.warehouses.includes(key) ? 'checked' : ''}> ${val}</label>
                        `).join('')}
                        </div>
                    </div>
                    <div class="modal-actions"><button class="btn btn-primary" onclick="saveUser()">Ulo≈æit</button></div>
                </div>`;
            showModal('user-modal', html);
        }

        function updatePermissionsForRole(role) {
            const preset = permissionPresets[role];
            if (!preset) return;
            document.querySelectorAll('#permissions-container input[type="checkbox"]').forEach(checkbox => {
                const permission = checkbox.dataset.permission;
                checkbox.checked = preset[permission] || false;
            });
        }

        function saveUser() {
            const id = state.currentEditingId;
            const selectedWarehouses = Array.from(document.querySelectorAll('input[name="user-warehouses"]:checked')).map(cb => cb.value);
            
            const permissions = {};
            document.querySelectorAll('#permissions-container input[type="checkbox"]').forEach(checkbox => {
                permissions[checkbox.dataset.permission] = checkbox.checked;
            });

            const passwordInput = document.getElementById('user-password').value.trim();
            const userData = {
                name: document.getElementById('user-name').value.trim(),
                email: document.getElementById('user-email').value.trim(),
                role: document.getElementById('user-role').value,
                warehouses: selectedWarehouses.length > 0 ? selectedWarehouses : null,
                permissions: permissions
            };

            if (!userData.name || !userData.email) return showAlert('Chyba', 'Jm√©no a email jsou povinn√©.', 'error');
            
            if (id) {
                const index = state.users.findIndex(u => u.id === id);
                if (passwordInput) {
                    userData.password = passwordInput;
                    userData.forcePasswordChange = true;
                }
                logAuditEvent('√öprava u≈æivatele', `Upraven u≈æivatel: ${userData.name}.`);
                state.users[index] = { ...state.users[index], ...userData };
            } else {
                if (!passwordInput) return showAlert('Chyba', 'Heslo je pro nov√©ho u≈æivatele povinn√©.', 'error');
                const newId = (Math.max(0, ...state.users.map(u => u.id)) + 1);
                const newUser = { 
                    id: newId, 
                    ...userData, 
                    password: passwordInput,
                    forcePasswordChange: true,
                    dashboard: { pinnedParts: [], pinnedCharts: [], dashboardScope: 'all' } 
                };
                logAuditEvent('Vytvo≈ôen√≠ u≈æivatele', `Vytvo≈ôen nov√Ω u≈æivatel: ${userData.name}.`);
                state.users.push(newUser);
            }
            saveStateToLocalStorage();
            renderUsersTable();
            hideModal('user-modal');
        }

        function deleteUser(id) {
            if(id === state.currentUser.id) return showAlert('Chyba', 'Nem≈Ø≈æete smazat s√°m sebe.', 'error');
            showAlert('Potvrzen√≠', 'Opravdu chcete smazat tohoto u≈æivatele?', 'confirm', () => {
                const userToDelete = state.users.find(u => u.id === id);
                logAuditEvent('Smaz√°n√≠ u≈æivatele', `Smaz√°n u≈æivatel: ${userToDelete.name}.`);
                state.users = state.users.filter(u => u.id !== id);
                saveStateToLocalStorage();
                renderUsersTable();
            });
        }
        
        function showSupplierModal(id = null) {
            const supplier = id ? state.suppliers.find(s => s.id === id) : null;
            state.currentEditingId = id;
            const title = id ? 'Upravit dodavatele' : 'Nov√Ω dodavatel';

            const html = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">${title}</h2>
                        <button class="modal-close" onclick="hideModal('supplier-modal')" aria-label="Zav≈ô√≠t">√ó</button>
                    </div>
                    <div class="form-group">
                        <label for="supplier-name">N√°zev firmy*</label>
                        <input type="text" id="supplier-name" class="form-input" value="${supplier ? supplier.name : ''}">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="supplier-ico">IƒåO</label>
                            <input type="text" id="supplier-ico" class="form-input" value="${supplier ? supplier.ico : ''}">
                        </div>
                        <div class="form-group">
                            <label for="supplier-contact">Kontaktn√≠ osoba</label>
                            <input type="text" id="supplier-contact" class="form-input" value="${supplier ? supplier.contactPerson : ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="supplier-email">Email</label>
                        <input type="email" id="supplier-email" class="form-input" value="${supplier ? supplier.email : ''}">
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="saveSupplier()">Ulo≈æit dodavatele</button>
                    </div>
                </div>
            `;
            showModal('supplier-modal', html);
        }

        function saveSupplier() {
            const id = state.currentEditingId;
            const supplierData = {
                name: document.getElementById('supplier-name').value.trim(),
                ico: document.getElementById('supplier-ico').value.trim(),
                contactPerson: document.getElementById('supplier-contact').value.trim(),
                email: document.getElementById('supplier-email').value.trim(),
            };

            if (!supplierData.name) {
                return showAlert('Chyba', 'N√°zev firmy je povinn√Ω.', 'error');
            }

            if (id) {
                const index = state.suppliers.findIndex(s => s.id === id);
                logAuditEvent('√öprava dodavatele', `Upraven dodavatel: ${supplierData.name}.`);
                state.suppliers[index] = { ...state.suppliers[index], ...supplierData };
            } else {
                const newId = (Math.max(0, ...state.suppliers.map(s => s.id)) + 1);
                logAuditEvent('Vytvo≈ôen√≠ dodavatele', `Vytvo≈ôen nov√Ω dodavatel: ${supplierData.name}.`);
                state.suppliers.push({ id: newId, ...supplierData });
            }

            saveStateToLocalStorage();
            renderSuppliersTable();
            hideModal('supplier-modal');
        }

        function deleteSupplier(id) {
            const isUsed = state.parts.some(p => p.supplierId === id);
            if (isUsed) {
                return showAlert('Chyba', 'Dodavatele nelze smazat, proto≈æe je p≈ôi≈ôazen k jednomu nebo v√≠ce d√≠l≈Øm.', 'error');
            }

            showAlert('Potvrzen√≠', 'Opravdu chcete smazat tohoto dodavatele?', 'confirm', () => {
                const supplierToDelete = state.suppliers.find(s => s.id === id);
                logAuditEvent('Smaz√°n√≠ dodavatele', `Smaz√°n dodavatel: ${supplierToDelete.name}.`);
                state.suppliers = state.suppliers.filter(s => s.id !== id);
                saveStateToLocalStorage();
                renderSuppliersTable();
            });
        }

        function showCreateOrderModal() {
            const createSelect = (data, placeholder) => `<option value="">${placeholder}</option>` + data.map(item =>`<option value="${item.id}">${item.name}</option>`).join('');
            
            const html = `
                <div class="modal">
                    <div class="modal-header"><h2 class="modal-title">Nov√° objedn√°vka</h2><button class="modal-close" onclick="hideModal('order-modal')" aria-label="Zav≈ô√≠t">√ó</button></div>
                    <div class="form-group"><label>Dodavatel*</label><select id="order-supplierId" class="form-select">${createSelect(state.suppliers, 'Vyberte dodavatele')}</select></div>
                    <h3>Polo≈æky objedn√°vky</h3>
                    <div class="order-item-labels">
                        <div>D√≠l</div><div>Mno≈æstv√≠</div><div>Cena/ks</div><div></div>
                    </div>
                    <div id="order-items-container"></div>
                    <button class="btn btn-secondary" onclick="addOrderItemField()">‚ûï P≈ôidat polo≈æku</button>
                    <div class="order-total">Celkov√° cena: <span id="order-total-price">0 Kƒç</span></div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="saveOrder()">Vytvo≈ôit objedn√°vku</button>
                        <button class="btn btn-secondary" onclick="hideModal('order-modal')">Zru≈°it</button>
                    </div>
                </div>`;
            showModal('order-modal', html);
            addOrderItemField();
        }

        function addOrderItemField() {
            const container = document.getElementById('order-items-container');
            const newRow = document.createElement('div');
            newRow.className = 'order-item-row';
            const partOptions = '<option value="">Vyberte d√≠l</option>' + state.parts.filter(p => p.warehouse !== null).map(p=>`<option value="${p.id}" data-price="${getLatestPrice(p)}">${p.name} (${p.inventoryNumber})</option>`).join('');
            newRow.innerHTML = `
                <select class="form-select order-part-select" onchange="updateOrderForm(this)">${partOptions}</select>
                <input type="number" class="form-input order-quantity-input" value="1" min="1" oninput="calculateOrderTotal()">
                <input type="number" class="form-input order-price-input" value="0" min="0" oninput="calculateOrderTotal()">
                <button class="remove-item-btn" onclick="this.parentElement.remove(); calculateOrderTotal();">√ó</button>`;
            container.appendChild(newRow);
        }

        function updateOrderForm(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const price = selectedOption.dataset.price || 0;
            const priceInput = selectElement.parentElement.querySelector('.order-price-input');
            priceInput.value = price;
            calculateOrderTotal();
        }

        function calculateOrderTotal() {
            let total = 0;
            document.querySelectorAll('.order-item-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.order-quantity-input').value) || 0;
                const price = parseFloat(row.querySelector('.order-price-input').value) || 0;
                total += quantity * price;
            });
            document.getElementById('order-total-price').textContent = `${total.toLocaleString('cs-CZ')} Kƒç`;
        }

        function saveOrder() {
            const orderData = {
                id: (Math.max(0, ...state.orders.map(o => o.id)) + 1),
                orderNumber: `OBJ-${Date.now().toString().slice(-5)}`,
                supplierId: parseInt(document.getElementById('order-supplierId').value),
                items: [],
                totalPrice: 0,
                status: 'ƒåek√° na dod√°n√≠',
                dateCreated: new Date()
            };
            if (!orderData.supplierId) return showAlert('Chyba', 'Vyberte pros√≠m dodavatele.', 'error');

            document.querySelectorAll('.order-item-row').forEach(row => {
                const partId = parseInt(row.querySelector('.order-part-select').value);
                const quantity = parseInt(row.querySelector('.order-quantity-input').value);
                const price = parseFloat(row.querySelector('.order-price-input').value);
                const part = state.parts.find(p => p.id === partId);
                if(part && quantity > 0) {
                    orderData.items.push({ partId, partName: part.name, quantity, price });
                    orderData.totalPrice += quantity * price;
                }
            });
            if(orderData.items.length === 0) return showAlert('Chyba', 'Objedn√°vka neobsahuje ≈æ√°dn√© platn√© polo≈æky.', 'error');
            state.orders.push(orderData);
            logAuditEvent('Vytvo≈ôen√≠ objedn√°vky', `Vytvo≈ôena objedn√°vka ${orderData.orderNumber} na ${orderData.items.length} polo≈æek.`);
            saveStateToLocalStorage();
            renderOrdersTable();
            hideModal('order-modal');
        }

        function receiveOrder(orderId) {
            const order = state.orders.find(o => o.id === orderId);
            if (!order) return;

            showAlert('Potvrzen√≠', `Opravdu chcete p≈ôijmout v≈°echny polo≈æky z objedn√°vky ${order.orderNumber}? T√≠m se nav√Ω≈°√≠ stavy na skladƒõ.`, 'confirm', () => {
                order.items.forEach(item => {
                    const partIndex = state.parts.findIndex(p => p.id === item.partId);
                    if (partIndex !== -1) {
                        state.parts[partIndex].currentStock += item.quantity;
                        const notes = `Z objedn√°vky <a href="#" onclick="event.preventDefault(); viewOrderFromTransaction('${order.orderNumber}')">${order.orderNumber}</a>`;
                        createTransaction('prijem', state.parts[partIndex], item.quantity, notes);
                    }
                });
                order.status = 'Dokonƒçeno';
                logAuditEvent('P≈ô√≠jem objedn√°vky', `P≈ôijata objedn√°vka ${order.orderNumber}.`);
                saveStateToLocalStorage();
                renderAll();
            });
        }

        function deleteOrder(id) {
            showAlert('Potvrzen√≠', 'Opravdu chcete smazat tuto objedn√°vku?', 'confirm', () => {
                const orderToDelete = state.orders.find(o => o.id === id);
                logAuditEvent('Smaz√°n√≠ objedn√°vky', `Smaz√°na objedn√°vka ${orderToDelete.orderNumber}.`);
                state.orders = state.orders.filter(o => o.id !== id);
                saveStateToLocalStorage();
                renderOrdersTable();
            });
        }
        
        function generateAutoOrders() {
            const lowStockParts = state.parts.filter(p => p.warehouse !== null && p.currentStock < p.minStock);
            if(lowStockParts.length === 0) return showAlert('Info', 'V≈°echny d√≠ly jsou v dostateƒçn√©m mno≈æstv√≠.');
            
            let generatedCount = 0;
            lowStockParts.forEach(part => {
                // pro automatickou objedn√°vku pou≈æij optim√°ln√≠ z√°sobu nebo dvojn√°sobek minima
                const quantityToOrder = (part.optimalStock || part.minStock * 2) - part.currentStock;
                if (quantityToOrder <= 0) return;

                const newOrder = {
                    id: (Math.max(0, ...state.orders.map(o => o.id)) + 1),
                    orderNumber: `AUTO-${Date.now().toString().slice(-5)}`,
                    supplierId: part.supplierId,
                    items: [{ partId: part.id, partName: part.name, quantity: quantityToOrder, price: getLatestPrice(part) }],
                    totalPrice: quantityToOrder * getLatestPrice(part),
                    status: 'ƒåek√° na dod√°n√≠',
                    dateCreated: new Date()
                };
                state.orders.push(newOrder);
                generatedCount++;
            });
            logAuditEvent('Auto-objedn√°vky', `Vygenerov√°no ${generatedCount} automatick√Ωch objedn√°vek.`);
            saveStateToLocalStorage();
            renderOrdersTable();
            showAlert('√öspƒõch', `Bylo vygenerov√°no ${generatedCount} automatick√Ωch objedn√°vek.`, 'success');
        }

        function showCreateTransferModal() {
            const uniquePartNames = [...new Set(state.parts.filter(p => p.warehouse !== null).map(p => p.name))];
            
            const html = `
                <div class="modal">
                    <div class="modal-header"><h2 class="modal-title">Nov√Ω p≈ôesun d√≠lu</h2><button class="modal-close" onclick="hideModal('transfer-modal')" aria-label="Zav≈ô√≠t">√ó</button></div>
                    <div class="form-group">
                        <label for="transfer-part-name">Vyberte d√≠l *</label>
                        <select id="transfer-part-name" class="form-select" onchange="updateTransferForm()">
                            <option value="">Vyberte d√≠l</option>
                            ${uniquePartNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transfer-from-warehouse">Ze skladu *</label>
                            <select id="transfer-from-warehouse" class="form-select" disabled><option>Nejprve vyberte d√≠l</option></select>
                        </div>
                        <div class="form-group">
                            <label for="transfer-to-warehouse">Do skladu *</label>
                            <select id="transfer-to-warehouse" class="form-select" disabled><option>Nejprve vyberte d√≠l</option></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="transfer-quantity">Mno≈æstv√≠ k p≈ôesunu *</label>
                        <input type="number" id="transfer-quantity" class="form-input" value="1" min="1">
                    </div>
                     <div class="form-group">
                        <label for="transfer-notes">Pozn√°mky</label>
                        <textarea id="transfer-notes" class="form-textarea" placeholder="Dodateƒçn√© pozn√°mky k p≈ôesunu..."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="saveTransfer()">Odeslat po≈æadavek na p≈ôesun</button>
                        <button class="btn btn-secondary" onclick="hideModal('transfer-modal')">Zru≈°it</button>
                    </div>
                </div>`;
            showModal('transfer-modal', html);
        }

        function updateTransferForm() {
            const partName = document.getElementById('transfer-part-name').value;
            const fromSelect = document.getElementById('transfer-from-warehouse');
            const toSelect = document.getElementById('transfer-to-warehouse');

            if (!partName) {
                fromSelect.innerHTML = '<option>Nejprve vyberte d√≠l</option>';
                fromSelect.disabled = true;
                toSelect.innerHTML = '<option>Nejprve vyberte d√≠l</option>';
                toSelect.disabled = true;
                return;
            }

            const partLocations = state.parts.filter(p => 
                p.name === partName && 
                p.warehouse !== null &&
                p.currentStock > p.minStock
            );
            
            if (partLocations.length > 0) {
                fromSelect.innerHTML = '<option value="">Vyberte zdrojov√Ω sklad</option>' + partLocations.map(p => `<option value="${p.id}">${state.warehouses[p.warehouse]} (Skladem: ${p.currentStock})</option>`).join('');
                fromSelect.disabled = false;
            } else {
                fromSelect.innerHTML = '<option value="">≈Ω√°dn√Ω sklad nem√° dostatek kus≈Ø</option>';
                fromSelect.disabled = true;
            }
            
            toSelect.innerHTML = '<option value="">Vyberte c√≠lov√Ω sklad</option>' + Object.entries(state.warehouses).map(([key, value]) => `<option value="${key}">${value}</option>`).join('');
            toSelect.disabled = false;
        }

        function saveTransfer() {
            const sourcePartId = document.getElementById('transfer-from-warehouse').value;
            const toWarehouse = document.getElementById('transfer-to-warehouse').value;
            const quantity = parseInt(document.getElementById('transfer-quantity').value);
            const notes = document.getElementById('transfer-notes').value.trim();

            if (!sourcePartId || !toWarehouse || isNaN(quantity) || quantity <= 0) {
                return showAlert('Chyba', 'Vypl≈àte pros√≠m v≈°echna povinn√° pole.', 'error');
            }
            
            const sourcePart = state.parts.find(p => p.id == sourcePartId);
            if (!sourcePart) return showAlert('Chyba', 'Zdrojov√Ω d√≠l nebyl nalezen.', 'error');
            if (sourcePart.warehouse === toWarehouse) return showAlert('Chyba', 'Zdrojov√Ω a c√≠lov√Ω sklad nemohou b√Ωt stejn√©.', 'error');
            if (sourcePart.currentStock < quantity) return showAlert('Chyba', `Nedostateƒçn√© mno≈æstv√≠ na zdrojov√©m skladƒõ. K dispozici: ${sourcePart.currentStock}`, 'error');
            
            const executeTransfer = () => {
                const newTransfer = {
                    id: (Math.max(0, ...state.transfers.map(t => t.id)) + 1),
                    transferNumber: `PRE-${Date.now().toString().slice(-5)}`,
                    partId: sourcePart.id,
                    partName: sourcePart.name,
                    fromWarehouse: sourcePart.warehouse,
                    toWarehouse,
                    quantity,
                    status: 'V procesu',
                    date: new Date(),
                    notes
                };
                state.transfers.push(newTransfer);
                logAuditEvent('Vytvo≈ôen√≠ p≈ôesunu', `Vytvo≈ôen p≈ôesun ${newTransfer.transferNumber} (${quantity}x ${sourcePart.name}) z ${state.warehouses[sourcePart.warehouse]} do ${state.warehouses[toWarehouse]}.`);
                saveStateToLocalStorage();
                renderTransfersTable();
                hideModal('transfer-modal');
            };

            if ((sourcePart.currentStock - quantity) < sourcePart.minStock) {
                showAlert('Potvrzen√≠', `Po p≈ôesunu klesne stav pod minimum (${sourcePart.minStock} ks). Opravdu pokraƒçovat?`, 'confirm', executeTransfer);
            } else {
                executeTransfer();
            }
        }

        function approveTransfer(id) {
            const transfer = state.transfers.find(t => t.id === id);
            if (!transfer) return;

            const sourcePartIndex = state.parts.findIndex(p => p.id === transfer.partId);
            if (sourcePartIndex === -1) return showAlert('Chyba', 'P≈Øvodn√≠ d√≠l pro p≈ôesun nebyl nalezen.', 'error');
            
            const sourcePart = state.parts[sourcePartIndex];
            if (sourcePart.currentStock < transfer.quantity) {
                transfer.status = 'Zru≈°eno (nedostatek)';
                logAuditEvent('Zru≈°en√≠ p≈ôesunu', `Zru≈°en p≈ôesun ${transfer.transferNumber} pro nedostatek d√≠l≈Ø.`);
                saveStateToLocalStorage();
                renderAll();
                return showAlert('Chyba', `P≈ôesun zru≈°en: Nedostateƒçn√Ω stav d√≠lu na zdrojov√©m skladƒõ.`, 'error');
            }

            let destPart = state.parts.find(p => p.code === sourcePart.code && p.warehouse === transfer.toWarehouse);
            
            sourcePart.currentStock -= transfer.quantity;
            const odeslaniNotes = `Do skladu ${state.warehouses[transfer.toWarehouse]} (<a href="#" onclick="event.preventDefault(); viewTransferFromTransaction('${transfer.transferNumber}')">${transfer.transferNumber}</a>)`;
            createTransaction('presun_odeslani', sourcePart, transfer.quantity, odeslaniNotes);

            const prijemNotes = `Ze skladu ${state.warehouses[transfer.fromWarehouse]} (<a href="#" onclick="event.preventDefault(); viewTransferFromTransaction('${transfer.transferNumber}')">${transfer.transferNumber}</a>)`;
            if (destPart) {
                destPart.currentStock += transfer.quantity;
                createTransaction('presun_prijem', destPart, transfer.quantity, prijemNotes);
            } else {
                const newId = (Math.max(0, ...state.parts.map(p => p.id)) + 1);
                const warehousePrefix = transfer.toWarehouse.toUpperCase();
                const warehouseParts = state.parts.filter(p => p.warehouse === transfer.toWarehouse && p.inventoryNumber);
                const maxInvNum = Math.max(0, ...warehouseParts.map(p => {
                    const num = p.inventoryNumber.split('-')[1];
                    return num ? parseInt(num) : 0;
                }));
                const inventoryNumber = `${warehousePrefix}-${String(maxInvNum + 1).padStart(4, '0')}`;

                const newStockedPart = {
                    ...sourcePart,
                    id: newId,
                    warehouse: transfer.toWarehouse,
                    currentStock: transfer.quantity,
                    umisteni: "Nov√©",
                    inventoryNumber: inventoryNumber
                };
                state.parts.push(newStockedPart);
                createTransaction('presun_prijem', newStockedPart, transfer.quantity, prijemNotes);
            }
            
            transfer.status = 'Dokonƒçeno';
            logAuditEvent('Potvrzen√≠ p≈ôesunu', `Potvrzen p≈ô√≠jem p≈ôesunu ${transfer.transferNumber}.`);
            saveStateToLocalStorage();
            renderAll();
        }

        function createTransaction(type, part, quantity, notes = '') {
            const transaction = {
                id: Date.now(),
                type,
                partId: part.id,
                partName: part.name,
                quantity,
                notes,
                date: new Date(),
                userId: state.currentUser.id,
                userName: state.currentUser.name
            };
            state.transactions.push(transaction);
            if (part.warehouse !== null && part.currentStock <= getLowStockThreshold(part)) {
                createNotification(`N√≠zk√Ω stav d√≠lu: ${part.name} (${part.currentStock} ks).`, 'warning', { partId: part.id });
            }
        }

        function createNotification(message, type = 'info', data = {}) {
            const newNotification = {
                id: Date.now(), message, type, data, read: false, timestamp: new Date()
            };
            state.notifications.unshift(newNotification);
            if (state.notifications.length > 50) state.notifications.pop();
            renderNotifications();
        }

        function renderNotifications() {
            const list = document.getElementById('notifications-list');
            const badge = document.getElementById('notification-badge');
            const unreadCount = state.notifications.filter(n => !n.read).length;
            badge.textContent = unreadCount;
            badge.classList.toggle('hidden', unreadCount === 0);
            list.innerHTML = state.notifications.length > 0 ? state.notifications.map(n => `
                <div class="notification-item ${n.read ? '' : 'unread'}" onclick="readNotification(${n.id})">
                    ${n.message}<span class="time">${n.timestamp.toLocaleString('cs-CZ')}</span>
                </div>`).join('') : '<div class="notification-item">≈Ω√°dn√° ozn√°men√≠.</div>';
        }

        function toggleNotifications() { document.getElementById('notifications-panel').classList.toggle('hidden'); }
        function readNotification(id) {
            const notification = state.notifications.find(n => n.id === id);
            if (notification) notification.read = true;
            saveStateToLocalStorage();
            renderNotifications();
        }
        
        let charts = {};
        
        function renderDashboard() {
            const user = state.currentUser;
            const dashboardContainer = document.getElementById('personalized-dashboard');
            const pinnedContainer = document.getElementById('pinned-items-container');
            
            if (!user || (!user.dashboard.pinnedParts.length && !user.dashboard.pinnedCharts.length)) {
                dashboardContainer.classList.add('hidden');
                return;
            }

            dashboardContainer.classList.remove('hidden');
            pinnedContainer.innerHTML = '';

            user.dashboard.pinnedParts.forEach(partId => {
                const part = state.parts.find(p => p.id === partId);
                if (part) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.onclick = () => showPartDetailModal(part.id);
                    card.innerHTML = `
                        <div class="stat-icon stat-blue">üî©</div>
                        <div class="stat-content">
                            <h3>${part.name}</h3>
                            <p>${part.currentStock} ks</p>
                            <small>${state.warehouses[part.warehouse] || ''} / ${part.umisteni || ''}</small>
                        </div>
                    `;
                    pinnedContainer.appendChild(card);
                }
            });

            user.dashboard.pinnedCharts.forEach(chartId => {
                const reportCard = document.createElement('div');
                reportCard.className = 'report-card';
                reportCard.dataset.chartId = chartId;
                
                if (chartId === 'parts-by-category' || chartId === 'value-by-category') {
                    reportCard.innerHTML = `<h3>${chartId === 'parts-by-category' ? 'D√≠ly podle kategorie' : 'Hodnota skladu podle kategorie'}</h3><canvas id="pinned-${chartId}-chart"></canvas>`;
                } else {
                    reportCard.innerHTML = `<h3>${chartId === 'top-used-parts' ? 'TOP 10 nejpou≈æ√≠vanƒõj≈°√≠ch d√≠l≈Ø' : 'Skladov√© "le≈æ√°ky"'}</h3><ul id="pinned-${chartId}-list" class="report-list"></ul>`;
                }
                pinnedContainer.appendChild(reportCard);
                renderSpecificReport(chartId, 'pinned-');
            });
        }

        function renderReports() {
            document.querySelectorAll('#reports-container .report-card').forEach(card => {
                const chartId = card.dataset.chartId;
                renderSpecificReport(chartId);
                
                const pinBtn = document.createElement('button');
                pinBtn.className = 'pin-btn';
                pinBtn.innerHTML = 'üìå';
                pinBtn.onclick = () => togglePinChart(chartId);
                if (state.currentUser.dashboard.pinnedCharts.includes(chartId)) {
                    pinBtn.classList.add('pinned');
                }
                if (!card.querySelector('.pin-btn')) {
                    card.appendChild(pinBtn);
                }
            });
        }

        function renderSpecificReport(chartId, prefix = '') {
            Object.values(charts).forEach(chart => { if(chart && chart.canvas.id.includes(chartId)) chart.destroy(); });
            const accessibleParts = getAccessible(state.parts).filter(p => p.warehouse !== null);

            if (chartId === 'parts-by-category' || chartId === 'value-by-category') {
                const data = accessibleParts.reduce((acc, part) => {
                    const categoryName = state.categories[part.category] || 'Nezn√°m√°';
                    acc[categoryName] = acc[categoryName] || { count: 0, value: 0 };
                    acc[categoryName].count++;
                    acc[categoryName].value += part.currentStock * getLatestPrice(part);
                    return acc;
                }, {});
                const labels = Object.keys(data);
                const categoryColors = ['#007aff', '#34c759', '#ff9500', '#ff3b30', '#af52de', '#5856d6'];
                
                if (chartId === 'parts-by-category') {
                     charts[prefix + chartId] = new Chart(document.getElementById(`${prefix}parts-by-category-chart`), {
                        type: 'doughnut',
                        data: { labels, datasets: [{ data: labels.map(l => data[l].count), backgroundColor: categoryColors }] },
                    });
                } else {
                    charts[prefix + chartId] = new Chart(document.getElementById(`${prefix}value-by-category-chart`), {
                        type: 'bar',
                        data: { labels, datasets: [{ label: 'Hodnota (Kƒç)', data: labels.map(l => data[l].value), backgroundColor: categoryColors }] },
                    });
                }
            } else {
                renderTurnoverReports(chartId, prefix);
            }
        }

        function renderTurnoverReports(chartId, prefix = '') {
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const recentTransactions = state.transactions.filter(t => new Date(t.date) > oneYearAgo);
            
            if (chartId === 'top-used-parts') {
                const dispensedParts = recentTransactions.filter(t => t.type === 'vydej');
                const usageCount = dispensedParts.reduce((acc, t) => {
                    acc[t.partId] = (acc[t.partId] || 0) + t.quantity;
                    return acc;
                }, {});
                const topUsed = Object.entries(usageCount).sort(([, a], [, b]) => b - a).slice(0, 10);
                const topUsedList = document.getElementById(`${prefix}top-used-parts-list`);
                topUsedList.innerHTML = topUsed.map(([partId, count]) => {
                    const part = state.parts.find(p => p.id === parseInt(partId));
                    return `<li><span>${part ? part.name : 'Nezn√°m√Ω d√≠l'}</span> <strong>${count} ks</strong></li>`;
                }).join('') || '<li>≈Ω√°dn√° data o v√Ωdej√≠ch za posledn√≠ rok.</li>';
            }

            if (chartId === 'shelf-warmers') {
                const dispensedParts = recentTransactions.filter(t => t.type === 'vydej');
                const stockedPartIds = new Set(state.parts.filter(p => p.warehouse !== null).map(p => p.id));
                const usedPartIds = new Set(dispensedParts.map(t => t.partId));
                const shelfWarmers = [...stockedPartIds].filter(id => !usedPartIds.has(id));
                const shelfWarmersList = document.getElementById(`${prefix}shelf-warmers-list`);
                shelfWarmersList.innerHTML = shelfWarmers.map(partId => {
                     const part = state.parts.find(p => p.id === partId);
                     return `<li><span>${part.name}</span> <strong>${part.currentStock} ks</strong></li>`;
                }).join('') || '<li>Nebyly nalezeny ≈æ√°dn√© "le≈æ√°ky".</li>';
            }
        }

        function renderPriceHistoryChart(part) {
            const ctx = document.getElementById('price-history-chart').getContext('2d');
            if (charts.priceHistory) charts.priceHistory.destroy();
            if (!part.priceHistory || part.priceHistory.length < 2) {
                 document.getElementById('price-history-chart').style.display = 'none';
                 return;
            }
             document.getElementById('price-history-chart').style.display = 'block';

            charts.priceHistory = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Cena (Kƒç)',
                        data: part.priceHistory.map(entry => ({ x: new Date(entry.date), y: entry.price })),
                        borderColor: 'var(--accent-blue)',
                        tension: 0.1
                    }]
                },
                options: { scales: { x: { type: 'time', time: { unit: 'month' } } } }
            });
        }
        
        function togglePinPart(partId) {
            const pinnedParts = state.currentUser.dashboard.pinnedParts;
            const index = pinnedParts.indexOf(partId);
            if (index > -1) pinnedParts.splice(index, 1);
            else pinnedParts.push(partId);
            saveStateToLocalStorage();
            renderDashboard();
            hideModal('part-detail-modal');
            showPartDetailModal(partId);
        }

        function togglePinChart(chartId) {
            const pinnedCharts = state.currentUser.dashboard.pinnedCharts;
            const index = pinnedCharts.indexOf(chartId);
            if (index > -1) pinnedCharts.splice(index, 1);
            else pinnedCharts.push(chartId);
            saveStateToLocalStorage();
            renderDashboard();
            renderReports();
        }
        
        function viewOrderFromTransaction(orderNumber) {
            const order = state.orders.find(o => o.orderNumber === orderNumber);
            if (!order) return showAlert('Chyba', 'Objedn√°vka nebyla nalezena.');
            const supplier = state.suppliers.find(s => s.id === order.supplierId);
            let itemsHtml = order.items.map(item => `<li>${item.quantity}x ${item.partName} @ ${item.price.toLocaleString('cs-CZ')} Kƒç</li>`).join('');
            let message = `
                <b>Dodavatel:</b> ${supplier ? supplier.name : 'Nezn√°m√Ω'}<br>
                <b>Datum:</b> ${new Date(order.dateCreated).toLocaleDateString('cs-CZ')}<br>
                <b>Stav:</b> ${order.status}<br>
                <b>Celkem:</b> ${order.totalPrice.toLocaleString('cs-CZ')} Kƒç<br>
                <b>Polo≈æky:</b><ul>${itemsHtml}</ul>
            `;
            showAlert(`Detail objedn√°vky ${order.orderNumber}`, message);
        }

        function viewTransferFromTransaction(transferNumber) {
            const transfer = state.transfers.find(t => t.transferNumber === transferNumber);
            if (!transfer) return showAlert('Chyba', 'P≈ôesun nebyl nalezen.');
             let message = `
                <b>D√≠l:</b> ${transfer.partName}<br>
                <b>Mno≈æstv√≠:</b> ${transfer.quantity} ks<br>
                <b>Z:</b> ${state.warehouses[transfer.fromWarehouse]}<br>
                <b>Do:</b> ${state.warehouses[transfer.toWarehouse]}<br>
                <b>Datum:</b> ${new Date(transfer.date).toLocaleDateString('cs-CZ')}<br>
                <b>Stav:</b> ${transfer.status}<br>
                <b>Pozn√°mky:</b> ${transfer.notes || '-'}
            `;
            showAlert(`Detail p≈ôesunu ${transfer.transferNumber}`, message);
        }
        
        function renderSettings() {
            document.getElementById('setting-low-stock-threshold').value = state.settings.lowStockThreshold || 20;
            renderDispenseReasonsSettings();
            renderCoreDataSettings();
            renderDashboardSettings();
        }

        function renderDispenseReasonsSettings() {
            const container = document.getElementById('dispense-reasons-list');
            container.innerHTML = '';
            if (!state.dispenseReasons) state.dispenseReasons = {};
            for (const [key, value] of Object.entries(state.dispenseReasons)) {
                const div = document.createElement('div');
                div.className = 'reason-item';
                div.innerHTML = `
                    <input type="text" class="form-input" value="${key}" disabled>
                    <input type="text" class="form-input" value="${value}" onchange="updateDispenseReason('${key}', this.value)">
                    <button class="btn btn-danger" onclick="deleteDispenseReason('${key}')">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            }
        }

        function addDispenseReason() {
            const keyInput = document.getElementById('new-reason-key');
            const valueInput = document.getElementById('new-reason-value');
            const key = keyInput.value.trim();
            const value = valueInput.value.trim();

            if (!key || !value) return showAlert('Chyba', 'Kl√≠ƒç i text jsou povinn√©.', 'error');
            if (state.dispenseReasons[key]) return showAlert('Chyba', 'Tento kl√≠ƒç ji≈æ existuje.', 'error');

            state.dispenseReasons[key] = value;
            logAuditEvent('Spr√°va nastaven√≠', `P≈ôid√°n nov√Ω d≈Øvod v√Ωdeje: '${value}'.`);
            saveStateToLocalStorage();
            renderDispenseReasonsSettings();
            keyInput.value = '';
            valueInput.value = '';
        }

        function updateDispenseReason(key, newValue) {
            if (state.dispenseReasons[key]) {
                logAuditEvent('Spr√°va nastaven√≠', `Upraven d≈Øvod v√Ωdeje '${key}' na '${newValue}'.`);
                state.dispenseReasons[key] = newValue;
                saveStateToLocalStorage();
                showAlert('√öspƒõch', 'D≈Øvod byl aktualizov√°n.', 'success');
            }
        }

        function deleteDispenseReason(key) {
            if (key === 'jine') {
                return showAlert('Chyba', 'D≈Øvod "Jin√©" nelze smazat, je syst√©mov√Ω.', 'error');
            }
            showAlert('Potvrzen√≠', `Opravdu chcete smazat d≈Øvod "${state.dispenseReasons[key]}"?`, 'confirm', () => {
                logAuditEvent('Spr√°va nastaven√≠', `Smaz√°n d≈Øvod v√Ωdeje: '${state.dispenseReasons[key]}'.`);
                delete state.dispenseReasons[key];
                saveStateToLocalStorage();
                renderDispenseReasonsSettings();
            });
        }
        
        function renderCoreDataSettings() {
            const renderList = (type) => {
                const container = document.getElementById(`${type}-settings-list`);
                container.innerHTML = '';
                if (!state[type]) state[type] = {};
                for (const [key, value] of Object.entries(state[type])) {
                    const div = document.createElement('div');
                    div.className = 'core-data-item';
                    div.innerHTML = `
                        <input type="text" class="form-input" value="${key}" disabled>
                        <input type="text" class="form-input" value="${value}" onchange="updateCoreDataItem('${type}', '${key}', this.value)">
                        <button class="btn btn-danger" onclick="deleteCoreDataItem('${type}', '${key}')">üóëÔ∏è</button>
                    `;
                    container.appendChild(div);
                }
            };
            renderList('warehouses');
            renderList('categories');
            renderList('machines');
            renderList('priorities');
        }

        function addCoreDataItem(type) {
            const keyInput = document.getElementById(`new-${type}-key`);
            const valueInput = document.getElementById(`new-${type}-value`);
            let key = keyInput.value.trim().toLowerCase().replace(/\s+/g, '');
            const value = valueInput.value.trim();
            // For non‚Äëadmin roles or when key is empty, generate the key from the value using slugify.  This
            // mirrors the behaviour of automatic key generation in the UI.  Warehouses require at least
            // seven characters; priorities use only the first character.
            let role = 'admin';
            try { role = (typeof getRole === 'function') ? getRole() : 'admin'; } catch(e){}
            if (role !== 'admin' || !key){
              key = slugify(value);
              if (type === 'priorities') key = key.charAt(0);
              if (type === 'warehouses'){
                while(key.length < 7) key += 'x';
              }
            }
            if (!key || !value) return showAlert('Chyba', 'Kl√≠ƒç i hodnota jsou povinn√©.', 'error');
            if (state[type][key]) return showAlert('Chyba', 'Tento kl√≠ƒç ji≈æ existuje.', 'error');

            state[type][key] = value;
            logAuditEvent('Spr√°va kmenov√Ωch dat', `P≈ôid√°na nov√° polo≈æka do '${type}': ${value}.`);
            saveStateToLocalStorage();
            renderCoreDataSettings();
            renderFilters();
             if (type === 'warehouses') {
                renderDashboardSettings();
            }
            keyInput.value = '';
            valueInput.value = '';
            showAlert('√öspƒõch', 'Polo≈æka byla √∫spƒõ≈°nƒõ p≈ôid√°na.', 'success');
        }

        function updateCoreDataItem(type, key, newValue) {
            if (state[type][key]) {
                logAuditEvent('Spr√°va kmenov√Ωch dat', `Upravena polo≈æka '${key}' v '${type}' na '${newValue}'.`);
                state[type][key] = newValue;
                saveStateToLocalStorage();
                renderFilters();
                 if (type === 'warehouses') {
                    renderDashboardSettings();
                }
                showAlert('√öspƒõch', 'Polo≈æka byla aktualizov√°na.', 'success');
            }
        }

        function deleteCoreDataItem(type, key) {
            const isInUse = {
                warehouses: state.parts.some(p => p.warehouse === key),
                categories: state.parts.some(p => p.category === key),
                priorities: state.parts.some(p => p.priority === key),
            };

            if (isInUse[type]) {
                return showAlert('Chyba', 'Tuto polo≈æku nelze smazat, proto≈æe je pou≈æ√≠v√°na u jednoho nebo v√≠ce d√≠l≈Ø.', 'error');
            }

            showAlert('Potvrzen√≠', `Opravdu chcete smazat polo≈æku "${state[type][key]}"?`, 'confirm', () => {
                logAuditEvent('Spr√°va kmenov√Ωch dat', `Smaz√°na polo≈æka '${state[type][key]}' z '${type}'.`);
                delete state[type][key];
                saveStateToLocalStorage();
                renderCoreDataSettings();
                renderFilters();
                if (type === 'warehouses') {
                    renderDashboardSettings();
                }
            });
        }


        function saveSettings() {
            state.settings.lowStockThreshold = parseInt(document.getElementById('setting-low-stock-threshold').value) || 20;
            
            const userIndex = state.users.findIndex(u => u.id === state.currentUser.id);
            if (userIndex > -1) {
                state.users[userIndex].dashboard.dashboardScope = document.getElementById('dashboard-scope-select').value;
            }
            logAuditEvent('Ulo≈æen√≠ nastaven√≠', 'Ulo≈æena obecn√° nastaven√≠ aplikace.');
            saveStateToLocalStorage();
            showAlert('√öspƒõch', 'Nastaven√≠ bylo ulo≈æeno.', 'success');
            updateStats();
        }
        
        function renderDashboardSettings() {
            const select = document.getElementById('dashboard-scope-select');
            const user = state.currentUser;
            const scope = user.dashboard.dashboardScope || 'all';
            
            let options = '<option value="all">V≈°echny dostupn√© sklady</option>';

            const accessibleWarehouses = user.warehouses || Object.keys(state.warehouses);
            
            accessibleWarehouses.forEach(whKey => {
                options += `<option value="${whKey}">${state.warehouses[whKey]}</option>`;
            });

            select.innerHTML = options;
            select.value = scope;
        }

        function backupData() {
            const dataStr = JSON.stringify(state, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `sklad_zaloha_v13_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            logAuditEvent('Z√°loha dat', 'U≈æivatel st√°hl z√°lohu dat.');
        }

        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const restoredState = JSON.parse(e.target.result);
                    showAlert('Potvrzen√≠', 'Opravdu chcete p≈ôepsat v≈°echna st√°vaj√≠c√≠ data daty ze z√°lohy? Tuto akci nelze vr√°tit zpƒõt.', 'confirm', () => {
                        // Ulo≈æ√≠me obnoven√Ω stav, ale bez currentUser, aby se vynutilo nov√© p≈ôihl√°≈°en√≠
                        const { currentUser, ...stateToRestore } = restoredState;
                        localStorage.setItem('sparePartsState_v13', JSON.stringify(stateToRestore));
                        logAuditEvent('Obnova dat', `Data byla obnovena ze souboru ${file.name}.`);
                        location.reload();
                    });
                } catch (err) {
                    showAlert('Chyba', 'Soubor se z√°lohou je po≈°kozen√Ω nebo v neplatn√©m form√°tu.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            let csv = [];
            const rows = table.querySelectorAll("tr");
            
            for (const row of rows) {
                const cols = row.querySelectorAll("td, th");
                const rowData = [];
                for (const col of cols) {
                    if (!col.classList.contains('action-buttons')) {
                        rowData.push('"' + col.innerText.replace(/"/g, '""').replace(/\n/g, ' ') + '"');
                    }
                }
                csv.push(rowData.join(","));
            }

            const csvFile = new Blob([csv.join("\n")], {type: "text/csv"});
            const downloadLink = document.createElement("a");
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
        }
        
        function exportTableToXLSX(tableId, filename) {
            const table = document.getElementById(tableId);
            const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet JS" });
            XLSX.writeFile(wb, filename || 'export.xlsx');
        }

        function showAlert(title, message, type = 'info', onConfirm = null) {
            const modal = document.getElementById('alert-modal');
            const iconMap = {
                info: '‚ÑπÔ∏è', success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå', confirm: '‚ùì'
            };
            const html = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2 class="modal-title">${iconMap[type]} ${title}</h2>
                        <button class="modal-close" onclick="hideModal('alert-modal')" aria-label="Zav≈ô√≠t">√ó</button>
                    </div>
                    <div style="margin-top: 16px; line-height: 1.5;">${message.replace(/\n/g, '<br>')}</div>
                    <div class="modal-footer" style="justify-content: ${type === 'confirm' ? 'space-between' : 'flex-end'};">
                        ${type === 'confirm' ? `
                        <button class="btn btn-secondary" onclick="hideModal('alert-modal')">Zru≈°it</button>
                        <button class="btn btn-primary" id="confirm-alert-btn">Potvrdit</button>
                        ` : `
                        <button class="btn btn-primary" onclick="hideModal('alert-modal')">Rozum√≠m</button>
                        `}
                    </div>
                </div>
            `;
            
            showModal('alert-modal', html);

            if (type === 'confirm' && onConfirm) {
                document.getElementById('confirm-alert-btn').onclick = () => {
                    hideModal('alert-modal');
                    onConfirm();
                };
            }
        }
        
        function showStartInventoryModal() {
            const warehouseOptions = Object.entries(state.warehouses).map(([id, name]) => `<option value="${id}">${name}</option>`).join('');
            const html = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">Zah√°jit novou inventuru</h2>
                        <button class="modal-close" onclick="hideModal('inventory-modal')" aria-label="Zav≈ô√≠t">√ó</button>
                    </div>
                    <div class="form-group">
                        <label for="inventory-warehouse">Vyberte sklad*</label>
                        <select id="inventory-warehouse" class="form-select">${warehouseOptions}</select>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="startInventory()">Zah√°jit</button>
                    </div>
                </div>
            `;
            showModal('inventory-modal', html);
        }

        function startInventory() {
            const warehouseId = document.getElementById('inventory-warehouse').value;
            if (!warehouseId) {
                return showAlert('Chyba', 'Mus√≠te vybrat sklad.', 'error');
            }

            const partsInWarehouse = state.parts
                .filter(p => p.warehouse === warehouseId)
                .map(p => ({
                    partId: p.id,
                    name: p.name,
                    inventoryNumber: p.inventoryNumber,
                    expectedStock: p.currentStock,
                    actualStock: null
                }));

            const newSession = {
                id: Date.now(),
                warehouseId: warehouseId,
                startDate: new Date(),
                status: 'Prob√≠h√°',
                userId: state.currentUser.id,
                userName: state.currentUser.name,
                items: partsInWarehouse
            };

            state.inventorySessions.push(newSession);
            logAuditEvent('Zah√°jen√≠ inventury', `Zah√°jena inventura pro sklad ${state.warehouses[warehouseId]}.`);
            saveStateToLocalStorage();
            renderInventoryList();
            hideModal('inventory-modal');
            continueInventory(newSession.id);
        }

        function continueInventory(sessionId) {
            const session = state.inventorySessions.find(s => s.id === sessionId);
            if (!session) return;

            document.getElementById('inventory-start-view').classList.add('hidden');
            const sessionView = document.getElementById('inventory-session-view');
            sessionView.classList.remove('hidden');

            const isFinished = session.status === 'Dokonƒçeno';

            let itemsHtml = session.items.map(item => {
                let discrepancy = '';
                if (item.actualStock !== null) {
                    const diff = item.actualStock - item.expectedStock;
                    if (diff > 0) discrepancy = `<span class="discrepancy-plus">+${diff}</span>`;
                    if (diff < 0) discrepancy = `<span class="discrepancy-minus">${diff}</span>`;
                }
                return `
                <div class="inventory-item">
                    <div>
                        <div class="font-medium">${item.name}</div>
                        <div class="text-gray-500">${item.inventoryNumber}</div>
                    </div>
                    <div>${item.expectedStock} ks</div>
                    <div><input type="number" class="form-input" data-part-id="${item.partId}" value="${item.actualStock !== null ? item.actualStock : ''}" ${isFinished ? 'disabled' : ''}></div>
                    <div>${discrepancy}</div>
                </div>
            `}).join('');

            sessionView.innerHTML = `
                <div class="table-container">
                    <div class="table-header">
                        <h3>Inventura skladu: ${state.warehouses[session.warehouseId]}</h3>
                        <button class="btn btn-secondary" onclick="showTab('inventory-module')">Zpƒõt na seznam</button>
                    </div>
                    <div style="padding: 24px;">
                        <div class="inventory-item" style="font-weight: bold;">
                           <div>N√°zev d√≠lu</div>
                           <div>Oƒçek√°v√°no</div>
                           <div>Napoƒç√≠t√°no</div>
                           <div>Rozd√≠l</div>
                        </div>
                        ${itemsHtml}
                        ${!isFinished ? `
                        <div class="modal-actions">
                            <button class="btn btn-primary" onclick="finishInventory(${sessionId})">Ulo≈æit a dokonƒçit inventuru</button>
                        </div>
                        ` : `
                        <div class="modal-actions">
                             <p class="text-secondary-color">Inventura byla dokonƒçena ${new Date(session.endDate).toLocaleString('cs-CZ')}.</p>
                        </div>
                        `}
                    </div>
                </div>
            `;
        }
        
        function finishInventory(sessionId) {
            const sessionIndex = state.inventorySessions.findIndex(s => s.id === sessionId);
            if (sessionIndex === -1) return;
            const session = state.inventorySessions[sessionIndex];

            const inputs = document.querySelectorAll('#inventory-session-view input[data-part-id]');
            inputs.forEach(input => {
                const partId = parseInt(input.dataset.partId);
                const actualStock = input.value !== '' ? parseInt(input.value) : null;
                const item = session.items.find(i => i.partId === partId);
                if (item) {
                    item.actualStock = actualStock;
                }
            });

            showAlert('Dokonƒçen√≠ inventury', 'Opravdu chcete dokonƒçit tuto inventuru? Budou zobrazeny rozd√≠ly a budete m√≠t mo≈ænost opravit stavy skladu.', 'confirm', () => {
                session.status = 'Dokonƒçeno';
                session.endDate = new Date();
                logAuditEvent('Dokonƒçen√≠ inventury', `Dokonƒçena inventura pro sklad ${state.warehouses[session.warehouseId]}.`);
                saveStateToLocalStorage();
                showInventoryDiscrepancy(sessionId);
            });
        }

        function showInventoryDiscrepancy(sessionId) {
            const session = state.inventorySessions.find(s => s.id === sessionId);
            const discrepancies = session.items.filter(item => item.actualStock !== null && item.actualStock !== item.expectedStock);

            if (discrepancies.length === 0) {
                showAlert('Inventura dokonƒçena', 'Nebyly nalezeny ≈æ√°dn√© rozd√≠ly ve stavech skladu.', 'success');
                continueInventory(sessionId);
                return;
            }

            let discrepancyHtml = discrepancies.map(item => `
                <div class="inventory-item">
                    <div>${item.name}</div>
                    <div>${item.expectedStock}</div>
                    <div>${item.actualStock}</div>
                    <div>${item.actualStock - item.expectedStock}</div>
                </div>
            `).join('');

            const html = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">Protokol o rozd√≠lech v inventu≈ôe</h2>
                        <button class="modal-close" onclick="hideModal('inventory-modal'); continueInventory(${sessionId});" aria-label="Zav≈ô√≠t">√ó</button>
                    </div>
                    <p>N√°sleduj√≠c√≠ polo≈æky se li≈°√≠ od evidovan√©ho stavu. Chcete stavy na skladƒõ opravit podle skuteƒçnosti?</p>
                    <div style="margin-top: 20px;">
                        <div class="inventory-item" style="font-weight: bold;">
                           <div>N√°zev d√≠lu</div>
                           <div>Oƒçek√°v√°no</div>
                           <div>Napoƒç√≠t√°no</div>
                           <div>Rozd√≠l</div>
                        </div>
                        ${discrepancyHtml}
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="hideModal('inventory-modal'); continueInventory(${sessionId});">Ne, nechat p≈Øvodn√≠ stavy</button>
                        <button class="btn btn-primary" onclick="applyInventoryCorrections(${sessionId})">Ano, opravit stavy</button>
                    </div>
                </div>
            `;
            showModal('inventory-modal', html);
        }

        function applyInventoryCorrections(sessionId) {
            const session = state.inventorySessions.find(s => s.id === sessionId);
            const discrepancies = session.items.filter(item => item.actualStock !== null && item.actualStock !== item.expectedStock);

            discrepancies.forEach(item => {
                const partIndex = state.parts.findIndex(p => p.id === item.partId);
                if (partIndex !== -1) {
                    const part = state.parts[partIndex];
                    const diff = item.actualStock - item.expectedStock;
                    part.currentStock = item.actualStock;
                    createTransaction('korekce', part, diff, `Inventura ze dne ${new Date(session.startDate).toLocaleDateString('cs-CZ')}`);
                }
            });
            logAuditEvent('Aplikace korekc√≠', `Aplikov√°ny korekce z inventury pro sklad ${state.warehouses[session.warehouseId]}.`);
            saveStateToLocalStorage();
            hideModal('inventory-modal');
            renderAll();
            continueInventory(sessionId);
            showAlert('√öspƒõch', 'Stavy skladu byly √∫spƒõ≈°nƒõ opraveny dle inventury.', 'success');
        }

        function debounce(func, delay = 300) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        function setupEventListeners() {
            document.getElementById('search-input').addEventListener('input', debounce(renderPartsTable, 300));
            document.getElementById('warehouse-filter').addEventListener('change', renderPartsTable);
            document.getElementById('category-filter').addEventListener('change', renderPartsTable);
            const mf = document.getElementById('machine-filter'); if (mf) mf.addEventListener('change', renderPartsTable);
        }

    </script>

<script>
  function editPartFromDetail(id){
    // Before opening the edit form, hide all open modals (including the part detail)
    // to ensure the edit modal appears above everything else.
    try { hideAllModals(); } catch(e) {}
    // Use a slight timeout to allow the DOM to update hidden states before rendering the new modal.
    setTimeout(function(){ showPartModal(id); }, 0);
  }

        // Alias for backward compatibility: some code still calls closeModal().
        // Ensure it maps to hideModal() to avoid undefined function errors.
        function closeModal(modalId) {
            hideModal(modalId);
        }
  window.editPartFromDetail = editPartFromDetail;
</script>


<script>
  function getPartsForMachine(machineId){
    return getAccessible(state.parts)
      .filter(p => p.warehouse !== null)
      .filter(p => p.machineId === machineId);
  }
  function computeMachineStats(machineId){
    const items = getPartsForMachine(machineId);
    let critical = 0, value = 0;
    items.forEach(part => {
      const low = getLowStockThreshold(part);
      if (part.currentStock === 0 || part.currentStock <= low) critical++;
      const price = getLatestPrice(part);
      value += (price * (part.currentStock || 0)) || 0;
    });
    const uniqueKey = p => (p.code || p.name || '').toLowerCase();
    const uniqueCount = Array.from(new Set(items.map(uniqueKey))).length;
    return { count: uniqueCount, critical, value };
  }
  function renderMachinesTable(){
    const tbody = document.getElementById('machines-table-body');
    const nores = document.getElementById('machines-no-results');
    const search = (document.getElementById('machine-search-input')?.value || '').toLowerCase();
    const entries = Object.entries(state.machines || {})
      .map(([id, name]) => ({ id, name }))
      .filter(m => !search || (m.name.toLowerCase().includes(search) || m.id.toLowerCase().includes(search)))
      .sort((a,b) => a.name.localeCompare(b.name,'cs'));
    if (!entries.length){ tbody.innerHTML = ''; nores.classList.remove('hidden'); return; }
    nores.classList.add('hidden');
    tbody.innerHTML = entries.map(m => { ensureMachineMeta(m.id); const st = revStatus(m.id);
      const {count, critical, value} = computeMachineStats(m.id);
      const badgeClass = critical > 0 ? 'badge-red' : 'badge-green';
      return `<tr>
        <td><span class="font-medium">${m.name}</span><div class="text-gray-500">${m.id}</div></td>
        <td>${count}</td>
        <td><span class="badge ${badgeClass}">${critical}</span></td>
        <td>${value ? value.toLocaleString('cs-CZ') + ' Kƒç' : '-'}</td>
        <td><span class="badge ${st.cls}">${st.label}</span></td>
        <td class="action-buttons"><button class="btn btn-secondary" onclick="showMachineDetail('${m.id}')">üëÅÔ∏è</button></td>
      </tr>`;
    }).join('');
    const input = document.getElementById('machine-search-input');
    if (input && !input._bind){ input.addEventListener('input', debounce(renderMachinesTable, 250)); input._bind = true; }
  }
  
function showMachineDetail(machineId){
    const name = state.machines?.[machineId] || machineId;
    const items = getPartsForMachine(machineId);
    ensureMachineMeta(machineId);
    recomputeRevision(machineId);
    const _mm = state.machineMeta[machineId];
    const _st = revStatus(machineId);
    // --- Maintenance filter preparation ---
    if (!_mm.ui) _mm.ui = {};
    const _mf = _mm.ui.maintFilter || 'all';
    const _today0 = new Date(); _today0.setHours(0,0,0,0);
    function _nx(t){ return t.next ? t.next : (t.last && t.freqDays ? addDays(t.last, t.freqDays) : null); }
    function _days(d){ if (!d) return null; const dd = new Date(d); dd.setHours(0,0,0,0); return Math.ceil((dd - _today0)/(1000*60*60*24)); }
    const _maint = (_mm.maintenance.tasks||[]).map((t,idx)=>({t, idx, nx:_nx(t), days:_days(_nx(t))})).filter(e=>{
      if (_mf==='active') return (e.days!=null && e.days>=0);
      if (_mf==='overdue') return (e.days!=null && e.days<0);
      if (_mf==='nodate') return (e.nx==null);
      return true; // all
    });
    const rows = items.map(part => {
      const low = getLowStockThreshold(part);
      const dot = part.currentStock === 0 ? 'status-dot-red' : (part.currentStock <= low ? 'status-dot-yellow' : 'status-dot-green');
      const price = getLatestPrice(part);
      return `<tr>
        <td>${part.name}</td>
        <td>${part.code || ''}</td>
        <td>${state.warehouses[part.warehouse] || ''}<div class="text-gray-500">${part.umisteni || ''}</div></td>
        <td><div class="inventory-status"><div class="status-dot ${dot}"></div><span>${part.currentStock} ks</span></div></td>
        <td>${price ? price.toLocaleString('cs-CZ') + ' Kƒç' : '-'}</td>
      </tr>`;
    }).join('');
    const html = `
      <div class="modal" style="max-width: 900px;">
        <div class="modal-header">
          <h2 class="modal-title">${name}</h2>
          <div class="inline-actions">
            <button class="btn btn-secondary" onclick="toggleDetailLayout(this)">‚Üï Pod sebou</button>
            <button class="btn btn-secondary" onclick="toggleFullModal(this)">‚§¢ Roz≈°√≠≈ôit</button>
          </div>
          <button class="modal-close" onclick="hideModal('machine-detail-modal')" aria-label="Zav≈ô√≠t">√ó</button>
        </div>
        
        
        <div class="modal-content">

          <!-- Summary stats -->
          <div class="stats-row" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:14px;">
            <div class="stat-card"><div class="stat-title">Poƒçet d√≠l≈Ø</div><div class="stat-value">${new Set(items.map(p=>p.code||p.name)).size}</div></div>
            <div class="stat-card"><div class="stat-title">Kritick√©</div><div class="stat-value">${items.filter(p=>p.currentStock===0 || p.currentStock<=getLowStockThreshold(p)).length}</div></div>
            <div class="stat-card"><div class="stat-title">Hodnota</div><div class="stat-value">${items.reduce((s,p)=>s+(getLatestPrice(p)*(p.currentStock||0)||0),0).toLocaleString('cs-CZ')} Kƒç</div></div>
            <div class="stat-card"><div class="stat-title">Revize</div><div class="stat-value"><span class="badge ${_st.cls}">${_st.label}</span></div></div>
          </div>

          <div class="subgrid">

            <!-- Parts section -->
            <section id="sec-parts" class="section" style="grid-column: 1;">
              <div class="section-header">
                <div class="section-title">D√≠ly</div>
                <div class="section-actions">
                  <button class="btn-icon" onclick="toggleSectionWide('sec-parts')" title="Roz≈°√≠≈ôit p≈ôes ≈°√≠≈ôku">‚Üî</button>
                  <button class="btn-icon" onclick="toggleSectionCollapse('sec-parts')" title="Sbalit/rozbalit">‚ñæ</button>
                </div>
              </div>
              <div class="section-body">
      <div id="notify-banner" class="notif-banner hidden"><div class="txt">M√°te ud√°losti <b>dnes</b> nebo <b>po term√≠nu</b>. Zapnƒõte notifikace a≈• na nƒõ nezapomenete.</div><div class="actions"><button id="notify-cta" class="btn btn-small">Povolit notifikace</button> <button id="notify-dismiss" class="btn btn-small">Skr√Ωt</button></div></div>
                <div class="table-container">
                  <table class="table">
                    <thead><tr><th>D√≠l</th><th>SKU</th><th>Um√≠stƒõn√≠</th><th>Stav</th><th>Cena/ks</th></tr></thead>
                    <tbody>${rows || '<tr><td colspan="5" class="text-center text-gray-500">≈Ω√°dn√© p≈ôi≈ôazen√© d√≠ly.</td></tr>'}</tbody>
                  </table>
                </div>
              </div>
            </section>

            <!-- Revision section -->
            <section id="sec-revision" class="section" style="grid-column: 2;">
              <div class="section-header">
                <div class="section-title">Revize</div>
                <div class="section-actions">
                  <button class="btn-icon" onclick="toggleSectionWide('sec-revision')" title="Roz≈°√≠≈ôit p≈ôes ≈°√≠≈ôku">‚Üî</button>
                  <button class="btn-icon" onclick="toggleSectionCollapse('sec-revision')" title="Sbalit/rozbalit">‚ñæ</button>
                </div>
              </div>
              <div class="section-body">
      <div id="notify-banner" class="notif-banner hidden"><div class="txt">M√°te ud√°losti <b>dnes</b> nebo <b>po term√≠nu</b>. Zapnƒõte notifikace a≈• na nƒõ nezapomenete.</div><div class="actions"><button id="notify-cta" class="btn btn-small">Povolit notifikace</button> <button id="notify-dismiss" class="btn btn-small">Skr√Ωt</button></div></div>
                <div class="kv" style="margin-bottom:8px;">
                  <div>P≈ô√≠≈°t√≠</div><div><span class="badge badge-large ${_st.cls}">${_mm.revision.next || '‚Äî'}</span></div>
                  <div>Posledn√≠</div><div>${_mm.revision.last || '‚Äî'}</div>
                  <div>Periodicita</div><div>${_mm.revision.periodicityDays || 365} d</div>
                  <div>Odpovƒõdn√°</div><div>${_mm.revision.responsible || '‚Äî'}</div>
                </div>
                <div class="inline-actions" style="margin-bottom:8px;">
                  <button class="btn btn-primary" onclick="markRevisionToday('${machineId}')">‚úîÔ∏è Revize provedena dnes</button>
                  <button class="btn btn-secondary" onclick="goToRevisions('${machineId}')">üóìÔ∏è Otev≈ô√≠t v P≈ôehledu</button>
                </div>
                <hr class="soft">
                <div class="form-row">
                  <div class="form-group">
                    <label>Posledn√≠ revize (YYYY-MM-DD)</label>
                    <input id="rev-last" class="form-input" type="date" value="${_mm.revision.last||''}">
                  </div>
                  <div class="form-group">
                    <label>Periodicita (dny)</label>
                    <input id="rev-period" class="form-input" type="number" min="1" value="${_mm.revision.periodicityDays||365}">
                  </div>
                </div>
                <div class="form-group">
                  <label>Odpovƒõdn√° osoba</label>
                  <input id="rev-resp" class="form-input" type="text" value="${_mm.revision.responsible||''}">
                </div>
                <div class="form-group">
                  <label>Pozn√°mka</label>
                  <input id="rev-note" class="form-input" type="text" value="${_mm.revision.note||''}">
                </div>
                <div class="small-muted">P≈ô√≠≈°t√≠ term√≠n = ‚ÄûPosledn√≠‚Äú + ‚ÄûPeriodicita‚Äú</div>
                <div class="modal-actions" style="justify-content:flex-start;">
                  <button class="btn btn-primary" onclick="saveRevision('${machineId}')">üíæ Ulo≈æit</button>
                </div>
              </div>
            </section>

            <!-- Maintenance section -->
            <section id="sec-maint" class="section" style="grid-column: 2;">
              <div class="section-header">
                <div class="section-title">Pl√°n √∫dr≈æby</div>
                <div class="section-actions">
                  <button class="btn-icon" onclick="toggleSectionWide('sec-maint')" title="Roz≈°√≠≈ôit p≈ôes ≈°√≠≈ôku">‚Üî</button>
                  <button class="btn-icon" onclick="toggleSectionCollapse('sec-maint')" title="Sbalit/rozbalit">‚ñæ</button>
                </div>
              </div>
              <div class="section-body">
      <div id="notify-banner" class="notif-banner hidden"><div class="txt">M√°te ud√°losti <b>dnes</b> nebo <b>po term√≠nu</b>. Zapnƒõte notifikace a≈• na nƒõ nezapomenete.</div><div class="actions"><button id="notify-cta" class="btn btn-small">Povolit notifikace</button> <button id="notify-dismiss" class="btn btn-small">Skr√Ωt</button></div></div>
                <div class="chips" id="maint-chips">
                  <button class="chip" data-mode="all">V≈°e</button>
                  <button class="chip" data-mode="active">Aktivn√≠</button>
                  <button class="chip" data-mode="overdue">Po term√≠nu</button>
                  <button class="chip" data-mode="nodate">Bez data</button>
                </div>
                <div id="maint-list">
                  ${_maint.map(e=>`
                    <div class="core-data-item" style="gap:8px; align-items:center;">
                      <span class="small-muted">√ökon</span>
                      <input class="form-input" id="mt-task-${e.idx}" placeholder="√ökon" value="${e.t.task||''}">
                      <span class="small-muted">Frekvence</span>
                      <input class="form-input" id="mt-freq-${e.idx}" type="number" min="1" placeholder="dny" value="${e.t.freqDays||''}" style="max-width:110px;">
                      <span class="small-muted">Posledn√≠</span>
                      <input class="form-input" id="mt-last-${e.idx}" type="date" value="${e.t.last||''}" style="max-width:160px;">
                      <input class="form-input" id="mt-resp-${e.idx}" placeholder="Odpovƒõdn√° osoba" value="${e.t.responsible||''}">
                      <button class="btn btn-secondary" onclick="markMaintToday('${machineId}', ${e.idx})">‚úîÔ∏è Dnes</button>
                      <button class="btn btn-danger" onclick="removeMaint('${machineId}', ${e.idx})">‚úï</button>
                    </div>
                  `).join('')}
                </div>
                <div class="core-data-item" style="gap:8px;margin-top:8px;">
                  <input class="form-input" id="mt-new-task" placeholder="Nov√Ω √∫kon (nap≈ô. V√Ωmƒõna filtru)">
                  <input class="form-input" id="mt-new-freq" type="number" min="1" placeholder="Frekvence (dny)" style="max-width:160px;">
                  <button class="btn btn-success" onclick="addMaint('${machineId}')">‚ûï P≈ôidat</button>
                </div>
                <div class="small-muted">P≈ô√≠≈°t√≠ term√≠n ka≈æd√©ho √∫konu = ‚ÄûPosledn√≠‚Äú + ‚ÄûFrekvence‚Äú</div>
              </div>
            </section>

            <!-- Protocols section -->
            <section id="sec-protocols" class="section" style="grid-column: 2;">
              <div class="section-header">
                <div class="section-title">Protokoly (PDF/JPG/PNG)</div>
                <div class="section-actions">
                  <button class="btn-icon" onclick="toggleSectionWide('sec-protocols')" title="Roz≈°√≠≈ôit p≈ôes ≈°√≠≈ôku">‚Üî</button>
                  <button class="btn-icon" onclick="toggleSectionCollapse('sec-protocols')" title="Sbalit/rozbalit">‚ñæ</button>
                </div>
              </div>
              <div class="section-body">
      <div id="notify-banner" class="notif-banner hidden"><div class="txt">M√°te ud√°losti <b>dnes</b> nebo <b>po term√≠nu</b>. Zapnƒõte notifikace a≈• na nƒõ nezapomenete.</div><div class="actions"><button id="notify-cta" class="btn btn-small">Povolit notifikace</button> <button id="notify-dismiss" class="btn btn-small">Skr√Ωt</button></div></div>
                <div id="prot-list">
                  ${(_mm.protocols||[]).map((f,i)=>`
                    <div class="doc-info" style="margin-bottom:6px; display:flex; justify-content:space-between; gap:8px; align-items:center;">
                      <span>üìÑ ${f.name} ‚Ä¢ ${(f.size/1024).toFixed(1)} kB ‚Ä¢ ${new Date(f.uploadedAt).toLocaleString('cs-CZ')}</span>
                      <div class="inline-actions">
                        <a class="btn btn-secondary" href="${f.dataUrl}" download="${f.name}">St√°hnout</a>
                        <button class="btn btn-danger" onclick="removeProtocol('${machineId}', ${i})">Smazat</button>
                      </div>
                    </div>
                  `).join('') || '<div class="text-gray-500">Zat√≠m ≈æ√°dn√© soubory.</div>'}
                </div>
                <div style="margin-top:8px;">
                  <input id="prot-file" type="file" accept=".pdf,.jpg,.jpeg,.png" onchange="uploadProtocol(event, '${machineId}')">
                  <div class="small-muted" style="margin-top:6px;">MVP ukl√°d√° do LocalStorage (doporuƒçeno &lt; 2 MB na soubor).</div>
                </div>
              </div>
            </section>

          </div> <!-- /subgrid -->
        </div>
<div class="modal-actions">
          <button class="btn btn-success" onclick="showAssignPartModal()">üì• Naskladnit</button>
          <button class="btn btn-outline" onclick="exportMachinesToCSV('${machineId}')">‚¨áÔ∏è Export</button>
        </div>
      </div>`;
    showModal('machine-detail-modal', html);
    try {
      const sub = document.querySelector('#machine-detail-modal .subgrid');
      if (sub) sub.classList.add('stack');
    } catch(_) {}
    try {
      // Activate chips state
      const chips = document.querySelectorAll('#maint-chips .chip');
      chips.forEach(btn=>{
        const mode = btn.getAttribute('data-mode');
        btn.classList.toggle('active', mode===_mf);
        if (!btn._bind){
          btn.addEventListener('click', ()=>{
            if (!_mm.ui) _mm.ui = {};
            _mm.ui.maintFilter = mode;
            saveStateToLocalStorage();
            openMachineDetail(machineId);
          });
          btn._bind = true;
        }
      });
    } catch(_) {}

    // Section ordering & DnD
    try {
      initDetailSectionsDnD(machineId);
      applySectionOrderFromState(machineId);
    } catch(_) {}
// Auto layout: pokud nejsou d√≠ly, sbal√≠me d√≠ly a roz≈°√≠≈ô√≠me ostatn√≠ sekce
try {
  const hasParts = (items && items.length > 0);
  const secParts = document.getElementById('sec-parts');
  if (secParts && !hasParts) {
    secParts.classList.add('section--collapsed');
    ['sec-revision','sec-maint','sec-protocols'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.add('section--wide');
    });
  }
} catch(_) {}

    try {
      const modal = document.querySelector('#machine-detail-modal .modal');
      const btn = modal?.querySelector('button[onclick^="toggleFullModal"]');
      if (modal && btn) { btn.textContent = modal.classList.contains('modal--full') ? '‚§° Zpƒõt' : '‚§¢ Roz≈°√≠≈ôit'; }
      const layBtn = modal?.querySelector('button[onclick^="toggleDetailLayout"]');
      if (layBtn) { const sub = modal.querySelector('.subgrid'); layBtn.textContent = (sub && sub.classList.contains('stack')) ? '‚Üî Vedle sebe' : '‚Üï Pod sebou'; }
    } catch(_) {}
}


function saveRevision(machineId){
  try { ensureMachineMeta(machineId); } catch(e){}
  const m = state.machineMeta[machineId];
  m.revision.last = (document.getElementById('rev-last')?.value) || null;
  m.revision.periodicityDays = Math.max(1, parseInt(document.getElementById('rev-period')?.value||'365',10));
  m.revision.responsible = document.getElementById('rev-resp')?.value || '';
  m.revision.note = document.getElementById('rev-note')?.value || '';
  recomputeRevision(machineId);
  saveStateToLocalStorage();
  try { renderMachinesTable(); } catch(_){}
  showMachineDetail(machineId);
  showAlert && showAlert('Ulo≈æeno', 'Revize ulo≈æena.', 'success');
}

function addMaint(machineId){
  ensureMachineMeta(machineId);
  const task = (document.getElementById('mt-new-task')?.value||'').trim();
  const freq = parseInt(document.getElementById('mt-new-freq')?.value||'0',10);
  if (!task || !freq) { showAlert && showAlert('Chyba','Vypl≈à √∫kon i frekvenci.','error'); return; }
  state.machineMeta[machineId].maintenance.tasks.push({task, freqDays:Math.max(1,freq), last:null, next:null, responsible:''});
  saveStateToLocalStorage();
  showMachineDetail(machineId);
}
function removeMaint(machineId, idx){
  state.machineMeta[machineId].maintenance.tasks.splice(idx,1);
  saveStateToLocalStorage();
  showMachineDetail(machineId);
}

async function uploadProtocol(ev, machineId){
  const f = ev.target.files?.[0]; if (!f) return;
  if (f.size > 2*1024*1024) { showAlert && showAlert('Pozor','Soubor je velk√Ω, zva≈æ extern√≠ √∫lo≈æi≈°tƒõ.','warning'); }
  const dataUrl = await new Promise(res=>{ const r = new FileReader(); r.onload = ()=>res(r.result); r.readAsDataURL(f); });
  ensureMachineMeta(machineId);
  state.machineMeta[machineId].protocols.push({name:f.name, mime:f.type, size:f.size, dataUrl, uploadedAt: new Date().toISOString()});
  saveStateToLocalStorage();
  showMachineDetail(machineId);
}
function removeProtocol(machineId, idx){
  state.machineMeta[machineId].protocols.splice(idx,1);
  saveStateToLocalStorage();
  showMachineDetail(machineId);
}


  /**
   * Aktualizuje optim√°ln√≠ z√°sobu pro ka≈æd√Ω d√≠l na z√°kladƒõ poƒçtu vydan√Ωch kus≈Ø
   * za posledn√≠ t√Ωden. Pro ka≈æd√Ω d√≠l (master i skladov√Ω) spoƒç√≠t√° souƒçet
   * transakc√≠ typu "vydej" v posledn√≠ch sedmi dnech a nastav√≠ vlastnost
   * `optimalStock` minim√°lnƒõ na hodnotu `minStock`. D√≠ly bez historie
   * vyd√°v√°n√≠ si ponechaj√≠ minim√°ln√≠ z√°sobu jako optim√°ln√≠.
   */
  function updateOptimalStock(){
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    state.parts.forEach(part => {
      // seƒçteme mno≈æstv√≠ vydan√Ωch kus≈Ø za posledn√≠ch 7 dn√≠
      let weeklyUsage = 0;
      state.transactions.forEach(t => {
        try {
          const tDate = new Date(t.date);
          if (t.partId === part.id && t.type && String(t.type).toLowerCase().includes('vydej') && tDate >= oneWeekAgo) {
            weeklyUsage += (t.quantity || 0);
          }
        } catch(e) {}
      });
      const min = part.minStock || 0;
      const opt = Math.max(min, weeklyUsage);
      part.optimalStock = opt;
    });
  }

  function exportMachinesToCSV(machineId){
    let rows = [["Za≈ô√≠zen√≠","D√≠l","SKU","Sklad","Um√≠stƒõn√≠","Aktu√°ln√≠ poƒçet","Cena/ks"]];
    const list = machineId ? [{id: machineId, name: state.machines[machineId]}]
      : Object.entries(state.machines||{}).map(([id,name])=>({id,name}));
    list.forEach(m => {
      const items = getPartsForMachine(m.id);
      items.forEach(p => {
        rows.push([m.name, p.name, p.code||'', state.warehouses[p.warehouse]||'', p.umisteni||'', p.currentStock||0, getLatestPrice(p)||0]);
      });
    });
    const csv = rows.map(r => r.map(x => `${(x??'').toString().replace(/"/g,'""')}`).map(x=>`"${x}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = machineId ? `zarizeni_${machineId}.csv` : 'zarizeni_export.csv'; a.click();
  }
</script>


<script>
  function normalizeMachineId(s){
    return (s||'').toString().trim().toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/\s+/g,'').replace(/[^a-z0-9_-]/g,'');
  }
  function showCreateMachineModal(){
    const html = `
      <div class="modal" style="max-width:520px;">
        <div class="modal-header">
          <h2 class="modal-title">Nov√© za≈ô√≠zen√≠</h2>
          <button class="modal-close" onclick="hideModal('machine-create-modal')" aria-label="Zav≈ô√≠t">√ó</button>
        </div>
        <div class="modal-content">
          <div class="form-group"><label>K√≥d (ID)*</label>
            <input id="machine-id" class="form-input" placeholder="nap≈ô. dopA">
            <div class="text-gray-500" style="font-size:12px;">bez diakritiky, mal√° p√≠smena, povolen√© znaky: a-z 0-9 _ -</div>
          </div>
          <div class="form-group"><label>N√°zev*</label>
            <input id="machine-name" class="form-input" placeholder="nap≈ô. Dopravn√≠k A">
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-primary" onclick="saveMachineFromModal()">Ulo≈æit</button>
        </div>
      </div>`;
    showModal('machine-create-modal', html);
    setTimeout(()=>document.getElementById('machine-id')?.focus(), 0);
  }
  function saveMachineFromModal(){
    const rawId = document.getElementById('machine-id')?.value || '';
    const id = normalizeMachineId(rawId);
    const name = (document.getElementById('machine-name')?.value || '').trim();
    if (!id || !name) return showAlert('Chyba', 'Vypl≈àte K√≥d i N√°zev.', 'error');
    if (!state.machines) state.machines = {};
    if (state.machines[id]) return showAlert('Chyba', 'Za≈ô√≠zen√≠ s t√≠mto k√≥dem ji≈æ existuje.', 'error');
    state.machines[id] = name;
    if (!state.machineMeta) state.machineMeta = {};
    try { ensureMachineMeta(id); } catch(e) {}
    logAuditEvent('Za≈ô√≠zen√≠', `Vytvo≈ôeno za≈ô√≠zen√≠ '${name}' (${id}).`);
    saveStateToLocalStorage();
    renderFilters();
    if (typeof renderMachinesTable === 'function') renderMachinesTable();
    closeModal('machine-create-modal');
    showAlert('Hotovo', 'Za≈ô√≠zen√≠ bylo vytvo≈ôeno.', 'success');
  }
</script>


<script>
(function(){
  if (!window.state) window.state = {};
  if (!state.ui) state.ui = {};
  if (!state.ui.smartFilter) state.ui.smartFilter = 'all';

  window.setSmartFilter = function(mode){
    state.ui.smartFilter = mode || 'all';
    try { renderPartsTable(); } catch(_){}
    updateSmartChips();
  };

  window.updateSmartChips = function(){
    const cont = document.getElementById('smart-chips');
    if (!cont) return;
    const mode = (state.ui && state.ui.smartFilter) || 'all';
    cont.querySelectorAll('.smart-chip').forEach(btn => {
      btn.classList.toggle('active', btn.getAttribute('data-mode') === mode);
    });
  };

  // Better search AND-token logic + include more fields
  const _origGetFiltered = window.getFilteredParts;
  window.getFilteredParts = function(){
    const si = document.getElementById('search-input');
    const searchRaw = (si ? si.value : '').toLowerCase().trim();
    const tokens = searchRaw ? searchRaw.split(/\s+/).filter(Boolean) : [];

    const warehouseFilter = (document.getElementById('warehouse-filter') ? document.getElementById('warehouse-filter').value : 'all');
    const categoryFilter = (document.getElementById('category-filter') ? document.getElementById('category-filter').value : 'all');
    const machineFilter = (document.getElementById('machine-filter') ? document.getElementById('machine-filter').value : 'all');
    const mode = (state.ui && state.ui.smartFilter) || 'all';

    return getAccessible(state.parts).filter(part => {
      const supplierName = (()=>{ try { const s = state.suppliers.find(x => x.id === part.supplierId); return (s && s.name) || ''; } catch(_) { return ''; } })();
      const categoryName = (state.categories && part.category && state.categories[part.category]) ? state.categories[part.category] : '';
      const warehouseName = (state.warehouses && part.warehouse && state.warehouses[part.warehouse]) ? state.warehouses[part.warehouse] : '';
      const searchIn = [part.name, part.code, part.description, part.inventoryNumber, part.manufacturerNumber, part.umisteni, supplierName, categoryName, warehouseName].join(' ').toLowerCase();

      // AND token search (every word must match)
      if (tokens.length && !tokens.every(t => searchIn.includes(t))) return false;

      if (warehouseFilter !== 'all' && part.warehouse !== warehouseFilter) return false;
      if (categoryFilter !== 'all' && part.category !== categoryFilter) return false;
      if (machineFilter !== 'all' && part.machineId !== machineFilter) return false;

      // Smart filters
      if (mode === 'missing') {
        const miss = [];
        if (!part.category) miss.push('Kategorie');
        if (!part.warehouse) miss.push('Sklad');
        if (!part.supplierId) miss.push('Dodavatel');
        if (part.minStock === null || part.minStock === undefined) miss.push('Min');
        if (part.maxStock === null || part.maxStock === undefined) miss.push('Max');
        if (!part.umisteni) miss.push('Um√≠stƒõn√≠');
        if (miss.length === 0) return false;
      }
      if (mode === 'low') {
        let thr = 0;
        try { thr = getLowStockThreshold(part) || 0; } catch(_){ thr = 0; }
        if (!(part.currentStock === 0 || part.currentStock <= thr)) return false;
      }
      if (mode === 'recent') {
        const stamp = part.lastImportedAt || part.updatedAt || part.createdAt || null;
        if (!stamp) return false;
        const t = Date.parse(stamp);
        if (isNaN(t)) return false;
        if ((Date.now() - t) > 1000*60*60*48) return false; // last 48h
      }

      return true;
    });
  };

  // Reset sorting to default (Name A‚ÜíZ)
  window.resetSorting = function(){
    if (!state.sortConfig) state.sortConfig = { key: 'name', direction: 'ascending' };
    else { state.sortConfig.key = 'name'; state.sortConfig.direction = 'ascending'; }
    try { renderPartsTable(); } catch(_){}
    try { showAlert('OK','T≈ô√≠dƒõn√≠ vr√°ceno na v√Ωchoz√≠: N√°zev (A‚ÜíZ).','success'); } catch(_){}
  };

  document.addEventListener('DOMContentLoaded', function(){
    try { updateSmartChips(); } catch(_){}
  });
})();
</script>

<style>
#bulkWhBackdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;z-index:9998;}
#bulkWhModal{position:fixed;inset:12% 50% auto 50%;transform:translate(-50%,0);width:640px;max-width:94vw;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.2);display:none;z-index:9999;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
#bulkWhHeader{padding:12px 16px;background:#f6f7f9;border-bottom:1px solid #e8eaee;display:flex;justify-content:space-between;align-items:center}
#bulkWhBody{padding:16px;display:grid;gap:12px;}
#bulkWhFooter{padding:12px 16px;background:#fafbfc;border-top:1px solid #e8eaee;display:flex;justify-content:flex-end;gap:10px;}
.bulk-input{width:100%;padding:10px 12px;border:1px solid #d8dde4;border-radius:10px;outline:none;}
.bulk-input:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.15);}
.bulk-check{display:flex;gap:8px;align-items:center;font-size:13px;color:#333;}
.bulk-btn{padding:10px 14px;border-radius:10px;border:1px solid #d8dde4;background:#fff;cursor:pointer;}
.bulk-btn.primary{background:#4f46e5;border-color:#4f46e5;color:#fff;}
#bulkWhClose{cursor:pointer;border:none;background:transparent;font-size:22px;line-height:1;}
.bulk-note{font-size:12px;color:#555;}
</style>
<div id="bulkWhBackdrop"></div>
<div id="bulkWhModal" role="dialog" aria-modal="true" aria-labelledby="bulkWhTitle">
  <div id="bulkWhHeader">
    <div id="bulkWhTitle">Hromadnƒõ doplnit sklad</div>
    <button id="bulkWhClose" onclick="closeBulkWarehouse()">√ó</button>
  </div>
  <div id="bulkWhBody">
    <div>
      <label>Zvol sklad (existuj√≠c√≠ nebo napi≈° nov√Ω)</label>
      <input id="bulkWarehouseInput" class="bulk-input" list="warehouse-datalist" placeholder="nap≈ô. Brno">
      <datalist id="warehouse-datalist"></datalist>
    </div>
    <div class="bulk-check"><input type="checkbox" id="bulkApplyAll"><label for="bulkApplyAll">pou≈æ√≠t i na polo≈æky, kter√© u≈æ sklad maj√≠ (jinak jen na ty bez skladu)</label></div>
    <div class="bulk-note" id="bulkWhCount">Vybr√°no: ‚Äî polo≈æek</div>
  </div>
  <div id="bulkWhFooter">
    <button class="bulk-btn" onclick="closeBulkWarehouse()">Zru≈°it</button>
    <button class="bulk-btn primary" onclick="applyBulkWarehouse()">Pou≈æ√≠t</button>
  </div>
</div>
<script>
(function(){
  function listWarehouses(){
    try {
      const out = [];
      for (const [k,v] of Object.entries(state.warehouses||{})) out.push({key:k, name:String(v)});
      out.sort((a,b)=>a.name.localeCompare(b.name,'cs',{sensitivity:'base'}));
      return out;
    } catch(e){ return []; }
  }
  function ensureWarehouseKey(val){
    if (val==null) return null;
    const v = String(val).trim();
    if (!v) return null;
    // if exact key exists
    if (state.warehouses && state.warehouses.hasOwnProperty(v)) return v;
    // match by display value (case-insensitive)
    for (const [k,disp] of Object.entries(state.warehouses||{})) {
      if (String(disp).toLowerCase() === v.toLowerCase()) return k;
    }
    // create new key from name
    function slug5(txt){
      const t = String(txt).normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-zA-Z0-9]/g,'').toLowerCase();
      return (t||'novy').slice(0,5);
    }
    let key = slug5(v); let i = 1;
    while (state.warehouses && state.warehouses.hasOwnProperty(key)) {
      key = (slug5(v)+i).slice(0,5); i++;
    }
    if (!state.warehouses) state.warehouses = {};
    state.warehouses[key] = v;
    return key;
  }

  window.openBulkWarehouse = function(){
    try {
      // Fill datalist
      const dl = document.getElementById('warehouse-datalist');
      if (dl) {
        dl.innerHTML = (listWarehouses().map(w => `<option value="${w.name}"></option>`).join(''));
      }
      // Count candidates (current filtered set)
      const parts = (typeof getFilteredParts==='function' ? getFilteredParts() : (state.parts||[]));
      const onlyMissing = !document.getElementById('bulkApplyAll') || !document.getElementById('bulkApplyAll').checked;
      const candidates = parts.filter(p => onlyMissing ? !p.warehouse : true);
      const lbl = document.getElementById('bulkWhCount');
      if (lbl) lbl.textContent = 'Vybr√°no: ' + candidates.length + ' polo≈æek ' + (onlyMissing ? '(bez skladu)' : '(viditeln√©)');
    } catch(e){}
    document.getElementById('bulkWhBackdrop').style.display='block';
    document.getElementById('bulkWhModal').style.display='block';
  };

  window.closeBulkWarehouse = function(){
    document.getElementById('bulkWhBackdrop').style.display='none';
    document.getElementById('bulkWhModal').style.display='none';
  };

  window.applyBulkWarehouse = function(){
    const input = document.getElementById('bulkWarehouseInput');
    const name = input ? input.value.trim() : '';
    if (!name) { try { showAlert('Chyb√≠ n√°zev skladu','Zadej n√°zev skladu nebo vyber z nab√≠dky.','warning'); } catch(_){ alert('Zadej n√°zev skladu.'); } return; }
    const key = ensureWarehouseKey(name);
    const parts = (typeof getFilteredParts==='function' ? getFilteredParts() : (state.parts||[]));
    const applyAll = document.getElementById('bulkApplyAll') && document.getElementById('bulkApplyAll').checked;
    let count = 0;
    for (const p of parts) {
      if (!applyAll && p.warehouse) continue;
      p.warehouse = key;
      count++;
    }
    try { saveStateToLocalStorage(); } catch(_){}
    try { renderPartsTable(); } catch(_){}
    try { updateStats(); } catch(_){}
    closeBulkWarehouse();
    try { showAlert('Hotovo', 'Sklad p≈ôi≈ôazen u ' + count + ' polo≈æek.', 'success'); } catch(_){ alert('Sklad p≈ôi≈ôazen u ' + count + ' polo≈æek.'); }
  };

  // Update count when toggling the checkbox
  document.addEventListener('change', function(ev){
    if (ev.target && ev.target.id === 'bulkApplyAll') {
      try {
        const parts = (typeof getFilteredParts==='function' ? getFilteredParts() : (state.parts||[]));
        const onlyMissing = !document.getElementById('bulkApplyAll').checked;
        const candidates = parts.filter(p => onlyMissing ? !p.warehouse : true);
        const lbl = document.getElementById('bulkWhCount');
        if (lbl) lbl.textContent = 'Vybr√°no: ' + candidates.length + ' polo≈æek ' + (onlyMissing ? '(bez skladu)' : '(viditeln√©)');
      } catch(e){}
    }
  });
})();
</script>

<script>
(function(){
  if (!state.ui) state.ui = {};
  if (!state.ui.missingFilter) state.ui.missingFilter = { warehouse:false, category:false, supplier:false, min:false, max:false, umisteni:false };

  // Show/hide panel based on smart filter mode
  function syncMissingPanelVisibility(){
    const panel = document.getElementById('missing-filter-panel');
    if (!panel) return;
    const mode = (state.ui && state.ui.smartFilter) || 'all';
    panel.classList.toggle('active', mode === 'missing');
  }
  window.syncMissingPanelVisibility = syncMissingPanelVisibility;

  // Wire checkboxes
  function readMissingSelection(){
    const sel = state.ui.missingFilter || { warehouse:false, category:false, supplier:false, min:false, max:false, umisteni:false };
    const ids = ['warehouse','category','supplier','min','max','umisteni'];
    ids.forEach(k => {
      const el = document.getElementById('mf-'+k);
      if (el) el.checked = !!sel[k];
    });
  }
  function saveMissingSelection(){
    if (!state.ui) state.ui = {};
    if (!state.ui.missingFilter) state.ui.missingFilter = {};
    const ids = ['warehouse','category','supplier','min','max','umisteni'];
    ids.forEach(k => {
      const el = document.getElementById('mf-'+k);
      state.ui.missingFilter[k] = el ? !!el.checked : false;
    });
    try { renderPartsTable(); } catch(_){}
  }
  function clearMissingSelection(){
    if (!state.ui) state.ui = {};
    state.ui.missingFilter = { warehouse:false, category:false, supplier:false, min:false, max:false, umisteni:false };
    readMissingSelection();
    try { renderPartsTable(); } catch(_){}
  }
  window.clearMissingSelection = clearMissingSelection;

  document.addEventListener('change', function(ev){
    if (ev.target && /^mf-(warehouse|category|supplier|min|max|umisteni)$/.test(ev.target.id)) {
      saveMissingSelection();
    }
  });
  document.addEventListener('click', function(ev){
    if (ev.target && ev.target.id === 'mf-clear') {
      clearMissingSelection();
    }
  });

  // Counts of missing per field
  function updateMissingCounts(){
    try {
      const parts = state.parts || [];
      let cWh=0,cCat=0,cSup=0,cMin=0,cMax=0,cUm=0;
      for (const p of parts) {
        if (!p.warehouse) cWh++;
        if (!p.category) cCat++;
        if (!p.supplierId) cSup++;
        if (p.minStock === null || p.minStock === undefined) cMin++;
        if (p.maxStock === null || p.maxStock === undefined) cMax++;
        if (!p.umisteni) cUm++;
      }
      const set = (id,val)=>{ const el=document.getElementById(id); if (el) el.textContent = val ? '('+val+')' : ''; };
      set('mf-warehouse-count', cWh);
      set('mf-category-count', cCat);
      set('mf-supplier-count', cSup);
      set('mf-min-count', cMin);
      set('mf-max-count', cMax);
      set('mf-umisteni-count', cUm);
    } catch(e){}
  }
  window.updateMissingCounts = updateMissingCounts;

  // Hook into existing render to keep panel in sync
  const _origRender = window.renderPartsTable;
  window.renderPartsTable = function(){
    if (typeof _origRender === 'function') _origRender();
    syncMissingPanelVisibility();
    readMissingSelection();
    updateMissingCounts();
  };

  // Override getFilteredParts to respect selected missing fields when mode === 'missing'
  const _origGet = window.getFilteredParts;
  window.getFilteredParts = function(){
    const mode = (state.ui && state.ui.smartFilter) || 'all';
    const parts = (typeof _origGet === 'function') ? _origGet() : (state.parts || []);
    if (mode !== 'missing') return parts;
    const sel = state.ui.missingFilter || {};
    const anySelected = !!(sel.warehouse || sel.category || sel.supplier || sel.min || sel.max || sel.umisteni);
    function isMissing(p, key){
      switch(key){
        case 'warehouse': return !p.warehouse;
        case 'category': return !p.category;
        case 'supplier': return !p.supplierId;
        case 'min': return p.minStock === null || p.minStock === undefined;
        case 'max': return p.maxStock === null || p.maxStock === undefined;
        case 'umisteni': return !p.umisteni;
      }
      return false;
    }
    return parts.filter(p => {
      if (!anySelected) {
        // No specific fields selected -> show items missing ANY of the tracked fields
        return ( !p.warehouse || !p.category || !p.supplierId || p.minStock==null || p.maxStock==null || !p.umisteni );
      } else {
        // At least one field selected -> show items missing ANY of the selected fields
        const keys = ['warehouse','category','supplier','min','max','umisteni'].filter(k => sel[k]);
        return keys.some(k => isMissing(p, k));
      }
    });
  };

  document.addEventListener('DOMContentLoaded', function(){
    syncMissingPanelVisibility();
    readMissingSelection();
    updateMissingCounts();
  });
})();
</script>

<style>
#qePopover{position:fixed;z-index:9999;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);display:none;width:520px;max-width:94vw;}
#qeHeader{padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f9fafb;font-weight:600;}
#qeBody{padding:12px;display:grid;gap:10px;}
#qeFooter{padding:10px 12px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:8px;}
.qe-input,.qe-select{width:100%;padding:8px 10px;border:1px solid #d8dde4;border-radius:8px;outline:none;}
.qe-input:focus,.qe-select:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.15);}
.qe-btn{padding:8px 12px;border-radius:8px;border:1px solid #d8dde4;background:#fff;cursor:pointer;}
.qe-btn.primary{background:#4f46e5;border-color:#4f46e5;color:#fff;}
</style>
<div id="qePopover">
  <div id="qeHeader">Rychl√° √∫prava</div>
  <div id="qeBody">
    <div><label>Kategorie</label><input id="qeCategory" list="qeCatList" class="qe-input"><datalist id="qeCatList"></datalist></div>
    
    <div>
      <label>Dodavatel</label>
      <select id="qeSupplierSel" class="qe-select"></select>
      <div id="qeSupplierNewWrap" style="margin-top:8px; display:none;">
        <input id="qeSupplierNew" class="qe-input" placeholder="Nov√Ω dodavatel ‚Äì zadej jm√©no">
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
      <div><label>Min</label><input id="qeMin" type="number" min="0" class="qe-input"></div>
      <div><label>Max</label><input id="qeMax" type="number" min="0" class="qe-input"></div>

      <div><label>Priorita</label>
        <select id="qePriority" class="qe-select">
          <option value="">‚Äî</option>
          <option value="a">A</option>
          <option value="b">B</option>
          <option value="c">C</option>
          <option value="d">D</option>
        </select>
      </div>

    </div>
    
    <div><label>Sklad</label><input id="qeWh" list="qeWhList" class="qe-input"><datalist id="qeWhList"></datalist></div>
    <div><label>Um√≠stƒõn√≠</label><input id="qeUm" class="qe-input"></div>
  </div>
  <div id="qeFooter">
    <button class="qe-btn" onclick="qeClose()">Zav≈ô√≠t</button>
    <button class="qe-btn primary" onclick="qeSave()">Ulo≈æit</button>
  </div>
</div>
<script>
(function(){
  let qeCurrentId = null;
  function listCategories(){ const arr=[]; try{ for (const [k,v] of Object.entries(state.categories||{})) arr.push({key:k,name:String(v)});}catch(e){} arr.sort((a,b)=>a.name.localeCompare(b.name,'cs',{sensitivity:'base'})); return arr; }
  function listSuppliers(){ const arr=[]; try{ for (const s of (state.suppliers||[])) arr.push({id:s.id,name:s.name||('Dodavatel #'+s.id)});}catch(e){} arr.sort((a,b)=>a.name.localeCompare(b.name,'cs',{sensitivity:'base'})); return arr; }
  function fillSupplierSelect(selectedId){ const sel = document.getElementById('qeSupplierSel'); if (!sel) return; const list = listSuppliers(); sel.innerHTML = '<option value="">‚Äî</option>' + list.map(s=>`<option value="${s.id}">${s.name}</option>`).join('') + '<option value="__new__">+ Nov√Ω dodavatel‚Ä¶</option>'; sel.value = selectedId ? String(selectedId) : ''; const wrap = document.getElementById('qeSupplierNewWrap'); if (wrap) wrap.style.display = 'none'; }
  function listWarehouses(){ const arr=[]; try{ for (const [k,v] of Object.entries(state.warehouses||{})) arr.push({key:k,name:String(v)});}catch(e){} arr.sort((a,b)=>a.name.localeCompare(b.name,'cs',{sensitivity:'base'})); return arr; }
  function ensureWarehouseKey(val){ const v=String(val||'').trim(); if(!v) return null; if (state.warehouses && state.warehouses.hasOwnProperty(v)) return v; for (const [k,disp] of Object.entries(state.warehouses||{})) if (String(disp).toLowerCase()===v.toLowerCase()) return k; function slug5(t){ const x=String(t).normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-zA-Z0-9]/g,'').toLowerCase(); return (x||'novy').slice(0,5);} let key=slug5(v),i=1; while(state.warehouses && state.warehouses.hasOwnProperty(key)){ key=(slug5(v)+i).slice(0,5); i++; } if(!state.warehouses) state.warehouses={}; state.warehouses[key]=v; return key; }
  function ensureCategoryKey(val){
    const v=String(val||'').trim(); if(!v) return null;
    if (state.categories && state.categories.hasOwnProperty(v)) return v;
    for (const [k,disp] of Object.entries(state.categories||{})) if (String(disp).toLowerCase()===v.toLowerCase()) return k;
    // create
    function slugN(t,n){ const x=String(t).normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').replace(/[^a-zA-Z0-9]/g,'').toLowerCase(); return (x||'novy').slice(0,n)||'novy'; }
    let key=slugN(v,12),i=1; while(state.categories && state.categories.hasOwnProperty(key)){ key=(slugN(v,12)+i).slice(0,12); i++; }
    if (!state.categories) state.categories={}; state.categories[key]=v; return key;
  }
  function findOrCreateSupplierByName(nm){
    const name = String(nm||'').trim(); if (!name) return null;
    const ex = (state.suppliers||[]).find(s => (s.name||'').toLowerCase() === name.toLowerCase());
    if (ex) return ex.id;
    const newId = ((state.suppliers||[]).reduce((m,s)=>Math.max(m, s.id||0),0)||0) + 1;
    if (!state.suppliers) state.suppliers=[];
    state.suppliers.push({ id:newId, name, ico:'', contactPerson:'', email:'' });
    return newId;
  }
  function locateTableRows(){
    const tab = document.getElementById('tab-inventory');
    if (!tab) return [];
    let rows = Array.from(tab.querySelectorAll('table tbody tr'));
    if (rows.length) return rows;
    // fallback to any rows under a "table-body"-like container
    rows = Array.from(tab.querySelectorAll('tbody tr, .table-body .row'));
    return rows;
  }
  function mapRowsToParts(){
    const parts = (typeof getFilteredParts==='function' ? getFilteredParts() : (state.parts||[]));
    const rows = locateTableRows();
    const n = Math.min(parts.length, rows.length);
    for (let i=0;i<n;i++){
      const r = rows[i];
      r.setAttribute('data-part-id', parts[i].id);
      if (!r.getAttribute('data-qe-bound')) {
        r.setAttribute('data-qe-bound','1');
        r.addEventListener('dblclick', (ev)=>{
          const id = parseInt(r.getAttribute('data-part-id'),10);
          if (!isNaN(id)) openQuickEditorFor(id, ev.clientX, ev.clientY);
        });
      }
    }
  }
  window.openQuickEditorFor = function(id, x, y){
    const p = (state.parts||[]).find(pp => pp.id === id);
    if (!p) return;
    qeCurrentId = id;
    const catDL = document.getElementById('qeCatList'); if (catDL) catDL.innerHTML = listCategories().map(c=>`<option value="${c.name}"></option>`).join('');
    fillSupplierSelect(p.supplierId);
    const whDL = document.getElementById('qeWhList'); if (whDL) whDL.innerHTML = listWarehouses().map(w=>`<option value="${w.name}"></option>`).join('');
    document.getElementById('qeCategory').value = (p.category && state.categories && state.categories[p.category]) ? state.categories[p.category] : '';
    document.getElementById('qeSupplier').value = (function(){ const s=(state.suppliers||[]).find(s=>s.id===p.supplierId); return s && s.name ? s.name : ''; })();
    document.getElementById('qeMin').value = (p.minStock ?? '');
    document.getElementById('qeMax').value = (p.maxStock ?? '');
    const prSel = document.getElementById('qePriority'); if (prSel) prSel.value = (p.priority || '');
    const sel = document.getElementById('qeSupplierSel'); if (sel) sel.onchange = function(){ const wrap = document.getElementById('qeSupplierNewWrap'); if (!wrap) return; wrap.style.display = (this.value === '__new__') ? 'block' : 'none'; };
    document.getElementById('qeUm').value = (p.umisteni ?? '');
    document.getElementById('qeWh').value = (p.warehouse && state.warehouses && state.warehouses[p.warehouse]) ? state.warehouses[p.warehouse] : '';
    const box = document.getElementById('qePopover');
    box.style.display='block';
    // position near cursor with viewport bounds
    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
    const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
    const bx = Math.min(x+10, vw-540); const by = Math.min(y+10, vh-300);
    box.style.left = bx+'px'; box.style.top = by+'px';
  };
  window.qeClose = function(){ document.getElementById('qePopover').style.display='none'; qeCurrentId = null; };
  window.qeSave = function(){
    if (qeCurrentId == null) return;
    const p = (state.parts||[]).find(pp => pp.id === qeCurrentId); if (!p) return;
    const catName = document.getElementById('qeCategory').value.trim();
    const sel = document.getElementById('qeSupplierSel');
    const supSelVal = sel ? sel.value : '';
    const supNewName = (document.getElementById('qeSupplierNew') ? document.getElementById('qeSupplierNew').value.trim() : '');
    const minVal = document.getElementById('qeMin').value;
    const maxVal = document.getElementById('qeMax').value;
    const umiVal = document.getElementById('qeUm').value.trim();
    const whName = document.getElementById('qeWh').value.trim();

    if (catName) p.category = ensureCategoryKey(catName);
    if (supSelVal === '__new__' && supNewName) { p.supplierId = findOrCreateSupplierByName(supNewName); }
    else if (supSelVal) { const sid = parseInt(supSelVal,10); if (!isNaN(sid)) p.supplierId = sid; }
    if (minVal !== '') { const v=parseInt(minVal,10); if(!isNaN(v)) p.minStock=v; }
    if (maxVal !== '') { const v=parseInt(maxVal,10); if(!isNaN(v)) p.maxStock=v; }
    const prSel = document.getElementById('qePriority'); if (prSel) { const pv = prSel.value || null; p.priority = pv; }
    p.umisteni = umiVal;
    if (whName) p.warehouse = ensureWarehouseKey(whName);

    try { saveStateToLocalStorage(); } catch(_){}
    try { renderPartsTable(); } catch(_){}
    qeClose();
    try { showAlert('Ulo≈æeno','≈ò√°dek upraven.','success'); } catch(_){}
  };

  // Wrap renderPartsTable to map rows to parts after each render
  const _origRender = window.renderPartsTable;
  window.renderPartsTable = function(){
    if (typeof _origRender === 'function') _origRender();
    try { mapRowsToParts(); } catch(e){}
  };

  document.addEventListener('DOMContentLoaded', function(){
    try { mapRowsToParts(); } catch(e){}
  });
})();
</script>

<style>
#bulkEdBackdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;z-index:9998;}
#bulkEdModal{position:fixed;inset:8% 50% auto 50%;transform:translate(-50%,0);width:760px;max-width:96vw;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.2);display:none;z-index:9999;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
#bulkEdHeader{padding:12px 16px;background:#f6f7f9;border-bottom:1px solid #e8eaee;display:flex;justify-content:space-between;align-items:center}
#bulkEdBody{padding:16px;display:grid;gap:14px;}
#bulkEdFooter{padding:12px 16px;background:#fafbfc;border-top:1px solid #e8eaee;display:flex;justify-content:flex-end;gap:10px;}
.bulk-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.bulk-field{display:flex;flex-direction:column;gap:6px;}
.bulk-input,.bulk-select{width:100%;padding:10px 12px;border:1px solid #d8dde4;border-radius:10px;outline:none;}
.bulk-input:focus,.bulk-select:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.15);}
.bulk-btn{padding:10px 14px;border-radius:10px;border:1px solid #d8dde4;background:#fff;cursor:pointer;}
.bulk-btn.primary{background:#4f46e5;border-color:#4f46e5;color:#fff;}
.bulk-note{font-size:12px;color:#555;}
.inline-edit-hint{font-size:12px;color:#6b7280;}
</style>
<div id="bulkEdBackdrop"></div>
<div id="bulkEdModal" role="dialog" aria-modal="true" aria-labelledby="bulkEdTitle">
  <div id="bulkEdHeader">
    <div id="bulkEdTitle">Hromadn√Ω editor</div>
    <button class="bulk-btn" onclick="closeBulkEditor()">Zav≈ô√≠t</button>
  </div>
  <div id="bulkEdBody">
    <div class="bulk-grid">
      <div class="bulk-field">
        <label>Kategorie</label>
        <input id="bulkCategory" list="bulkCategoryList" class="bulk-input" placeholder="ponech pr√°zdn√© pokud nechce≈° mƒõnit">
        <datalist id="bulkCategoryList"></datalist>
        <div class="inline-edit-hint">Vypl≈à jm√©no kategorie (nov√° se automaticky zalo≈æ√≠).</div>
      </div>
      <div class="bulk-field">
        <label>Dodavatel</label>
        <input id="bulkSupplier" list="bulkSupplierList" class="bulk-input" placeholder="ponech pr√°zdn√© pokud nechce≈° mƒõnit">
        <datalist id="bulkSupplierList"></datalist>
        <div class="inline-edit-hint">Zadej jm√©no dodavatele (nov√Ω se zalo≈æ√≠).</div>
      </div>
      <div class="bulk-field">
        <label>Min</label>
        <input id="bulkMin" class="bulk-input" type="number" min="0" placeholder="‚Äî">
      </div>
      <div class="bulk-field">
        <label>Max</label>
        <input id="bulkMax" class="bulk-input" type="number" min="0" placeholder="‚Äî">
      </div>
      <div class="bulk-field" style="grid-column:1 / -1;">
        <label>Um√≠stƒõn√≠</label>
        <input id="bulkUmisteni" class="bulk-input" placeholder="ponech pr√°zdn√© pokud nechce≈° mƒõnit">
      </div>
    </div>
    <label style="display:flex;gap:8px;align-items:center;"><input type="checkbox" id="bulkOnlyMissing"> Pou≈æ√≠t jen tam, kde hodnota chyb√≠</label>
    <div class="bulk-note" id="bulkEdCount">Vybr√°no: ‚Äî polo≈æek</div>
  </div>
  <div id="bulkEdFooter">
    <button class="bulk-btn" onclick="closeBulkEditor()">Zru≈°it</button>
    <button class="bulk-btn primary" onclick="applyBulkEditor()">Pou≈æ√≠t</button>
  </div>
</div>
<script>
(function(){
  function listCategories(){
    const arr=[]; try{ for (const [k,v] of Object.entries(state.categories||{})) arr.push({key:k,name:String(v)});}catch(e){}
    arr.sort((a,b)=>a.name.localeCompare(b.name,'cs',{sensitivity:'base'})); return arr;
  }
  function listSuppliers(){
    const arr=[]; try{ for (const s of (state.suppliers||[])) arr.push({id:s.id,name:s.name||('Dodavatel #'+s.id)});}catch(e){}
    arr.sort((a,b)=>a.name.localeCompare(b.name,'cs',{sensitivity:'base'})); return arr;
  }
  function slugN(t,n){ const x=String(t).normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').replace(/[^a-zA-Z0-9]/g,'').toLowerCase(); return (x||'novy').slice(0,n)||'novy'; }
  function ensureCategoryKey(val){
    if (val==null) return null; const v=String(val).trim(); if (!v) return null;
    if (state.categories && state.categories.hasOwnProperty(v)) return v;
    for (const [k,disp] of Object.entries(state.categories||{})) if (String(disp).toLowerCase()===v.toLowerCase()) return k;
    let key=slugN(v,12),i=1; while (state.categories && state.categories.hasOwnProperty(key)) { key=(slugN(v,12)+i).slice(0,12); i++; }
    if (!state.categories) state.categories={}; state.categories[key]=v; return key;
  }
  function findOrCreateSupplierByName(name){
    const nm = String(name||'').trim(); if (!nm) return null;
    const ex = (state.suppliers||[]).find(s => (s.name||'').toLowerCase() === nm.toLowerCase());
    if (ex) return ex.id;
    const newId = ((state.suppliers||[]).reduce((m,s)=>Math.max(m, s.id||0),0)||0) + 1;
    if (!state.suppliers) state.suppliers=[];
    state.suppliers.push({ id:newId, name:nm, ico:'', contactPerson:'', email:'' });
    return newId;
  }

  window.openBulkEditor = function(){
    // Fill datalists
    const catDL = document.getElementById('bulkCategoryList');
    const supDL = document.getElementById('bulkSupplierList');
    if (catDL) catDL.innerHTML = listCategories().map(c=>`<option value="${c.name}"></option>`).join('');
    if (supDL) supDL.innerHTML = listSuppliers().map(s=>`<option value="${s.name}"></option>`).join('');
    // Count candidates
    const parts = (typeof getFilteredParts==='function' ? getFilteredParts() : (state.parts||[]));
    document.getElementById('bulkEdCount').textContent = 'Vybr√°no: ' + parts.length + ' polo≈æek (aktu√°lnƒõ zobrazen√©)';
    document.getElementById('bulkEdBackdrop').style.display='block';
    document.getElementById('bulkEdModal').style.display='block';
  };
  window.closeBulkEditor = function(){
    document.getElementById('bulkEdBackdrop').style.display='none';
    document.getElementById('bulkEdModal').style.display='none';
  };
  window.applyBulkEditor = function(){
    const parts = (typeof getFilteredParts==='function' ? getFilteredParts() : (state.parts||[]));
    const onlyMissing = document.getElementById('bulkOnlyMissing').checked;

    const catName = (document.getElementById('bulkCategory').value||'').trim();
    const supName = (document.getElementById('bulkSupplier').value||'').trim();
    const minVal = document.getElementById('bulkMin').value;
    const maxVal = document.getElementById('bulkMax').value;
    const umiVal = (document.getElementById('bulkUmisteni').value||'').trim();

    const catKey = catName ? ensureCategoryKey(catName) : null;
    const supId  = supName ? findOrCreateSupplierByName(supName) : null;
    const hasMin = (minVal !== '');
    const hasMax = (maxVal !== '');
    const hasUmi = (umiVal !== '');

    let changed = 0;
    for (const p of parts) {
      if (catKey) {
        if (!onlyMissing || !p.category) { p.category = catKey; changed++; }
      }
      if (supId) {
        if (!onlyMissing || !p.supplierId) { p.supplierId = supId; changed++; }
      }
      if (hasMin) {
        const v = parseInt(minVal,10); if (!isNaN(v)) { if (!onlyMissing || p.minStock==null) { p.minStock = v; changed++; } }
      }
      if (hasMax) {
        const v = parseInt(maxVal,10); if (!isNaN(v)) { if (!onlyMissing || p.maxStock==null) { p.maxStock = v; changed++; } }
      }
      if (hasUmi) {
        if (!onlyMissing || !p.umisteni) { p.umisteni = umiVal;
    if (whName) p.warehouse = ensureWarehouseKey(whName); changed++; }
      }
    }
    try { saveStateToLocalStorage(); } catch(_){}
    try { renderPartsTable(); } catch(_){}
    try { updateStats(); } catch(_){}
    closeBulkEditor();
    try { showAlert('Hotovo', 'Upraveno hodnot: ' + changed + ' (nap≈ô√≠ƒç polo≈ækami).', 'success'); } catch(_){ alert('Upraveno: ' + changed); }
  };
})();
</script>
<script>

// --- Revize & √ödr≈æba: p≈ôehled (tab) ---
function _daysUntil(dateStr){
  if (!dateStr) return null;
  const ms = 24*60*60*1000;
  const d = Math.ceil((new Date(dateStr).setHours(0,0,0,0) - new Date().setHours(0,0,0,0))/ms);
  return d;
}
function _statusBadge(days){
  if (days === null || days === undefined) return {label:'‚Äî', cls:'badge-gray'};
  if (days < 0) return {label:`Po term√≠nu ${Math.abs(days)} d`, cls:'badge-red'};
  if (days <= 7) return {label:`Za ${days} d`, cls:'badge-orange'};
  if (days <= 30) return {label:`Za ${days} d`, cls:'badge-yellow'};
  return {label:`${days} d`, cls:'badge-green'};
}
function _maintNext(t){
  if (!t) return null;
  if (t.next) return t.next;
  if (t.last && t.freqDays) return addDays(t.last, t.freqDays);
  return null;
}
function getServiceEvents(){
  const out = [];
  const machines = state.machines || {};
  Object.entries(machines).forEach(([id, name])=>{
    try { ensureMachineMeta(id); } catch(_){}
    const mm = state.machineMeta?.[id] || {};
    // Revize
    const last = mm.revision?.last || null;
    const per = mm.revision?.periodicityDays || null;
    const next = mm.revision?.next || (last && per ? addDays(last, per) : null);
    const days = next ? _daysUntil(next) : null;
    out.push({
      id: `r:${id}`,
      machineId:id, machine:name, type:'Revize', task:'‚Äî', responsible:mm.revision?.responsible||'',
      freq: per? `${per} d`:'‚Äî', last, next, days, note: mm.revision?.note||''
    });
    // Maintenance tasks
    (mm.maintenance?.tasks || []).forEach((t,i)=>{
      const nx = _maintNext(t);
      const d = nx ? _daysUntil(nx) : null;
      out.push({
        id: `m:${id}:${i}`,
        machineId:id, machine:name, type:'√ödr≈æba', task:(t.task||''), responsible:(t.responsible||mm.revision?.responsible||''),
        freq: t.freqDays? `${t.freqDays} d`:'‚Äî', last: (t.last||''), next: nx, days:d, note: ''
      });
    });
  });
  return out;
}


// Vizu√°ln√≠ ≈°t√≠tek podle typu (Revize/√ödr≈æba)
function typeBadge(t){
  if (t === 'Revize') return `<span class="tag tag--revize"><span class="type-icon">üîé</span>Revize</span>`;
  return `<span class="tag tag--udrzba"><span class="type-icon">üîß</span>√ödr≈æba</span>`;
}
function renderRevisionsTab(){
  const tbody = document.getElementById('revisions-table-body');
  const nores = document.getElementById('revisions-no-results');
  const search = (document.getElementById('rev-search-input')?.value || '').toLowerCase();
  if (!state.ui) state.ui = {};
  const mode = state.ui.revFilter || 'all';
  const typeMode = state.ui.revType || 'all';
  if (!state.ui) state.ui = {};
  if (!state.ui.revSel) state.ui.revSel = {};
  const sel = state.ui.revSel;
  const rows = getServiceEvents()
    .filter(e => {
      // search filter
      const hay = (e.machine + ' ' + e.type + ' ' + (e.task||'') + ' ' + (e.responsible||'')).toLowerCase();
      if (search && !hay.includes(search)) return false;
      // mode filter (time)
      if (mode === 'overdue') return (e.days != null && e.days < 0);
      if (mode === '7') return (e.days != null && e.days >= 0 && e.days <= 7);
      if (mode === '30') return (e.days != null && e.days >= 8 && e.days <= 30);
      if (mode === 'later') return (e.days != null && e.days > 30);
      if (mode === 'nodate') return (e.next == null);
      if (mode === 'selected') return !!(state.ui && state.ui.revSel && state.ui.revSel[e.id]);
      // type filter
      if (typeMode === 'Revize' && e.type !== 'Revize') return false;
      if (typeMode === '√ödr≈æba' && e.type !== '√ödr≈æba') return false;
      return true;
    })
    .sort((a,b)=>{
      // Sort by next date (nulls last), then type
      if (a.next && b.next) return new Date(a.next)-new Date(b.next);
      if (a.next && !b.next) return -1;
      if (!a.next && b.next) return 1;
      return a.type.localeCompare(b.type,'cs');
    });

  if (!rows.length){ tbody.innerHTML=''; nores.classList.remove('hidden'); return; }
  nores.classList.add('hidden');
  tbody.innerHTML = rows.map(e => {
    const st = _statusBadge(e.days);
    // Normalise and correct data positions.  Some imported datasets may
    // misplace values across columns.  Start by extracting all fields
    // with fallbacks to dashes.
        let taskVal = e.task || '‚Äî';
        let responsibleVal = e.responsible || '‚Äî';
        let freqVal = e.freq || '‚Äî';
        let lastVal = e.last || '‚Äî';
        let nextVal = e.next || '‚Äî';

        // For √ödr≈æba rows, recompute frequency, last and next from the underlying task in state.
        // Some imported or newly created tasks may have misplaced values; by consulting
        // state.machineMeta we ensure the frequency appears in the correct column and
        // last/next reflect true dates.  The event id is formatted as "m:machineId:index".
        if (e.type === '√ödr≈æba') {
          try {
            const parts = String(e.id).split(':');
            if (parts.length === 3) {
              const machineId = parts[1];
              const idx = parseInt(parts[2], 10);
              const task = state?.machineMeta?.[machineId]?.maintenance?.tasks?.[idx];
              if (task) {
                // Frequency stored in freqDays
                if (task.freqDays) freqVal = `${task.freqDays} d`;
                // Last maintenance date (ISO string) or empty
                lastVal = task.last || '‚Äî';
                // Next due date if defined
                nextVal = task.next || '‚Äî';
              }
            }
          } catch(_e) {}
        }
        // If the frequency is missing but the "last" field looks like a day count (e.g. "30 d"),
        // then the frequency and last values have likely been swapped during import or data entry.
        // This can occur for both "Revize" and "√ödr≈æba" events.  In such a case assign the
        // frequency from the last value and shift the subsequent columns left.  We intentionally
        // remove the previous next value because it is unknown in this context.
        // Detect when the last column contains a duration (e.g. "30 d") but the frequency column
        // does not.  In such a case the values have likely been shifted one column to the right.
        // Swap them back: move the day-count into the frequency column, shift last‚Üínext and drop
        // the original next because it is unknown.
        if (/^\d+(\s*d)?$/.test(String(lastVal)) && !/^\d+(\s*d)?$/.test(String(freqVal))) {
          const tmp = lastVal;
          freqVal = tmp;
          lastVal = nextVal;
          nextVal = '‚Äî';
        }
    // For maintenance rows (√ödr≈æba), sometimes imports omit the task (and
    // even the responsible person) causing all subsequent fields to shift
    // left.  Detect and shift one or two positions to the right.
    if (e.type === '√ödr≈æba') {
      // Single-column shift: task missing, but responsibleVal and freqVal
      // populated, and lastVal is a date string (YYYY-MM-DD).  Shift
      // responsible‚Üítask, freq‚Üíresponsible, last‚Üífreq, next‚Üílast.
      const isShift1 = (!e.task || e.task.trim() === '') &&
                       responsibleVal !== '‚Äî' &&
                       freqVal !== '‚Äî' &&
                       typeof lastVal === 'string' && /\d{4}-\d{2}-\d{2}/.test(String(lastVal));
      // Two-column shift: both task and responsible missing, freqVal holds
      // the task, lastVal holds the responsible, and nextVal holds the
      // frequency.  Shift accordingly and clear last and next.
      const isShift2 = (!e.task || e.task.trim() === '') &&
                       (!e.responsible || e.responsible.trim() === '') &&
                       freqVal !== '‚Äî' &&
                       lastVal !== '‚Äî' &&
                       nextVal !== '‚Äî';
      if (isShift1) {
        const newTask = responsibleVal;
        const newResp = freqVal;
        const newFreq = lastVal;
        const newLast = nextVal;
        taskVal = newTask;
        responsibleVal = newResp;
        freqVal = newFreq;
        lastVal = newLast;
        nextVal = '‚Äî';
      } else if (isShift2) {
        const newTask = freqVal;
        const newResp = lastVal;
        const newFreq = nextVal;
        taskVal = newTask;
        responsibleVal = newResp;
        freqVal = newFreq;
        lastVal = '‚Äî';
        nextVal = '‚Äî';
      }
    }
    return `<tr class="${e.type==='Revize' ? 'row--revize' : 'row--udrzba'}" data-machine-id="${e.machineId}" data-eid="${e.id}">
      <td class="sel"><input type="checkbox" class="rev-row-check" data-eid="${e.id}" ${(state.ui?.revSel && state.ui.revSel[e.id]) ? 'checked' : ''}></td>
      <td>
        <div><a href="#" onclick="goToMachine('${e.machineId}');return false;" class="font-medium link" title="Otev≈ô√≠t detail za≈ô√≠zen√≠">${e.machine}</a></div>
        <div class="text-gray-500">${e.machineId}</div>
        <div style="margin-top:4px;">${typeBadge(e.type)}</div>
      </td>
      <td class="cell-wrap"><span title="${taskVal==='‚Äî' ? '' : taskVal}">${taskVal}</span></td>
      <td>${responsibleVal}</td>
      <td>${freqVal}</td>
      <td>${lastVal}</td>
      <td>${nextVal}</td>
      <td><span class="badge ${st.cls}">${st.label}</span></td>
      <td class="cell-wrap"><span class="clamp-2" title="${e.note || ''}">${e.note || '‚Äî'}</span></td>
    </tr>`;
  }).join('');

  // Bind row checkboxes
  document.querySelectorAll('.rev-row-check').forEach(cb => {
    if (!cb._bind){
      cb.addEventListener('change', (e)=>{
        const id = cb.getAttribute('data-eid');
        if (cb.checked) sel[id] = true; else delete sel[id];
        saveStateToLocalStorage();
        updateBulkBar();
      });
      cb._bind = true;
    }
  });

  // Master checkbox
  const master = document.getElementById('rev-master');
  if (master && !master._bind){
    master.addEventListener('change', ()=>{
      const visibleIds = Array.from(document.querySelectorAll('#revisions-table tbody tr')).map(tr => tr.getAttribute('data-eid'));
      if (master.checked) visibleIds.forEach(id => { if (id) sel[id] = true; });
      else visibleIds.forEach(id => { if (id) delete sel[id]; });
      saveStateToLocalStorage();
      renderRevisionsTab();
    });
    master._bind = true;
  }
  // Set master state
  if (master){
    const visibleIds = Array.from(document.querySelectorAll('#revisions-table tbody tr')).map(tr => tr.getAttribute('data-eid')).filter(Boolean);
    const allSelected = visibleIds.length>0 && visibleIds.every(id => !!sel[id]);
    master.checked = allSelected;
    master.indeterminate = !allSelected && visibleIds.some(id => !!sel[id]);
  }

  updateBulkBar();

  // Reset horizontal scroll to the far left after rendering.  Without this
  // reset, the table container may retain its previous scroll position
  // when switching filters or tabs, causing the left-most columns to be
  // hidden off-screen.
  (function(){
    const revTable = document.getElementById('revisions-table');
    if (revTable && revTable.parentElement && typeof revTable.parentElement.scrollLeft === 'number') {
      revTable.parentElement.scrollLeft = 0;
    }
  })();

  // Bind search input
  const inp = document.getElementById('rev-search-input');
  if (inp && !inp._bind){ inp.addEventListener('input', debounce(renderRevisionsTab, 250)); inp._bind = true; }

  // Smart chips binding
  const chips = document.querySelectorAll('#rev-smart-chips .smart-chip');
  // Type chips binding
  const typeChips = document.querySelectorAll('#rev-type-chips .smart-chip');
  typeChips.forEach(btn => {
    const val = btn.getAttribute('data-type');
    if (!btn._bind){
      btn.addEventListener('click', ()=>{
        if (!state.ui) state.ui = {};
        state.ui.revType = val;
        typeChips.forEach(b=> b.classList.toggle('active', b===btn));
        renderRevisionsTab();
      });
      btn._bind = true;
    }
    btn.classList.toggle('active', (val === (state.ui.revType || 'all')));
  });

  chips.forEach(btn => {
    if (!btn._bind){
      btn.addEventListener('click', ()=>{
        state.ui.revFilter = btn.getAttribute('data-mode');
        chips.forEach(b=> b.classList.toggle('active', b===btn));
        renderRevisionsTab();
      });
      btn._bind = true;
    }
    btn.classList.toggle('active', (btn.getAttribute('data-mode') === mode));
  });
}

// Hook: default filter
document.addEventListener('DOMContentLoaded', function(){ if (!state.ui) state.ui = {}; state.ui.revFilter = state.ui.revFilter || 'all'; });
</script>

<style>
/* --- Revize vs √ödr≈æba vizu√°ln√≠ rozli≈°en√≠ --- */
/* Zajist√≠ fungov√°n√≠ pseudo-elementu v ≈ô√°dc√≠ch tabulky */
#revisions-table tbody tr { position: relative; }

/* Solid akcent pro Revizi */
.row--revize::before {
  content: "";
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 4px;
  background: #1d4ed8; /* modr√° */
  border-radius: 2px;
}

/* Dashed akcent pro √ödr≈æbu (vzor pomoc√≠ repeating-linear-gradient) */
.row--udrzba::before {
  content: "";
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 4px;
  background: repeating-linear-gradient(
    to bottom,
    #065f46 0 8px,      /* pln√° ƒç√°st */
    transparent 8px 14px /* mezera */
  );
  border-radius: 2px;
}

/* ≈†t√≠tky typu v bu≈àce "Typ" */
.tag { display:inline-flex; align-items:center; gap:6px; padding:2px 10px;
       border-radius:9999px; font-weight:600; font-size:12px; }
.tag--revize  { background:#e6f0ff; color:#1d4ed8; }
.tag--udrzba  { background:#ecfdf5; color:#065f46; }
.type-icon { font-size:14px; line-height:1; }
</style>


<style>
/* Zv√Ωraznƒõn√≠ c√≠lov√©ho ≈ô√°dku po p≈ôeskoƒçen√≠ */
@keyframes flashHighlight {
  0%   { background-color: #fff3c4; }
  100% { background-color: transparent; }
}
.highlight-flash { animation: flashHighlight 2.2s ease-out 1; }
</style>


<script>
// Cross-link helpers
function goToMachine(machineId){
  try { showTab('machines'); } catch(_) {}
  setTimeout(function(){ try { openMachineDetail(machineId); } catch(_) {} }, 0);
  return false;
}
function highlightRevisionRow(machineId){
  try {
    const rows = document.querySelectorAll('#revisions-table tbody tr');
    let first = null;
    rows.forEach(tr => {
      if (tr.getAttribute('data-machine-id') === machineId){
        tr.classList.remove('highlight-flash'); // restart animation
        void tr.offsetWidth;
        tr.classList.add('highlight-flash');
        if (!first) first = tr;
      }
    });
    if (first) first.scrollIntoView({behavior:'smooth', block:'center'});
  } catch(e){}
}
function goToRevisions(machineId){
  try { showTab('revisions'); } catch(_) {}
  setTimeout(function(){
    try {
      if (!state.ui) state.ui = {};
      if (!state.ui.revFilter) state.ui.revFilter = 'all';
      renderRevisionsTab();
      highlightRevisionRow(machineId);
    } catch(_){}
  }, 0);
  return false;
}
</script>


<style>
/* --- Device detail layout polish --- */
.modal .subgrid { display:grid; grid-template-columns: 1.9fr 1.1fr; gap:16px; }
@media (max-width: 980px) { .modal .subgrid { grid-template-columns: 1fr; } }
.section-title { font-weight:700; font-size:16px; margin:2px 0 8px; }
.kv { display:grid; grid-template-columns: 120px 1fr; gap:8px; font-size:14px; }
.kv div:first-child { color:#6b7280; } /* gray-500 */
.inline-actions { display:flex; gap:8px; flex-wrap:wrap; }
.small-muted { color:#6b7280; font-size:12px; }
hr.soft { border:0; height:1px; background:rgba(0,0,0,0.06); margin:12px 0; }
.badge-large { padding:6px 10px; border-radius:9999px; font-weight:700; font-size:12px; }
.btn-ghost { background:transparent; border:1px dashed rgba(0,0,0,0.15); }
.link { text-decoration: underline; text-underline-offset: 2px; }
</style>


<script>
function todayISO(){ const d = new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }

function markRevisionToday(machineId){
  ensureMachineMeta(machineId);
  const m = state.machineMeta[machineId];
  m.revision.last = todayISO();
  recomputeRevision(machineId);
  saveStateToLocalStorage();
  try { renderMachinesTable(); } catch(_){}
  openMachineDetail(machineId);
  showAlert && showAlert('Ulo≈æeno', 'Revize oznaƒçena jako provedena dnes.', 'success');
}

function markMaintToday(machineId, idx){
  ensureMachineMeta(machineId);
  const t = state.machineMeta[machineId].maintenance.tasks[idx];
  if (!t) return;
  t.last = todayISO();
  // recompute next
  if (t.freqDays) t.next = addDays(t.last, t.freqDays);
  saveStateToLocalStorage();
  openMachineDetail(machineId);
  showAlert && showAlert('Ulo≈æeno', '√ödr≈æba oznaƒçena jako provedena dnes.', 'success');
}
</script>


<style>
/* Full-size toggle for device detail modal */
.modal.modal--full {
  width: 98vw !important;
  max-width: 98vw !important;
  height: 94vh !important;
  max-height: 94vh !important;
}
.modal.modal--full .modal-content {
  overflow: auto;
  max-height: calc(94vh - 96px); /* header + actions approx */
}
/* Make modal behave as column so content can grow */
.modal { display: flex; flex-direction: column; }
.modal .modal-content { flex: 1 1 auto; }
</style>


<script>
function toggleFullModal(btn){
  try {
    const modal = btn.closest('.modal');
    if (!modal) return;
    const full = modal.classList.toggle('modal--full');
    btn.textContent = full ? '‚§° Zpƒõt' : '‚§¢ Roz≈°√≠≈ôit';
  } catch(e){}
}
</script>


<style>
/* --- UI polish for Revize tab --- */
/* Subtle link style for table (no default blue) */
.table a.link { color: inherit; text-decoration: none; font-weight:600; }
.table a.link:hover { text-decoration: underline; }
.table a.link:visited { color: inherit; }

/* Sticky table header */
#revisions-table thead th {
  position: sticky;
  top: 0;
  background: #f8fafc; /* light */
  z-index: 1;
}

/* Align some columns */
#revisions-table th:nth-child(7),
#revisions-table td:nth-child(7) { text-align: center; }

/* Keep dates on one line */
#revisions-table td:nth-child(6),
#revisions-table td:nth-child(7) { white-space: nowrap; }

/* Softer row hover */
#revisions-table tbody tr:hover { background: #f5f7fb; }

/* Slim export buttons */
.btn.btn-outline.btn-slim { padding:6px 10px; border-radius:10px; }
</style>


<style>
/* --- Better text fit for Revize table --- */
#revisions-table { table-layout: auto; }
#revisions-table th, #revisions-table td { vertical-align: middle; }

/* Allow wrapping where it matters */
#revisions-table td.cell-wrap { white-space: normal; word-break: break-word; overflow-wrap: anywhere; }

/* Two-line clamp for notes (keeps rows compact) */
.clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

/* Reasonable column widths */

#revisions-table th:nth-child(8), #revisions-table td:nth-child(8) { width: 140px; } /* Stav */
#revisions-table th:nth-child(5), #revisions-table td:nth-child(5) { width: 160px; text-align:center; } /* Periodicita */
#revisions-table th:nth-child(6), #revisions-table td:nth-child(6),
#revisions-table th:nth-child(7), #revisions-table td:nth-child(7) { width: 140px; white-space: nowrap; } /* Posledn√≠, P≈ô√≠≈°t√≠ */
</style>


<style>
/* Refined layout widths: readable line length in device detail */
.modal .subgrid { grid-template-columns: 1.6fr 520px; }
@media (min-width: 1500px) {
  .modal .subgrid { grid-template-columns: 1.8fr 560px; }
}
@media (max-width: 1100px) {
  .modal .subgrid { grid-template-columns: 1fr; }
}
/* Ensure inputs don't stretch beyond card width */
.settings-card .form-input { max-width: 100%; }
/* Tweak kv grid labels for consistency */
.kv { grid-template-columns: 110px 1fr; }
</style>


<style>
/* --- Collapsible & wide sections in device detail --- */
.section { background:#fff; border-radius:14px; box-shadow: 0 1px 0 rgba(0,0,0,0.05); }
.section .section-header { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; }
.section .section-title { font-weight:700; font-size:16px; }
.section .section-actions { display:flex; gap:8px; }
.btn-icon { padding:6px 10px; border-radius:10px; background:#f3f4f6; border:1px solid #e5e7eb; }
.btn-icon:hover { background:#eef2ff; }
.section .section-body { padding: 8px 12px 12px; }

.section--collapsed .section-body { display:none; }
.section--wide { grid-column: 1 / -1; }

/* Ensure cards inside section look good */
.section .settings-card { box-shadow:none; padding:0; border:none; }
.section .settings-card .section-title { margin: 0 0 8px; }

/* Reduce excessive margins when inside section body */
.section .table-container { margin: 0; }

/* Make left column parts section span both columns when desired */
.modal .subgrid { display:grid; grid-template-columns: 1.6fr 520px; gap:16px; }
@media (min-width: 1500px) { .modal .subgrid { grid-template-columns: 1.8fr 560px; } }
@media (max-width: 1100px) { .modal .subgrid { grid-template-columns: 1fr; } }

/* Small muted helper */
.small-muted { color:#6b7280; font-size:12px; }
</style>


<script>
function toggleSectionCollapse(id){
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.toggle('section--collapsed');
}
function toggleSectionWide(id){
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.toggle('section--wide');
}
</script>


<style>
/* Drag & Drop styling for sections */
.section { position: relative; }
.section[draggable="true"] .section-header { cursor: move; }
.section.dragging { opacity: 0.6; }
.section.drop-before { box-shadow: inset 0 3px 0 #a3bffa; }
.section.drop-after  { box-shadow: inset 0 -3px 0 #a3bffa; }

/* Chips for maintenance filter */
.chips { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px; }
.chip { padding:6px 10px; border:1px solid #e5e7eb; border-radius:9999px; background:#f9fafb; font-weight:600; font-size:12px; }
.chip.active { background:#eef2ff; border-color:#c7d2fe; color:#4338ca; }
</style>


<script>
function readSectionOrder(container){
  return Array.from(container.querySelectorAll('section[id]')).map(s=>s.id);
}
function applySectionOrderFromState(machineId){
  const cont = document.querySelector('#machine-detail-modal .subgrid');
  if (!cont) return;
  ensureMachineMeta(machineId);
  const ui = state.machineMeta[machineId].ui || (state.machineMeta[machineId].ui={});
  const current = readSectionOrder(cont);
  if (!ui.sectionsOrder || !Array.isArray(ui.sectionsOrder) || !ui.sectionsOrder.length){
    ui.sectionsOrder = current;
    saveStateToLocalStorage();
    return;
  }
  // Reorder DOM to match saved order (ignore missing/extra)
  ui.sectionsOrder.forEach(id=>{
    const el = cont.querySelector('#'+id);
    if (el) cont.appendChild(el);
  });
}
function saveSectionOrder(machineId){
  const cont = document.querySelector('#machine-detail-modal .subgrid');
  if (!cont) return;
  ensureMachineMeta(machineId);
  const order = readSectionOrder(cont);
  state.machineMeta[machineId].ui = state.machineMeta[machineId].ui || {};
  state.machineMeta[machineId].ui.sectionsOrder = order;
  saveStateToLocalStorage();
}
function initDetailSectionsDnD(machineId){
  const cont = document.querySelector('#machine-detail-modal .subgrid');
  if (!cont) return;
  cont.querySelectorAll('section').forEach(sec=>{
    if (sec._dnd) return;
    // drag only by header, but set draggable on section
    sec.setAttribute('draggable','true');
    sec.addEventListener('dragstart', (e)=>{
      sec.classList.add('dragging');
      e.dataTransfer.setData('text/plain', sec.id);
    });
    sec.addEventListener('dragend', ()=>{
      sec.classList.remove('dragging');
      cont.querySelectorAll('.drop-before,.drop-after').forEach(el=>el.classList.remove('drop-before','drop-after'));
    });
    sec.addEventListener('dragover', (e)=>{
      e.preventDefault();
      const bbox = sec.getBoundingClientRect();
      const mid = bbox.top + bbox.height/2;
      cont.querySelectorAll('.drop-before,.drop-after').forEach(el=>el.classList.remove('drop-before','drop-after'));
      if (e.clientY < mid) sec.classList.add('drop-before'); else sec.classList.add('drop-after');
    });
    sec.addEventListener('dragleave', ()=>{
      sec.classList.remove('drop-before','drop-after');
    });
    sec.addEventListener('drop', (e)=>{
      e.preventDefault();
      const sourceId = e.dataTransfer.getData('text/plain');
      const src = document.getElementById(sourceId);
      if (!src || src===sec) return;
      const bbox = sec.getBoundingClientRect();
      const mid = bbox.top + bbox.height/2;
      if (e.clientY < mid) cont.insertBefore(src, sec); else cont.insertBefore(src, sec.nextSibling);
      cont.querySelectorAll('.drop-before,.drop-after').forEach(el=>el.classList.remove('drop-before','drop-after'));
      saveSectionOrder(machineId);
    });
    sec._dnd = true;
  });
}
</script>


<style>
/* Bulk actions bar */
#rev-bulkbar { display:flex; align-items:center; gap:8px; padding:10px; border:1px solid #e5e7eb; border-radius:12px; background:#f9fafb; }
#rev-bulkbar.hidden { display:none; }
#rev-bulkbar .count { font-weight:700; margin-right:8px; }
#rev-bulkbar .btn { padding:6px 10px; border-radius:10px; }
#rev-bulkbar .btn-danger { background:#ef4444; color:#fff; }
#rev-bulkbar .btn-secondary { background:#e5e7eb; }
#rev-bulkbar .btn-success { background:#22c55e; color:#fff; }

/* Selection cell */
#revisions-table td.sel, #revisions-table th.sel { width:28px; text-align:center; }
#revisions-table td.sel input[type="checkbox"] { width:16px; height:16px; }
</style>


<script>
function getSelectedEvents(){
  if (!state.ui || !state.ui.revSel) return [];
  const sel = state.ui.revSel;
  const events = getServiceEvents();
  const map = new Map(events.map(e => [e.id, e]));
  return Object.keys(sel).filter(id => sel[id]).map(id => map.get(id)).filter(Boolean);
}
function updateBulkBar(){
  const bar = document.getElementById('rev-bulkbar');
  if (!bar) return;
  const cnt = getSelectedEvents().length;
  bar.querySelector('.count').textContent = cnt + ' vybr√°no';
  bar.classList.toggle('hidden', cnt === 0);
}
function bulkClear(){
  if (!state.ui) state.ui = {};
  state.ui.revSel = {};
  saveStateToLocalStorage();
  renderRevisionsTab();
}
function bulkMarkToday(){
  const events = getSelectedEvents();
  if (!events.length){ showAlert && showAlert('Nic nevybr√°no','Vyber ≈ô√°dky v tabulce.','warning'); return; }
  const today = new Date(); today.setHours(0,0,0,0);
  const iso = today.toISOString().slice(0,10);
  events.forEach(e => {
    if (e.id.startsWith('r:')){
      const machineId = e.machineId;
      ensureMachineMeta(machineId);
      const m = state.machineMeta[machineId];
      m.revision.last = iso;
      recomputeRevision(machineId);
    } else if (e.id.startsWith('m:')){
      const parts = e.id.split(':');
      const machineId = parts[1];
      const idx = parseInt(parts[2],10);
      ensureMachineMeta(machineId);
      const t = state.machineMeta[machineId].maintenance.tasks[idx];
      if (t){ t.last = iso; if (t.freqDays) t.next = addDays(iso, t.freqDays); }
    }
  });
  saveStateToLocalStorage();
  state.ui.revSel = {};
  try { renderMachinesTable(); } catch(_){}
  renderRevisionsTab();
  showAlert && showAlert('Hotovo','Oznaƒçeno jako provedeno dnes.','success');
}
function bulkDownloadProtocols(){
  const events = getSelectedEvents();
  const ids = Array.from(new Set(events.map(e => e.machineId)));
  let foundAny = false;
  ids.forEach(machineId => {
    const prot = state.machineMeta?.[machineId]?.protocols || [];
    prot.forEach(f => {
      foundAny = true;
      const a = document.createElement('a');
      a.href = f.dataUrl; a.download = f.name; document.body.appendChild(a); a.click(); a.remove();
    });
  });
  if (!foundAny) { showAlert && showAlert('≈Ω√°dn√© soubory','Vybran√© polo≈æky nemaj√≠ ulo≈æen√© protokoly.','info'); }
}
</script>


<style>
#rev-bulkbar .form-input { border-radius:10px; border:1px solid #e5e7eb; background:#fff; }
#rev-bulkbar .btn { background:#eef2ff; }
#rev-bulkbar .btn:hover { background:#e0e7ff; }
</style>


<script>
function bulkSetDate(){
  const events = getSelectedEvents();
  if (!events.length){ showAlert && showAlert('Nic nevybr√°no','Vyber ≈ô√°dky v tabulce.','warning'); return; }
  const inp = document.getElementById('rev-bulk-date');
  const val = inp && inp.value;
  if (!val){ showAlert && showAlert('Zadej datum','Vyber datum vpravo od tlaƒç√≠tka.','warning'); return; }
  events.forEach(e => {
    if (e.id.startsWith('r:')){
      ensureMachineMeta(e.machineId);
      const m = state.machineMeta[e.machineId];
      m.revision.last = val;
      recomputeRevision(e.machineId);
    } else if (e.id.startsWith('m:')){
      const parts = e.id.split(':');
      const machineId = parts[1];
      const idx = parseInt(parts[2],10);
      ensureMachineMeta(machineId);
      const t = state.machineMeta[machineId].maintenance.tasks[idx];
      if (t){ t.last = val; if (t.freqDays) t.next = addDays(val, t.freqDays); }
    }
  });
  saveStateToLocalStorage();
  try { renderMachinesTable(); } catch(_){}
  renderRevisionsTab();
  showAlert && showAlert('Hotovo','Nastavil(a) jsi vybran√Ω datum.','success');
}

function bulkSetResponsible(){
  const events = getSelectedEvents();
  if (!events.length){ showAlert && showAlert('Nic nevybr√°no','Vyber ≈ô√°dky v tabulce.','warning'); return; }
  const inp = document.getElementById('rev-bulk-resp');
  const val = (inp && inp.value || '').trim();
  if (!val){ showAlert && showAlert('Zadej jm√©no','Dopl≈à odpovƒõdnou osobu.','warning'); return; }
  events.forEach(e => {
    if (e.id.startsWith('r:')){
      ensureMachineMeta(e.machineId);
      const m = state.machineMeta[e.machineId];
      m.revision.responsible = val;
    } else if (e.id.startsWith('m:')){
      const parts = e.id.split(':');
      const machineId = parts[1];
      const idx = parseInt(parts[2],10);
      ensureMachineMeta(machineId);
      const t = state.machineMeta[machineId].maintenance.tasks[idx];
      if (t){ t.responsible = val; }
    }
  });
  saveStateToLocalStorage();
  renderRevisionsTab();
  showAlert && showAlert('Hotovo','Odpovƒõdn√° osoba p≈ôi≈ôazena.','success');
}
</script>


<script>
function exportArrayToCSV(filename, headers, rows){
  const escape = (v)=>('"' + String(v).replace(/"/g,'""').replace(/\n/g,' ') + '"');
  const lines = [];
  lines.push(headers.map(escape).join(','));
  rows.forEach(r => lines.push(r.map(escape).join(',')));
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function bulkExportSelectedCSV(){
  const events = getSelectedEvents();
  if (!events.length){ showAlert && showAlert('Nic nevybr√°no','Vyber ≈ô√°dky v tabulce.','warning'); return; }
  const headers = ['Za≈ô√≠zen√≠','K√≥d','Typ','√ökon','Odpovƒõdn√° osoba','Periodicita/Frekvence','Posledn√≠','P≈ô√≠≈°t√≠','Stav','Pozn√°mka'];
  const rows = events.map(e => {
    const days = e.next ? _daysUntil(e.next) : null;
    const st = _statusBadge(days);
    return [
      e.machine || '',
      e.machineId || '',
      e.type || '',
      e.task || '',
      e.responsible || '',
      e.freq || '',
      e.last || '',
      e.next || '',
      st.label || '',
      e.note || ''
    ];
  });
  exportArrayToCSV('vybrane_revize_udrzba.csv', headers, rows);
}

function bulkDeleteSelected(){
  const events = getSelectedEvents();
  const maint = events.filter(e => e && e.id && e.id.startsWith('m:'));
  if (!maint.length){
    showAlert && showAlert('Nic ke smaz√°n√≠','Vyber nejprve √∫kony √∫dr≈æby (≈ô√°dky typu √ödr≈æba).','info');
    return;
  }
  const ok = window.confirm(`Opravdu smazat ${maint.length} vybran√Ωch √∫kon≈Ø √∫dr≈æby? Tuto akci nelze vr√°tit.`);
  if (!ok) return;
  // Skupiny dle za≈ô√≠zen√≠ a smazat od nejvy≈°≈°√≠ch index≈Ø
  const byMachine = {};
  maint.forEach(e => {
    const parts = e.id.split(':');
    const mid = parts[1];
    const idx = parseInt(parts[2],10);
    if (!byMachine[mid]) byMachine[mid] = [];
    byMachine[mid].push(idx);
  });
  Object.entries(byMachine).forEach(([mid, arr]) => {
    ensureMachineMeta(mid);
    const tasks = state.machineMeta[mid].maintenance.tasks || [];
    arr.sort((a,b)=>b-a).forEach(i => { if (i>=0 && i<tasks.length) tasks.splice(i,1); });
  });
  // Vyƒçistit v√Ωbƒõr u smazan√Ωch polo≈æek
  if (!state.ui) state.ui = {};
  if (!state.ui.revSel) state.ui.revSel = {};
  maint.forEach(e => { delete state.ui.revSel[e.id]; });
  saveStateToLocalStorage();
  try { renderMachinesTable(); } catch(_){}
  renderRevisionsTab();
  showAlert && showAlert('Smaz√°no', `${maint.length} √∫kon(≈Ø) odstranƒõno.`, 'success');
}
</script>


<style>
/* Stacked layout for device detail (one column) */
.modal .subgrid.stack { grid-template-columns: 1fr !important; }
</style>


<script>
function toggleDetailLayout(btn){
  try {
    const sub = document.querySelector('#machine-detail-modal .subgrid');
    if (!sub) return;
    const stacked = sub.classList.toggle('stack');
    btn.textContent = stacked ? '‚Üî Vedle sebe' : '‚Üï Pod sebou';
  } catch(e){}
}
</script>




<!-- CHATGPT PATCH G-CAL-JS (extended v2: edit planned, next-due auto, counters) -->
<script>
(function(){
  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const pad = n => String(n).padStart(2,'0');
  const todayStr = () => { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
  function ymd(dt){ return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`; }
  const fmtMonth = (y,m) => new Date(y,m,1).toLocaleDateString('cs-CZ',{ month:'long', year:'numeric' });

  // Safe HTML escape helper (fallback if global not present)
  const escapeHtml = (function(){
    if (window.escapeHtml) return window.escapeHtml;
    return function(s){
      const span = document.createElement('span');
      span.textContent = (s==null ? '' : String(s));
      return span.innerHTML;
    };
  })();
  if (!window.escapeHtml) window.escapeHtml = escapeHtml;
  function lsGet(key, def){ try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e){ return def; } }
  function lsSet(key, val){ try { localStorage.setItem(key, JSON.stringify(val)); } catch(e){} }

  // ---- Planned events ----
  function plansKey(deviceId){ return 'deviceDetail:plans:'+deviceId; }
  function collectDeviceIds(){
    const ids = new Set();
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if (k.startsWith('deviceDetail:svc:') || k.startsWith('deviceDetail:hist:') || k.startsWith('deviceDetail:plans:') || k.startsWith('deviceDetail:maint:')){
        ids.add(k.split(':').pop());
      }
    }
    return Array.from(ids).sort();
  }
  function loadNameMap(){ try{ return JSON.parse(localStorage.getItem('deviceDetail:nameMap')||'{}'); }catch{ return {}; } }
  function deviceLabel(id, nameMap){ return nameMap[id] || id; }

  // ---- Auto "Next due" from preventive maintenance ----
  // Expected LS structure per device: deviceDetail:maint:<id> = [{task, freqDays, last}]
  // This can b√Ωt ulo≈æeno z detailu za≈ô√≠zen√≠ (nebo ruƒçnƒõ).
  function maintKey(deviceId){ return 'deviceDetail:maint:'+deviceId; }
  function addDays(ds, d){ const x=new Date(ds); if(isNaN(x)) return null; x.setDate(x.getDate()+(Number(d)||0)); return ymd(x); }

  function gatherEvents(ym){
    const [y,m] = ym;
    const monthStart = new Date(y,m,1).getTime();
    const monthEnd = new Date(y,m+1,0).getTime();
    const inMonth = (ds)=>{ const d=new Date(ds); if (isNaN(d)) return false; const t=d.getTime(); return t>=monthStart && t<=monthEnd; };
    const devs = collectDeviceIds();
    const nameMap = loadNameMap();
    const events = [];
    devs.forEach(id => {
      const svc = lsGet('deviceDetail:svc:'+id, []);
      (svc||[]).forEach(r => { if (r.date && inMonth(r.date)) events.push({ type:'servis', date:r.date, title:r.desc || 'Servis', device:id, meta:r.person||'', source:'svc' }); });
      const hist = lsGet('deviceDetail:hist:'+id, []);
      (hist||[]).forEach(h => {
        if (inMonth(h.when)){
          const t = (h.type||'').toLowerCase();
          if (t==='revize') events.push({ type:'revize', date:h.when, title:h.title||'Revize', device:id, source:'hist' });
          else if (t==='√∫dr≈æba' || t==='udrzba') events.push({ type:'udrzba', date:h.when, title:h.title||'√ödr≈æba', device:id, source:'hist' });
          else if (t==='protokol') events.push({ type:'protokol', date:h.when, title:h.title||'Protokol', device:id, source:'hist' });
        }
      });
      const plans = lsGet(plansKey(id), []);
      (plans||[]).forEach(p => { if (p.date && inMonth(p.date)) events.push({ type:p.type||'udrzba', date:p.date, title:p.title||'Pl√°n', device:id, source:'plan', id:p.id }); });

      // auto inject NextDue
      const maint = lsGet(maintKey(id), []);
      (maint||[]).forEach(t => {
        if (!t.freqDays || !t.last) return;
        const next = addDays(t.last, t.freqDays);
        if (next && inMonth(next)){
          events.push({ type:'udrzba', date: next, title: (t.task ? 'Preventivka: '+t.task : 'Preventivn√≠ √∫dr≈æba'), device:id, source:'nextdue' });
        }
      });
    });
    events.forEach(ev => ev.deviceLabel = deviceLabel(ev.device, nameMap));
    events.sort((a,b)=> a.date.localeCompare(b.date) || (a.deviceLabel||'').localeCompare(b.deviceLabel||''));
    return { events, devices: collectDeviceIds().map(id=>({id, label: deviceLabel(id, nameMap)})) };
  }

  // Badge with today's events count (all devices)
  function updateCalendarBadge(){
    const badge = $('#calendar-badge'); if (!badge) return;
    const devs = collectDeviceIds();
    const today = todayStr();
    let count = 0;
    devs.forEach(id => {
      const svc = lsGet('deviceDetail:svc:'+id, []);
      count += (svc||[]).filter(r=>r.date===today).length;
      const hist = lsGet('deviceDetail:hist:'+id, []);
      count += (hist||[]).filter(h=>h.when===today).length;
      const plans = lsGet(plansKey(id), []);
      count += (plans||[]).filter(p=>p.date===today).length;
      const maint = lsGet(maintKey(id), []);
      count += (maint||[]).filter(t=>{ const next= (t.freqDays && t.last) ? addDays(t.last, t.freqDays) : null; return next===today; }).length;
    });
    if (count>0){ badge.textContent = count; badge.classList.remove('hidden'); }
    else { badge.classList.add('hidden'); }
  }

  // ---- Planned events CRUD ----
  function createPlannedEvent(deviceId, dateStr, type, title){ if (!(window.can && can('plan:create'))) { alert('Nem√°te opr√°vnƒõn√≠ vytv√°≈ôet pl√°ny.'); return; }
    const key = plansKey(deviceId);
    const arr = lsGet(key, []);
    const id = String(Date.now());
    arr.push({ id, date: dateStr, type, title });
    lsSet(key, arr);
    wireGlobalCalendar._refresh && wireGlobalCalendar._refresh();
    updateCalendarBadge();
  }
  function deletePlannedEvent(deviceId, id){ if (!(window.can && can('plan:delete'))) { alert('Nem√°te opr√°vnƒõn√≠ mazat pl√°ny.'); return; }
    const key = plansKey(deviceId);
    const arr = lsGet(key, []);
    const idx = arr.findIndex(e => e.id===id);
    if (idx!==-1){ arr.splice(idx,1); lsSet(key, arr); }
    wireGlobalCalendar._refresh && wireGlobalCalendar._refresh();
    updateCalendarBadge();
  }
  function updatePlannedEvent(deviceId, id, patch){ if (!(window.can && can('plan:edit'))) { alert('Nem√°te opr√°vnƒõn√≠ upravovat pl√°ny.'); return; }
    // allow moving between devices
    const oldKey = plansKey(deviceId);
    let arr = lsGet(oldKey, []);
    const idx = arr.findIndex(e => e.id===id);
    if (idx===-1) return;
    let item = arr[idx];
    arr.splice(idx,1); lsSet(oldKey, arr);
    const newDev = patch.deviceId || deviceId;
    item = Object.assign(item, patch);
    const newKey = plansKey(newDev);
    const target = lsGet(newKey, []);
    target.push(item);
    lsSet(newKey, target);
    wireGlobalCalendar._refresh && wireGlobalCalendar._refresh();
    updateCalendarBadge();
  }

  // ---- Rendering ----
  function setTypeCounts(events){
    const counts = { revize:0, udrzba:0, servis:0, protokol:0 };
    events.forEach(ev => { if (counts.hasOwnProperty(ev.type)) counts[ev.type]++; });
    const map = { revize:'#cnt-revize', udrzba:'#cnt-udrzba', servis:'#cnt-servis', protokol:'#cnt-protokol' };
    Object.keys(map).forEach(k => { const el = document.querySelector(map[k]); if (el) el.textContent = counts[k] || 0; });
  }

  function renderMonthCalendar(ym){
    const grid = $('#events-grid');
    const label = $('#ev-month-label');
    const devSel = $('#ev-device');
    if (!grid || !label) return;
    grid.classList.add('events-grid'); grid.classList.remove('week-grid');
    label.textContent = fmtMonth(ym[0], ym[1]);

    const { events, devices } = gatherEvents(ym);
    if (devSel && !devSel.dataset.filled){
      devSel.dataset.filled='1';
      devices.forEach(d => { const opt=document.createElement('option'); opt.value=d.id; opt.textContent=d.label; devSel.appendChild(opt); });
    }

    const activeTypes = $$('.ev-type').filter(cb=>cb.checked).map(cb=>cb.value);
    const query = ($('#ev-q')?.value || '').toLowerCase();
    const devFilter = devSel ? devSel.value : '';

    const filtered = events.filter(ev =>
      activeTypes.includes(ev.type) &&
      (!query || (ev.title||'').toLowerCase().includes(query) || (ev.deviceLabel||'').toLowerCase().includes(query)) &&
      (!devFilter || ev.device === devFilter)
    );

    setTypeCounts(filtered);

    const daysInMonth = new Date(ym[0], ym[1]+1, 0).getDate();
    const itemsByDay = {};
    filtered.forEach(ev => {
      const d = new Date(ev.date);
      if (isNaN(d)) return;
      if (d.getFullYear()!==ym[0] || d.getMonth()!==ym[1]) return;
      const day = d.getDate();
      (itemsByDay[day] = itemsByDay[day]||[]).push(ev);
    });

    grid.innerHTML = '';
    const startDow = new Date(ym[0], ym[1], 1).getDay();
    const monStart = (startDow===0)?7:startDow;
    for (let i=1; i<monStart; i++){ const empty=document.createElement('div'); empty.className='events-cell'; grid.appendChild(empty); }
    const today = todayStr();
    for (let day=1; day<=daysInMonth; day++){
      const ds = `${ym[0]}-${pad(ym[1]+1)}-${pad(day)}`;
      const cell = document.createElement('div'); cell.className='events-cell';
      if (ds === today) cell.classList.add('today');
      if (ds < today && (itemsByDay[day]||[]).length) cell.classList.add('overdue');
      const dn = document.createElement('div'); dn.className='daynum'; dn.textContent = day; cell.appendChild(dn);
      const dots = document.createElement('div'); dots.className='dots';
      (itemsByDay[day]||[]).forEach(ev => { const dot=document.createElement('span'); dot.className='dot '+ev.type; dot.title = ev.deviceLabel; dots.appendChild(dot); });
      cell.appendChild(dots);
      cell.addEventListener('click', ()=> renderDayList(ds, itemsByDay[day]||[]));
      enableDropTarget(cell, ds);
      cell.addEventListener('dblclick', ()=> openQuickAdd(ds));
      grid.appendChild(cell);
    }

    const firstWith = Object.keys(itemsByDay).map(Number).sort((a,b)=>a-b)[0];
    if (firstWith) renderDayList(`${ym[0]}-${pad(ym[1]+1)}-${pad(firstWith)}`, itemsByDay[firstWith]);
    else renderDayList(today, []);

    const btn = $('#events-export-ics');
    if (btn && !btn.dataset.wired){ btn.dataset.wired='1'; btn.addEventListener('click', ()=> exportICS(filtered, new Date(ym[0],ym[1],1))); }
  }

  function renderWeekCalendar(weekStart){
    const grid = $('#events-grid');
    const label = $('#ev-month-label'); if (!grid || !label) return;
    grid.classList.remove('events-grid'); grid.classList.add('week-grid');
    const d0 = new Date(weekStart);
    const week = []; for (let i=0;i<7;i++){ const d=new Date(d0); d.setDate(d0.getDate()+i); week.push(d); }
    label.textContent = `T√Ωden ${ymd(week[0])} ‚Äì ${ymd(week[6])}`;

    // gather events for both months if needed
    const ym=[week[0].getFullYear(), week[0].getMonth()];
    const { events } = gatherEvents(ym);
    const ym2=[week[6].getFullYear(), week[6].getMonth()];
    if (ym2[0]!==ym[0] || ym2[1]!==ym[1]) events.push(...gatherEvents(ym2).events);

    const activeTypes = $$('.ev-type').filter(cb=>cb.checked).map(cb=>cb.value);
    const query = ($('#ev-q')?.value || '').toLowerCase();
    const devFilter = $('#ev-device')?.value || '';

    const filtered = events.filter(ev =>
      activeTypes.includes(ev.type) &&
      (!query || (ev.title||'').toLowerCase().includes(query) || (ev.deviceLabel||'').toLowerCase().includes(query)) &&
      (!devFilter || ev.device === devFilter)
    );

    setTypeCounts(filtered);

    const map = {};
    filtered.forEach(ev => { (map[ev.date] = map[ev.date] || []).push(ev); });

    grid.innerHTML = '';
    week.forEach(day => {
      const ds = ymd(day);
      const col = document.createElement('div'); col.className='week-col';
      col.innerHTML = `<div class="head"><span>${day.toLocaleDateString('cs-CZ',{weekday:'short', day:'2-digit', month:'2-digit'})}</span><span class="muted">${(map[ds]||[]).length}</span></div><div class="body"></div>`;
      const body = col.querySelector('.body');
      (map[ds]||[]).forEach(ev => {
        const row = document.createElement('div'); row.className='week-item';
        row.innerHTML = `<div class="left"><span class="tag ${ev.type}">${ev.type}</span><b>${escapeHtml(ev.title||'')}</b><span class="muted">${escapeHtml(ev.deviceLabel||'')}</span></div>` +
                        (ev.source==='plan' ? `<div class="right"><button class="btn-small" data-edit="${ev.device}:${ev.id}:${ev.date}">‚úèÔ∏è</button><button class="btn-small" data-del="${ev.device}:${ev.id}">üóë</button></div>` : '');
        body.appendChild(row);
      });
      // Quick add inline
      const add = document.createElement('div'); add.className='add-inline';
      add.innerHTML = `
        <select class="qa-type">
          <option value="udrzba">√ödr≈æba</option>
          <option value="revize">Revize</option>
          <option value="servis">Servis</option>
          <option value="protokol">Protokol</option>
        </select>
        <select class="qa-device"></select>
        <input class="qa-title" placeholder="N√°zev‚Ä¶">
        <button class="btn-small qa-add">P≈ôidat</button>`;
        try{ if (typeof ev!=='undefined' && ev && ev.source==='plan'){ makePlannedDraggable(row, ev.device, ev.id); } }catch{}
      const sel = add.querySelector('.qa-device');
      collectDeviceIds().forEach(id=>{ const opt=document.createElement('option'); opt.value=id; opt.textContent=deviceLabel(id, loadNameMap()); sel.appendChild(opt); });
      add.querySelector('.qa-add').addEventListener('click', ()=>{
        const type = add.querySelector('.qa-type').value;
        const dev = sel.value;
        const title = add.querySelector('.qa-title').value || 'Pl√°n';
        createPlannedEvent(dev, ds, type, title);
      });
      body.appendChild(add);

      enableDropTarget(col, ds);
      grid.appendChild(col);
    });

    // wire deletes & edits for planned items
    grid.querySelectorAll('button[data-del]').forEach(btn => {
      btn.addEventListener('click', ()=>{
        const [dev, id] = btn.dataset.del.split(':');
        deletePlannedEvent(dev, id);
      });
    });
    grid.querySelectorAll('button[data-edit]').forEach(btn => {
      btn.addEventListener('click', ()=>{
        const [dev, id, date] = btn.dataset.edit.split(':');
        inlineEditPlanned(dev, id, date, btn.closest('.week-item'));
      });
    });
  }

  function inlineEditPlanned(deviceId, id, dateStr, container){
    const key = plansKey(deviceId);
    const arr = lsGet(key, []);
    const item = arr.find(e => e.id===id);
    if (!item) return;
    const shell = document.createElement('div'); shell.className='edit-inline';
    shell.innerHTML = `
      <input class="ed-date" type="date" value="${dateStr}">
      <select class="ed-type">
        <option value="udrzba" ${item.type==='udrzba'?'selected':''}>√ödr≈æba</option>
        <option value="revize" ${item.type==='revize'?'selected':''}>Revize</option>
        <option value="servis" ${item.type==='servis'?'selected':''}>Servis</option>
        <option value="protokol" ${item.type==='protokol'?'selected':''}>Protokol</option>
      </select>
      <select class="ed-device"></select>
      <input class="ed-title" value="${escapeHtml(item.title||'')}" placeholder="N√°zev‚Ä¶">
      <button class="btn-small ed-save">Ulo≈æit</button>
      <button class="btn-small ed-cancel">Zru≈°it</button>`;
    const sel = shell.querySelector('.ed-device');
    collectDeviceIds().forEach(id=>{ const opt=document.createElement('option'); opt.value=id; opt.textContent=deviceLabel(id, loadNameMap()); sel.appendChild(opt); });
    sel.value = deviceId;

    const old = container.innerHTML;
    container.innerHTML = ''; container.appendChild(shell);
    shell.querySelector('.ed-cancel').addEventListener('click', ()=>{ container.innerHTML = old; wireGlobalCalendar._refresh(); });
    shell.querySelector('.ed-save').addEventListener('click', ()=>{
      const patch = {
        date: shell.querySelector('.ed-date').value || dateStr,
        type: shell.querySelector('.ed-type').value,
        title: shell.querySelector('.ed-title').value || item.title,
        deviceId: shell.querySelector('.ed-device').value
      };
      updatePlannedEvent(deviceId, id, patch);
    });
  }

  function openQuickAdd(ds){
    const list = $('#events-list'); if (!list) return;
    const add = document.createElement('div'); add.className='add-inline';
    add.innerHTML = `
      <b>${ds}</b>
      <select class="qa-type">
        <option value="udrzba">√ödr≈æba</option>
        <option value="revize">Revize</option>
        <option value="servis">Servis</option>
        <option value="protokol">Protokol</option>
      </select>
      <select class="qa-device"></select>
      <input class="qa-title" placeholder="N√°zev‚Ä¶">
      <button class="btn-small qa-add">P≈ôidat</button>`;
    const sel = add.querySelector('.qa-device');
    collectDeviceIds().forEach(id=>{
      const opt=document.createElement('option'); opt.value=id; opt.textContent=deviceLabel(id, loadNameMap()); sel.appendChild(opt);
    });
    add.querySelector('.qa-add').addEventListener('click', ()=>{
      const type = add.querySelector('.qa-type').value;
      const dev = sel.value;
      const title = add.querySelector('.qa-title').value || 'Pl√°n';
      createPlannedEvent(dev, ds, type, title);
    });
    list.prepend(add);
  }

  function renderDayList(ds, items){
    const list = $('#events-list'); if (!list) return;
    if (!items.length){
      list.innerHTML = `<div class="small-muted">${ds}: ≈æ√°dn√© ud√°losti.</div>`;
    } else {
      list.innerHTML = `<div class="small-muted">${ds}</div>` + items.map(ev => `
        <div class="item">
          <span class="tag ${ev.type}">${ev.type}</span>
          <b>${escapeHtml(ev.title||'')}</b> <span class="devchip">‚Ä¢ ${escapeHtml(ev.deviceLabel||ev.device||'')}</span>
          ${ev.source==='plan' ? `<button class="btn-small" onclick="completePlannedEvent('${ev.device}','${ev.id}','${ev.date}')">‚úîÔ∏è Splnƒõno</button><button class="btn-small" data-edit="${ev.device}:${ev.id}:${ev.date}">‚úèÔ∏è</button><button class="btn-small" data-del="${ev.device}:${ev.id}">üóë</button>` : ''}
        </div>`).join('');
      // Make planned items draggable
      list.querySelectorAll('.item').forEach(it => {
        const editBtn = it.querySelector('button[data-edit]');
        if (editBtn){
          const parts = editBtn.getAttribute('data-edit').split(':');
          if (parts.length>=3){ makePlannedDraggable(it, parts[0], parts[1]); }
        }
      });
      // Allow dropping onto the list area to move to that selected day
      enableDropTarget(list, ds);
      // wire list buttons
      list.querySelectorAll('button[data-del]').forEach(btn => btn.addEventListener('click', ()=>{
        const [dev, id] = btn.dataset.del.split(':');
        deletePlannedEvent(dev, id);
      }));
      list.querySelectorAll('button[data-edit]').forEach(btn => btn.addEventListener('click', ()=>{
        const [dev, id, date] = btn.dataset.edit.split(':');
        inlineEditPlanned(dev, id, date, btn.closest('.item'));
      }));
    }
    // quick add inline for month view
    const qa = document.createElement('div'); qa.className='add-inline';
    qa.innerHTML = `
      <select class="qa-type">
        <option value="udrzba">√ödr≈æba</option>
        <option value="revize">Revize</option>
        <option value="servis">Servis</option>
        <option value="protokol">Protokol</option>
      </select>
      <select class="qa-device"></select>
      <input class="qa-title" placeholder="N√°zev‚Ä¶">
      <button class="btn-small qa-add">P≈ôidat</button>`;
    const sel = qa.querySelector('.qa-device');
    collectDeviceIds().forEach(id=>{ const opt=document.createElement('option'); opt.value=id; opt.textContent=deviceLabel(id, loadNameMap()); sel.appendChild(opt); });
    qa.querySelector('.qa-add').addEventListener('click', ()=>{
      const type = qa.querySelector('.qa-type').value;
      const dev = sel.value;
      const title = qa.querySelector('.qa-title').value || 'Pl√°n';
      createPlannedEvent(dev, ds, type, title);
    });
    list.appendChild(qa);
  }

  function icsEscape(s){ return String(s||'').replace(/([,;])/g,'\\$1').replace(/\n/g,'\\n'); }
  function toICSDate(ds){ return ds.replace(/-/g,'') + 'T090000Z'; }
  function exportICS(events, start){
    const lines = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//SMSD//Kalend√°≈ô//CZ'];
    events.forEach((ev,i)=>{
      lines.push('BEGIN:VEVENT');
      lines.push('UID:'+ Date.now() + '-' + i + '@smsd');
      lines.push('DTSTAMP:' + toICSDate( (new Date()).toISOString().slice(0,10) ));
      lines.push('DTSTART:' + toICSDate(ev.date));
      lines.push('SUMMARY:' + icsEscape((ev.type.toUpperCase()) + ': ' + (ev.title||'') + ' [' + (ev.deviceLabel||ev.device||'') + ']'));
      lines.push('END:VEVENT');
    });
    lines.push('END:VCALENDAR');
    const blob = new Blob([lines.join('\\r\\n')], {type:'text/calendar'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `kalendar_${start.getFullYear()}-${pad(start.getMonth()+1)}.ics`; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
  }

  
  // ==== Drag & Drop for planned events ====
  function makePlannedDraggable(el, dev, id){
    if (!el || el.dataset.dnd==='1') return;
    el.dataset.dnd='1';
    if (!(window.can && can('calendar:dragdrop'))) return; el.setAttribute('draggable','true');
    el.addEventListener('dragstart', (e)=>{
      e.dataTransfer.setData('text/plain', JSON.stringify({ device: dev, id }));
      el.classList.add('dragging');
    });
    el.addEventListener('dragend', ()=> el.classList.remove('dragging'));
  }
  function enableDropTarget(el, targetDate){
    if (!el || el.dataset.drop==='1') return;
    el.dataset.drop='1';
    el.addEventListener('dragover', (e)=>{ if (!(window.can && can('calendar:dragdrop'))) return; e.preventDefault(); el.classList.add('drop-hover'); });
    el.addEventListener('dragleave', ()=> el.classList.remove('drop-hover'));
    el.addEventListener('drop', (e)=>{
      e.preventDefault();
      el.classList.remove('drop-hover');
      try{
        const data = JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
        if (data && data.device && data.id){
          updatePlannedEvent(data.device, data.id, { date: targetDate });
        }
      }catch(err){ console.warn('Drop parse failed', err); }
    });
  }

  
  function histKey(deviceId){ return 'deviceDetail:hist:'+deviceId; }
  function svcKey(deviceId){ return 'deviceDetail:svc:'+deviceId; }
  function maintKey(deviceId){ return 'deviceDetail:maint:'+deviceId; }
  const getUser = ()=> localStorage.getItem('app:username') || 'nezn√°m√Ω';

  function completePlannedEvent(deviceId, id, dateStr){ if (!(window.can && can('plan:complete') && can('service:create'))) { alert('Nem√°te opr√°vnƒõn√≠ oznaƒçit pl√°n jako splnƒõn√Ω.'); return; }
    // 1) read plan
    const pk = plansKey(deviceId);
    const plans = lsGet(pk, []);
    const idx = plans.findIndex(p=>p.id===id);
    if (idx===-1) return;
    const plan = plans[idx];

    // 2) create service record
    const sk = svcKey(deviceId);
    const services = lsGet(sk, []);
    const svc = {
      id: 'svc_'+Date.now(),
      date: dateStr || (new Date().toISOString().slice(0,10)),
      person: getUser(),
      desc: (plan.title||'Pl√°n') + ' (splnƒõno z pl√°nu)',
      usedParts: [], photos: [], checklist: [], createdFromPlan: id
    };
    services.push(svc);
    lsSet(sk, services);

    // 3) history entry
    const hk = histKey(deviceId);
    const hist = lsGet(hk, []);
    const mapType = plan.type==='servis' ? 'Servis' : plan.type==='revize' ? 'Revize' : plan.type==='protokol' ? 'Protokol' : '√ödr≈æba';
    hist.push({ type: mapType, title: plan.title || 'Pl√°n', when: svc.date });
    lsSet(hk, hist);

    // 4) update preventive last if relevant
    if (plan.type === 'udrzba'){
      const mk = maintKey(deviceId);
      const items = lsGet(mk, []);
      const title = String(plan.title||'').replace(/^Preventivka:\s*/i,'');
      const i = items.findIndex(t => (String(t.task||'').toLowerCase() === title.toLowerCase()));
      if (i!==-1){
        items[i].last = svc.date;
        lsSet(mk, items);
      }
    }

    // 5) remove plan
    plans.splice(idx,1);
    lsSet(pk, plans);

    // 6) refresh
    wireGlobalCalendar._refresh && wireGlobalCalendar._refresh();
    updateCalendarBadge();
  }

  function wireGlobalCalendar(){
    const tab = document.getElementById('tab-calendar'); if (!tab) return;
    const grid = document.getElementById('events-grid');
    grid.classList.add('events-grid'); grid.classList.remove('week-grid'); // default month
    let view = (function(){ const d=new Date(); return [d.getFullYear(), d.getMonth()]; })();
    let weekStart = (function(){ const d=new Date(); const wd=(d.getDay()||7); d.setDate(d.getDate()-(wd-1)); return ymd(d); })();
    let mode = 'month';
    function refresh(){
      if (mode==='month'){ renderMonthCalendar(view); }
      else { renderWeekCalendar(weekStart); }
    }
    wireGlobalCalendar._refresh = refresh;

    const prev = document.getElementById('ev-prev');
    const next = document.getElementById('ev-next');
    const today = document.getElementById('ev-today');
    const q = document.getElementById('ev-q');
    const dev = document.getElementById('ev-device');
    const btnMonth = document.getElementById('view-month');
    const btnWeek  = document.getElementById('view-week');

    if (prev && !prev.dataset.wired){ prev.dataset.wired='1'; prev.addEventListener('click', ()=>{
      if (mode==='month'){ if(--view[1] < 0){ view[0]--; view[1]=11; } }
      else { const d=new Date(weekStart); d.setDate(d.getDate()-7); weekStart=ymd(d); }
      refresh();
    });}
    if (next && !next.dataset.wired){ next.dataset.wired='1'; next.addEventListener('click', ()=>{
      if (mode==='month'){ if(++view[1] > 11){ view[0]++; view[1]=0; } }
      else { const d=new Date(weekStart); d.setDate(d.getDate()+7); weekStart=ymd(d); }
      refresh();
    });}
    if (today && !today.dataset.wired){ today.dataset.wired='1'; today.addEventListener('click', ()=>{
      const d=new Date(); view=[d.getFullYear(), d.getMonth()];
      const t=new Date(); const wd=(t.getDay()||7); t.setDate(t.getDate()-(wd-1)); weekStart=ymd(t);
      refresh();
    });}
    $$('.ev-type').forEach(cb => { if (!cb.dataset.wired){ cb.dataset.wired='1'; cb.addEventListener('change', refresh); }});
    if (q && !q.dataset.wired){ q.dataset.wired='1'; q.addEventListener('input', refresh); }
    if (dev && !dev.dataset.wired){ dev.dataset.wired='1'; dev.addEventListener('change', refresh); }
    if (btnMonth && !btnMonth.dataset.wired){ btnMonth.dataset.wired='1'; btnMonth.addEventListener('click', ()=>{ mode='month'; refresh(); }); }
    if (btnWeek && !btnWeek.dataset.wired){ btnWeek.dataset.wired='1'; btnWeek.addEventListener('click', ()=>{ mode='week'; refresh(); }); }

    refresh();
  }

  // Hook into showTab to init when user opens it
  const _showTab = window.showTab;
  window.showTab = function(name){
    if (_showTab) _showTab(name);
    if (name === 'calendar'){ setTimeout(()=>{ wireGlobalCalendar(); updateCalendarBadge(); }, 0); }
  };
  // Update badge on load and when storage changes
  window.addEventListener('load', ()=>{ updateCalendarBadge(); renderPreventivePanel(); });
  
  // ==== Preventive plans manager (global) ====
  function maintKey(deviceId){ return 'deviceDetail:maint:'+deviceId; }
  function addDays(ds, d){ const x=new Date(ds); if(isNaN(x)) return ''; x.setDate(x.getDate()+(Number(d)||0)); return ymd(x); }

  function renderPreventivePanel(){
    const panel = document.getElementById('preventive-panel');
    if (!panel) return;
    const devSel = document.getElementById('prev-device');
    const tbody = document.querySelector('#prev-table tbody');

    // fill device selector
    if (devSel && !devSel.dataset.filled){
      devSel.dataset.filled='1';
      const all = collectDeviceIds();
      if (!all.length){ const opt=document.createElement('option'); opt.value=''; opt.textContent='(nen√≠ ≈æ√°dn√© za≈ô√≠zen√≠)'; devSel.appendChild(opt); }
      all.forEach(id => { const opt=document.createElement('option'); opt.value=id; opt.textContent=deviceLabel(id, loadNameMap()); devSel.appendChild(opt); });
      devSel.value = all[0] || '';
    }

    function drawTable(){
      const id = devSel.value;
      const arr = lsGet(maintKey(id), []);
      tbody.innerHTML = (arr||[]).map((t,i)=>{
        const next = (t.freqDays && t.last) ? addDays(t.last, t.freqDays) : '';
        return `<tr data-i="${i}">
          <td><input value="${escapeHtml(t.task||'')}" class="prev-task"></td>
          <td><input value="${escapeHtml(t.freqDays||'')}" type="number" class="prev-freq"></td>
          <td><input value="${escapeHtml(t.last||'')}" type="date" class="prev-last"></td>
          <td><span class="prev-next">${escapeHtml(next)}</span></td>
          <td style="width:1%; white-space:nowrap;">
            <button class="btn-small prev-del">üóë</button>
          </td>
        </tr>`;
      }).join('');
      if (!arr || !arr.length){
        tbody.innerHTML = '<tr><td colspan="5"><div class="small-muted">≈Ω√°dn√© polo≈æky. P≈ôidej nov√Ω ≈ô√°dek.</div></td></tr>';
      }
    }

    // handlers
    const toggle = document.getElementById('prev-toggle');
    if (toggle && !toggle.dataset.wired){
      toggle.dataset.wired='1';
      toggle.addEventListener('click', ()=> panel.classList.toggle('open'));
    }
    const addBtn = document.getElementById('prev-add');
    if (addBtn && !addBtn.dataset.wired){
      addBtn.dataset.wired='1';
      addBtn.addEventListener('click', ()=>{
        const id = devSel.value;
        const arr = lsGet(maintKey(id), []);
        arr.push({ task:'', freqDays:'', last:'' });
        lsSet(maintKey(id), arr);
        drawTable();
      });
    }
    const saveBtn = document.getElementById('prev-save');
    if (saveBtn && !saveBtn.dataset.wired){
      saveBtn.dataset.wired='1';
      saveBtn.addEventListener('click', ()=>{
        const id = devSel.value;
        const rows = Array.from(document.querySelectorAll('#prev-table tbody tr'));
        const data = rows.map(r => ({
          task: r.querySelector('.prev-task')?.value || '',
          freqDays: Number(r.querySelector('.prev-freq')?.value || 0) || 0,
          last: r.querySelector('.prev-last')?.value || ''
        })).filter(x => x.task || x.freqDays || x.last);
        lsSet(maintKey(id), data);
        wireGlobalCalendar._refresh && wireGlobalCalendar._refresh();
        updateCalendarBadge();
        drawTable();
      });
    }
    if (devSel && !devSel.dataset.changed){
      devSel.dataset.changed='1';
      devSel.addEventListener('change', drawTable);
    }
    // delete delegation
    tbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('.prev-del'); if (!btn) return;
      const row = btn.closest('tr'); const idx = Number(row.dataset.i||0);
      const id = devSel.value;
      const arr = lsGet(maintKey(id), []);
      if (idx>=0 && idx<arr.length){ arr.splice(idx,1); lsSet(maintKey(id), arr); }
      drawTable();
      wireGlobalCalendar._refresh && wireGlobalCalendar._refresh();
      updateCalendarBadge();
    });

    // Export / Import
    const exp = document.getElementById('prev-export');
    if (exp && !exp.dataset.wired){
      exp.dataset.wired='1';
      exp.addEventListener('click', ()=>{
        const all = {};
        collectDeviceIds().forEach(id => { all[id] = lsGet(maintKey(id), []); });
        const blob = new Blob([JSON.stringify(all, null, 2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='preventivni_plany.json'; a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
      });
    }
    const imp = document.getElementById('prev-import-input');
    if (imp && !imp.dataset.wired){
      imp.dataset.wired='1';
      imp.addEventListener('change', async ()=>{
        const f = imp.files?.[0]; if (!f) return;
        try {
          const txt = await f.text();
          const obj = JSON.parse(txt);
          const ids = Object.keys(obj||{});
          ids.forEach(id => { lsSet(maintKey(id), obj[id]||[]); });
          alert('Import hotov: ' + ids.length + ' za≈ô√≠zen√≠.');
          drawTable();
          wireGlobalCalendar._refresh && wireGlobalCalendar._refresh();
          updateCalendarBadge();
        } catch(err){ alert('Import selhal: ' + err); }
        imp.value='';
      });
    }

    drawTable();
  }
window.addEventListener('storage', ()=>{ updateCalendarBadge(); });
})();
</script>




<!-- CHATGPT PATCH 17: Dashboard Due/Overdue widget logic -->
<script>
(function(){
  // Helpers copied (lightweight) from calendar code
  const pad = n => String(n).padStart(2,'0');
  const todayStr = () => { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
  function ymd(dt){ return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`; }
  function lsGet(key, def){ try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e){ return def; } }
  function collectDeviceIds(){
    const ids = new Set();
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if (k.startsWith('deviceDetail:svc:') || k.startsWith('deviceDetail:hist:') || k.startsWith('deviceDetail:plans:') || k.startsWith('deviceDetail:maint:')){
        ids.add(k.split(':').pop());
      }
    }
    return Array.from(ids).sort();
  }
  function maintKey(id){ return 'deviceDetail:maint:'+id; }
  function addDays(ds, d){ const x=new Date(ds); if(isNaN(x)) return null; x.setDate(x.getDate()+(Number(d)||0)); return ymd(x); }

  function computeDueCounts(){
    const today = todayStr();
    let cToday=0, cSoon=0, cOver=0;
    const inRange = (ds) => {
      const diff = Math.round((new Date(ds) - new Date(today))/86400000);
      if (isNaN(diff)) return null;
      return diff;
    };
    collectDeviceIds().forEach(id => {
      // service + history events
      const svc = lsGet('deviceDetail:svc:'+id, []);
      (svc||[]).forEach(r => {
        const diff = inRange(r.date); if (diff==null) return;
        if (diff<0) cOver++; else if (diff===0) cToday++; else if (diff<=14) cSoon++;
      });
      const hist = lsGet('deviceDetail:hist:'+id, []);
      (hist||[]).forEach(h => {
        const diff = inRange(h.when); if (diff==null) return;
        if (diff<0) cOver++; else if (diff===0) cToday++; else if (diff<=14) cSoon++;
      });
      const plans = lsGet('deviceDetail:plans:'+id, []);
      (plans||[]).forEach(p => {
        const diff = inRange(p.date); if (diff==null) return;
        if (diff<0) cOver++; else if (diff===0) cToday++; else if (diff<=14) cSoon++;
      });
      // preventive next due
      const maint = lsGet(maintKey(id), []);
      (maint||[]).forEach(t => {
        if (!t.freqDays || !t.last) return;
        const nd = addDays(t.last, t.freqDays);
        const diff = inRange(nd); if (diff==null) return;
        if (diff<0) cOver++; else if (diff===0) cToday++; else if (diff<=14) cSoon++;
      });
    });
    const elT = document.getElementById('due-today');
    const elS = document.getElementById('due-soon');
    const elO = document.getElementById('due-overdue');
    if (elT) elT.textContent = cToday;
    if (elS) elS.textContent = cSoon;
    if (elO) elO.textContent = cOver;
  }

  // Button behavior: open calendar tab
  window.openCalendarFromDashboard = function(){
    if (window.showTab) window.showTab('calendar');
    // Optionally, mark that user came from dashboard (for future deep filters)
    try { localStorage.setItem('calendar:lastOpen','dashboard'); } catch {}
  };

  window.addEventListener('load', computeDueCounts);
  window.addEventListener('storage', computeDueCounts);
  // Trigger once after DOM changes (in case dashboard tab becomes visible later)
  setTimeout(computeDueCounts, 200);
})();
</script>


<!-- CHATGPT PATCH 21: Notifications (browser) -->
<script>
(function(){
  const NOTIFY_KEY = 'app:notifyEnabled';
  const LAST_DIGEST_KEY = 'app:notifyLastDigest';
  const SNAPSHOT_KEY = 'app:notifyLastSnapshot';
  const DIGEST_HOUR = 9, DIGEST_MIN = 0; // 09:00 local time

  const $ = (s,r=document)=>r.querySelector(s);
  function lsGet(key, def){ try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e){ return def; } }
  function lsSet(key, val){ try { localStorage.setItem(key, JSON.stringify(val)); } catch(e){} }
  function todayStr(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }
  function isSupported(){ return 'Notification' in window; }
  function enabled(){ return localStorage.getItem(NOTIFY_KEY) === '1'; }

  function collectDeviceIds(){
    const ids = new Set();
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if (k.startsWith('deviceDetail:svc:') || k.startsWith('deviceDetail:hist:') || k.startsWith('deviceDetail:plans:') || k.startsWith('deviceDetail:maint:')){
        ids.add(k.split(':').pop());
      }
    }
    return Array.from(ids).sort();
  }
  function addDays(ds, d){ const x=new Date(ds); if(isNaN(x)) return null; x.setDate(x.getDate()+(Number(d)||0)); const p=n=>String(n).padStart(2,'0'); return `${x.getFullYear()}-${p(x.getMonth()+1)}-${p(x.getDate())}`; }
  function maintKey(id){ return 'deviceDetail:maint:'+id; }

  function computeCounts(windowDays){
    const today = todayStr();
    let cToday=0, cSoon=0, cOver=0;
    const inRange = (ds) => {
      const diff = Math.round((new Date(ds) - new Date(today))/86400000);
      if (isNaN(diff)) return null;
      return diff;
    };
    collectDeviceIds().forEach(id => {
      const svc = lsGet('deviceDetail:svc:'+id, []);
      (svc||[]).forEach(r => { const d=inRange(r.date); if(d==null) return; if(d<0)cOver++; else if(d===0)cToday++; else if(d<=windowDays)cSoon++; });
      const hist = lsGet('deviceDetail:hist:'+id, []);
      (hist||[]).forEach(h => { const d=inRange(h.when); if(d==null) return; if(d<0)cOver++; else if(d===0)cToday++; else if(d<=windowDays)cSoon++; });
      const plans = lsGet('deviceDetail:plans:'+id, []);
      (plans||[]).forEach(p => { const d=inRange(p.date); if(d==null) return; if(d<0)cOver++; else if(d===0)cToday++; else if(d<=windowDays)cSoon++; });
      const maint = lsGet(maintKey(id), []);
      (maint||[]).forEach(t => {
        if (!t.freqDays || !t.last) return;
        const nd = addDays(t.last, t.freqDays);
        const d=inRange(nd); if(d==null) return; if(d<0)cOver++; else if(d===0)cToday++; else if(d<=windowDays)cSoon++;
      });
    });
    return { today:cToday, soon:cSoon, overdue:cOver };
  }

  function showNotification(title, body){
    if (!isSupported()) return;
    const n = new Notification(title, { body, tag:'smsd-digest', renotify:true });
    try { n.onclick = () => { window.focus(); if (window.showTab) window.showTab('calendar'); n.close(); }; } catch{}
  }

  async function enableNotifications(){
    if (!isSupported()){ alert('V√°≈° prohl√≠≈æeƒç nepodporuje notifikace.'); return false; }
    let perm = Notification.permission;
    if (perm === 'default'){ perm = await Notification.requestPermission(); }
    if (perm !== 'granted'){ alert('Notifikace nepovoleny.'); return false; }
    localStorage.setItem(NOTIFY_KEY, '1');
    updateToggleUI();
    scheduleDailyDigest();
    showNotification('Notifikace povoleny', 'Zobraz√≠m denn√≠ p≈ôehled v 09:00 nebo p≈ôi zmƒõn√°ch.');
    return true;
  }
  function disableNotifications(){
    localStorage.removeItem(NOTIFY_KEY);
    updateToggleUI();
    if (window._digestTimer){ clearTimeout(window._digestTimer); window._digestTimer=null; }
  }

  function updateToggleUI(){
    const btn = document.getElementById('notify-toggle-btn');
    if (!btn) return;
    btn.textContent = enabled() ? 'üîï Vypnout notifikace' : 'üîî Zapnout notifikace';
  }

  function msUntilNext(hour, min){
    const now = new Date();
    const target = new Date(); target.setHours(hour, min, 0, 0);
    if (target <= now){ target.setDate(target.getDate()+1); }
    return target - now;
  }

  function sendDigestIfNeeded(reason){
    if (!enabled() || Notification.permission!=='granted') return;
    const last = localStorage.getItem(LAST_DIGEST_KEY);
    const today = todayStr();
    const counts = computeCounts(14);
    if (reason==='change'){
      // compare snapshot; only notify when counts go up in today or overdue
      const prev = lsGet(SNAPSHOT_KEY, {today:0, overdue:0, soon:0});
      if (counts.today>prev.today || counts.overdue>prev.overdue){
        const body = `Dnes: ${counts.today}, Po term√≠nu: ${counts.overdue}, Brzy (‚â§14 dn√≠): ${counts.soon}`;
        showNotification('Nov√© ud√°losti', body);
      }
      lsSet(SNAPSHOT_KEY, counts);
      return;
    }
    // daily digest; send once per day
    if (last === today) return;
    if (counts.today || counts.overdue || counts.soon){
      const body = `Dnes: ${counts.today}, Po term√≠nu: ${counts.overdue}, Brzy (‚â§14 dn√≠): ${counts.soon}`;
      showNotification('√ödr≈æba & revize ‚Äì denn√≠ p≈ôehled', body);
      localStorage.setItem(LAST_DIGEST_KEY, today);
      lsSet(SNAPSHOT_KEY, counts);
    }
  }

  function scheduleDailyDigest(){
    if (!enabled()) return;
    const delay = msUntilNext(DIGEST_HOUR, DIGEST_MIN);
    if (window._digestTimer) clearTimeout(window._digestTimer);
    window._digestTimer = setTimeout(function run(){
      sendDigestIfNeeded('daily');
      // schedule next
      window._digestTimer = setTimeout(run, 24*60*60*1000);
    }, delay);
  }

  function updateBanner(){
    const banner = document.getElementById('notify-banner'); if (!banner) return;
    const btn = document.getElementById('notify-cta');
    const dismiss = document.getElementById('notify-dismiss');
    const counts = computeCounts(14);
    const shouldShow = !enabled() && (counts.today>0 || counts.overdue>0);
    banner.classList.toggle('hidden', !shouldShow);
    if (btn && !btn.dataset.wired){ btn.dataset.wired='1'; btn.addEventListener('click', enableNotifications); }
    if (dismiss && !dismiss.dataset.wired){ dismiss.dataset.wired='1'; dismiss.addEventListener('click', ()=> banner.classList.add('hidden')); }
  }

  // Wire buttons
  window.addEventListener('load', ()=>{
    updateToggleUI();
    updateBanner();
    // if already enabled & it's after 09:00 and no digest today, send immediately once
    if (enabled()){
      const now = new Date();
      const afterDigestTime = now.getHours()>DIGEST_HOUR || (now.getHours()===DIGEST_HOUR && now.getMinutes()>=DIGEST_MIN);
      const last = localStorage.getItem(LAST_DIGEST_KEY);
      if (afterDigestTime && last !== todayStr()){
        sendDigestIfNeeded('daily');
      }
      scheduleDailyDigest();
    }
    // test button
    const t = document.getElementById('notify-test-btn');
    if (t && !t.dataset.wired){
      t.dataset.wired='1';
      t.addEventListener('click', ()=>{
        if (!enabled()) enableNotifications();
        else showNotification('Test notifikace', 'V≈°echno funguje ‚úÖ');
      });
    }
    const toggle = document.getElementById('notify-toggle-btn');
    if (toggle && !toggle.dataset.wired){
      toggle.dataset.wired='1';
      toggle.addEventListener('click', ()=> enabled() ? disableNotifications() : enableNotifications());
    }
  });

  // React to data changes (storage)
  window.addEventListener('storage', ()=>{
    updateBanner();
    sendDigestIfNeeded('change');
  });
})();
</script>


<!-- CHATGPT PATCH 22: Backup logic (Export & Import) -->
<script>
(function(){
  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const p2 = n => String(n).padStart(2,'0');

  function collectDeviceIds(){
    const ids = new Set();
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if (k.startsWith('deviceDetail:')){
        const parts = k.split(':');
        const id = parts[parts.length-1];
        if (id) ids.add(id);
      }
    }
    return Array.from(ids).sort();
  }

  function getInventorySnapshot(include){
    const out = { included:false };
    if (!include) return out;
    try {
      if (window.getPartsDB){
        const db = window.getPartsDB();
        if (db && db.arr){
          out.included = true;
          out.key = db.key || null;
          out.map = db._map || null;
          out.rows = db.arr || [];
        }
      }
    } catch(e){ console.warn('Inventory snapshot failed', e); }
    return out;
  }

  function collectAll(includeInventory){
    const exportObj = {
      meta: {
        version: 1,
        exportedAt: new Date().toISOString(),
        app: 'SMSD-lite',
        user: localStorage.getItem('app:username') || null
      },
      globals: {
        nameMap: (function(){ try{ return JSON.parse(localStorage.getItem('deviceDetail:nameMap')||'{}'); }catch{ return {}; } })(),
        notifyEnabled: localStorage.getItem('app:notifyEnabled') === '1'
      },
      devices: {},
      inventory: getInventorySnapshot(includeInventory)
    };

    const ids = collectDeviceIds();
    ids.forEach(id => {
      const section = {};
      ['svc','hist','plans','maint','audit'].forEach(kind => {
        const key = `deviceDetail:${kind}:${id}`;
        try { section[kind] = JSON.parse(localStorage.getItem(key) || '[]'); } catch{ section[kind] = []; }
      });
      exportObj.devices[id] = section;
    });

    // counts
    let svc=0,hist=0,plans=0,maint=0,audit=0,photos=0;
    Object.values(exportObj.devices).forEach(sec => {
      svc += (sec.svc||[]).length;
      hist += (sec.hist||[]).length;
      plans += (sec.plans||[]).length;
      maint += (sec.maint||[]).length;
      audit += (sec.audit||[]).length;
      (sec.svc||[]).forEach(s => photos += (s.photos||[]).length);
    });
    exportObj.meta.counts = { devices: Object.keys(exportObj.devices).length, svc, hist, plans, maint, audit, photos };

    return exportObj;
  }

  function downloadJSON(obj){
    const ts = new Date();
    const fn = `backup_${ts.getFullYear()}-${p2(ts.getMonth()+1)}-${p2(ts.getDate())}_${p2(ts.getHours())}${p2(ts.getMinutes())}.json`;
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fn;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
  }

  // Update backup statistics and optionally preview JSON.
  // showPreview: when true, the JSON preview panel is displayed and populated; otherwise it remains hidden.
  function setStatsPreview(obj, showPreview){
    const s = $('#backup-stats');
    if (!s) return;
    const c = obj.meta.counts;
    s.innerHTML = `Za≈ô√≠zen√≠: <b>${c.devices}</b> ‚Ä¢ Servisy: <b>${c.svc}</b> ‚Ä¢ Historie: <b>${c.hist}</b> ‚Ä¢ Pl√°ny: <b>${c.plans}</b> ‚Ä¢ Preventivka: <b>${c.maint}</b> ‚Ä¢ Audit: <b>${c.audit}</b> ‚Ä¢ Fotky: <b>${c.photos}</b>`
      + (obj.inventory.included ? ` ‚Ä¢ Invent√°≈ô: <b>${(obj.inventory.rows||[]).length}</b> ≈ô√°dk≈Ø` : '');
    const prev = $('#backup-preview');
    if (prev){
      if (showPreview){
        prev.style.display = 'block';
        try {
          prev.textContent = JSON.stringify(obj.meta, null, 2);
        } catch(_){
          prev.textContent = '';
        }
      } else {
        // Hide preview when not requested
        prev.style.display = 'none';
      }
    }
  }

  async function readJSONFile(file){
    const txt = await file.text();
    return JSON.parse(txt);
  }

  function clearExisting(targetKeys){
    targetKeys.forEach(k => { try { localStorage.removeItem(k); } catch{} });
  }

  function mergeImport(data, replace){
    // Compose target key list for selective replace
    const keysToClear = [];
    Object.keys(data.devices||{}).forEach(id => {
      ['svc','hist','plans','maint','audit'].forEach(kind => keysToClear.push(`deviceDetail:${kind}:${id}`));
    });
    if (data.globals && data.globals.nameMap) keysToClear.push('deviceDetail:nameMap');
    if (data.inventory && data.inventory.included && data.inventory.key) keysToClear.push(data.inventory.key);

    if (replace) clearExisting(keysToClear);

    // Write devices
    Object.entries(data.devices||{}).forEach(([id, sec]) => {
      Object.entries(sec||{}).forEach(([kind, arr]) => {
        const key = `deviceDetail:${kind}:${id}`;
        if (!replace){
          // merge: concat arrays (avoid dup by id if present)
          try {
            const prev = JSON.parse(localStorage.getItem(key) || '[]');
            const seen = new Set();
            const merged = (prev.concat(arr||[])).filter(x => {
              const k = (x && (x.id || x.when || x.date)) ? String(x.id || x.when || x.date) : Math.random().toString(36).slice(2);
              if (seen.has(k)) return false; seen.add(k); return true;
            });
            localStorage.setItem(key, JSON.stringify(merged));
          } catch{ localStorage.setItem(key, JSON.stringify(arr||[])); }
        } else {
          localStorage.setItem(key, JSON.stringify(arr||[]));
        }
      });
    });

    // Globals
    if (data.globals){
      if (data.globals.nameMap) localStorage.setItem('deviceDetail:nameMap', JSON.stringify(data.globals.nameMap));
      if (data.globals.notifyEnabled){ localStorage.setItem('app:notifyEnabled', '1'); }
    }

    // Inventory
    if (data.inventory && data.inventory.included && data.inventory.rows){
      try {
        if (window.getPartsDB){
          const db = window.getPartsDB();
          const key = data.inventory.key || db?.key;
          if (key){
            localStorage.setItem(key, JSON.stringify(data.inventory.rows));
            // if map is provided, try to store it next to key (optional, if your app supports it)
          }
        }
      } catch(e){ console.warn('Inventory import failed', e); }
    }

    // Trigger refreshes
    try { window.updateCalendarBadge && window.updateCalendarBadge(); } catch{}
    window.dispatchEvent(new StorageEvent('storage', { key: 'backup:import', newValue: String(Date.now()) }));
    alert('Import dokonƒçen ‚úÖ');
  }

  function wireBackupsUI(){
    const exp = $('#backup-export');
    const inc = $('#backup-include-inventory');
    const imp = $('#backup-import-input');
    const impR = $('#backup-import-replace-input');
    if (exp && !exp.dataset.wired){
      exp.dataset.wired='1';
      exp.addEventListener('click', ()=>{
        const data = collectAll(!!inc?.checked);
        // Show the preview when exporting
        setStatsPreview(data, true);
        downloadJSON(data);
      });
    }
    if (imp && !imp.dataset.wired){
      imp.dataset.wired='1';
      imp.addEventListener('change', async ()=>{
        const f = imp.files?.[0]; if (!f) return;
        try {
          const data = await readJSONFile(f);
          // Show the preview when importing (merge)
          setStatsPreview(data, true);
          mergeImport(data, false);
        } catch(e){ alert('Import selhal: '+e); }
        imp.value='';
      });
    }
    if (impR && !impR.dataset.wired){
      impR.dataset.wired='1';
      impR.addEventListener('change', async ()=>{
        const f = impR.files?.[0]; if (!f) return;
        if (!confirm('Opravdu nahradit existuj√≠c√≠ data? Tato akce p≈ôep√≠≈°e za≈ô√≠zen√≠ a invent√°≈ô.')){ impR.value=''; return; }
        try {
          const data = await readJSONFile(f);
          // Show the preview when importing (replace)
          setStatsPreview(data, true);
          mergeImport(data, true);
        } catch(e){ alert('Import selhal: '+e); }
        impR.value='';
      });
    }

    // Auto-show stats for current snapshot
    try {
      const snap = collectAll(!!inc?.checked);
      // Hide preview on initial load; only update counts summary
      setStatsPreview(snap, false);
    } catch{}
  }

  // Wire when Settings tab opens
  const _showTab = window.showTab;
  window.showTab = function(name){
    if (_showTab) _showTab(name);
    if (name === 'settings'){ setTimeout(wireBackupsUI, 0); }
  };
  window.addEventListener('load', ()=>{
    if (!document.getElementById('tab-settings')?.classList.contains('hidden')) wireBackupsUI();
  });
})();
</script>


<!-- CHATGPT PATCH 23: Roles & Permissions logic -->
<script>
(function(){
  const ROLE_KEY = 'app:role';
  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

  // Permission matrix
  const PERMS = {
    admin: {
      'service:create':1,'service:edit':1,'service:delete':1,
      'plan:create':1,'plan:edit':1,'plan:delete':1,'plan:complete':1,
      'calendar:dragdrop':1,
      'maint:manage':1,
      'backup:export':1,'backup:import':1,
      'templates:save':1,
      'inventory:update':1,
      'audit:view':1,
    },
    technik: {
      'service:create':1,'service:edit':1,'service:delete':1,
      'plan:create':1,'plan:edit':1,'plan:delete':1,'plan:complete':1,
      'calendar:dragdrop':1,
      'maint:manage':1,
      'backup:export':1,'backup:import':0,
      'templates:save':1,
      'inventory:update':1,
      'audit:view':1,
    },
    viewer: {
      'service:create':0,'service:edit':0,'service:delete':0,
      'plan:create':0,'plan:edit':0,'plan:delete':0,'plan:complete':0,
      'calendar:dragdrop':0,
      'maint:manage':0,
      'backup:export':0,'backup:import':0,
      'templates:save':0,
      'inventory:update':0,
      'audit:view':1,
    }
  };
  function getRole(){ return localStorage.getItem(ROLE_KEY) || 'admin'; }
  function setRole(r){ localStorage.setItem(ROLE_KEY, r); updateRoleUI(); applyRoleGates(); }
  function can(action){ const r=getRole(); const set=PERMS[r]||PERMS.admin; return !!set[action]; }
  window.can = can; // export for other files

  function updateRoleUI(){
    const role = getRole();
    const chip = document.getElementById('role-chip');
    const name = document.getElementById('role-chip-name');
    if (chip && name){
      name.textContent = role.charAt(0).toUpperCase()+role.slice(1);
      chip.classList.remove('role-admin','role-technik','role-viewer');
      chip.classList.add('role-'+role);
    }
    const sel = document.getElementById('role-select');
    if (sel && sel.value !== role) sel.value = role;
  }

  // Gate UI elements across the app
  function applyRoleGates(){
    // Backups
    const btnExp = document.getElementById('backup-export');
    const btnImp = document.getElementById('backup-import-input');
    const btnImpLbl = document.querySelector('label[for="backup-import-input"]');
    const btnImpR = document.getElementById('backup-import-replace-input');
    const btnImpRLbl = document.querySelector('label[for="backup-import-replace-input"]');
    if (btnExp) btnExp.disabled = !can('backup:export');
    if (btnImp && btnImpLbl){ btnImp.disabled = !can('backup:import'); btnImpLbl.classList.toggle('disabled', !can('backup:import')); }
    if (btnImpR && btnImpRLbl){ btnImpR.disabled = !can('backup:import'); btnImpRLbl.classList.toggle('disabled', !can('backup:import')); }

    // Preventive manager
    const mSection = document.getElementById('preventive-panel');
    if (mSection){
      const add = document.getElementById('prev-add');
      const save = document.getElementById('prev-save');
      const imp = document.getElementById('prev-import-input');
      const impLbl = document.querySelector('label[for="prev-import-input"]');
      const exp = document.getElementById('prev-export');
      [add, save].forEach(b=>{ if (b) b.disabled = !can('maint:manage'); });
      if (imp) imp.disabled = !can('maint:manage');
      if (impLbl) impLbl.classList.toggle('disabled', !can('maint:manage'));
      if (exp) exp.disabled = !can('maint:manage'); // export povol√≠me jen admin/technik
      const devSel = document.getElementById('prev-device');
      if (devSel) devSel.disabled = !can('maint:manage');
    }

    // Calendar: month/week quick-adds, deletes, complete buttons will be gated at handler level; here disable visible buttons if exist
    $$('.qa-add').forEach(b => b.disabled = !can('plan:create'));
    // Toggle DnD by adding marker class; renderer will respect can('calendar:dragdrop')
    document.body.classList.toggle('role-can-dnd', can('calendar:dragdrop'));

    // Notification controls available to all, no gating

    // After updating role gates, rewire the auto-key behaviour for core data.  This ensures that
    // when the user changes role (e.g. from admin to technician), the key fields in Settings
    // reflect the correct editability and autogeneration logic.  We call both the legacy
    // auto-key wiring (if present) and the global autoGenerateKey for each type to update
    // the disabled state and slug values immediately.
    try { window.__wireCoreDataAutokey && window.__wireCoreDataAutokey(); } catch(e) {}
    try {
      ['warehouses','categories','machines','priorities'].forEach(function(t){
        if (typeof autoGenerateKey === 'function') autoGenerateKey(t);
      });
    } catch(e){}
  }

  function wireRolesUI(){
    const sel = document.getElementById('role-select');
    if (sel && !sel.dataset.wired){
      sel.dataset.wired='1';
      sel.addEventListener('change', ()=> setRole(sel.value));
    }
    updateRoleUI();
    applyRoleGates();
  }

  // Hook Settings tab open
  const _showTab = window.showTab;
  window.showTab = function(name){
    if (_showTab) _showTab(name);
    if (name==='settings'){ setTimeout(wireRolesUI, 0); }
    // also re-apply gates on calendar open (new elements may appear)
    if (name==='calendar'){ setTimeout(applyRoleGates, 0); }
  };
  window.addEventListener('load', ()=>{
    updateRoleUI();
    applyRoleGates();
  });

  // Export a tiny API for other scripts
  window.__roles = { can, getRole, applyRoleGates };
})();
</script>


<!-- CHATGPT PATCH 24: Service modal wiring -->
<script>
function openServiceForMachine(machineId){
  // close machine detail modal to avoid .modal query ambiguity
  try { hideModal('machine-detail-modal'); } catch{}
  const overlay = document.getElementById('svc-modal');
  overlay.dataset.machineId = machineId;
  // Set machine name in title if available
  try {
    const name = state.machines?.[machineId] || machineId;
    overlay.querySelector('.modal-title').textContent = `Servis & Historie ‚Äî ${name}`;
  } catch {}
  overlay.classList.remove('hidden');
  overlay.classList.add('active');
  // Initial renders
  try { renderServiceList(overlay); } catch(e){ console.warn('renderServiceList missing', e); }
  try { renderHistory(overlay); } catch(e){ console.warn('renderHistory missing', e); }
  try { __roles && __roles.applyRoleGates && __roles.applyRoleGates(); } catch {}
}
</script>

<script>
async function filesToDataURLs(files, maxW=1280, quality=0.75){
    const results = [];
    for (const file of files){
      if (!file.type.startsWith('image/')) continue;
      const dataURL = await new Promise((resolve)=>{
        const reader = new FileReader();
        reader.onload = async (ev)=>{
          const img = new Image();
          img.onload = ()=>{
            const scale = Math.min(1, maxW / img.width);
            const w = Math.round(img.width * scale);
            const h = Math.round(img.height * scale);
            const canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            let out = canvas.toDataURL('image/jpeg', quality);
            resolve(out);
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      });
      results.push({ name: file.name, type: 'image/jpeg', dataURL });
    }
    return results;
  }

  function svcKey(modal){ return LS_PREFIX + 'svc:' + getDeviceKey(modal); }
  function histKey(modal){ return LS_PREFIX + 'hist:' + getDeviceKey(modal); } // reserved if needed later

  async function addServiceRecord(){
    const modal = document.querySelector('.modal');
    if(!modal) return;
    const date = modal.querySelector('#svc-date')?.value || todayStr();
    const person = modal.querySelector('#svc-person')?.value || '';
    const desc = modal.querySelector('#svc-desc')?.value || '';
    const files = modal.querySelector('#svc-photos')?.files || [];
    const photos = await filesToDataURLs(files);

    const rec = {
      id: 'svc_' + Date.now(),
      date, person, desc,
      photos,
      createdAt: new Date().toISOString()
    };
    const arr = lsGet(svcKey(modal), []);
    arr.push(rec);
    lsSet(svcKey(modal), arr);
    renderServiceList(modal);
    renderHistory(modal);
    // clear form
    if(modal.querySelector('#svc-desc')) modal.querySelector('#svc-desc').value = '';
    if(modal.querySelector('#svc-photos')) modal.querySelector('#svc-photos').value = '';
  }
  window.addServiceRecord = addServiceRecord;

  function renderServiceList(modal){
    const listEl = modal.querySelector('#svc-list');
    if(!listEl) return;
    const recs = lsGet(svcKey(modal), []).slice().sort((a,b)=>b.date.localeCompare(a.date));
    if(recs.length===0){ listEl.innerHTML = '<div class="small-muted">Zat√≠m ≈æ√°dn√© servisn√≠ z√°znamy.</div>'; return; }
    listEl.innerHTML = recs.map(r => `
      <div class="svc-item">
        <h4>Servis ‚Äì ${r.desc ? escapeHtml(r.desc) : 'bez popisu'}</h4>
        <div class="meta">Datum: ${r.date}${r.person ? ' ‚Ä¢ Technik: ' + escapeHtml(r.person) : ''}</div>
        ${r.photos && r.photos.length ? `<div class="svc-photos">` + r.photos.map(p=>`<a href="${p.dataURL}" target="_blank" rel="noopener"><img src="${p.dataURL}" alt="" title="${escapeHtml(p.caption||'')}"></a>`).join('') + `</div>` : ''}
      </div>
    `).join('');
  }

  function renderHistory(modal){
    const histEl = modal.querySelector('#history-list');
    if(!histEl) return;
    // For now, aggregate only service records; later we can merge maintenance/protocol updates
    const svc = lsGet(svcKey(modal), []);
    const events = svc.map(r => ({ type:'Servis', when: r.date, title: r.desc || 'Z√°znam servisu', who: r.person }));
    if(events.length===0){ histEl.innerHTML = '<div class="small-muted">Zat√≠m ≈æ√°dn√° historie.</div>'; return; }
    // sort desc by date
    events.sort((a,b)=> b.when.localeCompare(a.when));
    histEl.innerHTML = events.map(e => `
      <div class="hist-item">
        <div class="title">${e.type}: ${escapeHtml(e.title)}</div>
        <div class="when">${e.when}${e.who ? ' ‚Ä¢ ' + escapeHtml(e.who) : ''}</div>
      </div>
    `).join('');
  }

  function escapeHtml(str){
    return String(str || '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  function initDefaults(modal){
    const d = modal.querySelector('#svc-date');
    if(d && !d.value){ d.value = todayStr(); }
  }

  // Initialize when a device detail modal appears
  const obs = new MutationObserver((mutations)=>{
    for(const m of mutations){
      for(const node of m.addedNodes){
        if(!(node instanceof HTMLElement)) continue;
        const modal = node.matches?.('.modal') ? node : node.querySelector?.('.modal');
        if(modal && modal.querySelector('.subgrid')){
          enableSectionReorder(modal);
          renderServiceList(modal);
          renderHistory(modal);
          initDefaults(modal);
        }
      }
    }
  });
  obs.observe(document.documentElement, { childList: true, subtree: true });

  // Also run on current modal if it's already in DOM
  window.addEventListener('load', ()=>{
    const modal = document.querySelector('.modal');
    if(modal && modal.querySelector('.subgrid')){
      enableSectionReorder(modal);
      renderServiceList(modal);
      renderHistory(modal);
      initDefaults(modal);
    }
  });
})();
</script>


<!-- CHATGPT PATCH 3: Auto-history for Maintenance & Protocol uploads -->
<script>
(function(){
  const LS_PREFIX = 'deviceDetail:';

  function lsGet(key, def){ try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e){ return def; } }
  function lsSet(key, val){ try { localStorage.setItem(key, JSON.stringify(val)); } catch(e){ console.warn('LocalStorage full?', e); } }

  function getDeviceKey(modal){
    const idEl = modal.querySelector('[data-machine-id],[data-device-id]');
    if (idEl && (idEl.dataset.machineId || idEl.dataset.deviceId)) {
      return (idEl.dataset.machineId || idEl.dataset.deviceId);
    }
    const t = (modal.querySelector('.modal-title')?.textContent || '').trim();
    return t || 'global';
  }
  function histKey(modal){ return LS_PREFIX + 'hist:' + getDeviceKey(modal); }
  function svcKey(modal){ return LS_PREFIX + 'svc:' + getDeviceKey(modal); }

  function nowDate(){ const d = new Date(); return d.toISOString().slice(0,10); } // YYYY-MM-DD
  function addHistory(modal, type, title, meta){
    const key = histKey(modal);
    const arr = lsGet(key, []);
    arr.push({ id: 'hist_'+Date.now()+Math.random().toString(36).slice(2), type, title, meta: meta||'', when: nowDate() });
    lsSet(key, arr);
    // re-render
    if (window.renderHistory) window.renderHistory(modal);
  }

  function getLabelForInput(input){
    // Try "label for=id"
    if (input.id) {
      const lab = input.ownerDocument.querySelector(`label[for="${CSS.escape(input.id)}"]`);
      if (lab) return lab.textContent.trim();
    }
    // Try nearest preceding label in same form-group
    const grp = input.closest('.form-group') || input.parentElement;
    if (grp){
      const lab = grp.querySelector('label');
      if (lab) return lab.textContent.trim();
    }
    return input.placeholder || input.name || input.type || 'Pole';
  }

  function watchMaintenance(modal){
    const sec = modal.querySelector('#sec-maint');
    if (!sec || sec.dataset.watchHist === '1') return;
    sec.dataset.watchHist = '1';

    // Inputs/Selects changes
    sec.addEventListener('change', (e)=>{
      const el = e.target;
      if (!(el instanceof HTMLElement)) return;
      if (!['INPUT','SELECT','TEXTAREA'].includes(el.tagName)) return;
      const label = getLabelForInput(el);
      let value = '';
      if (el.tagName === 'INPUT' && (el.type === 'checkbox' || el.type === 'radio')) {
        value = el.checked ? 'zapnuto' : 'vypnuto';
      } else {
        value = (el.value || '').toString();
      }
      if (value.length > 120) value = value.slice(0,117)+'‚Ä¶';
      addHistory(modal, '√ödr≈æba', `${label} ‚Üí ${value}`);
    });

    // Buttons (nap≈ô. "Dnes", "P≈ôidat", "Ulo≈æit" ‚Ä¶)
    sec.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if (!btn) return;
      const tx = (btn.textContent || btn.title || '').trim();
      if (!tx) return;
      // Ignore collapse/drag
      if (btn.classList.contains('drag-handle')) return;
      if (/Sbalit|rozbalit/i.test(tx)) return;
      addHistory(modal, '√ödr≈æba', `Akce: ${tx}`);
    });
  }

  function watchProtocols(modal){
    const sec = modal.querySelector('#sec-protocols');
    if (!sec || sec.dataset.watchHist === '1') return;
    sec.dataset.watchHist = '1';

    const fi = sec.querySelector('input[type="file"]');
    if (!fi) return;
    fi.addEventListener('change', (e)=>{
      const files = [...(fi.files || [])];
      if (!files.length) return;
      if (files.length === 1){
        addHistory(modal, 'Protokol', `Nahr√°n soubor: ${files[0].name}`);
      } else {
        addHistory(modal, 'Protokol', `Nahr√°no ${files.length} soubor≈Ø (nap≈ô. ${files[0].name})`);
      }
    });
  }

  // Extend existing renderHistory to include explicit history records + service records
  const _renderHistory = window.renderHistory;
  window.renderHistory = function(modal){
    const histEl = (modal || document).querySelector('#history-list');
    if (!histEl) return;

    // explicit hist events
    const hKey = histKey(modal || document.querySelector('.modal') || document);
    const hist = lsGet(hKey, []);

    // service-derived events
    const svc = lsGet(svcKey(modal || document.querySelector('.modal') || document), [])
      .map(r => ({ type: 'Servis', when: r.date, title: r.desc || 'Z√°znam servisu', who: r.person }));

    const events = [
      ...hist,
      ...svc.map(e => ({ id:'svc_'+Math.random().toString(36).slice(2), type: e.type, title: e.title, meta: e.who||'', when: e.when }))
    ];

    if (events.length === 0){
      histEl.innerHTML = '<div class="small-muted">Zat√≠m ≈æ√°dn√° historie.</div>';
      return;
    }

    // sort desc by date (YYYY-MM-DD)
    events.sort((a,b) => b.when.localeCompare(a.when));

    histEl.innerHTML = events.map(e => `
      <div class="hist-item">
        <div class="title">${e.type}: ${escapeHtml(e.title||'')}</div>
        <div class="when">${e.when}${e.meta ? ' ‚Ä¢ ' + escapeHtml(e.meta) : ''}</div>
      </div>
    `).join('');
  };

  // Hook into modal appearance (reuse existing observer if present)
  function initWatchers(modal){
    try { watchMaintenance(modal); } catch(e){ console.warn(e); }
    try { watchProtocols(modal); } catch(e){ console.warn(e); }
  }

  // Run when modal is added
  const obs = new MutationObserver((mutations)=>{
    for(const m of mutations){
      for(const node of m.addedNodes){
        if(!(node instanceof HTMLElement)) continue;
        const modal = node.matches?.('.modal') ? node : node.querySelector?.('.modal');
        if (modal){
          initWatchers(modal);
          if (window.renderHistory) window.renderHistory(modal);
        }
      }
    }
  });
  obs.observe(document.documentElement, { childList: true, subtree: true });

  // And on existing modal
  window.addEventListener('load', ()=>{
    const modal = document.querySelector('.modal');
    if (modal){
      initWatchers(modal);
      if (window.renderHistory) window.renderHistory(modal);
    }
  });
})();
</script>


<!-- CHATGPT PATCH 4: Service edit/delete + data export/import + maintenance/revision actions -->
<script>
(function(){
  const LS_PREFIX = 'deviceDetail:';

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const todayStr = () => new Date().toISOString().slice(0,10);
  const esc = (s) => String(s||'').replace(/[&<>"']/g, t => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[t]));

  function getDeviceKey(modal){
    const idEl = modal.querySelector('[data-machine-id],[data-device-id]');
    if (idEl && (idEl.dataset.machineId || idEl.dataset.deviceId)) {
      return (idEl.dataset.machineId || idEl.dataset.deviceId);
    }
    const t = (modal.querySelector('.modal-title')?.textContent || '').trim();
    return t || 'global';
  }
  const svcKey = (modal) => LS_PREFIX + 'svc:' + getDeviceKey(modal);
  const histKey = (modal) => LS_PREFIX + 'hist:' + getDeviceKey(modal);

  function lsGet(key, def){ try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e){ return def; } }
  function lsSet(key, val){ try { localStorage.setItem(key, JSON.stringify(val)); } catch(e){ alert('Ukl√°d√°n√≠ do LocalStorage se nezda≈ôilo (plno?).'); } }

  // --- Buttons injection (Maintenance & Revision) ---
  function ensureActionButtons(modal){
    // Maintenance: Dokonƒçeno dnes
    const maint = $('#sec-maint', modal);
    if (maint && !$('#maint-done-today-btn', maint)){
      const btn = document.createElement('button');
      btn.id = 'maint-done-today-btn';
      btn.className = 'btn btn-success';
      btn.textContent = '‚úì Dokonƒçeno dnes';
      btn.title = 'Nastav√≠ ‚ÄûPosledn√≠‚Äú na dne≈°n√≠ datum a vlo≈æ√≠ do Historie';
      (maint.querySelector('.section-actions') || maint.querySelector('.section-header') || maint).appendChild(btn);
      btn.addEventListener('click', ()=> markMaintenanceDone(modal));
    }

    // Revision: Zapsat revizi (dnes)
    const rev = $('#sec-revision', modal);
    if (rev && !$('#rev-add-today-btn', rev)){
      const btn2 = document.createElement('button');
      btn2.id = 'rev-add-today-btn';
      btn2.className = 'btn';
      btn2.textContent = '‚úì Zapsat revizi (dnes)';
      btn2.title = 'P≈ôid√° polo≈æku do Historie';
      (rev.querySelector('.section-actions') || rev.querySelector('.section-header') || rev).appendChild(btn2);
      btn2.addEventListener('click', ()=> addRevisionEvent(modal));
    }

    // Service: Export/Import
    const svc = $('#sec-service', modal);
    if (svc && !$('#svc-export-btn', svc)){
      const wrap = document.createElement('div');
      wrap.className = 'inline-actions';
      wrap.innerHTML = `
        <button id="svc-export-btn" class="btn">Export Servis (JSON)</button>
        <button id="svc-import-btn" class="btn">Import Servis (JSON)</button>
        <input id="svc-import-file" type="file" accept="application/json" style="display:none;">
      `;
      (svc.querySelector('.section-actions') || svc.querySelector('.section-header') || svc).appendChild(wrap);
      $('#svc-export-btn', svc).addEventListener('click', ()=> exportService(modal));
      $('#svc-import-btn', svc).addEventListener('click', ()=> $('#svc-import-file', svc).click());
      $('#svc-import-file', svc).addEventListener('change', e=> importService(modal, e.target.files?.[0]));
    }

    // History: Export CSV
    const hist = $('#sec-history', modal);
    if (hist && !$('#hist-export-csv-btn', hist)){
      const btn3 = document.createElement('button');
      btn3.id = 'hist-export-csv-btn';
      btn3.className = 'btn';
      btn3.textContent = 'Export Historie (CSV)';
      (hist.querySelector('.section-actions') || hist.querySelector('.section-header') || hist).appendChild(btn3);
      btn3.addEventListener('click', ()=> exportHistoryCSV(modal));
    }
  }

  // --- Maintenance complete ---
  function markMaintenanceDone(modal){
    const sec = $('#sec-maint', modal);
    if (!sec) return;
    // Find inputs for task name (√ökon) and the last date (Posledn√≠)
    const taskEl = sec.querySelector('input[placeholder], select, input[type="text"]');
    const dateEl = sec.querySelector('input[type="date"]');
    const taskName = (taskEl && (taskEl.value || taskEl.selectedOptions?.[0]?.text)) || '√ökon';
    const today = todayStr();
    if (dateEl) dateEl.value = today;
    addHistory(modal, '√ödr≈æba', `Dokonƒçeno: ${taskName}`, 'dnes');
    alert('√ödr≈æba zaps√°na do Historie.');
    if (window.renderHistory) window.renderHistory(modal);
  }

  // --- Revision event ---
  function addRevisionEvent(modal){
    addHistory(modal, 'Revize', 'Provedena revize', 'dnes');
    alert('Revize zaps√°na do Historie.');
    if (window.renderHistory) window.renderHistory(modal);
  }

  // --- History helpers ---
  function addHistory(modal, type, title, meta){
    const key = histKey(modal);
    const arr = lsGet(key, []);
    arr.push({ id:'hist_'+Date.now()+Math.random().toString(36).slice(2), type, title, meta: meta||'', when: todayStr() });
    lsSet(key, arr);
  }

  function exportHistoryCSV(modal){
    // Compose unified history (explicit + service-derived)
    const h = lsGet(histKey(modal), []);
    const svc = lsGet(svcKey(modal), []);
    const rows = [['date','type','title','meta']];
    // explicit
    h.forEach(e => rows.push([e.when, e.type, e.title||'', e.meta||'']));
    // service-derived
    svc.forEach(r => rows.push([r.date, 'Servis', r.desc||'Z√°znam servisu', r.person||'']));
    const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    download(`historie_${getDeviceKey(modal)}.csv`, csv, 'text/csv');
  }

  function exportService(modal){
    const data = lsGet(svcKey(modal), []);
    download(`servis_${getDeviceKey(modal)}.json`, JSON.stringify(data, null, 2), 'application/json');
  }
  function importService(modal, file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      try {
        const arr = JSON.parse(String(ev.target.result||'[]'));
        if(!Array.isArray(arr)) throw new Error('Soubor nen√≠ pole z√°znam≈Ø.');
        lsSet(svcKey(modal), arr);
        renderServiceListEnhanced(modal);
        if (window.renderHistory) window.renderHistory(modal);
        alert('Servis importov√°n.');
      } catch(e){
        alert('Import se nezda≈ôil: ' + e.message);
      }
    };
    reader.readAsText(file);
  }

  function download(filename, content, mime){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], {type: mime||'application/octet-stream'}));
    a.download = filename;
    a.click();
    setTimeout(()=> URL.revokeObjectURL(a.href), 2000);
  }

  // --- Service CRUD (edit/delete) ---
  function getSvc(modal){ return lsGet(svcKey(modal), []); }
  function setSvc(modal, arr){ lsSet(svcKey(modal), arr); }

  function renderServiceListEnhanced(modal){
    const listEl = $('#svc-list', modal);
    if(!listEl) return;
    const recs = getSvc(modal).slice().sort((a,b)=> b.date.localeCompare(a.date));
    if(recs.length === 0){
      listEl.innerHTML = '<div class="small-muted">Zat√≠m ≈æ√°dn√© servisn√≠ z√°znamy.</div>';
      return;
    }
    listEl.innerHTML = recs.map(r => `
      <div class="svc-item" data-id="${esc(r.id)}">
        <h4>Servis ‚Äì ${r.desc ? esc(r.desc) : 'bez popisu'}</h4>
        <div class="meta">Datum: ${r.date}${r.person ? ' ‚Ä¢ Technik: ' + esc(r.person) : ''}</div>
        ${r.photos && r.photos.length ? `<div class="svc-photos">` + r.photos.map(p=>`<a href="${p.dataURL}" target="_blank" rel="noopener"><img src="${p.dataURL}" alt="" title="${escapeHtml(p.caption||'')}"></a>`).join('') + `</div>` : ''}
        <div class="inline-actions" style="margin-top:8px;">
          <button class="btn btn-small" data-act="edit">Upravit</button>
          <button class="btn btn-small" data-act="delete">Smazat</button>
        </div>
      </div>
    `).join('');

    // Wire buttons
    listEl.querySelectorAll('button[data-act="edit"]').forEach(btn => btn.addEventListener('click', ()=>{
      const id = btn.closest('.svc-item').dataset.id;
      startEditService(modal, id);
    }));
    listEl.querySelectorAll('button[data-act="delete"]').forEach(btn => btn.addEventListener('click', ()=>{
      const id = btn.closest('.svc-item').dataset.id;
      if(confirm('Opravdu smazat tento servisn√≠ z√°znam?')){
        deleteService(modal, id);
      }
    }));
  }

  
function startEditService(modal, id){
    const arr = getSvc(modal);
    const rec = arr.find(x => x.id === id);
    if(!rec) return;
    $('#svc-date', modal).value = rec.date || todayStr();
    $('#svc-person', modal).value = rec.person || '';
    $('#svc-desc', modal).value = rec.desc || '';
    // preload required photos & photo editor state
    if ($('#svc-required-photos', modal)) $('#svc-required-photos', modal).value = rec.requiredPhotos || 0;
    const form = $('.service-form', modal);
    form.dataset.editId = id;
    // Load existing photos into editor so captions/tags/order can be edited
    try {
      const st = formState(modal) || (form._photoState = { photos: [] });
      st.photos = (rec.photos||[]).map((p, i)=> ({
        id: p.id || ('ph_'+Date.now()+'_'+i),
        name: p.name || ('photo_'+(i+1)+'.jpg'),
        type: p.type || 'image/jpeg',
        dataURL: p.dataURL,
        caption: p.caption || '',
        tags: p.tags || [],
        order: (typeof p.order==='number'? p.order : i)
      }));
      renderPhotoEditor(modal);
    } catch(e){ console.warn('Preload photos failed', e); }
    let btn = form.querySelector('button.btn-success');
    if(btn){ btn.textContent = 'üíæ Ulo≈æit zmƒõny'; }
  }

  function deleteService(modal, id){
    const arr = getSvc(modal).filter(x => x.id !== id);
    setSvc(modal, arr);
    renderServiceListEnhanced(modal);
    if (window.renderHistory) window.renderHistory(modal);
  }

  async function saveService(modal){
    const date = $('#svc-date', modal)?.value || todayStr();
    const person = $('#svc-person', modal)?.value || '';
    const desc = $('#svc-desc', modal)?.value || '';
    const files = $('#svc-photos', modal)?.files || [];
    const photos = await filesToDataURLs(files); // reuse from previous patch (global)

    const form = $('.service-form', modal);
    const editId = form?.dataset.editId;
    const arr = getSvc(modal);

    if(editId){
      const idx = arr.findIndex(x => x.id === editId);
      if(idx !== -1){
        const old = arr[idx];
        arr[idx] = {
          ...old,
          date, person, desc,
          photos: photos.length ? photos : (old.photos || []),
          updatedAt: new Date().toISOString()
        };
        setSvc(modal, arr);
        form.dataset.editId = '';
        const btn = form.querySelector('button.btn-success'); if(btn) btn.textContent = '‚ûï P≈ôidat z√°znam';
      }
    } else {
      const rec = { id: 'svc_'+Date.now(), date, person, desc, photos, createdAt: new Date().toISOString() };
      arr.push(rec);
      setSvc(modal, arr);
    }

    // clear file input only (text fields mohou z≈Østat)
    if($('#svc-photos', modal)) $('#svc-photos', modal).value = '';
    renderServiceListEnhanced(modal);
    if (window.renderHistory) window.renderHistory(modal);
  }

  // Override addServiceRecord to route to saveService
  window.addServiceRecord = function(){ const modal = document.querySelector('.modal'); if(modal) saveService(modal); };

  // Ensure our enhanced renderer runs when modal opens
  function initEnhancements(modal){
    ensureActionButtons(modal);
    renderServiceListEnhanced(modal);
    if (window.renderHistory) window.renderHistory(modal);
  }

  // filesToDataURLs from patch 2 must exist; if not, provide a fallback
  async function filesToDataURLs(files, maxW=1280, quality=0.75){
    if (!files || !files.length) return [];
    return await new Promise(resolve => {
      // quick sequential process
      const out = [];
      let i = 0;
      const next = () => {
        if (i >= files.length) return resolve(out);
        const file = files[i++];
        if (!file.type || !file.type.startsWith('image/')) { next(); return; }
        const reader = new FileReader();
        reader.onload = ev => {
          const img = new Image();
          img.onload = () => {
            const scale = Math.min(1, maxW / img.width);
            const w = Math.round(img.width * scale);
            const h = Math.round(img.height * scale);
            const canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            const dataURL = canvas.toDataURL('image/jpeg', quality);
            out.push({ name: file.name, type: 'image/jpeg', dataURL });
            next();
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      };
      next();
    });
  }

  // Observe modal open and initialize enhancements
  const obs = new MutationObserver((mutations)=>{
    for(const m of mutations){
      for(const node of m.addedNodes){
        if(!(node instanceof HTMLElement)) continue;
        const modal = node.matches?.('.modal') ? node : node.querySelector?.('.modal');
        if (modal && modal.querySelector('#sec-service')){
          initEnhancements(modal);
        }
      }
    }
  });
  obs.observe(document.documentElement, { childList: true, subtree: true });

  // Also on current modal
  window.addEventListener('load', ()=>{
    const modal = document.querySelector('.modal');
    if (modal && modal.querySelector('#sec-service')){
      initEnhancements(modal);
    }
  });
})();
</script>


<!-- CHATGPT PATCH 5: Roles, filters, PDF export, history delete + audit -->
<script>
(function(){
  const LS_PREFIX = 'deviceDetail:';
  const APP_ROLE_KEY = 'app:userRole'; // 'viewer' | 'editor' | 'admin'
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  // ----- Roles -----
  function getRole(){
    const r = localStorage.getItem(APP_ROLE_KEY);
    return r || 'viewer';
  }
  function setRole(r){
    localStorage.setItem(APP_ROLE_KEY, r);
    applyRoleUI();
  }
  function applyRoleUI(modal){
    modal = modal || document.querySelector('.modal') || document;
    const role = getRole();
    const badge = $('#role-badge', modal);
    if (badge){
      const map = { admin:'Admin', editor:'Editor', viewer:'Viewer' };
      badge.textContent = map[role] || role;
      badge.classList.remove('role-admin','role-editor','role-viewer');
      badge.classList.add('role-' + (role in map ? role : 'viewer'));
      badge.title = 'Klikni pro zmƒõnu role (pro demonstraci pr√°v)';
      badge.style.cursor = 'pointer';
      badge.onclick = () => {
        const next = role === 'viewer' ? 'editor' : (role === 'editor' ? 'admin' : 'viewer');
        setRole(next);
      };
    }
    // Permissions
    const canEdit = role === 'editor' || role === 'admin';
    const canDelete = role === 'admin';
    // Service form
    const svcForm = $('.service-form', modal);
    if (svcForm){
      svcForm.querySelectorAll('input,textarea,button').forEach(el => {
        if (el.id === 'svc-photos' || el.matches('.btn-success')){
          el.disabled = !canEdit;
        }
      });
    }
    // Service list actions
    $$('#sec-service .svc-item .inline-actions button', modal).forEach(btn=>{
      const act = btn.dataset.act;
      btn.disabled = (act === 'delete') ? !canDelete : !canEdit;
    });
    // Maintenance & Revision action buttons
    const maintBtn = $('#maint-done-today-btn', modal);
    if (maintBtn) maintBtn.disabled = !canEdit;
    const revBtn = $('#rev-add-today-btn', modal);
    if (revBtn) revBtn.disabled = !canEdit;
    // Export/Import buttons
    const exportBtn = $('#svc-export-btn', modal);
    const importBtn = $('#svc-import-btn', modal);
    const histCsvBtn = $('#hist-export-csv-btn', modal);
    const pdfBtn = $('#svc-pdf-btn', modal);
    [exportBtn, importBtn, histCsvBtn, pdfBtn].forEach(b => { if(b) b.disabled = !canDelete; });
    // History delete icons
    $$('.hist-del-btn', modal).forEach(b => b.disabled = !canDelete);
  }

  // ----- Filters: Service -----
  function svcApplyFilters(modal){
    const listEl = $('#svc-list', modal);
    if(!listEl) return;
    const from = $('#svc-from', modal)?.value || '';
    const to = $('#svc-to', modal)?.value || '';
    const tech = ($('#svc-tech', modal)?.value || '').toLowerCase();
    const q = ($('#svc-q', modal)?.value || '').toLowerCase();

    listEl.querySelectorAll('.svc-item').forEach(card => {
      const meta = card.querySelector('.meta')?.textContent.toLowerCase() || '';
      const title = card.querySelector('h4')?.textContent.toLowerCase() || '';
      const dateMatch = /Datum:\s*([0-9]{4}-[0-9]{2}-[0-9]{2})/.exec(card.querySelector('.meta')?.textContent || '');
      const date = dateMatch ? dateMatch[1] : '';
      let ok = true;
      if (from && date && date < from) ok = false;
      if (to && date && date > to) ok = false;
      if (tech && !meta.includes(tech)) ok = false;
      if (q && !(title.includes(q) || meta.includes(q))) ok = false;
      card.style.display = ok ? '' : 'none';
    });
  }

  // ----- Filters: History -----
  function histApplyFilters(modal){
    const from = $('#hist-from', modal)?.value || '';
    const to = $('#hist-to', modal)?.value || '';
    const q = ($('#hist-q', modal)?.value || '').toLowerCase();
    const types = $$('.hist-type', modal).filter(cb => cb.checked).map(cb => cb.value);

    $$('#history-list .hist-item', modal).forEach(row => {
      const when = (row.querySelector('.when')?.textContent || '').slice(0,10);
      const title = (row.querySelector('.title')?.textContent || '').toLowerCase();
      const type = (row.querySelector('.title')?.textContent.split(':')[0] || '').trim();
      let ok = true;
      if (from && when && when < from) ok = false;
      if (to && when && when > to) ok = false;
      if (types.length && !types.includes(type)) ok = false;
      if (q && !title.includes(q)) ok = false;
      row.style.display = ok ? '' : 'none';
    });
  }

  // Wire filter events
  function wireFilters(modal){
    ['#svc-from','#svc-to','#svc-tech','#svc-q'].forEach(sel => {
      const el = $(sel, modal); if (el) el.addEventListener('input', ()=> svcApplyFilters(modal));
    });
    ['#hist-from','#hist-to','#hist-q'].forEach(sel => {
      const el = $(sel, modal); if (el) el.addEventListener('input', ()=> histApplyFilters(modal));
    });
    $$('.hist-type', modal).forEach(cb => cb.addEventListener('change', ()=> histApplyFilters(modal)));
  }

  // ----- PDF Export -----
  

function exportServicePDF(modal){
  const title = (modal.querySelector('.modal-title')?.textContent || 'Za≈ô√≠zen√≠').trim();
  const svcCards = Array.from(modal.querySelectorAll('#svc-list .svc-item')).filter(el => el.style.display !== 'none');
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  const stamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
  const w = window.open('', '_blank');
  const styles = `
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;padding:16px;color:#222;}
    h1{font-size:20px;margin:0 0 10px}
    h2{font-size:16px;margin:16px 0 8px}
    .meta{color:#777;font-size:12px}
    .svc-card{border:1px solid #ddd;border-radius:10px;padding:10px;margin:10px 0}
    .svc-photos img{width:160px;height:120px;object-fit:cover;margin:4px;border-radius:6px;border:1px solid #ccc}
  `;
  const bodyCards = svcCards.map(card => {
    const h = card.querySelector('h4')?.outerHTML || '';
    const m = card.querySelector('.meta')?.outerHTML || '';
    const p = card.querySelector('.svc-photos')?.outerHTML || '';
    return `<div class="svc-card">${h}${m}${p||''}</div>`;
  }).join('');

  const html = `<!doctype html>
<html><head><meta charset="utf-8"><title>Servisn√≠ karta ‚Äì ${title}</title>
<style>${styles}</style>
</head><body>
  <h1>Servisn√≠ karta ‚Äì ${title}</h1>
  <div class="meta">Vygenerov√°no: ${stamp}</div>
  <h2>Servisn√≠ z√°znamy</h2>
  ${bodyCards}
</body></html>`;

  w.document.open();
  w.document.write(html);
  w.document.close();
  try { w.focus(); } catch{}
})();

</script>


<!-- CHATGPT PATCH 9: Inventory Mapper logic -->
<script>
(function(){
  const LS_PREFIX = 'deviceDetail:';
  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

  function getDeviceKey(modal){
    const idEl = (modal||document).querySelector('[data-machine-id],[data-device-id]');
    if (idEl && (idEl.dataset.machineId || idEl.dataset.deviceId)) return (idEl.dataset.machineId || idEl.dataset.deviceId);
    const t = (modal||document).querySelector('.modal-title')?.textContent?.trim();
    return t || 'global';
  }
  function lsGet(key, def){ try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e){ return def; } }
  function lsSet(key, val){ try { localStorage.setItem(key, JSON.stringify(val)); } catch(e){ alert('Nelze ulo≈æit nastaven√≠ (LocalStorage pln√Ω?).'); } }

  function invMapKey(modal, perDevice){
    return perDevice ? `${LS_PREFIX}invMap:${getDeviceKey(modal)}` : `${LS_PREFIX}invMap`;
  }

  function loadInvMap(modal){
    // prefer per-device if exists, otherwise global
    const per = lsGet(`${LS_PREFIX}invMap:${getDeviceKey(modal)}`, null);
    const glob = lsGet(`${LS_PREFIX}invMap`, null);
    return per || glob || { key:'parts', id:'id', name:'name', sku:'sku', qty:'qty' };
  }

  function listLsKeys(){
    const keys = [];
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      try {
        const v = JSON.parse(localStorage.getItem(k));
        if (Array.isArray(v)) keys.push(k);
      } catch {}
    }
    return keys.sort();
  }

  function showPreview(map){
    const box = $('#inv-preview-box');
    if (!box) return;
    try{
      const arr = JSON.parse(localStorage.getItem(map.key) || '[]');
      const head = ['id','name','sku','qty'].map(f => map[f]||f);
      const sample = (arr||[]).slice(0,10).map(it => ({
        id: it[map.id], name: it[map.name], sku: it[map.sku], qty: it[map.qty]
      }));
      box.textContent = JSON.stringify({ key: map.key, head, sample }, null, 2);
    }catch(e){
      box.textContent = 'N√°hled se nepoda≈ôil naƒç√≠st.';
    }
  }

  function wireInvMapper(modal){
    const toggle = $('#inv-map-toggle', modal);
    const panel = $('#inv-map-panel', modal);
    const keyIn = $('#inv-key', modal), idIn = $('#inv-id', modal), nameIn = $('#inv-name', modal),
          skuIn = $('#inv-sku', modal), qtyIn = $('#inv-qty', modal), perChk = $('#inv-per-device', modal);
    const saveBtn = $('#inv-save', modal), prevBtn = $('#inv-preview', modal);

    if (toggle && !toggle.dataset.wired){
      toggle.dataset.wired='1';
      toggle.addEventListener('click', ()=>{
        panel.style.display = panel.style.display==='block' ? 'none' : 'block';
      });
    }

    // datalist of localStorage keys
    const dl = $('#ls-keys', modal);
    if (dl && !dl.dataset.filled){
      dl.dataset.filled = '1';
      listLsKeys().forEach(k => {
        const o = document.createElement('option'); o.value = k; dl.appendChild(o);
      });
    }

    // load mapping
    const m = loadInvMap(modal);
    keyIn.value = m.key || '';
    idIn.value = m.id || 'id';
    nameIn.value = m.name || 'name';
    skuIn.value = m.sku || 'sku';
    qtyIn.value = m.qty || 'qty';

    const doSave = () => {
      const map = { key: keyIn.value.trim(), id:idIn.value.trim(), name:nameIn.value.trim(), sku:skuIn.value.trim(), qty:qtyIn.value.trim() };
      if (!map.key){ alert('Vypl≈à LocalStorage kl√≠ƒç.'); return; }
      lsSet(invMapKey(modal, perChk.checked), map);
      alert('Mapov√°n√≠ ulo≈æeno.');
      showPreview(map);
    };
    if (saveBtn && !saveBtn.dataset.wired){ saveBtn.dataset.wired='1'; saveBtn.addEventListener('click', doSave); }
    if (prevBtn && !prevBtn.dataset.wired){ prevBtn.dataset.wired='1'; prevBtn.addEventListener('click', ()=> showPreview({ key:keyIn.value, id:idIn.value, name:nameIn.value, sku:skuIn.value, qty:qtyIn.value })); }

    // initial preview
    showPreview(m);
  }

  // ---- Override getPartsDB & applyStockDeduction to use mapping first ----
  const _getPartsDB = window.getPartsDB;
  window.getPartsDB = function(){
    const modal = document.querySelector('.modal');
    const map = loadInvMap(modal);
    try{
      const arr = JSON.parse(localStorage.getItem(map.key) || '[]');
      if (Array.isArray(arr)){
        // wrap items with normalized view for matching
        return { src:'mapped:'+map.key, arr, key: map.key, _map: map };
      }
    }catch{}
    // fallback
    return _getPartsDB ? _getPartsDB() : {src:'none', arr:[]};
  };

  const _applyStockDeduction = window.applyStockDeduction;
  window.applyStockDeduction = function(used){
    const db = window.getPartsDB();
    if (db.src && db.src.startsWith('mapped:') && db._map){
      const m = db._map;
      let changed = false;
      used.forEach(u => {
        const match = (db.arr || []).find(p => {
          const id = p[m.id]; const sku = (p[m.sku]||'')+''; const name = (p[m.name]||'')+'';
          return (u.partId && String(id)===String(u.partId)) ||
                 (u.sku && sku.toLowerCase()===String(u.sku).toLowerCase()) ||
                 (u.name && name.toLowerCase()===String(u.name).toLowerCase());
        });
        if (match && typeof match[m.qty] === 'number'){
          match[m.qty] = Math.max(0, match[m.qty] - (u.qty||1));
          changed = true;
        }
      });
      if (changed){ localStorage.setItem(db.key, JSON.stringify(db.arr)); }
      if (!changed) console.warn('Mapov√°n√≠ OK, ale ≈æ√°dn√° polo≈æka nesedla ‚Äì zkontroluj pole id/sku/name.');
      return;
    }
    // fallback to previous logic
    if (_applyStockDeduction) _applyStockDeduction(used);
  };

  // Observe modal open to wire mapper
  const obs = new MutationObserver((mutations)=>{
    for(const m of mutations){
      for(const node of m.addedNodes){
        if(!(node instanceof HTMLElement)) continue;
        const modal = node.matches?.('.modal') ? node : node.querySelector?.('.modal');
        if (modal){
          try { wireInvMapper(modal); } catch(e){}
        }
      }
    }
  });
  obs.observe(document.documentElement, { childList:true, subtree:true });

  window.addEventListener('load', ()=>{
    const modal = document.querySelector('.modal');
    if (modal) try { wireInvMapper(modal); } catch{}
  });

})();
</script>


<!-- CHATGPT PATCH 10: Service checklist logic -->
<script>
(function(){
  const LS_PREFIX = 'deviceDetail:';
  const APP_USER_KEY = 'app:username';
  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const getUser = ()=> localStorage.getItem(APP_USER_KEY) || 'nezn√°m√Ω';

  // --- Helpers from previous patches (safe fallbacks) ---
  function getDeviceKey(modal){
    const idEl = (modal||document).querySelector('[data-machine-id],[data-device-id]');
    if (idEl && (idEl.dataset.machineId || idEl.dataset.deviceId)) return (idEl.dataset.machineId || idEl.dataset.deviceId);
    const t = (modal||document).querySelector('.modal-title')?.textContent?.trim();
    return t || 'global';
  }
  function lsGet(key, def){ try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e){ return def; } }
  function lsSet(key, val){ try { localStorage.setItem(key, JSON.stringify(val)); } catch(e){ console.warn('LocalStorage full?', e); } }
  function svcKey(modal){ return LS_PREFIX + 'svc:' + getDeviceKey(modal); }

  // --- Checklist UI ---
  function setChecklist(modal, items){
    const ul = $('#svc-checklist-list', modal); if (!ul) return;
    ul.innerHTML = '';
    (items || []).forEach((it, idx)=>{
      const li = document.createElement('li'); li.className = 'svc-chk';
      const id = 'chk_'+idx+'_'+Date.now();
      li.innerHTML = `<input type="checkbox" ${it.done?'checked':''} id="${id}"><label for="${id}">${escapeHtml(it.text||'')}</label><span class="rm" title="Odstranit">‚úñ</span>`;
      ul.appendChild(li);
      li.querySelector('.rm').addEventListener('click', ()=> li.remove());
    });
  }
  function getChecklist(modal){
    return $$('#svc-checklist-list .svc-chk', modal).map(li => {
      return { text: li.querySelector('label')?.textContent || '', done: li.querySelector('input[type="checkbox"]')?.checked || false };
    });
  }
  function wireChecklist(modal){
    const add = $('#svc-checklist-add', modal);
    const input = $('#svc-checklist-new', modal);
    const clear = $('#svc-checklist-clear', modal);
    if (add && !add.dataset.wired){
      add.dataset.wired='1';
      add.addEventListener('click', ()=>{
        const t = (input.value||'').trim();
        if (!t) return;
        const items = getChecklist(modal);
        items.push({ text:t, done:false });
        setChecklist(modal, items);
        input.value='';
      });
    }
    if (clear && !clear.dataset.wired){
      clear.dataset.wired='1';
      clear.addEventListener('click', ()=> setChecklist(modal, []));
    }
  }

  // --- Extend templates to include checklist + requiredPhotos ---
  if (window.getTpls && window.setTpls && window.renderTplSelect){
    const getTpls = window.getTpls;
    const setTpls = window.setTpls;
    window.defaultTpls = window.defaultTpls || function(){ return []; };

    // Replace default templates with versions including checklist & requiredPhotos
    window.getTpls = function(){
      const t = getTpls();
      if (Array.isArray(t) && t.length) return t;
      // fallback default
      return [
        { id:'tpl_oil', name:'V√Ωmƒõna oleje', req:{date:true, person:true, desc:true}, prefill:{desc:'V√Ωmƒõna oleje + kontrola tƒõsnosti'}, checklist:[
          'Zastavit za≈ô√≠zen√≠', 'Zajistit/odvƒõtrat', 'Vypustit star√Ω olej', 'Doplnit olej dle specifikace', '√öklid a z√°pis'
        ], requiredPhotos: 1 },
        { id:'tpl_filter', name:'V√Ωmƒõna filtru', req:{date:true, person:true, desc:true}, prefill:{desc:'V√Ωmƒõna filtru dle pl√°nu'}, checklist:[
          'Odpojit nap√°jen√≠', 'Demontovat star√Ω filtr', 'Namontovat nov√Ω filtr', 'Funkƒçn√≠ zkou≈°ka'
        ], requiredPhotos: 1 },
        { id:'tpl_check', name:'Kontrola stavu', req:{date:true, person:true, desc:true}, prefill:{desc:'Kontroln√≠ prohl√≠dka ‚Äì viz checklist'}, checklist:[
          'Kontrola uchycen√≠', 'Kontrola netƒõsnost√≠', 'Test bezpeƒçnostn√≠ch prvk≈Ø'
        ], requiredPhotos: 0 }
      ];
    };

    const _renderTplSelect = window.renderTplSelect;
    window.renderTplSelect = function(modal){
      if (_renderTplSelect) _renderTplSelect(modal);
      // ensure events for new behavior
      const sel = $('#svc-template', modal);
      if (sel && !sel.dataset.ckWired){
        sel.dataset.ckWired='1';
        sel.addEventListener('change', ()=>{
          const tpl = window.getTpls().find(t => t.id===sel.value);
          if (!tpl) return;
          // required photos
          const rp = $('#svc-required-photos', modal);
          if (rp) rp.value = tpl.requiredPhotos || 0;
          // checklist
          const items = (tpl.checklist || []).map(text => ({ text, done:false }));
          setChecklist(modal, items);
        });
      }
      // Save template should include checklist + requiredPhotos
      const saveBtn = $('#svc-template-save', modal);
      if (saveBtn && !saveBtn.dataset.ckWired){
        saveBtn.dataset.ckWired='1';
        saveBtn.addEventListener('click', ()=>{
          const name = prompt('N√°zev nov√© ≈°ablony:');
          if (!name) return;
          const tpls = getTpls() || [];
          const req = (function(){
            try { return JSON.parse($('.service-form', modal).dataset.req || '{}'); } catch { return {}; }
          })();
          const prefill = { desc: $('#svc-desc', modal)?.value || '' };
          const checklist = getChecklist(modal).map(i => i.text).filter(Boolean);
          const requiredPhotos = Math.max(0, parseInt($('#svc-required-photos', modal)?.value||'0',10) || 0);
          tpls.push({ id:'tpl_'+Date.now(), name, req, prefill, checklist, requiredPhotos });
          setTpls(tpls);
          window.renderTplSelect(modal);
          alert('≈†ablona ulo≈æena.');
        });
      }
    };
  }

  // --- Enhance validation: required photos + checklist done ---
  const _validateServiceForm = window.validateServiceForm || function(){ return true; };
  window.validateServiceForm = function(modal){
    let ok = _validateServiceForm(modal);
    // required photos
    const reqPhotos = Math.max(0, parseInt($('#svc-required-photos', modal)?.value||'0',10) || 0);
    if (reqPhotos > 0){
      const files = $('#svc-photos', modal)?.files || [];
      // if editing, count existing photos from record
      const form = $('.service-form', modal);
      const editId = form?.dataset.editId || '';
      let existing = 0;
      if (editId){
        const arr = lsGet(svcKey(modal), []);
        const rec = arr.find(x=>x.id===editId);
        existing = (rec?.photos || []).length;
      }
      const count = (files.length || 0) + existing;
      if (count < reqPhotos){
        $('#svc-photos', modal)?.classList.add('invalid');
        alert(`Je pot≈ôeba p≈ôilo≈æit alespo≈à ${reqPhotos} fotek (aktu√°lnƒõ ${count}).`);
        ok = false;
      } else {
        $('#svc-photos', modal)?.classList.remove('invalid');
      }
    }
    // checklist
    const items = getChecklist(modal);
    if (items.length && items.some(i => !i.done)){
      alert('Dokonƒçi checklist (za≈°krtni v≈°echny polo≈æky).');
      ok = false;
    }
    return ok;
  };

  // --- After saving, persist checklist + requiredPhotos + owner, and render badges ---
  const __prevSaveService = window.saveService;
  window.saveService = async function(modal){ if (!(window.can && ( ($('.service-form', modal)?.dataset.editId ? can('service:edit') : can('service:create')) ))) { alert('Nem√°te opr√°vnƒõn√≠ ukl√°dat servis.'); return; }
    if (!window.validateServiceForm(modal)) return;
    if (__prevSaveService) await __prevSaveService(modal);
    // attach checklist + requiredPhotos + owner on latest or edited record
    const key = svcKey(modal);
    const arr = lsGet(key, []);
    const form = $('.service-form', modal);
    const editId = form?.dataset.editId || '';
    const idx = editId ? arr.findIndex(x=>x.id===editId) : (arr.length-1);
    if (idx >= 0){
      arr[idx].checklist = getChecklist(modal);
      arr[idx].requiredPhotos = Math.max(0, parseInt($('#svc-required-photos', modal)?.value||'0',10) || 0);
      if (!arr[idx].owner) arr[idx].owner = getUser();
      lsSet(key, arr);
    }
    if (window.renderServiceListEnhanced) window.renderServiceListEnhanced(modal);
    if (window.renderHistory) window.renderHistory(modal);
  };

  // --- Override renderer to show checklist progress & used parts badges ---
  const _renderSvcList = window.renderServiceListEnhanced;
  window.renderServiceListEnhanced = function(modal){
    const listEl = $('#svc-list', modal);
    if (!listEl) return;
    const arr = lsGet(svcKey(modal), []).slice().sort((a,b)=> b.date.localeCompare(a.date));
    if(arr.length === 0){
      listEl.innerHTML = '<div class="small-muted">Zat√≠m ≈æ√°dn√© servisn√≠ z√°znamy.</div>';
      return;
    }
    listEl.innerHTML = arr.map(r => {
      const done = (r.checklist||[]).filter(i=>i.done).length;
      const total = (r.checklist||[]).length;
      const chkBadge = total ? `<span class="badge">Checklist: ${done}/${total}</span>` : '';
      const reqPhotos = r.requiredPhotos||0;
      const photosN = (r.photos||[]).length;
      const photoBadge = reqPhotos ? `<span class="badge">Foto: ${photosN}/${reqPhotos}</span>` : (photosN? `<span class="badge">Foto: ${photosN}</span>`:'');
      const used = (r.usedParts||[]);
      const usedBadge = used && used.length ? `<span class="badge">Pou≈æit√© d√≠ly: ${used.length}</span>` : '';
      return `
      <div class="svc-item" data-id="${escapeHtml(r.id)}" data-owner="${escapeHtml(r.owner||'')}">
        <h4>Servis ‚Äì ${r.desc ? escapeHtml(r.desc) : 'bez popisu'}</h4>
        <div class="meta">Datum: ${r.date}${r.person ? ' ‚Ä¢ Technik: ' + escapeHtml(r.person) : ''}${r.owner ? ' ‚Ä¢ Autor: ' + escapeHtml(r.owner) : ''}</div>
        <div class="svc-badges">${chkBadge}${photoBadge}${usedBadge}</div>
        ${r.photos && r.photos.length ? `<div class="svc-photos">` + r.photos.map(p=>`<a href="${p.dataURL}" target="_blank" rel="noopener"><img src="${p.dataURL}" alt="" title="${escapeHtml(p.caption||'')}"></a>`).join('') + `</div>` : ''}
        <div class="inline-actions" style="margin-top:8px;">
          <button class="btn btn-small" data-act="edit">Upravit</button>
          <button class="btn btn-small" data-act="delete">Smazat</button>
        </div>
      </div>`;
    }).join('');

    // Wire buttons: reuse existing handlers if present
    listEl.querySelectorAll('button[data-act="edit"]').forEach(btn => btn.addEventListener('click', ()=>{
      const id = btn.closest('.svc-item').dataset.id;
      if(window.startEditService) window.startEditService(modal, id);
    }));
    listEl.querySelectorAll('button[data-act="delete"]').forEach(btn => btn.addEventListener('click', ()=>{
      const card = btn.closest('.svc-item');
      const id = card.dataset.id;
      if(window.deleteService) window.deleteService(modal, id);
    }));

    try { if (window.applyServicePermissions) window.applyServicePermissions(modal); } catch{}
    try { if (window.svcApplyFilters) window.svcApplyFilters(modal); } catch{}
  };

  // Wire checklist on modal open
  const obs = new MutationObserver((mutations)=>{
    for(const m of mutations){
      for(const node of m.addedNodes){
        if(!(node instanceof HTMLElement)) continue;
        const modal = node.matches?.('.modal') ? node : node.querySelector?.('.modal');
        if (modal){
          try { wireChecklist(modal); } catch(e){}
        }
      }
    }
  });
  obs.observe(document.documentElement, { childList:true, subtree:true });

  window.addEventListener('load', ()=>{
    const modal = document.querySelector('.modal');
    if (modal) try { wireChecklist(modal); } catch{}
  });

})();

</script>
    <!-- CHATGPT PATCH: Core data auto-key generation and role-based editing -->
    <script>
    (function(){
      // Utility to generate a slug from a given string; removes diacritics and non‚Äëalphanumeric characters
      function slugify(str){
        return String(str||'').toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
          .replace(/\s+/g,'')
          .replace(/[^a-z0-9]/g,'');
      }
      // Apply automatic kl√≠ƒç generation and disable editing for non‚Äëadmin roles.  When run, it will
      // locate the new key/value inputs for warehouses, categories, machines and priorities.  If the
      // current role (via getRole()) is not 'admin', the key field is disabled and automatically
      // populated based on the value field.  For priorities the key is limited to one character; for
      // warehouses a minimum length of seven characters is enforced by padding with 'x'.
      function wireCoreDataAutokey(){
        const types = ['warehouses','categories','machines','priorities'];
        types.forEach(type => {
          const keyInput = document.getElementById(`new-${type}-key`);
          const valueInput = document.getElementById(`new-${type}-value`);
          if (!keyInput || !valueInput) return;
          const roleFn = (typeof getRole === 'function') ? getRole : (()=> 'admin');
          keyInput.disabled = roleFn() !== 'admin';
          // Remove previous listener if exists
          if (keyInput._autoGenListener){
            valueInput.removeEventListener('input', keyInput._autoGenListener);
          }
          const listener = () => {
            if (roleFn() !== 'admin'){
              let slug = slugify(valueInput.value);
              if (type === 'priorities') slug = slug.charAt(0);
              if (type === 'warehouses'){
                while (slug.length < 7) slug += 'x';
              }
              keyInput.value = slug;
            }
          };
          keyInput._autoGenListener = listener;
          valueInput.addEventListener('input', listener);
          // Immediately populate the key field based on the current value when wiring
          listener();
        });
      }
      // Export to global
      window.__wireCoreDataAutokey = wireCoreDataAutokey;
      // Apply on DOM ready
      document.addEventListener('DOMContentLoaded', () => setTimeout(wireCoreDataAutokey, 0));
      // Hook into showTab when defined; wrap once to avoid multiple hooks
      function hookShowTab(){
        const st = window.showTab;
        if (typeof st === 'function' && !st.__autokeyHooked){
          const wrapped = function(name){
            st.apply(this, arguments);
            if (name === 'settings') setTimeout(wireCoreDataAutokey, 0);
          };
          wrapped.__autokeyHooked = true;
          window.showTab = wrapped;
        }
      }
      hookShowTab();
      window.addEventListener('load', hookShowTab);
      // After hooking showTab, reapply role gates so that auto‚Äëkey wiring runs immediately
      // for the current role.  applyRoleGates will in turn call wireCoreDataAutokey via
      // the global __roles reference.  Wrapped in try/catch to avoid errors if roles
      // script is not yet loaded.
      try { window.__roles && window.__roles.applyRoleGates && window.__roles.applyRoleGates(); } catch(e){}
    })();
    </script>

    <!-- Ensure upgradeMachineMeta runs on DOM ready.  Previously this code was placed
         outside of the HTML and caused parse issues which broke subsequent scripts
         (for example the automatic key generator).  Moving it here keeps the
         listener within the document body and avoids syntax errors. -->
    <script>
    document.addEventListener('DOMContentLoaded', function(){ try { upgradeMachineMeta(); } catch(_) {} });
    </script>

    <!-- CHATGPT PATCH: Auto-generate keys based on names for core data (warehouses, categories, machines, priorities) -->
    <script>
    // Global slugify helper: remove diacritics, spaces and non‚Äëalphanumeric characters, lower‚Äëcase result.
    function slugify(str){
      return String(str||'').toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,'')
        .replace(/[^a-z0-9]/g,'');
    }
    /**
     * Automatically generate a key for the given core data type based on the input value.
     * For non‚Äëadmin users the key is auto‚Äëgenerated and the key field is disabled.  For
     * admin users the key field remains editable and no automatic updates occur.
     * Warehouses require at least seven characters (padded with 'x'), priorities take only
     * the first character.
     * @param {string} type One of 'warehouses','categories','machines','priorities'.
     */
    function autoGenerateKey(type){
      const keyInput = document.getElementById(`new-${type}-key`);
      const valueInput = document.getElementById(`new-${type}-value`);
      if(!keyInput || !valueInput) return;
      // Determine current role from the roles script; fallback to 'admin' if unavailable
      let role = 'admin';
      try { role = (typeof getRole === 'function') ? getRole() : 'admin'; } catch(e){}
      if(role !== 'admin'){
        let slug = slugify(valueInput.value);
        if(type === 'priorities') slug = slug.charAt(0);
        if(type === 'warehouses'){
          while(slug.length < 7) slug += 'x';
        }
        keyInput.value = slug;
        keyInput.disabled = true;
      } else {
        // Admin can freely edit; do not override existing value
        keyInput.disabled = false;
      }
    }
    // Initialize auto‚Äëgenerated keys on DOM ready for all types.  This ensures that if a role
    // other than admin is already selected (persisted in localStorage) when the Settings tab
    // loads, the key fields will reflect the correct state and initial slug values.
    document.addEventListener('DOMContentLoaded', function(){
      ['warehouses','categories','machines','priorities'].forEach(function(t){ autoGenerateKey(t); });
    });
    </script>
</body>
</html>
