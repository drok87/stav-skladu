<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systém správy náhradních dílů v13</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- Základní styly a proměnné --- */
        :root {
            --bg-color: #f0f2f5;
            --bg-secondary-color: #ffffff;
            --bg-tertiary-color: #f5f5f7;
            --text-primary-color: #1c1c1e;
            --text-secondary-color: #6a6a6a;
            --text-tertiary-color: #8e8e93;
            --border-color: #e5e5ea;
            --border-light-color: #d1d1d6;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --shadow-hover-color: rgba(0, 0, 0, 0.08);
            --accent-blue: #007aff;
            --accent-green: #34c759;
            --accent-red: #ff3b30;
            --accent-orange: #ff9500;
            --accent-yellow: #ffcc00;
            --accent-purple: #af52de;
        }

        .dark-mode {
            --bg-color: #000000;
            --bg-secondary-color: #1c1c1e;
            --bg-tertiary-color: #2c2c2e;
            --text-primary-color: #ffffff;
            --text-secondary-color: #aeaeb2;
            --text-tertiary-color: #8e8e93;
            --border-color: #3a3a3c;
            --border-light-color: #48484a;
            --shadow-color: rgba(255, 255, 255, 0.05);
            --shadow-hover-color: rgba(255, 255, 255, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            background-color: var(--bg-color);
            color: var(--text-primary-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        /* --- Přihlašovací obrazovka --- */
        #login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100%;
        }
        .login-box {
            width: 100%;
            max-width: 400px;
            padding: 40px;
            background: var(--bg-secondary-color);
            border-radius: 16px;
            box-shadow: 0 8px 24px var(--shadow-color);
            text-align: center;
        }
        .login-box h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .login-box p {
            color: var(--text-secondary-color);
            margin-bottom: 24px;
        }
        .login-box .form-group {
            text-align: left;
            margin-bottom: 16px;
        }
        #login-error {
            color: var(--accent-red);
            margin-top: 16px;
            font-size: 0.875rem;
            min-height: 1.2em;
        }


        /* --- Hlavička --- */
        .header {
            background: var(--bg-secondary-color);
            border-radius: 12px;
            box-shadow: 0 1px 2px var(--shadow-color), 0 0 0 1px var(--shadow-color);
            padding: 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary-color);
            margin-bottom: 8px;
        }
        .header p {
            color: var(--text-secondary-color);
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-info {
            text-align: right;
        }
        .user-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        .user-role {
            font-size: 0.875rem;
            color: var(--text-tertiary-color);
        }
        .user-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* --- Tmavý režim a Notifikace --- */
        .theme-switcher, .notifications-bell {
            background: var(--bg-tertiary-color);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-secondary-color);
            transition: all 0.2s ease;
        }
        .theme-switcher:hover, .notifications-bell:hover {
            background: var(--border-color);
            color: var(--text-primary-color);
        }
        .notifications-bell {
            position: relative;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-secondary-color);
        }
        .notifications-panel {
            position: absolute;
            top: 50px;
            right: 0;
            width: 320px;
            background: var(--bg-secondary-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid var(--border-color);
            z-index: 1001;
            overflow: hidden;
        }
        .notifications-panel-header {
            padding: 12px 16px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
        }
        .notifications-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
            color: var(--text-secondary-color);
            cursor: pointer;
        }
        .notification-item:hover {
            background: var(--bg-tertiary-color);
        }
        .notification-item.unread {
            background: var(--bg-tertiary-color);
            color: var(--text-primary-color);
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .notification-item .time {
            font-size: 0.75rem;
            color: var(--text-tertiary-color);
            display: block;
            margin-top: 4px;
        }

        /* --- Hlavní navigace --- */
        .main-nav {
            background: var(--bg-secondary-color);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px var(--shadow-color), 0 0 0 1px var(--shadow-color);
        }
        .main-nav-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .main-nav-button {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            color: var(--text-secondary-color);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
        }
        .main-nav-button:hover {
            background: var(--bg-tertiary-color);
            color: var(--text-primary-color);
        }
        .main-nav-button.active {
            background: var(--border-color);
            color: var(--text-primary-color);
            font-weight: 600;
        }

        /* --- Statistiky & Dashboard --- */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: var(--bg-secondary-color);
            border-radius: 12px;
            box-shadow: 0 1px 2px var(--shadow-color), 0 0 0 1px var(--shadow-color);
            padding: 24px;
            display: flex;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: none;
            cursor: pointer;
            position: relative;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-hover-color), 0 0 0 1px var(--shadow-color);
        }
        .stat-icon {
            width: 48px;
            height: 48px;
            margin-right: 16px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: var(--bg-tertiary-color);
        }
        .stat-content h3 {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-tertiary-color);
            margin-bottom: 4px;
        }
        .stat-content p {
            font-size: 1.875rem;
            font-weight: 600;
        }
        .stat-blue { color: var(--accent-blue); }
        .stat-red { color: var(--accent-red); }
        .stat-orange { color: var(--accent-orange); }
        .stat-green { color: var(--accent-green); }
        #personalized-dashboard h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        /* --- Filtry a Vyhledávání --- */
        .filters {
            background: var(--bg-secondary-color);
            border-radius: 12px;
            box-shadow: 0 1px 2px var(--shadow-color), 0 0 0 1px var(--shadow-color);
            padding: 24px;
            margin-bottom: 24px;
        }
        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
        }
        .filters-left {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }
        .search-box {
            position: relative;
        }
        .search-input {
            padding: 12px 12px 12px 44px;
            border: 1px solid var(--border-light-color);
            border-radius: 10px;
            width: 320px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background-color: var(--bg-tertiary-color);
            color: var(--text-primary-color);
        }
        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            background-color: var(--bg-secondary-color);
        }
        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary-color);
            font-size: 1.1rem;
        }
        .filter-select {
            padding: 12px 16px;
            border: 1px solid var(--border-light-color);
            border-radius: 10px;
            background: var(--bg-tertiary-color);
            font-size: 0.875rem;
            min-width: 140px;
            transition: all 0.2s ease;
            color: var(--text-primary-color);
        }
        .filter-select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            background-color: var(--bg-secondary-color);
        }
        .filters-right {
             display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }

        /* --- Tabulka --- */
        .table-container {
            background: var(--bg-secondary-color);
            border-radius: 12px;
            box-shadow: 0 1px 2px var(--shadow-color), 0 0 0 1px var(--shadow-color);
            overflow-x: auto;
        }
        .table-header {
            background: var(--bg-tertiary-color);
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary-color);
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }
        .table th {
            background: var(--bg-tertiary-color);
            padding: 16px 24px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-tertiary-color);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: color 0.2s;
        }
        .table th:hover {
            color: var(--text-primary-color);
        }
        .table th .sort-indicator {
            margin-left: 8px;
            opacity: 0.5;
        }
        .table th.sorted .sort-indicator {
            opacity: 1;
        }
        .table td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--bg-tertiary-color);
            vertical-align: middle;
            color: var(--text-primary-color);
        }
        .table tr:hover {
            background: var(--bg-tertiary-color);
        }
        .table tr.low-stock {
            background: rgba(255, 149, 0, 0.1);
        }
        .table tr.out-of-stock {
            background: rgba(255, 59, 48, 0.1);
        }
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* --- Modály --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
            backdrop-filter: blur(8px);
        }
        .modal {
            background: var(--bg-secondary-color);
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
            position: relative;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1), 0 0 0 1px var(--shadow-color);
            display: flex;
            flex-direction: column;
        }
        .modal-content-wrapper {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 32px;
            flex-grow: 1;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary-color);
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-tertiary-color);
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .modal-close:hover {
            color: var(--text-primary-color);
            background: var(--bg-tertiary-color);
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-light-color);
            border-radius: 10px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background-color: var(--bg-tertiary-color);
            color: var(--text-primary-color);
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            background-color: var(--bg-secondary-color);
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
            justify-content: flex-end;
        }
        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        /* --- Ostatní komponenty --- */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary-color);
            margin-bottom: 6px;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            text-decoration: none;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-primary:hover { background: #005bb5; }
        .btn-success { background: var(--accent-green); color: white; }
        .btn-warning { background: var(--accent-orange); color: white; }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-secondary { background: var(--border-color); color: var(--text-primary-color); }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 16px;
        }
        .badge-gray { background: var(--bg-tertiary-color); color: var(--text-primary-color); }
        .badge-red { background: rgba(255, 59, 48, 0.2); color: var(--accent-red); }
        .badge-orange { background: rgba(255, 149, 0, 0.2); color: var(--accent-orange); }
        .badge-green { background: rgba(52, 199, 89, 0.2); color: var(--accent-green); }
        .badge-blue { background: rgba(0, 122, 255, 0.2); color: var(--accent-blue); }
        .badge-purple { background: rgba(175, 82, 222, 0.2); color: var(--accent-purple); }
        .inventory-status { display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot-green { background: var(--accent-green); }
        .status-dot-yellow { background: var(--accent-orange); }
        .status-dot-red { background: var(--accent-red); }
        .hidden { display: none !important; }
        .font-medium { font-weight: 500; }
        .text-gray-500 { color: var(--text-tertiary-color); }
        .no-results { text-align: center; padding: 48px 24px; color: var(--text-tertiary-color); }
        .no-results .icon { font-size: 4rem; margin-bottom: 20px; display: block; opacity: 0.5; }

        /* Detail dílu - Nové styly */
        .part-detail-media {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .part-detail-image-container {
            width: 100%;
            height: 250px;
            background-color: var(--bg-tertiary-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px dashed var(--border-light-color);
        }
        .part-detail-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .part-detail-image-placeholder {
            font-size: 4rem;
            color: var(--text-tertiary-color);
            opacity: 0.5;
        }
        #part-qr-code { text-align: center; }
        #part-qr-code img { max-width: 150px; margin: 0 auto; }
        .file-upload-label {
            display: block;
            padding: 10px 15px;
            background-color: var(--border-color);
            color: var(--text-primary-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-upload-label:hover {
            background-color: var(--border-light-color);
        }
        .doc-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-tertiary-color);
            padding: 8px 12px;
            border-radius: 8px;
        }
        .doc-info span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .part-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px 24px; margin-bottom: 24px; }
        .detail-item h4 { font-size: 0.875rem; color: var(--text-tertiary-color); font-weight: 500; margin-bottom: 4px; }
        .detail-item p { font-size: 1rem; font-weight: 600; color: var(--text-primary-color); }
        .history-section { margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color); }
        .history-section h3 { font-size: 1.125rem; font-weight: 600; color: var(--text-primary-color); margin-bottom: 16px; }
        .history-list { max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; background-color: var(--bg-tertiary-color); }
        .history-item { padding: 8px 0; border-bottom: 1px dashed var(--border-light-color); font-size: 0.875rem; color: var(--text-primary-color); }
        .history-item:last-child { border-bottom: none; }
        .history-item .date { color: var(--text-tertiary-color); margin-right: 8px; }
        .history-item .type-add { color: var(--accent-green); }
        .history-item .type-remove { color: var(--accent-orange); }
        
        /* Objednávky */
        .order-item-row { display: grid; grid-template-columns: 2fr 1fr 1fr 40px; gap: 10px; align-items: center; margin-bottom: 10px; }
        .order-item-labels { display: grid; grid-template-columns: 2fr 1fr 1fr 40px; gap: 10px; padding: 0 10px; margin-bottom: 5px; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary-color); }
        .order-item-labels > div { padding-bottom: 5px; }
        .order-item-row .form-group { margin-bottom: 0; }
        .order-total { text-align: right; font-size: 1.2rem; font-weight: 600; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .remove-item-btn { background: none; border: none; color: var(--accent-red); font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 50%; line-height: 1; height: 30px; width: 30px; }
        .remove-item-btn:hover { background-color: var(--bg-tertiary-color); }

        /* Oprávnění */
        .permissions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .permissions-grid label { display: flex; align-items: center; gap: 8px; }


        /* Reporty */
        #reports-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; }
        .report-card { 
            background: var(--bg-secondary-color); 
            border-radius: 12px; 
            padding: 24px; 
            box-shadow: 0 1px 2px var(--shadow-color), 0 0 0 1px var(--shadow-color);
            position: relative;
        }
        .report-card h3 { margin-bottom: 20px; font-weight: 600; }
        .report-list { list-style: none; padding: 0; }
        .report-list li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .report-list li:last-child { border-bottom: none; }
        .pin-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .pin-btn:hover { opacity: 1; }
        .pin-btn.pinned { opacity: 1; color: var(--accent-blue); }
        
        /* Nová záložka Nastavení */
        #tab-settings .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }
        .settings-card {
            background: var(--bg-secondary-color);
            border-radius: 12px;
            box-shadow: 0 1px 2px var(--shadow-color), 0 0 0 1px var(--shadow-color);
            padding: 24px;
        }
        .settings-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary-color);
            margin-bottom: 16px;
        }
        #dispense-reasons-list .reason-item, .core-data-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        /* Inventura */
        #inventory-session-view .inventory-item {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr;
            gap: 16px;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
         #inventory-session-view .inventory-item:last-child {
            border-bottom: none;
        }
        .discrepancy-plus { color: var(--accent-green); }
        .discrepancy-minus { color: var(--accent-red); }

        /* Responzivní design */
        @media (max-width: 920px) {
            .modal-content-wrapper {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            .container { padding: 16px; }
            .header { flex-direction: column; text-align: center; gap: 16px; }
            .filters-row, .form-row, .form-row-3 { flex-direction: column; align-items: stretch; grid-template-columns: 1fr; }
            .filters-left { flex-direction: column; }
            .search-input { width: 100%; }
            .stats, #reports-container, #pinned-items-container { grid-template-columns: 1fr; }
            .main-nav-buttons { flex-direction: column; }
            .login-box { padding: 24px; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1>Přihlášení</h1>
            <p>Vítejte v systému správy náhradních dílů</p>
            <div class="form-group">
                <label for="login-email">Email</label>
                <input type="email" id="login-email" class="form-input" placeholder="vas.email@firma.cz">
            </div>
            <div class="form-group">
                <label for="login-password">Heslo</label>
                <input type="password" id="login-password" class="form-input" placeholder="••••••••">
            </div>
            <button class="btn btn-primary" style="width: 100%; padding: 12px;" onclick="handleLogin()">Přihlásit se</button>
            <p id="login-error"></p>
        </div>
    </div>

    <div id="app-container" class="container hidden">
        <div class="header">
            <div>
                <h1>Systém správy náhradních dílů v13</h1>
                <p>Kompletní řešení pro evidenci, hlídání a správu skladových zásob</p>
            </div>
            <div class="header-right">
                <div class="notifications-bell" onclick="toggleNotifications()">
                    🔔
                    <div id="notification-badge" class="notification-badge hidden">0</div>
                    <div id="notifications-panel" class="notifications-panel hidden">
                        <div class="notifications-panel-header">Oznámení</div>
                        <div class="notifications-list" id="notifications-list"></div>
                    </div>
                </div>
                <div class="theme-switcher" onclick="toggleDarkMode()">🌓</div>
                <div class="user-info">
                    <div class="user-name" id="current-user-name"></div>
                    <div class="user-role" id="current-user-role"></div>
                    <div class="user-actions">
                        <button class="btn btn-secondary" onclick="showChangePasswordModal()" style="padding: 4px 8px; font-size: 0.75rem;">
                            Změnit heslo
                        </button>
                        <button class="btn btn-secondary" onclick="handleLogout()" style="padding: 4px 8px; font-size: 0.75rem;">
                            Odhlásit
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-nav">
            <div class="main-nav-buttons">
                <button class="main-nav-button active" onclick="showTab('dashboard')">📊 Dashboard</button>
                <button class="main-nav-button" onclick="showTab('inventory')">📦 Sklad</button>
                <button class="main-nav-button" onclick="showTab('machines')">🏗️ Zařízení</button>
                <button class="main-nav-button" onclick="showTab('suppliers')">🏭 Dodavatelé</button>
                <button class="main-nav-button" onclick="showTab('orders')">🛒 Objednávky</button>
                <button class="main-nav-button" onclick="showTab('transfers')">🔄 Přesuny</button>
                <button class="main-nav-button" onclick="showTab('inventory-module')">✔️ Inventura</button>
                <button class="main-nav-button" onclick="showTab('transactions')">📋 Transakce</button>
                <button class="main-nav-button" onclick="showTab('reports')">📈 Reporty</button>
                <button class="main-nav-button" onclick="showTab('users')">👥 Uživatelé</button>
                <button class="main-nav-button" onclick="showTab('audit-log')">🛡️ Audit Log</button>
                <button class="main-nav-button" onclick="showTab('settings')">⚙️ Nastavení</button>
            </div>
        </div>

        <div id="tab-dashboard" class="tab-content">
            <div class="stats">
                <div class="stat-card" onclick="showTab('inventory')">
                    <div class="stat-icon stat-blue">📦</div>
                    <div class="stat-content"><h3>Celkem dílů na skladě</h3><p class="stat-blue" id="total-parts">0</p></div>
                </div>
                <div class="stat-card" onclick="showLowStockReport()">
                    <div class="stat-icon stat-red">⚠️</div>
                    <div class="stat-content"><h3>Nízký stav</h3><p class="stat-red" id="low-stock-parts">0</p></div>
                </div>
                <div class="stat-card" onclick="showCriticalPartsReport()">
                    <div class="stat-icon stat-orange">🚨</div>
                    <div class="stat-content"><h3>Kritické díly</h3><p class="stat-orange" id="critical-parts">0</p></div>
                </div>
                <div class="stat-card" onclick="showTotalValueDetails()">
                    <div class="stat-icon stat-green">💰</div>
                    <div class="stat-content"><h3>Hodnota skladu</h3><p class="stat-green" id="total-value">0 Kč</p></div>
                </div>
            </div>
            <div id="personalized-dashboard" class="hidden" style="margin-top: 24px;">
                <h2>Připnuté položky</h2>
                <div id="pinned-items-container" class="stats"></div>
            </div>
        </div>

        <div id="tab-inventory" class="tab-content hidden">
            <div class="filters">
                <div class="filters-row">
                    <div class="filters-left">
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="Hledat podle názvu, kódu..." id="search-input">
                            <div class="search-icon">🔍</div>
                        </div>
                        <select class="filter-select" id="warehouse-filter"></select>
                        <select class="filter-select" id="category-filter"></select>
                        <select class="filter-select" id="machine-filter"></select>
                    </div>
                    <div class="filters-right">
                        <button id="new-part-btn" class="btn btn-primary" onclick="showPartModal()">➕ Zavést nový typ dílu</button>
                        <button class="btn btn-success" onclick="showAssignPartModal()">📥 Naskladnit díl</button>
                    </div>
                </div>
            </div>
            <div class="table-container">
                 <div class="table-header">
                    <h3>Přehled skladu</h3>
                    <div class="filters-right">
                        <button class="btn" onclick="openBulkEditor()">🛠️ Hromadný editor</button>
    
                        <button class="btn" onclick="openBulkWarehouse()">🏷️ Doplnit sklad</button>
    
                        <button class="btn" onclick="resetSorting()">↕️ Reset třídění</button>

                        <button class="btn btn-secondary" onclick="exportTableToCSV('parts-table', 'sklad.csv')">📄 Export do CSV</button>
                        <button class="btn btn-success" onclick="exportTableToXLSX('parts-table', 'sklad.xlsx')">📊 Export do Excel</button>
                    
<style>
.smart-chips { display:flex; gap:8px; padding:10px 0 6px 0; flex-wrap:wrap; }
.smart-chip { padding:6px 10px; border:1px solid #d8dde4; border-radius:999px; background:#fff; cursor:pointer; font-size:13px; }
.smart-chip.active { background:#4f46e5; color:#fff; border-color:#4f46e5; }
</style>
<div class="smart-chips" id="smart-chips">
  <button class="smart-chip" data-mode="all" onclick="setSmartFilter('all')">Vše</button>
  <button class="smart-chip" data-mode="missing" onclick="setSmartFilter('missing')">Chybí údaje</button>
  <button class="smart-chip" data-mode="low" onclick="setSmartFilter('low')">Nízký stav</button>
  <button class="smart-chip" data-mode="recent" onclick="setSmartFilter('recent')">Naposledy importované</button>
</div>
<style>
#missing-filter-panel{ display:none; padding:8px 0 10px 0; }
#missing-filter-panel.active{ display:block; }
.missing-row{ display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
.mf-chip{ display:inline-flex; gap:6px; align-items:center; background:#f8fafc; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:13px; cursor:pointer; }
.mf-chip input{ margin:0; }
.mf-count{ font-size:12px; color:#6b7280; }
</style>
<div id="missing-filter-panel">
  <div class="missing-row">
    <label class="mf-chip"><input type="checkbox" id="mf-warehouse"> Sklad <span class="mf-count" id="mf-warehouse-count"></span></label>
    <label class="mf-chip"><input type="checkbox" id="mf-category"> Kategorie <span class="mf-count" id="mf-category-count"></span></label>
    <label class="mf-chip"><input type="checkbox" id="mf-supplier"> Dodavatel <span class="mf-count" id="mf-supplier-count"></span></label>
    <label class="mf-chip"><input type="checkbox" id="mf-min"> Min <span class="mf-count" id="mf-min-count"></span></label>
    <label class="mf-chip"><input type="checkbox" id="mf-max"> Max <span class="mf-count" id="mf-max-count"></span></label>
    <label class="mf-chip"><input type="checkbox" id="mf-umisteni"> Umístění <span class="mf-count" id="mf-umisteni-count"></span></label>
    <button class="btn" id="mf-clear">Vymazat výběr</button>
  </div>
  <div class="missing-row" style="margin-top:8px; font-size:12px; color:#6b7280;">
    Když nic nezaškrtnete, zobrazí se položky, kterým chybí <em>cokoliv</em> z výše uvedeného.
  </div>
</div>

</div>
                </div>
                <table class="table" id="parts-table"><thead id="parts-table-head"></thead><tbody id="parts-table-body"></tbody></table>
                <div id="no-results-message" class="no-results hidden">
                    <div class="icon">🔍</div><h3>Žádné výsledky</h3><p>Zkuste upravit kritéria vyhledávání.</p>
                </div>
            </div>
        </div>
        
        
        <div id="tab-machines" class="tab-content hidden">
            <div class="section-header">
                <h2>Zařízení</h2>
                <div class="table-actions">
                    <button class="btn btn-primary" onclick="showCreateMachineModal()">➕ Nové zařízení</button>
                    <button class="btn btn-secondary" onclick="showTab('settings')">⚙️ Spravovat zařízení</button>
                    <button class="btn btn-outline" onclick="exportMachinesToCSV()">⬇️ Export CSV</button>
                </div>
            </div>
            <div class="filters">
                <div class="filters-row">
                    <div class="filters-left">
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="Hledat zařízení..." id="machine-search-input">
                            <div class="search-icon">🔍</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <table class="table" id="machines-table">
                    <thead>
                        <tr>
                            <th>Název</th>
                            <th>Počet dílů</th>
                            <th>Kritické</th>
                            <th>Hodnota zásob</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody id="machines-table-body"></tbody>
                </table>
                <div id="machines-no-results" class="empty-state hidden">Žádná zařízení k zobrazení.</div>
            </div>
        </div>
<div id="tab-suppliers" class="tab-content hidden">
            <div class="table-container">
                <div class="table-header">
                    <h3>Seznam dodavatelů</h3>
                    <button class="btn btn-primary" onclick="showSupplierModal()">➕ Nový dodavatel</button>
                </div>
                <table class="table">
                    <thead><tr><th>Název</th><th>IČO</th><th>Kontakt</th><th>Email</th><th>Akce</th></tr></thead>
                    <tbody id="suppliers-table-body"></tbody>
                </table>
                 <div id="no-suppliers-message" class="no-results hidden"><div class="icon">🏭</div><h3>Žádní dodavatelé</h3><p>Zatím jste nezadali žádného dodavatele.</p></div>
            </div>
        </div>

        <div id="tab-orders" class="tab-content hidden">
            <div class="table-container">
                <div class="table-header">
                    <h3>Objednávky</h3>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="showCreateOrderModal()">➕ Nová objednávka</button>
                        <button class="btn btn-success" onclick="generateAutoOrders()">🤖 Auto objednávky</button>
                    </div>
                </div>
                <table class="table">
                    <thead><tr><th>Číslo</th><th>Dodavatel</th><th>Položky</th><th>Cena</th><th>Stav</th><th>Vytvořeno</th><th>Akce</th></tr></thead>
                    <tbody id="orders-table-body"></tbody>
                </table>
                <div id="no-orders-message" class="no-results hidden"><div class="icon">🛒</div><h3>Žádné objednávky</h3></div>
            </div>
        </div>

        <div id="tab-transfers" class="tab-content hidden">
            <div class="table-container">
                <div class="table-header">
                    <h3>Přesuny mezi sklady</h3>
                    <div class="table-actions"><button class="btn btn-primary" onclick="showCreateTransferModal()">➕ Nový přesun</button></div>
                </div>
                <table class="table">
                    <thead><tr><th>Číslo</th><th>Díl</th><th>Z</th><th>Do</th><th>Množství</th><th>Stav</th><th>Datum</th><th>Akce</th></tr></thead>
                    <tbody id="transfers-table-body"></tbody>
                </table>
                <div id="no-transfers-message" class="no-results hidden"><div class="icon">🔄</div><h3>Žádné přesuny</h3></div>
            </div>
        </div>

        <div id="tab-inventory-module" class="tab-content hidden">
             <div id="inventory-start-view">
                <div class="table-container">
                    <div class="table-header">
                        <h3>Probíhající a dokončené inventury</h3>
                        <button class="btn btn-primary" onclick="showStartInventoryModal()">➕ Nová inventura</button>
                    </div>
                    <table class="table">
                        <thead><tr><th>Sklad</th><th>Datum zahájení</th><th>Stav</th><th>Zpracoval</th><th>Akce</th></tr></thead>
                        <tbody id="inventory-list-body"></tbody>
                    </table>
                    <div id="no-inventory-message" class="no-results hidden"><div class="icon">✔️</div><h3>Žádné inventury</h3><p>Zahajte novou inventuru pro kontrolu skladu.</p></div>
                </div>
            </div>
            <div id="inventory-session-view" class="hidden"></div>
        </div>

        <div id="tab-transactions" class="tab-content hidden">
             <div class="filters">
                <div class="filters-row">
                    <div class="filters-left">
                        <label for="transaction-date-from">Od:</label>
                        <input type="date" id="transaction-date-from" class="form-input" style="width: auto;">
                        <label for="transaction-date-to">Do:</label>
                        <input type="date" id="transaction-date-to" class="form-input" style="width: auto;">
                        <button class="btn btn-secondary" onclick="renderTransactionsTable()">Filtrovat</button>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <div class="table-header"><h3>Historie transakcí</h3>
                    <div class="filters-right">
                        <button class="btn btn-secondary" onclick="exportTableToCSV('transactions-table', 'transakce.csv')">📄 Export do CSV</button>
                        <button class="btn btn-success" onclick="exportTableToXLSX('transactions-table', 'transakce.xlsx')">📊 Export do Excel</button>
                    </div>
                </div>
                <table class="table" id="transactions-table">
                    <thead><tr><th>Datum</th><th>Typ</th><th>Díl</th><th>Množství</th><th>Důvod/Poznámka</th><th>Uživatel</th></tr></thead>
                    <tbody id="transactions-table-body"></tbody>
                </table>
                <div id="no-transactions-message" class="no-results hidden"><div class="icon">📋</div><h3>Žádné transakce</h3></div>
            </div>
        </div>

        <div id="tab-reports" class="tab-content hidden">
            <div id="reports-container">
                <div class="report-card" data-chart-id="parts-by-category"><h3>Díly podle kategorie</h3><canvas id="parts-by-category-chart"></canvas></div>
                <div class="report-card" data-chart-id="value-by-category"><h3>Hodnota skladu podle kategorie</h3><canvas id="value-by-category-chart"></canvas></div>
                <div class="report-card" data-chart-id="top-used-parts">
                    <h3>TOP 10 nejpoužívanějších dílů (poslední rok)</h3>
                    <ul id="top-used-parts-list" class="report-list"></ul>
                </div>
                <div class="report-card" data-chart-id="shelf-warmers">
                    <h3>Skladové "ležáky" (bez výdeje za poslední rok)</h3>
                    <ul id="shelf-warmers-list" class="report-list"></ul>
                </div>
            </div>
        </div>

        <div id="tab-users" class="tab-content hidden">
            <div class="table-container">
                <div class="table-header">
                    <h3>Správa uživatelů</h3>
                    <div class="table-actions"><button class="btn btn-primary" onclick="showAddUserModal()">➕ Přidat uživatele</button></div>
                </div>
                <table class="table">
                    <thead><tr><th>Jméno</th><th>Email</th><th>Role</th><th>Sklady</th><th>Akce</th></tr></thead>
                    <tbody id="users-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-audit-log" class="tab-content hidden">
            <div class="table-container">
                <div class="table-header">
                    <h3>Audit Log - Záznamy o změnách</h3>
                    <div class="filters-right">
                        <select id="audit-log-user-filter" class="filter-select" onchange="renderAuditLogTable()"></select>
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Uživatel</th>
                            <th>Akce</th>
                            <th>Detail</th>
                        </tr>
                    </thead>
                    <tbody id="audit-log-table-body"></tbody>
                </table>
                <div id="no-audit-log-message" class="no-results hidden">
                    <div class="icon">🛡️</div>
                    <h3>Žádné záznamy</h3>
                    <p>Zatím nebyly provedeny žádné sledované změny.</p>
                </div>
            </div>
        </div>
        
        <div id="tab-settings" class="tab-content hidden">
            <div class="settings-grid">
                <div class="settings-card">
                    <h3>Správa dat</h3>
                    <p class="text-secondary-color" style="margin-bottom: 16px;">Zálohujte všechna data aplikace do souboru nebo je obnovte ze zálohy.</p>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-success" onclick="backupData()">💾 Stáhnout zálohu</button>
                        <button class="btn btn-warning" onclick="document.getElementById('restore-input').click()">📤 Nahrát ze zálohy</button>
                        <input type="file" id="restore-input" class="hidden" accept=".json" onchange="restoreData(event)">
                    
<div class="card" style="margin-top:16px; padding:16px; border:1px solid #e5e7eb; border-radius:12px;">
  <h3 style="margin:0 0 8px 0;">Nastavení SKU</h3>
  <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:12px; align-items:end;">
    <div>
      <label>Prefix</label>
      <input id="sku-prefix-input" class="input" placeholder="např. SKU-">
    </div>
    <div>
      <label>Počet číslic</label>
      <input id="sku-digits-input" class="input" type="number" min="1" max="12" placeholder="např. 6">
    </div>
    <div>
      <button class="btn btn-primary" onclick="saveSkuSettings()">Uložit</button>
    </div>
  </div>
  <div style="margin-top:10px; font-size:13px;">Další v řadě: <strong id="sku-next-preview">—</strong></div>
</div>
<script>
(function(){
  function ensureSkuSettings(){
    if (!state.settings) state.settings = {};
    if (!state.settings.skuPrefix) state.settings.skuPrefix = 'SKU-';
    if (state.settings.skuDigits == null) state.settings.skuDigits = 6;
  }
  function escRe(s){ return String(s).replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
  window.computeNextSkuSeed = function(){
    ensureSkuSettings();
    const re = new RegExp('^' + escRe(state.settings.skuPrefix) + '(\\d+)$', 'i');
    let maxNum = 0;
    for (const p of (state.parts || [])) {
      const m = (p.code || '').trim().match(re);
      if (m && m[1]) {
        const n = parseInt(m[1],10);
        if (!isNaN(n) && n > maxNum) maxNum = n;
      }
    }
    if (state.settings.nextSku && state.settings.nextSku - 1 > maxNum) maxNum = state.settings.nextSku - 1;
    return maxNum + 1;
  };
  function pad(n,w){ const s=String(n); return s.length>=w?s:'0'.repeat(w-s.length)+s; }
  window.updateSkuPreview = function(){
    try {
      ensureSkuSettings();
      const next = computeNextSkuSeed();
      const sample = state.settings.skuPrefix + pad(next, state.settings.skuDigits);
      const el = document.getElementById('sku-next-preview'); if (el) el.textContent = sample;
    } catch(e){}
  };
  window.saveSkuSettings = function(){
    ensureSkuSettings();
    const prefEl = document.getElementById('sku-prefix-input');
    const digEl = document.getElementById('sku-digits-input');
    if (prefEl && prefEl.value) state.settings.skuPrefix = prefEl.value;
    if (digEl && digEl.value) state.settings.skuDigits = Math.max(1, Math.min(12, parseInt(digEl.value,10) || 6));
    try { saveStateToLocalStorage(); } catch(_){}
    updateSkuPreview();
    try { showAlert('Uloženo','Nastavení SKU aktualizováno.','success'); } catch(_){}
  };
  document.addEventListener('DOMContentLoaded', function(){
    ensureSkuSettings();
    const prefEl = document.getElementById('sku-prefix-input');
    const digEl = document.getElementById('sku-digits-input');
    if (prefEl) prefEl.value = state.settings.skuPrefix;
    if (digEl) digEl.value = state.settings.skuDigits;
    updateSkuPreview();
  });
})();
</script>
</div>
                </div>
                 <div class="settings-card">
                    <h3>Obecné nastavení</h3>
                    <div class="form-group">
                        <label for="setting-low-stock-threshold">Hranice pro nízký stav (v % nad min. stav)</label>
                        <input type="number" id="setting-low-stock-threshold" class="form-input" value="20" min="0">
                        <p class="text-tertiary-color" style="font-size: 0.75rem; margin-top: 4px;">Díl bude označen jako "nízký stav", když jeho množství klesne pod `minStock * (1 + threshold / 100)`.</p>
                    </div>
                    <div class="form-group">
                        <label for="dashboard-scope-select">Zobrazení dat na Dashboardu</label>
                        <select id="dashboard-scope-select" class="form-select"></select>
                    </div>
                     <button class="btn btn-primary" onclick="saveSettings()">Uložit nastavení</button>
                </div>
                <div class="settings-card">
                    <h3>Důvody výdeje</h3>
                    <p class="text-secondary-color" style="margin-bottom: 16px;">Spravujte předdefinované možnosti pro důvod výdeje dílu ze skladu.</p>
                    <div id="dispense-reasons-list"></div>
                    <div style="display: flex; gap: 12px; margin-top: 16px;">
                        <input type="text" id="new-reason-key" placeholder="Klíč (např. oprava)" class="form-input">
                        <input type="text" id="new-reason-value" placeholder="Text (např. Oprava zařízení)" class="form-input">
                        <button class="btn btn-success" onclick="addDispenseReason()">➕</button>
                    </div>
                </div>
                 <div class="settings-card">
                    <h3>Kmenová data aplikace</h3>
                    <p class="text-secondary-color" style="margin-bottom: 16px;">Spravujte základní číselníky aplikace.</p>
                    
                    <!-- Správa skladů -->
                    <h4>Sklady</h4>
                    <div id="warehouses-settings-list"></div>
                    <div class="core-data-item">
                        <input type="text" id="new-warehouses-key" placeholder="Klíč (5 znaků)" class="form-input" maxlength="5">
                        <input type="text" id="new-warehouses-value" placeholder="Název skladu" class="form-input">
                        <button class="btn btn-success" onclick="addCoreDataItem('warehouses')">➕</button>
                    </div>

                    <!-- Správa kategorií -->
                    <h4 style="margin-top: 16px;">Kategorie</h4>
                    <div id="categories-settings-list"></div>
                    <div class="core-data-item">
                        <input type="text" id="new-categories-key" placeholder="Klíč (bez diakritiky)" class="form-input">
                        <input type="text" id="new-categories-value" placeholder="Název kategorie" class="form-input">
                        <button class="btn btn-success" onclick="addCoreDataItem('categories')">➕</button>
                    </div>

                    
                    <!-- Správa zařízení/strojů -->
                    <h4 style=\"margin-top: 16px;\">Zařízení / Stroje</h4>
                    <div id=\"machines-settings-list\"></div>
                    <div class=\"core-data-item\">
                        <input type=\"text\" id=\"new-machines-key\" placeholder=\"Klíč (bez diakritiky)\" class=\"form-input\">
                        <input type=\"text\" id=\"new-machines-value\" placeholder=\"Název zařízení / stroje\" class=\"form-input\">
                        <button class=\"btn btn-success\" onclick=\"addCoreDataItem('machines')\">➕</button>
                    </div>
                    <!-- Správa priorit -->
                    <h4 style="margin-top: 16px;">Priority</h4>
                    <div id="priorities-settings-list"></div>
                    <div class="core-data-item">
                        <input type="text" id="new-priorities-key" placeholder="Klíč (písmeno)" class="form-input" maxlength="1">
                        <input type="text" id="new-priorities-value" placeholder="Název priority" class="form-input">
                        <button class="btn btn-success" onclick="addCoreDataItem('priorities')">➕</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="part-modal" class="modal-overlay hidden"></div>
    <div id="assign-part-modal" class="modal-overlay hidden"></div>
    <div id="user-modal" class="modal-overlay hidden"></div>
    <div id="order-modal" class="modal-overlay hidden"></div>
    <div id="transfer-modal" class="modal-overlay hidden"></div>
    <div id="part-detail-modal" class="modal-overlay hidden"></div>
    <div id="receive-modal" class="modal-overlay hidden"></div>
    <div id="dispense-modal" class="modal-overlay hidden"></div>
    <div id="alert-modal" class="modal-overlay hidden"></div>
    <div id="supplier-modal" class="modal-overlay hidden"></div>
    <div id="inventory-modal" class="modal-overlay hidden"></div>
    <div id="change-password-modal" class="modal-overlay hidden"></div>
    <div id="machine-detail-modal" class="modal-overlay hidden"></div>
    <div id="machine-create-modal" class="modal-overlay hidden"></div>

    <script>
        // --- Globální stav aplikace ---
        let state = {
            parts: [], users: [], transactions: [], orders: [], transfers: [], notifications: [],
            suppliers: [], inventorySessions: [], auditLog: [],
            warehouses: {}, categories: {}, priorities: {}, dispenseReasons: {}, machines: {},
            settings: { lowStockThreshold: 20 },
            currentUser: null, // Uživatel se nastaví po přihlášení
            currentEditingId: null,
            sortConfig: { key: 'name', direction: 'ascending' }
        };

        const permissionPresets = {
            admin: { canEditParts: true, canDeleteParts: true, canCreateOrders: true, canCreateTransfers: true, canManageUsers: true, canViewReports: true, canAddMasterPart: true, canManageSettings: true, canManageSuppliers: true, canPerformInventory: true },
            vedouci_skladu: { canEditParts: true, canDeleteParts: false, canCreateOrders: true, canCreateTransfers: true, canManageUsers: false, canViewReports: true, canAddMasterPart: true, canManageSettings: false, canManageSuppliers: true, canPerformInventory: true },
            technik: { canEditParts: false, canDeleteParts: false, canCreateOrders: false, canCreateTransfers: true, canManageUsers: false, canViewReports: false, canAddMasterPart: false, canManageSettings: false, canManageSuppliers: false, canPerformInventory: false },
        };

        // --- Globální stav pro focus management ---
        let lastFocusedElement;

        // --- Inicializace ---
        document.addEventListener('DOMContentLoaded', () => {
            loadStateFromLocalStorage();
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
            }
            // Zobrazí přihlašovací obrazovku místo přímého spuštění aplikace
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
            
            // Event listener pro stisk Enter v poli hesla
            document.getElementById('login-password').addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleLogin();
                }
            });
            console.log("Aplikace v13 inicializována s přihlašovací obrazovkou!");
        });
        
        function initializeApp() {
            renderAll();
            setupEventListeners();
            checkForcePasswordChange();
        }

        function renderAll() {
            if (!state.currentUser) return; // Nespouštět renderování bez přihlášeného uživatele
            // Před vykreslením aktualizujeme optimální zásoby podle transakcí
            if (typeof updateOptimalStock === 'function') updateOptimalStock();
            updateUserInterface();
            renderPartsTable();
            renderSuppliersTable();
            renderOrdersTable();
            renderTransfersTable();
            renderInventoryList();
            renderTransactionsTable();
            renderUsersTable();
            renderFilters();
            renderNotifications();
            updateStats();
            // Zajistí, že se dashboard a další záložky vykreslí při prvním načtení
            const activeTab = document.querySelector('.main-nav-button.active').getAttribute('onclick').match(/'(.*?)'/)[1];
            showTab(activeTab);
        }

        // --- Správa dat a LocalStorage ---
        function loadStateFromLocalStorage() {
            const savedState = localStorage.getItem('sparePartsState_v13'); // Změna verze na v13
            if (savedState) {
                const loaded = JSON.parse(savedState);
                // Načteme vše kromě currentUser, ten se nastaví až po přihlášení
                const { currentUser, ...restOfState } = loaded;
                state = { ...state, ...restOfState };
                
                // Migrační skripty pro starší verze
                if (state.users && state.users.length > 0) {
                    state.users.forEach(u => {
                        if (typeof u.forcePasswordChange === 'undefined') {
                            u.forcePasswordChange = false;
                        }
                        if (!u.dashboard) {
                            u.dashboard = { pinnedParts: [], pinnedCharts: [], dashboardScope: 'all' };
                        }
                    });
                } else {
                    loadSampleData(); // Pokud nejsou uživatelé, načteme vzorová data
                    return;
                }

                if (state.parts) {
                    state.parts.forEach(p => {
                        if (p.price && !p.priceHistory) {
                            p.priceHistory = [{ date: new Date().toISOString(), price: p.price }];
                            delete p.price;
                        } else if (!p.priceHistory) {
                             p.priceHistory = [];
                        }
                        if (typeof p.imageData === 'undefined') p.imageData = null;
                        if (typeof p.docName === 'undefined') p.docName = null;
                    });
                }

                if (!state.dispenseReasons) state.dispenseReasons = { 'oprava': 'Oprava zařízení', 'udrzba': 'Plánovaná údržba', 'jine': 'Jiné (specifikovat)' };
                if (!state.suppliers) state.suppliers = [];
                if (!state.inventorySessions) state.inventorySessions = [];
                if (!state.auditLog) state.auditLog = [];
                if (state.notifications) {
                    state.notifications.forEach(n => n.timestamp = new Date(n.timestamp));
                } else {
                    state.notifications = [];
                }

            } else {
                loadSampleData();
            }
        }

        function saveStateToLocalStorage() {
            try {
                // Ukládáme vše kromě currentUser, aby se uživatel musel vždy přihlásit
                const stateToSave = { ...state };
                delete stateToSave.currentUser; 
                localStorage.setItem('sparePartsState_v13', JSON.stringify(stateToSave));
            } catch (e) {
                console.error("Chyba při ukládání do LocalStorage:", e);
                showAlert('Chyba', 'Chyba při ukládání dat. Je možné, že je úložiště plné.', 'error');
            }
        }

        function loadSampleData() {
            state.warehouses = { 'lib': 'Liboc', 'bro': 'Brno', 'poc': 'Počernice' };
            state.categories = { 'elektro': 'Elektro', 'mechanicke': 'Mechanické', 'spotrebni': 'Spotřební' };
            if (!state.machines || Object.keys(state.machines).length===0) { state.machines = { dopA: 'Dopravník A', sklVez1: 'Skladovací věž 1' }; }
            state.priorities = { 'a': 'A - Kritický díl', 'b': 'B - Vysoká', 'c': 'C - Střední', 'd': 'D - Nízká' };
            state.dispenseReasons = { 'oprava': 'Oprava zařízení', 'udrzba': 'Plánovaná údržba', 'prodej': 'Prodej zákazníkovi', 'testovani': 'Testování / Vývoj', 'jine': 'Jiné (specifikovat)' };
            state.suppliers = [
                { id: 1, name: 'Nord', ico: '12345678', contactPerson: 'Pan Novák', email: 'nord@email.cz' },
                { id: 2, name: 'Interroll', ico: '87654321', contactPerson: 'Paní Svobodová', email: 'interroll@email.cz' },
            ];
            state.users = [
                { id: 1, name: 'David Rok', email: 'david.rok@firma.cz', password: 'admin', role: 'admin', permissions: permissionPresets.admin, warehouses: null, dashboard: { pinnedParts: [], pinnedCharts: [], dashboardScope: 'all' }, forcePasswordChange: true },
                { id: 2, name: 'Jan Technik', email: 'jan.technik@firma.cz', password: 'tech', role: 'technik', permissions: permissionPresets.technik, warehouses: ['lib'], dashboard: { pinnedParts: [], pinnedCharts: [], dashboardScope: 'all' }, forcePasswordChange: true },
                { id: 3, name: 'Petr Skladník', email: 'petr.skladnik@firma.cz', password: 'sklad', role: 'vedouci_skladu', permissions: permissionPresets.vedouci_skladu, warehouses: ['lib', 'poc'], dashboard: { pinnedParts: [], pinnedCharts: [], dashboardScope: 'all' }, forcePasswordChange: true },
            ];
            state.parts = [
                { id: 1, name: 'Elektropřevodovka Nord 0,37kW', code: 'VP-0001', description: 'i=12,5 + hřídel + řemenice Ø100', category: 'elektro', supplierId: 1, priority: 'a', priceHistory: [{date: new Date().toISOString(), price: 9587}], manufacturerNumber: 'NORD-037-125', warehouse: null, umisteni: null, currentStock: 0, minStock: 2, maxStock: 5, inventoryNumber: null, imageData: null, docName: null },
                { id: 2, name: 'Interroll 24V RollerDrive EC5000', code: 'VP-0002', description: 'EL=450', category: 'elektro', supplierId: 2, priority: 'b', priceHistory: [{date: new Date().toISOString(), price: 7819}], manufacturerNumber: 'IR-EC5000-450', warehouse: null, umisteni: null, currentStock: 0, minStock: 3, maxStock: 10, inventoryNumber: null, imageData: null, docName: null },
                { id: 101, name: 'Elektropřevodovka Nord 0,37kW', code: 'VP-0001', inventoryNumber: 'LIB-0001', description: 'i=12,5 + hřídel + řemenice Ø100', category: 'elektro', supplierId: 1, priority: 'a', warehouse: 'lib', umisteni: 'A1 / 15-A', currentStock: 1, minStock: 2, maxStock: 5, priceHistory: [{date: new Date().toISOString(), price: 9587}], manufacturerNumber: 'NORD-037-125', imageData: null, docName: null },
                { id: 102, name: 'Interroll 24V RollerDrive EC5000', code: 'VP-0002', inventoryNumber: 'BRO-0001', description: 'EL=450', category: 'elektro', supplierId: 2, priority: 'b', warehouse: 'bro', umisteni: 'Sekce 2 / 8-B', currentStock: 3, minStock: 3, maxStock: 10, priceHistory: [{date: new Date().toISOString(), price: 7819}], manufacturerNumber: 'IR-EC5000-450', imageData: null, docName: null },
                { id: 103, name: 'Hydraulický ventil Parker', code: 'VP-0003', inventoryNumber: 'POC-0001', description: 'D1VW020B, 4/3 cestný', category: 'mechanicke', supplierId: null, priority: 'c', warehouse: 'poc', umisteni: 'Zóna A / 3-C', currentStock: 7, minStock: 3, maxStock: 8, priceHistory: [{date: new Date().toISOString(), price: 4250}], manufacturerNumber: 'PKR-D1VW020B', imageData: null, docName: null },
            ];
            state.orders = [];
            state.transfers = [];
            state.transactions = [];
            state.notifications = [];
            state.inventorySessions = [];
            state.auditLog = [];
            state.settings = { lowStockThreshold: 20 };
            saveStateToLocalStorage(); // Uloží vzorová data bez přihlášeného uživatele
        }

        // --- Přihlášení / Odhlášení ---
        function handleLogin() {
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');

            const user = state.users.find(u => u.email.toLowerCase() === email && u.password === password);

            if (user) {
                state.currentUser = user;
                logAuditEvent('Přihlášení', `Uživatel ${user.name} se úspěšně přihlásil.`);
                saveStateToLocalStorage(); // Uložíme stav (bez currentUser)

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                errorElement.textContent = '';
                document.getElementById('login-password').value = '';

                initializeApp(); // Inicializujeme aplikaci pro přihlášeného uživatele
            } else {
                errorElement.textContent = 'Nesprávný email nebo heslo.';
                state.currentUser = null;
            }
        }

        function handleLogout() {
            logAuditEvent('Odhlášení', `Uživatel ${state.currentUser.name} se odhlásil.`);
            state.currentUser = null;
            
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-email').focus();
        }

        // --- Audit Log ---
        function logAuditEvent(action, details) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                userName: state.currentUser ? state.currentUser.name : 'Systém',
                action: action,
                details: details
            };
            state.auditLog.unshift(logEntry);
            if (state.auditLog.length > 500) { // Omezení délky logu
                state.auditLog.pop();
            }
        }

        function renderAuditLogTable() {
            const tbody = document.getElementById('audit-log-table-body');
            const noResultsMessage = document.getElementById('no-audit-log-message');
            const userFilter = document.getElementById('audit-log-user-filter');

            // Populate user filter if not already populated
            if (userFilter.options.length <= 1) { // Check to prevent re-populating
                userFilter.innerHTML = '<option value="all">Všichni uživatelé</option>';
                state.users.forEach(user => {
                    userFilter.innerHTML += `<option value="${user.name}">${user.name}</option>`;
                });
            }

            const selectedUser = userFilter.value;
            let filteredLog = state.auditLog;

            if (selectedUser !== 'all') {
                filteredLog = state.auditLog.filter(entry => entry.userName === selectedUser);
            }

            noResultsMessage.classList.toggle('hidden', filteredLog.length > 0);

            tbody.innerHTML = filteredLog.map(entry => `
                <tr>
                    <td>${new Date(entry.timestamp).toLocaleString('cs-CZ')}</td>
                    <td>${entry.userName}</td>
                    <td>${entry.action}</td>
                    <td>${entry.details}</td>
                </tr>
            `).join('');
        }
        
        // --- Pomocné funkce pro data ---
        function getLatestPrice(part) {
            if (!part.priceHistory || part.priceHistory.length === 0) return 0;
            return part.priceHistory[part.priceHistory.length - 1].price;
        }

        function getLowStockThreshold(part) {
            return part.minStock * (1 + (state.settings.lowStockThreshold || 20) / 100);
        }
        
        function getDashboardParts() {
            const scope = state.currentUser.dashboard.dashboardScope || 'all';
            const accessibleParts = getAccessible(state.parts).filter(p => p.warehouse !== null);

            if (scope === 'all') {
                return accessibleParts;
            }
            return accessibleParts.filter(p => p.warehouse === scope);
        }

        function updateStats() {
            const stockedParts = getDashboardParts();
            document.getElementById('total-parts').textContent = stockedParts.length;
            const lowStockParts = stockedParts.filter(p => p.currentStock <= getLowStockThreshold(p) && p.minStock > 0).length;
            document.getElementById('low-stock-parts').textContent = lowStockParts;
            const criticalParts = stockedParts.filter(p => p.priority === 'a').length;
            document.getElementById('critical-parts').textContent = criticalParts;
            const totalValue = stockedParts.reduce((sum, part) => sum + (part.currentStock * getLatestPrice(part)), 0);
            document.getElementById('total-value').textContent = `${totalValue.toLocaleString('cs-CZ')} Kč`;
        }

        function showLowStockReport() {
            const lowStockParts = getDashboardParts().filter(p => p.warehouse !== null && p.currentStock <= getLowStockThreshold(p) && p.minStock > 0);
            if (lowStockParts.length === 0) {
                return showAlert('Info', 'Všechny díly mají dostatečný stav!');
            }
            let reportText = `DÍLY S NÍZKÝM STAVEM (${lowStockParts.length}):\n\n`;
            lowStockParts.forEach(part => {
                reportText += `${part.name} (Skladem: ${part.currentStock} / Min: ${part.minStock})\n`;
            });
            showAlert('Report nízkých stavů', reportText, 'info');
        }

        function showCriticalPartsReport() {
            const criticalParts = getDashboardParts().filter(p => p.warehouse !== null && p.priority === 'a');
            if (criticalParts.length === 0) {
                return showAlert('Info', 'Žádné kritické díly nebyly nalezeny.');
            }
            let reportText = `KRITICKÉ DÍLY (${criticalParts.length}):\n\n`;
            criticalParts.forEach(part => {
                reportText += `${part.name} (Skladem: ${part.currentStock})\n`;
            });
            showAlert('Report kritických dílů', reportText, 'info');
        }

        function showTotalValueDetails() {
            const accessibleParts = getDashboardParts();
            const totalValue = accessibleParts.reduce((sum, part) => sum + (part.currentStock * getLatestPrice(part)), 0);
            showAlert('Info', `Celková hodnota skladu je: ${totalValue.toLocaleString('cs-CZ')} Kč.`);
        }

        // --- Správa UI (záložky, uživatel, tmavý režim) ---
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('.main-nav-button').forEach(btn => btn.classList.remove('active'));
            const activeButton = document.querySelector(`.main-nav-button[onclick*="'${tabName}'"]`);
            if (activeButton) activeButton.classList.add('active');
            
            if (tabName === 'dashboard') renderDashboard();
            if (tabName === 'reports') renderReports();
            if (tabName === 'machines') renderMachinesTable();
            if (tabName === 'settings') renderSettings();
            if (tabName === 'audit-log') renderAuditLogTable();
            if (tabName === 'inventory-module') {
                document.getElementById('inventory-start-view').classList.remove('hidden');
                document.getElementById('inventory-session-view').classList.add('hidden');
            }
        }

        function updateUserInterface() {
            const user = state.currentUser;
            if (!user) return;
            document.getElementById('current-user-name').textContent = user.name;
            const roleMap = { admin: 'Administrátor', vedouci_skladu: 'Vedoucí skladu', technik: 'Technik' };
            document.getElementById('current-user-role').textContent = roleMap[user.role] || user.role;
            
            var _btn = document.getElementById('new-part-btn'); if (_btn) { _btn.style.display = userCan('canAddMasterPart') ? 'flex' : 'none'; }
            document.querySelector('.filters-right button[onclick*="showAssignPartModal"]').style.display = userCan('canEditParts') ? 'flex' : 'none';
            document.querySelector('#tab-orders .table-actions').style.display = userCan('canCreateOrders') ? 'flex' : 'none';
            document.querySelector('#tab-transfers .table-actions').style.display = userCan('canCreateTransfers') ? 'flex' : 'none';
            document.querySelector('#tab-users .table-actions').style.display = userCan('canManageUsers') ? 'flex' : 'none';
            document.querySelector('.main-nav-button[onclick*="users"]').style.display = userCan('canManageUsers') ? 'flex' : 'none';
            document.querySelector('.main-nav-button[onclick*="reports"]').style.display = userCan('canViewReports') ? 'flex' : 'none';
            document.querySelector('.main-nav-button[onclick*="settings"]').style.display = userCan('canManageSettings') ? 'flex' : 'none';
            document.querySelector('.main-nav-button[onclick*="suppliers"]').style.display = userCan('canManageSuppliers') ? 'flex' : 'none';
            document.querySelector('.main-nav-button[onclick*="inventory-module"]').style.display = userCan('canPerformInventory') ? 'flex' : 'none';
            document.querySelector('.main-nav-button[onclick*="audit-log"]').style.display = userCan('canManageUsers') ? 'flex' : 'none'; // Jen pro adminy
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            renderAll();
        }

        // --- Oprávnění a Změna Hesla ---
        function userCan(permission) {
            const user = state.currentUser;
            if (!user) return false;
            if (user.role === 'admin') return true;
            return user.permissions && user.permissions[permission];
        }

        function hasAccess(warehouseId) {
            const user = state.currentUser;
            if (!user) return false;
            if (user.role === 'admin' || !user.warehouses || user.warehouses.length === 0) return true;
            return user.warehouses.includes(warehouseId);
        }

        function getAccessible(items) {
            if (!state.currentUser || state.currentUser.role === 'admin') return items;
            return items.filter(item => {
                if (item.warehouse === null) return true; // Master díly jsou vždy přístupné
                return 'warehouse' in item ? hasAccess(item.warehouse) : true;
            });
        }

        function checkForcePasswordChange() {
            if (state.currentUser && state.currentUser.forcePasswordChange) {
                showChangePasswordModal(true);
            }
        }

        function showChangePasswordModal(isForced = false) {
            const title = isForced ? 'Vytvořte si nové heslo' : 'Změnit heslo';
            const message = isForced ? 'Pro pokračování si musíte nastavit nové heslo. Toto je vaše první přihlášení.' : 'Zadejte nové heslo pro váš účet.';
            
            const html = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2 class="modal-title">${title}</h2>
                        ${!isForced ? `<button class="modal-close" onclick="hideModal('change-password-modal')" aria-label="Zavřít">×</button>` : ''}
                    </div>
                    <p class="text-secondary-color" style="margin-bottom: 24px;">${message}</p>
                    <div class="form-group">
                        <label for="new-password">Nové heslo*</label>
                        <input type="password" id="new-password" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Potvrďte nové heslo*</label>
                        <input type="password" id="confirm-password" class="form-input">
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="saveNewPassword()">Uložit nové heslo</button>
                    </div>
                </div>`;
            showModal('change-password-modal', html);
        }

        function saveNewPassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!newPassword || !confirmPassword) {
                return showAlert('Chyba', 'Obě pole pro heslo jsou povinná.', 'error');
            }
            if (newPassword !== confirmPassword) {
                return showAlert('Chyba', 'Zadaná hesla se neshodují.', 'error');
            }
            if (newPassword.length < 4) {
                return showAlert('Chyba', 'Heslo musí mít alespoň 4 znaky.', 'error');
            }
            
            // Načteme celý stav, abychom mohli upravit pole uživatelů
            const savedStateJSON = localStorage.getItem('sparePartsState_v13');
            if (!savedStateJSON) {
                return showAlert('Chyba', 'Nelze načíst data pro uložení hesla.', 'error');
            }
            const fullState = JSON.parse(savedStateJSON);

            const userIndex = fullState.users.findIndex(u => u.id === state.currentUser.id);
            if (userIndex > -1) {
                fullState.users[userIndex].password = newPassword;
                fullState.users[userIndex].forcePasswordChange = false;
                
                // Aktualizujeme i aktuálního uživatele v paměti
                state.currentUser.password = newPassword;
                state.currentUser.forcePasswordChange = false;

                logAuditEvent('Změna hesla', `Uživatel ${state.currentUser.name} si změnil heslo.`);
                
                // Uložíme celý aktualizovaný stav zpět
                localStorage.setItem('sparePartsState_v13', JSON.stringify(fullState));
                
                hideModal('change-password-modal');
                showAlert('Úspěch', 'Vaše heslo bylo úspěšně změněno.', 'success');
            } else {
                showAlert('Chyba', 'Nepodařilo se najít uživatele pro změnu hesla.', 'error');
            }
        }

        // --- Filtry a řazení ---
        function renderFilters() {
            const createOptions = (selectId, data, allLabel) => {
                const select = document.getElementById(selectId);
                select.innerHTML = `<option value="all">${allLabel}</option>`;
                for (const id in data) {
                    select.innerHTML += `<option value="${id}">${data[id]}</option>`;
                }
            };
            createOptions('warehouse-filter', state.warehouses, 'Všechny sklady');
            createOptions('category-filter', state.categories, 'Všechny kategorie');
            createOptions('machine-filter', state.machines, 'Všechna zařízení');
        }

        function getFilteredParts() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const warehouseFilter = document.getElementById('warehouse-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const machineFilter = document.getElementById('machine-filter') ? document.getElementById('machine-filter').value : 'all';

            return getAccessible(state.parts).filter(part => part.warehouse !== null).filter(part => {
                const searchIn = [part.name, part.code, part.description, part.inventoryNumber].join(' ').toLowerCase();
                if (searchTerm && !searchIn.includes(searchTerm)) return false;
                if (warehouseFilter !== 'all' && part.warehouse !== warehouseFilter) return false;
                if (categoryFilter !== 'all' && part.category !== categoryFilter) return false;
                if (machineFilter !== 'all' && part.machineId !== machineFilter) return false;
                return true;
            });
        }
        
        function requestSort(key) {
            if (state.sortConfig.key === key && state.sortConfig.direction === 'ascending') {
                state.sortConfig.direction = 'descending';
            } else {
                state.sortConfig.key = key;
                state.sortConfig.direction = 'ascending';
            }
            renderPartsTable();
        }

        // --- Vykreslování tabulek ---
        function renderPartsTable() {
            const tbody = document.getElementById('parts-table-body');
            const thead = document.getElementById('parts-table-head');
            const noResultsMessage = document.getElementById('no-results-message');
            
            const headers = [
                { key: 'name', label: 'Díl' },
                { key: 'code', label: 'SKU / Inv.č.' },
                { key: 'category', label: 'Kategorie' },
                { key: 'machine', label: 'Zařízení' },
                { key: 'warehouse', label: 'Umístění' },
                { key: 'currentStock', label: 'Stav Skladu' },
                { key: 'price', label: 'Hodnota' },
            ];
            thead.innerHTML = '<tr>' + headers.map(h => {
                const isSorted = state.sortConfig.key === h.key;
                const indicator = isSorted ? (state.sortConfig.direction === 'ascending' ? '▲' : '▼') : '↕';
                return `<th onclick="requestSort('${h.key}')" class="${isSorted ? 'sorted' : ''}">${h.label} <span class="sort-indicator">${indicator}</span></th>`;
            }).join('') + '</tr>';

            const filteredParts = getFilteredParts();
            const { key, direction } = state.sortConfig;
            filteredParts.sort((a, b) => {
                let valA = a[key], valB = b[key];
                if (key === 'price') {
                    valA = getLatestPrice(a) * a.currentStock;
                    valB = getLatestPrice(b) * b.currentStock;
                }
                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                if (valA < valB) return direction === 'ascending' ? -1 : 1;
                if (valA > valB) return direction === 'ascending' ? 1 : -1;
                return 0;
            });

            noResultsMessage.classList.toggle('hidden', filteredParts.length > 0);
            
            tbody.innerHTML = filteredParts.map(part => {
                 const lowStockThreshold = getLowStockThreshold(part);
                 const stockStatusClass = part.currentStock === 0 ? 'out-of-stock' : (part.currentStock <= lowStockThreshold ? 'low-stock' : '');
                 let statusDotClass = 'status-dot-green';
                 if (part.currentStock === 0) statusDotClass = 'status-dot-red';
                 else if (part.currentStock <= lowStockThreshold) statusDotClass = 'status-dot-yellow';
                 const currentPrice = getLatestPrice(part);

                return `<tr class="${stockStatusClass}" style="cursor: pointer;" onclick="showPartDetailModal(${part.id})">
                    <td><span class="font-medium">${part.name}</span></td>
                    <td><div>${part.code || ''}</div><div class="text-gray-500">${part.inventoryNumber || ''}</div></td>
                    <td><span class="badge badge-gray">${state.categories[part.category] || ''}</span></td>
                    <td><span class=\"badge badge-blue\">${state.machines[part.machineId] || ''}</span></td>
                    <td><div>${state.warehouses[part.warehouse] || ''}</div><div class="text-gray-500">${part.umisteni || ''}</div></td>
                    <td><div class="inventory-status"><div class="status-dot ${statusDotClass}"></div><span>${part.currentStock} ks</span></div></td>
                    <td>${(currentPrice * part.currentStock) ? (currentPrice * part.currentStock).toLocaleString('cs-CZ') + ' Kč' : '-'}</td>
                </tr>`;
            }).join('');
        }

        function renderUsersTable() {
            const tbody = document.getElementById('users-table-body');
            const roleMap = { admin: 'Administrátor', vedouci_skladu: 'Vedoucí skladu', technik: 'Technik' };
            const roleBadgeMap = { admin: 'badge-blue', vedouci_skladu: 'badge-purple', technik: 'badge-green' };
            tbody.innerHTML = state.users.map(user => {
                const warehouses = user.warehouses && user.warehouses.length > 0 ? user.warehouses.map(wh => state.warehouses[wh]).join(', ') : 'Všechny';
                return `<tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="badge ${roleBadgeMap[user.role]}">${roleMap[user.role]}</span></td>
                    <td>${warehouses}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="showEditUserModal(${user.id})">✏️</button>
                        ${state.currentUser.id !== user.id ? `<button class="btn btn-danger" onclick="deleteUser(${user.id})">🗑️</button>` : ''}
                    </td>
                </tr>`;
            }).join('');
        }
        
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            document.getElementById('no-orders-message').classList.toggle('hidden', state.orders.length > 0);
            tbody.innerHTML = state.orders.map(order => {
                const statusBadgeMap = { 'Čeká na dodání': 'badge-yellow', 'Dokončeno': 'badge-green', 'Zrušeno': 'badge-red' };
                const supplier = state.suppliers.find(s => s.id === order.supplierId);
                return `
                <tr>
                    <td>${order.orderNumber}</td>
                    <td>${supplier ? supplier.name : 'Neznámý'}</td>
                    <td>${order.items.length}</td>
                    <td>${order.totalPrice.toLocaleString('cs-CZ')} Kč</td>
                    <td><span class="badge ${statusBadgeMap[order.status] || 'badge-gray'}">${order.status}</span></td>
                    <td>${new Date(order.dateCreated).toLocaleDateString('cs-CZ')}</td>
                    <td class="action-buttons">
                        ${order.status === 'Čeká na dodání' ? `<button class="btn btn-success" onclick="receiveOrder(${order.id})">✅ Přijmout</button>` : ''}
                        <button class="btn btn-secondary" onclick="viewOrderFromTransaction('${order.orderNumber}')">👁️</button>
                        <button class="btn btn-danger" onclick="deleteOrder(${order.id})">🗑️</button>
                    </td>
                </tr>`
            }).join('');
        }

        function renderTransfersTable() {
            const tbody = document.getElementById('transfers-table-body');
            document.getElementById('no-transfers-message').classList.toggle('hidden', state.transfers.length > 0);
            tbody.innerHTML = state.transfers.map(t => {
                const canConfirm = hasAccess(t.toWarehouse) && t.status === 'V procesu';
                return `<tr>
                    <td>${t.transferNumber}</td>
                    <td>${t.partName}</td>
                    <td>${state.warehouses[t.fromWarehouse]}</td>
                    <td>${state.warehouses[t.toWarehouse]}</td>
                    <td>${t.quantity}</td>
                    <td><span class="badge ${t.status === 'Dokončeno' ? 'badge-green' : 'badge-yellow'}">${t.status}</span></td>
                    <td>${new Date(t.date).toLocaleDateString('cs-CZ')}</td>
                    <td>
                        ${canConfirm ? `<button class="btn btn-success" onclick="approveTransfer(${t.id})">Potvrdit příjem</button>` : ''}
                        <button class="btn btn-secondary" onclick="viewTransferFromTransaction('${t.transferNumber}')">👁️</button>
                    </td>
                </tr>`
            }).join('');
        }

        function renderTransactionsTable() {
            const tbody = document.getElementById('transactions-table-body');
            const noResultsMessage = document.getElementById('no-transactions-message');
            const fromDate = document.getElementById('transaction-date-from').value;
            const toDate = document.getElementById('transaction-date-to').value;

            let filteredTransactions = [...state.transactions];

            if (fromDate) {
                filteredTransactions = filteredTransactions.filter(t => new Date(t.date) >= new Date(fromDate));
            }
            if (toDate) {
                const toDateObj = new Date(toDate);
                toDateObj.setHours(23, 59, 59, 999);
                filteredTransactions = filteredTransactions.filter(t => new Date(t.date) <= toDateObj);
            }

            noResultsMessage.classList.toggle('hidden', filteredTransactions.length > 0);
            const typeMap = { prijem: 'Příjem', vydej: 'Výdej', presun_odeslani: 'Přesun (odeslání)', presun_prijem: 'Přesun (příjem)', uprava: 'Úprava', korekce: 'Korekce' };
            const typeColor = { prijem: 'stat-green', vydej: 'stat-orange', presun_odeslani: 'stat-orange', presun_prijem: 'stat-green', uprava: 'stat-blue', korekce: 'stat-purple' };
            
            tbody.innerHTML = filteredTransactions.reverse().map(t => `
                <tr>
                    <td>${new Date(t.date).toLocaleString('cs-CZ')}</td>
                    <td class="${typeColor[t.type]}">${typeMap[t.type]}</td>
                    <td>${t.partName}</td>
                    <td>${t.quantity}</td>
                    <td>${t.notes || ''}</td>
                    <td>${t.userName}</td>
                </tr>
            `).join('');
        }

        function renderSuppliersTable() {
            const tbody = document.getElementById('suppliers-table-body');
            const noResultsMessage = document.getElementById('no-suppliers-message');
            noResultsMessage.classList.toggle('hidden', state.suppliers.length > 0);

            tbody.innerHTML = state.suppliers.map(supplier => `
                <tr>
                    <td>${supplier.name}</td>
                    <td>${supplier.ico || '-'}</td>
                    <td>${supplier.contactPerson || '-'}</td>
                    <td>${supplier.email || '-'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-secondary" onclick="showSupplierModal(${supplier.id})">✏️ Upravit</button>
                        <button class="btn btn-danger" onclick="deleteSupplier(${supplier.id})">🗑️</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderInventoryList() {
            const tbody = document.getElementById('inventory-list-body');
            const noResultsMessage = document.getElementById('no-inventory-message');
            noResultsMessage.classList.toggle('hidden', state.inventorySessions.length > 0);
            
            tbody.innerHTML = [...state.inventorySessions].reverse().map(session => {
                const statusBadge = session.status === 'Dokončeno' ? 'badge-green' : 'badge-yellow';
                return `
                    <tr>
                        <td>${state.warehouses[session.warehouseId]}</td>
                        <td>${new Date(session.startDate).toLocaleDateString('cs-CZ')}</td>
                        <td><span class="badge ${statusBadge}">${session.status}</span></td>
                        <td>${session.userName}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="continueInventory(${session.id})">${session.status === 'Dokončeno' ? 'Zobrazit' : 'Pokračovat'}</button>
                        </td>
                    </tr>
                `
            }).join('');
        }

        // --- Modální okna a CRUD operace ---
        function showModal(modalId, innerHTML) {
            lastFocusedElement = document.activeElement; 

            const modal = document.getElementById(modalId);
            modal.innerHTML = innerHTML;
            modal.classList.remove('hidden');

            const modalContent = modal.querySelector('.modal');
            const modalTitle = modal.querySelector('.modal-title');
            
            if (modalContent && modalTitle) {
                const titleId = 'modal-title-' + modalId;
                modalTitle.id = titleId;
                modalContent.setAttribute('role', 'dialog');
                modalContent.setAttribute('aria-modal', 'true');
                modalContent.setAttribute('aria-labelledby', titleId);
            }
            
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstFocusableElement = focusableElements[0];
            const lastFocusableElement = focusableElements[focusableElements.length - 1];

            if (firstFocusableElement) {
                firstFocusableElement.focus();
            }

            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const closeButton = modal.querySelector('.modal-close');
                    if (closeButton) {
                        closeButton.click();
                    }
                }
                const isTabPressed = e.key === 'Tab' || e.keyCode === 9;
                if (!isTabPressed) return;

                if (e.shiftKey) { 
                    if (document.activeElement === firstFocusableElement) {
                        lastFocusableElement.focus();
                        e.preventDefault();
                    }
                } else { 
                    if (document.activeElement === lastFocusableElement) {
                        firstFocusableElement.focus();
                        e.preventDefault();
                    }
                }
            });
        }

        function hideModal(modalId) {
            const chartCanvas = document.querySelector(`#${modalId} #price-history-chart`);
            if (chartCanvas && charts.priceHistory) {
                charts.priceHistory.destroy();
            }
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                modal.innerHTML = ''; 
            }
            
            if (lastFocusedElement) {
                lastFocusedElement.focus(); 
            }
        }

        /**
         * Hide and clear all currently visible modals. This ensures that when a new
         * modal is opened (e.g. editing a part or stocking from a machine detail),
         * it is not obscured by any previously opened modals. Without clearing
         * other modals, their overlay remains in the DOM and may appear above
         * newly opened modals due to stacking context. This helper safely hides
         * every `.modal-overlay` that is not hidden and empties its HTML.
         */
        function hideAllModals() {
            const openModals = document.querySelectorAll('.modal-overlay:not(.hidden)');
            openModals.forEach(modalEl => {
                modalEl.classList.add('hidden');
                modalEl.innerHTML = '';
            });
        }

        // Expose hideAllModals globally so it can be called from inline events if needed.
        window.hideAllModals = hideAllModals;
        
        function showPartModal(id = null) {
            // Before rendering, ensure all other modals are hidden. This prevents
            // the edit/new modal from being obscured by a previously open modal (e.g. part detail).
            try { hideAllModals(); } catch(e) {}
            const part = id ? state.parts.find(p => p.id === id) : null;
            const isMasterPart = part ? part.warehouse === null : true;
            state.currentEditingId = id;
            const currentPrice = part ? getLatestPrice(part) : 0;

            let title = 'Upravit díl';
            if (!id) title = 'Zavést nový typ dílu';
            else if (isMasterPart) title = 'Upravit master díl';

            const createSelect = (data, selected, placeholder = null) => {
                let options = placeholder ? `<option value="">${placeholder}</option>` : '';
                options += Object.entries(data).map(([key, val]) => `<option value="${key}" ${ (key === selected) ? 'selected' : ''}>${val}</option>`).join('');
                return options;
            };

            const supplierOptions = '<option value="">Bez dodavatele</option>' + state.suppliers.map(s => `<option value="${s.id}" ${part && s.id === part.supplierId ? 'selected' : ''}>${s.name}</option>`).join('');

            const html = `
                <div class="modal">
                    <div class="modal-header"><h2 class="modal-title">${title}</h2><button class="modal-close" onclick="hideModal('part-modal')" aria-label="Zavřít">×</button></div>
                    <div class="form-group"><label>Název dílu*</label><input type="text" id="part-name" class="form-input" value="${part ? part.name : ''}"></div>
                    <div class="form-row">
                        <div class="form-group"><label>SKU</label><input type="text" id="part-code" class="form-input" value="${part ? part.code : '(bude vygenerováno)'}" disabled></div>
                        <div class="form-group"><label>Číslo výrobce</label><input type="text" id="part-manufacturerNumber" class="form-input" value="${part ? part.manufacturerNumber : ''}"></div>
                    </div>
                    <div class="form-group"><label>Popis dílu</label><textarea id="part-description" class="form-textarea">${part ? part.description : ''}</textarea></div>
                    <div class="form-row">
                        <div class="form-group"><label>Kategorie</label><select id="part-category" class="form-select">${createSelect(state.categories, part ? part.category : null)}</select></div>
                        <div class="form-group"><label>Dodavatel</label><select id="part-supplierId" class="form-select">${supplierOptions}</select></div>
                    </div>
                    <div class=\"form-row\">
                        <div class=\"form-group\"><label>Zařízení / Stroj</label><select id=\"part-machineId\" class=\"form-select\">${createSelect(state.machines, part ? part.machineId : null, 'Vyberte zařízení/stroj')}</select></div>
                        <div class=\"form-group\"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Priorita</label><select id="part-priority" class="form-select">${createSelect(state.priorities, part ? part.priority : null, 'Vyberte prioritu')}</select></div>
                        <div class="form-group"><label>Cena/ks (Kč)</label><input type="number" id="part-price" class="form-input" value="${currentPrice}" min="0" step="0.01"></div>
                    </div>
                    ${isMasterPart ? `
                    <div class="form-row">
                        <div class="form-group"><label>Minimální zásoba*</label><input type="number" id="part-minStock" class="form-input" value="${part ? part.minStock : 1}" min="0" step="1"></div>
                        <div class="form-group"><label>Optimální zásoba</label><input type="number" id="part-optimalStock" class="form-input" value="${(part && part.optimalStock !== undefined) ? part.optimalStock : ''}" min="0" step="1"></div>
                    </div>` : `
                    <div class="form-row">
                         <div class="form-group"><label>Sklad</label><select id="part-warehouse" class="form-select" disabled>${createSelect(state.warehouses, part ? part.warehouse : null)}</select></div>
                         <div class="form-group"><label>Umístění</label><input type="text" id="part-umisteni" class="form-input" value="${part ? part.umisteni : ''}" placeholder="např. A1 / 15-C"></div>
                    </div>`}
                    <div class="modal-actions"><button class="btn btn-primary" onclick="savePart()">Uložit</button></div>
                </div>`;
            showModal('part-modal', html);
        }

        function savePart() {
            const id = state.currentEditingId;
            const newPrice = parseFloat(document.getElementById('part-price').value) || 0;
            const partData = {
                name: document.getElementById('part-name').value.trim(),
                description: document.getElementById('part-description').value.trim(),
                category: document.getElementById('part-category').value,
                supplierId: parseInt(document.getElementById('part-supplierId').value) || null,
                priority: document.getElementById('part-priority').value,
                manufacturerNumber: document.getElementById('part-manufacturerNumber').value.trim(),
                machineId: (document.getElementById('part-machineId') && document.getElementById('part-machineId').value) || null,
            };

            if (!partData.name) {
                return showAlert('Chyba', 'Název dílu je povinné pole.', 'error');
            }

            if (id) {
                const index = state.parts.findIndex(p => p.id === id);
                const oldPart = { ...state.parts[index] };
                const part = state.parts[index];
                const currentPrice = getLatestPrice(part);
                if (newPrice !== currentPrice) {
                    part.priceHistory.push({ date: new Date().toISOString(), price: newPrice });
                }
                const isMasterPart = part.warehouse === null;
                if (isMasterPart) {
                    // master díl: vždy aktualizujeme minimální a optimální zásobu
                    partData.minStock = parseInt(document.getElementById('part-minStock').value) || 0;
                    // načti zadanou optimální zásobu (případně ponech stávající nebo minimální)
                    const optInput = document.getElementById('part-optimalStock');
                    if (optInput) {
                        const parsedOpt = parseInt(optInput.value);
                        partData.optimalStock = isNaN(parsedOpt) ? (part.optimalStock || partData.minStock) : parsedOpt;
                    } else {
                        partData.optimalStock = part.optimalStock || partData.minStock;
                    }
                    // nastav maxStock podle optimální nebo minimální zásoby (pro kompatibilitu s existující logikou)
                    partData.maxStock = partData.optimalStock || (partData.minStock * 2);
                } else {
                    partData.umisteni = document.getElementById('part-umisteni').value.trim();
                }
                state.parts[index] = { ...part, ...partData };
                logAuditEvent('Úprava dílu', `Upraven díl: ${partData.name} (ID: ${id}).`);
            } else {
                if (!userCan('canAddMasterPart')) {
                    return showAlert('Chyba', 'Pro tuto akci nemáte oprávnění.', 'error');
                }
                const existingPartByName = state.parts.find(p => p.name.toLowerCase() === partData.name.toLowerCase() && p.warehouse === null);
                if (existingPartByName) {
                    return showAlert('Chyba', 'Master díl s tímto názvem již existuje.', 'error');
                }
                const vpParts = state.parts.filter(p => p.code && p.code.startsWith('VP-'));
                const maxVpNum = Math.max(0, ...vpParts.map(p => parseInt(p.code.split('-')[1] || 0)));
                partData.code = `VP-${String(maxVpNum + 1).padStart(4, '0')}`;
                
                const newId = (Math.max(0, ...state.parts.map(p => p.id)) + 1);
                // sestav nový master díl (bez skladové pozice)
                // načti minimální a optimální zásobu
                const minVal = parseInt(document.getElementById('part-minStock').value) || 0;
                const optInput = document.getElementById('part-optimalStock');
                const optVal = optInput ? parseInt(optInput.value) : NaN;
                const optimalVal = isNaN(optVal) ? minVal : optVal;
                const newPart = { 
                    id: newId, 
                    ...partData,
                    priceHistory: [{ date: new Date().toISOString(), price: newPrice }],
                    // ulož minimální a optimální zásobu
                    minStock: minVal,
                    optimalStock: optimalVal,
                    // maxStock pro kompatibilitu využívá optimální hodnotu nebo dvojnásobek minima
                    maxStock: optimalVal || (minVal * 2),
                    warehouse: null, 
                    inventoryNumber: null,
                    umisteni: null,
                    currentStock: 0,
                    imageData: null, 
                    docName: null,
                };
                state.parts.push(newPart);
                logAuditEvent('Zavedení dílu', `Zaveden nový master díl: ${partData.name}.`);
                showAlert('Úspěch', 'Nový typ dílu byl zaveden. Nyní jej můžete naskladnit.', 'success');
            }
            
            saveStateToLocalStorage();
            renderAll();
            hideModal('part-modal');
        }

        function showAssignPartModal() {
            // Před načtením formuláře skryj všechny otevřené modály, včetně detailu stroje nebo dílu.
            // V opačném případě by nově otevřený formulář mohl zůstat pod starými modály.
            try { hideAllModals(); } catch(e) {}
            const masterParts = state.parts.filter(p => p.warehouse === null);
            if (masterParts.length === 0) {
                return showAlert('Info', 'Neexistují žádné master díly k naskladnění. Nejprve musíte nějaký zavést do systému.');
            }
            const createSelect = (data, placeholder) => `<option value="">${placeholder}</option>` + Object.entries(data).map(([key, val]) => `<option value="${key}">${val}</option>`).join('');
            const masterPartOptions = '<option value="">Vyberte typ dílu...</option>' + masterParts.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');

            const html = `
            <div class="modal">
                <div class="modal-header"><h2 class="modal-title">Naskladnit díl</h2><button class="modal-close" onclick="hideModal('assign-part-modal')" aria-label="Zavřít">×</button></div>
                <div class="form-group"><label>Typ dílu*</label><select id="assign-master-part" class="form-select">${masterPartOptions}</select></div>
                <div class="form-row">
                    <div class="form-group"><label>Sklad*</label><select id="assign-warehouse" class="form-select">${createSelect(state.warehouses, 'Vyberte sklad...')}</select></div>
                    <div class="form-group"><label>Počet kusů*</label><input type="number" id="assign-quantity" class="form-input" min="1" value="1" step="1"></div>
                </div>
                <div class="form-group"><label>Umístění ve skladu</label><input type="text" id="assign-location" class="form-input" placeholder="např. Regál A1, pozice 5C"></div>
                <div class="modal-actions"><button class="btn btn-primary" onclick="saveAssignPart()">Naskladnit</button></div>
            </div>`;
            showModal('assign-part-modal', html);
        }

        function saveAssignPart() {
            const masterPartId = parseInt(document.getElementById('assign-master-part').value);
            const warehouse = document.getElementById('assign-warehouse').value;
            const quantity = parseInt(document.getElementById('assign-quantity').value);
            const location = document.getElementById('assign-location').value.trim();

            if (!masterPartId || !warehouse || !quantity || quantity <= 0) {
                return showAlert('Chyba', 'Všechna pole s * jsou povinná.', 'error');
            }

            const masterPart = state.parts.find(p => p.id === masterPartId);
            if (!masterPart) return showAlert('Chyba', 'Master díl nebyl nalezen.', 'error');
            
            const existingStockedPart = state.parts.find(p => p.code === masterPart.code && p.warehouse === warehouse);
            if (existingStockedPart) {
                return showAlert('Chyba', 'Tento typ dílu již na vybraném skladu existuje. Pro navýšení počtu kusů použijte akci v detailu dílu.', 'error');
            }
            
            const warehousePrefix = warehouse.toUpperCase();
            const warehouseParts = state.parts.filter(p => p.warehouse === warehouse && p.inventoryNumber);
            const maxInvNum = Math.max(0, ...warehouseParts.map(p => {
                const num = p.inventoryNumber.split('-')[1];
                return num ? parseInt(num) : 0;
            }));
            const inventoryNumber = `${warehousePrefix}-${String(maxInvNum + 1).padStart(4, '0')}`;

            const newId = (Math.max(0, ...state.parts.map(p => p.id)) + 1);
            const newStockedPart = {
                ...masterPart,
                id: newId,
                warehouse: warehouse,
                currentStock: quantity,
                umisteni: location,
                inventoryNumber: inventoryNumber
            };
            
            state.parts.push(newStockedPart);
            createTransaction('prijem', newStockedPart, quantity, 'Prvotní naskladnění nového typu dílu');
            logAuditEvent('Naskladnění dílu', `Naskladněno ${quantity} ks dílu ${masterPart.name} do skladu ${state.warehouses[warehouse]}.`);

            saveStateToLocalStorage();
            renderAll();
            hideModal('assign-part-modal');
        }

        function showReceiveModal(id) {
            const part = state.parts.find(p => p.id === id);
            if (!part) return;
            state.currentEditingId = id;
            const currentPrice = getLatestPrice(part);
            const html = `
            <div class="modal">
                <div class="modal-header"><h2 class="modal-title">Příjem dílu: ${part.name}</h2><button class="modal-close" onclick="hideModal('receive-modal')" aria-label="Zavřít">×</button></div>
                <p>Aktuálně skladem: ${part.currentStock} ks</p>
                <div class="form-group"><label>Počet k naskladnění*</label><input type="number" id="receive-quantity" class="form-input" value="1" min="1" step="1"></div>
                <div class="form-group"><label>Nová cena/ks (aktuální: ${currentPrice} Kč)</label><input type="number" id="receive-price" class="form-input" placeholder="${currentPrice}" step="0.01"></div>
                <div class="form-group"><label>Poznámka</label><input type="text" id="receive-notes" class="form-input" placeholder="např. z objednávky OBJ-12345"></div>
                <div class="modal-actions"><button class="btn btn-success" onclick="saveReceive()">Naskladnit</button></div>
            </div>`;
            showModal('receive-modal', html);
        }

        function saveReceive() {
            const id = state.currentEditingId;
            const quantity = parseInt(document.getElementById('receive-quantity').value);
            const newPriceInput = document.getElementById('receive-price');
            const newPrice = newPriceInput.value ? parseFloat(newPriceInput.value) : null;
            const notes = document.getElementById('receive-notes').value.trim();

            if (isNaN(quantity) || quantity <= 0) {
                return showAlert('Chyba', 'Zadejte platné množství.', 'error');
            }

            const index = state.parts.findIndex(p => p.id === id);
            if (index === -1) return;
            const part = state.parts[index];

            part.currentStock += quantity;
            if (newPrice !== null && !isNaN(newPrice) && newPrice !== getLatestPrice(part)) {
                part.priceHistory.push({ date: new Date().toISOString(), price: newPrice });
            }

            createTransaction('prijem', part, quantity, notes || 'Naskladnění');
            logAuditEvent('Příjem na sklad', `Přijato ${quantity} ks dílu ${part.name}. Poznámka: ${notes}`);
            saveStateToLocalStorage();
            renderAll();
            hideModal('receive-modal');
            showPartDetailModal(id);
        }

        function showDispenseModal(id) {
            const part = state.parts.find(p => p.id === id);
            if (!part) return;
            state.currentEditingId = id;

            const reasonOptions = Object.entries(state.dispenseReasons).map(([key, value]) => 
                `<option value="${key}">${value}</option>`
            ).join('');

            const html = `
            <div class="modal">
                <div class="modal-header"><h2 class="modal-title">Výdej dílu: ${part.name}</h2><button class="modal-close" onclick="hideModal('dispense-modal')" aria-label="Zavřít">×</button></div>
                <p>Aktuálně skladem: ${part.currentStock} ks</p>
                <div class="form-group"><label>Počet k vydání*</label><input type="number" id="dispense-quantity" class="form-input" value="1" min="1" max="${part.currentStock}" step="1"></div>
                <div class="form-group">
                    <label for="dispense-reason-select">Důvod výdeje*</label>
                    <select id="dispense-reason-select" class="form-select" onchange="toggleCustomReason(this.value)">
                        ${reasonOptions}
                    </select>
                </div>
                <div class="form-group hidden" id="custom-reason-group">
                    <label for="dispense-reason-custom">Specifikujte důvod*</label>
                    <input type="text" id="dispense-reason-custom" class="form-input">
                </div>
                <div class="modal-actions"><button class="btn btn-warning" onclick="saveDispense()">Vydat ze skladu</button></div>
            </div>`;
            showModal('dispense-modal', html);
        }

        function toggleCustomReason(selectedValue) {
            document.getElementById('custom-reason-group').classList.toggle('hidden', selectedValue !== 'jine');
        }

        function saveDispense() {
            const id = state.currentEditingId;
            const quantity = parseInt(document.getElementById('dispense-quantity').value);
            const reasonSelect = document.getElementById('dispense-reason-select');
            let reason = reasonSelect.options[reasonSelect.selectedIndex].text;
            
            if (reasonSelect.value === 'jine') {
                const customReason = document.getElementById('dispense-reason-custom').value.trim();
                if (!customReason) {
                    return showAlert('Chyba', 'Pokud zvolíte "Jiné", musíte specifikovat důvod.', 'error');
                }
                reason = customReason;
            }

            const index = state.parts.findIndex(p => p.id === id);
            if (index === -1) return;
            const part = state.parts[index];

            if (isNaN(quantity) || quantity <= 0) return showAlert('Chyba', 'Zadejte platné množství.', 'error');
            if (!reason) return showAlert('Chyba', 'Důvod výdeje je povinný.', 'error');
            if (quantity > part.currentStock) return showAlert('Chyba', `Nelze vydat více kusů, než je na skladě (${part.currentStock} ks).`, 'error');

            part.currentStock -= quantity;
            createTransaction('vydej', part, quantity, reason);
            logAuditEvent('Výdej ze skladu', `Vydáno ${quantity} ks dílu ${part.name}. Důvod: ${reason}`);
            saveStateToLocalStorage();
            renderAll();
            hideModal('dispense-modal');
            showPartDetailModal(id);
        }

        function deletePart(id) {
            showAlert('Potvrzení', 'Opravdu chcete smazat tento díl? Tímto smažete jeho záznam ze skladu. Pro smazání master dílu jej musíte upravit.', 'confirm', () => {
                const partToDelete = state.parts.find(p => p.id === id);
                logAuditEvent('Smazání dílu', `Smazán díl: ${partToDelete.name} (Inv. č.: ${partToDelete.inventoryNumber}).`);
                state.parts = state.parts.filter(p => p.id !== id);
                saveStateToLocalStorage();
                hideModal('part-detail-modal');
                renderAll();
            });
        }

        function showPartDetailModal(id) {
            const part = state.parts.find(p => p.id === id);
            if (!part) return;

            const partTransactions = [...state.transactions].reverse().filter(t => t.partId === id);
            const priorityBadgeMap = { a: 'badge-red', b: 'badge-orange', c: 'badge-yellow', d: 'badge-green' };
            const supplier = state.suppliers.find(s => s.id === part.supplierId);
            const currentPrice = getLatestPrice(part);
            const isPinned = state.currentUser.dashboard.pinnedParts.includes(part.id);
            
            const html = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">${part.name}</h2>
                        <button class="modal-close" onclick="hideModal('part-detail-modal')" aria-label="Zavřít">×</button>
                    </div>
                    <div class="modal-content-wrapper">
                        <div class="part-detail-media">
                            <div class="part-detail-image-container">
                                ${part.imageData ? `<img src="${part.imageData}" alt="Fotka dílu" class="part-detail-image">` : `<div class="part-detail-image-placeholder">📷</div>`}
                            </div>
                            <div id="part-qr-code"></div>
                            <div class="form-group">
                                <label for="image-upload-${part.id}" class="file-upload-label">🖼️ Změnit fotku</label>
                                <input type="file" id="image-upload-${part.id}" class="hidden" accept="image/*" onchange="handleImageUpload(event, ${part.id})">
                            </div>
                            <div class="form-group">
                                <label>Dokumentace</label>
                                ${part.docName ? `
                                    <div class="doc-info">
                                        <span>📄 ${part.docName}</span>
                                        <button class="btn btn-danger" style="padding: 2px 8px;" onclick="deletePartDoc(${part.id})">🗑️</button>
                                    </div>
                                ` : `
                                    <label for="doc-upload-${part.id}" class="file-upload-label">➕ Nahrát dokument</label>
                                    <input type="file" id="doc-upload-${part.id}" class="hidden" accept=".pdf,.doc,.docx,.txt" onchange="handleDocUpload(event, ${part.id})">
                                `}
                            </div>
                        </div>
                        <div>
                            <div class="part-detail-grid">
                                <div class="detail-item"><h4>SKU</h4><p>${part.code || '-'}</p></div>
                                <div class="detail-item"><h4>Inventární číslo</h4><p>${part.inventoryNumber || '-'}</p></div>
                                <div class="detail-item"><h4>Sklad</h4><p>${state.warehouses[part.warehouse]}</p></div>
                                <div class="detail-item"><h4>Umístění</h4><p>${part.umisteni || '-'}</p></div>
                                <div class="detail-item"><h4>Aktuální počet</h4><p>${part.currentStock} ks</p></div>
                                <div class="detail-item"><h4>Min. počet</h4><p>${part.minStock} ks</p></div>
                                <div class="detail-item"><h4>Opt. počet</h4><p>${(part.optimalStock !== undefined && part.optimalStock !== null) ? part.optimalStock : '-'} ks</p></div>
                                <div class="detail-item"><h4>Priorita</h4><p><span class="badge ${priorityBadgeMap[part.priority] || 'badge-gray'}">${state.priorities[part.priority] || '-'}</span></p></div>
                                <div class="detail-item"><h4>Cena/ks</h4><p>${currentPrice.toLocaleString('cs-CZ')} Kč</p></div>
                                <div class="detail-item"><h4>Dodavatel</h4><p>${supplier ? supplier.name : 'Není'}</p></div>
                            </div>
                             <div class="history-section">
                                <h3>Historie ceny</h3>
                                <canvas id="price-history-chart"></canvas>
                            </div>
                            <div class="history-section">
                                <h3>Historie transakcí</h3>
                                <div class="history-list">
                                    ${partTransactions.length > 0 ? partTransactions.map(t => `<div class="history-item">
                                        <span class="date">${new Date(t.date).toLocaleString('cs-CZ')}</span> - ${t.userName} - 
                                        <span class="${t.type.includes('prijem') ? 'type-add' : 'type-remove'}">${t.type} (${t.quantity}ks)</span>
                                        <div class="text-gray-500">${t.notes}</div>
                                    </div>`).join('') : '<p>Žádná historie.</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="togglePinPart(${part.id})">${isPinned ? '📌 Odepnout z dashboardu' : '📌 Připnout na dashboard'}</button>
                        ${userCan('canEditParts') ? `
                        <button class="btn btn-success" onclick="showReceiveModal(${part.id})">📥 Příjem</button>
                        <button class="btn btn-warning" onclick="showDispenseModal(${part.id})">📤 Výdej</button>
                        <button class="btn btn-secondary" onclick=\"editPartFromDetail(${part.id})\">✏️ Upravit</button>` : ''}
                        ${userCan('canDeleteParts') ? `<button class="btn btn-danger" onclick="deletePart(${part.id})">🗑️ Smazat</button>` : ''}
                    </div>
                </div>`;
            showModal('part-detail-modal', html);
            displayQRCode('part-qr-code', `PART_INV:${part.inventoryNumber}`);
            renderPriceHistoryChart(part);
        }

        function displayQRCode(elementId, text) {
            try {
                const typeNumber = 4;
                const errorCorrectionLevel = 'L';
                const qr = qrcode(typeNumber, errorCorrectionLevel);
                qr.addData(text);
                qr.make();
                document.getElementById(elementId).innerHTML = qr.createImgTag(4);
            } catch (e) {
                console.error("Chyba při generování QR kódu:", e);
                document.getElementById(elementId).innerHTML = "QR kód nelze zobrazit.";
            }
        }

        function handleImageUpload(event, partId) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const partIndex = state.parts.findIndex(p => p.id === partId);
                if (partIndex > -1) {
                    state.parts[partIndex].imageData = e.target.result;
                    logAuditEvent('Změna obrázku', `Změněn obrázek pro díl ${state.parts[partIndex].name}.`);
                    saveStateToLocalStorage();
                    showPartDetailModal(partId);
                }
            };
            reader.readAsDataURL(file);
        }

        function handleDocUpload(event, partId) {
            const file = event.target.files[0];
            if (!file) return;
            const partIndex = state.parts.findIndex(p => p.id === partId);
            if (partIndex > -1) {
                state.parts[partIndex].docName = file.name;
                logAuditEvent('Nahrání dokumentu', `Nahrán dokument ${file.name} pro díl ${state.parts[partIndex].name}.`);
                saveStateToLocalStorage();
                showPartDetailModal(partId);
            }
        }

        function deletePartDoc(partId) {
            const partIndex = state.parts.findIndex(p => p.id === partId);
            if (partIndex > -1) {
                logAuditEvent('Smazání dokumentu', `Smazán dokument ${state.parts[partIndex].docName} pro díl ${state.parts[partIndex].name}.`);
                state.parts[partIndex].docName = null;
                saveStateToLocalStorage();
                showPartDetailModal(partId);
            }
        }

        function showAddUserModal() { showUserModal(); }
        function showEditUserModal(id) { showUserModal(id); }
        function showUserModal(id = null) {
            const user = id ? state.users.find(u => u.id === id) : null;
            state.currentEditingId = id;
            const title = id ? 'Upravit uživatele' : 'Přidat nového uživatele';
            const roles = { admin: 'Administrátor', vedouci_skladu: 'Vedoucí skladu', technik: 'Technik' };
            
            const permissions = user ? user.permissions : permissionPresets.technik;

            const html = `
                <div class="modal">
                    <div class="modal-header"><h2 class="modal-title">${title}</h2><button class="modal-close" onclick="hideModal('user-modal')" aria-label="Zavřít">×</button></div>
                    <div class="form-row">
                        <div class="form-group"><label>Jméno*</label><input type="text" id="user-name" class="form-input" value="${user ? user.name : ''}"></div>
                        <div class="form-group"><label>Email*</label><input type="email" id="user-email" class="form-input" value="${user ? user.email : ''}"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Heslo*</label><input type="password" id="user-password" class="form-input" ${id ? 'placeholder="Zadejte pro změnu"' : ''}></div>
                        <div class="form-group"><label>Role</label><select id="user-role" class="form-select" onchange="updatePermissionsForRole(this.value)">${Object.entries(roles).map(([key, val]) => `<option value="${key}" ${user && key === user.role ? 'selected' : ''}>${val}</option>`).join('')}</select></div>
                    </div>
                    <hr style="margin: 20px 0; border-color: var(--border-color);">
                    <div class="form-group">
                        <label>Detailní oprávnění</label>
                        <div class="permissions-grid" id="permissions-container">
                            <label><input type="checkbox" data-permission="canAddMasterPart" ${permissions.canAddMasterPart ? 'checked' : ''}> Může zakládat nové typy dílů</label>
                            <label><input type="checkbox" data-permission="canEditParts" ${permissions.canEditParts ? 'checked' : ''}> Může upravovat díly a naskladňovat</label>
                            <label><input type="checkbox" data-permission="canDeleteParts" ${permissions.canDeleteParts ? 'checked' : ''}> Může mazat díly</label>
                            <label><input type="checkbox" data-permission="canCreateOrders" ${permissions.canCreateOrders ? 'checked' : ''}> Může vytvářet objednávky</label>
                            <label><input type="checkbox" data-permission="canCreateTransfers" ${permissions.canCreateTransfers ? 'checked' : ''}> Může vytvářet přesuny</label>
                            <label><input type="checkbox" data-permission="canManageUsers" ${permissions.canManageUsers ? 'checked' : ''}> Může spravovat uživatele</label>
                            <label><input type="checkbox" data-permission="canViewReports" ${permissions.canViewReports ? 'checked' : ''}> Může vidět reporty</label>
                            <label><input type="checkbox" data-permission="canManageSettings" ${permissions.canManageSettings ? 'checked' : ''}> Může spravovat nastavení</label>
                             <label><input type="checkbox" data-permission="canManageSuppliers" ${permissions.canManageSuppliers ? 'checked' : ''}> Může spravovat dodavatele</label>
                            <label><input type="checkbox" data-permission="canPerformInventory" ${permissions.canPerformInventory ? 'checked' : ''}> Může provádět inventuru</label>
                        </div>
                    </div>
                     <div class="form-group"><label>Přístup ke skladům (prázdné = všechny)</label>
                        <div class="permissions-grid">
                        ${Object.entries(state.warehouses).map(([key, val]) => `
                            <label><input type="checkbox" name="user-warehouses" value="${key}" ${user && user.warehouses && user.warehouses.includes(key) ? 'checked' : ''}> ${val}</label>
                        `).join('')}
                        </div>
                    </div>
                    <div class="modal-actions"><button class="btn btn-primary" onclick="saveUser()">Uložit</button></div>
                </div>`;
            showModal('user-modal', html);
        }

        function updatePermissionsForRole(role) {
            const preset = permissionPresets[role];
            if (!preset) return;
            document.querySelectorAll('#permissions-container input[type="checkbox"]').forEach(checkbox => {
                const permission = checkbox.dataset.permission;
                checkbox.checked = preset[permission] || false;
            });
        }

        function saveUser() {
            const id = state.currentEditingId;
            const selectedWarehouses = Array.from(document.querySelectorAll('input[name="user-warehouses"]:checked')).map(cb => cb.value);
            
            const permissions = {};
            document.querySelectorAll('#permissions-container input[type="checkbox"]').forEach(checkbox => {
                permissions[checkbox.dataset.permission] = checkbox.checked;
            });

            const passwordInput = document.getElementById('user-password').value.trim();
            const userData = {
                name: document.getElementById('user-name').value.trim(),
                email: document.getElementById('user-email').value.trim(),
                role: document.getElementById('user-role').value,
                warehouses: selectedWarehouses.length > 0 ? selectedWarehouses : null,
                permissions: permissions
            };

            if (!userData.name || !userData.email) return showAlert('Chyba', 'Jméno a email jsou povinné.', 'error');
            
            if (id) {
                const index = state.users.findIndex(u => u.id === id);
                if (passwordInput) {
                    userData.password = passwordInput;
                    userData.forcePasswordChange = true;
                }
                logAuditEvent('Úprava uživatele', `Upraven uživatel: ${userData.name}.`);
                state.users[index] = { ...state.users[index], ...userData };
            } else {
                if (!passwordInput) return showAlert('Chyba', 'Heslo je pro nového uživatele povinné.', 'error');
                const newId = (Math.max(0, ...state.users.map(u => u.id)) + 1);
                const newUser = { 
                    id: newId, 
                    ...userData, 
                    password: passwordInput,
                    forcePasswordChange: true,
                    dashboard: { pinnedParts: [], pinnedCharts: [], dashboardScope: 'all' } 
                };
                logAuditEvent('Vytvoření uživatele', `Vytvořen nový uživatel: ${userData.name}.`);
                state.users.push(newUser);
            }
            saveStateToLocalStorage();
            renderUsersTable();
            hideModal('user-modal');
        }

        function deleteUser(id) {
            if(id === state.currentUser.id) return showAlert('Chyba', 'Nemůžete smazat sám sebe.', 'error');
            showAlert('Potvrzení', 'Opravdu chcete smazat tohoto uživatele?', 'confirm', () => {
                const userToDelete = state.users.find(u => u.id === id);
                logAuditEvent('Smazání uživatele', `Smazán uživatel: ${userToDelete.name}.`);
                state.users = state.users.filter(u => u.id !== id);
                saveStateToLocalStorage();
                renderUsersTable();
            });
        }
        
        function showSupplierModal(id = null) {
            const supplier = id ? state.suppliers.find(s => s.id === id) : null;
            state.currentEditingId = id;
            const title = id ? 'Upravit dodavatele' : 'Nový dodavatel';

            const html = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">${title}</h2>
                        <button class="modal-close" onclick="hideModal('supplier-modal')" aria-label="Zavřít">×</button>
                    </div>
                    <div class="form-group">
                        <label for="supplier-name">Název firmy*</label>
                        <input type="text" id="supplier-name" class="form-input" value="${supplier ? supplier.name : ''}">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="supplier-ico">IČO</label>
                            <input type="text" id="supplier-ico" class="form-input" value="${supplier ? supplier.ico : ''}">
                        </div>
                        <div class="form-group">
                            <label for="supplier-contact">Kontaktní osoba</label>
                            <input type="text" id="supplier-contact" class="form-input" value="${supplier ? supplier.contactPerson : ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="supplier-email">Email</label>
                        <input type="email" id="supplier-email" class="form-input" value="${supplier ? supplier.email : ''}">
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="saveSupplier()">Uložit dodavatele</button>
                    </div>
                </div>
            `;
            showModal('supplier-modal', html);
        }

        function saveSupplier() {
            const id = state.currentEditingId;
            const supplierData = {
                name: document.getElementById('supplier-name').value.trim(),
                ico: document.getElementById('supplier-ico').value.trim(),
                contactPerson: document.getElementById('supplier-contact').value.trim(),
                email: document.getElementById('supplier-email').value.trim(),
            };

            if (!supplierData.name) {
                return showAlert('Chyba', 'Název firmy je povinný.', 'error');
            }

            if (id) {
                const index = state.suppliers.findIndex(s => s.id === id);
                logAuditEvent('Úprava dodavatele', `Upraven dodavatel: ${supplierData.name}.`);
                state.suppliers[index] = { ...state.suppliers[index], ...supplierData };
            } else {
                const newId = (Math.max(0, ...state.suppliers.map(s => s.id)) + 1);
                logAuditEvent('Vytvoření dodavatele', `Vytvořen nový dodavatel: ${supplierData.name}.`);
                state.suppliers.push({ id: newId, ...supplierData });
            }

            saveStateToLocalStorage();
            renderSuppliersTable();
            hideModal('supplier-modal');
        }

        function deleteSupplier(id) {
            const isUsed = state.parts.some(p => p.supplierId === id);
            if (isUsed) {
                return showAlert('Chyba', 'Dodavatele nelze smazat, protože je přiřazen k jednomu nebo více dílům.', 'error');
            }

            showAlert('Potvrzení', 'Opravdu chcete smazat tohoto dodavatele?', 'confirm', () => {
                const supplierToDelete = state.suppliers.find(s => s.id === id);
                logAuditEvent('Smazání dodavatele', `Smazán dodavatel: ${supplierToDelete.name}.`);
                state.suppliers = state.suppliers.filter(s => s.id !== id);
                saveStateToLocalStorage();
                renderSuppliersTable();
            });
        }

        function showCreateOrderModal() {
            const createSelect = (data, placeholder) => `<option value="">${placeholder}</option>` + data.map(item =>`<option value="${item.id}">${item.name}</option>`).join('');
            
            const html = `
                <div class="modal">
                    <div class="modal-header"><h2 class="modal-title">Nová objednávka</h2><button class="modal-close" onclick="hideModal('order-modal')" aria-label="Zavřít">×</button></div>
                    <div class="form-group"><label>Dodavatel*</label><select id="order-supplierId" class="form-select">${createSelect(state.suppliers, 'Vyberte dodavatele')}</select></div>
                    <h3>Položky objednávky</h3>
                    <div class="order-item-labels">
                        <div>Díl</div><div>Množství</div><div>Cena/ks</div><div></div>
                    </div>
                    <div id="order-items-container"></div>
                    <button class="btn btn-secondary" onclick="addOrderItemField()">➕ Přidat položku</button>
                    <div class="order-total">Celková cena: <span id="order-total-price">0 Kč</span></div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="saveOrder()">Vytvořit objednávku</button>
                        <button class="btn btn-secondary" onclick="hideModal('order-modal')">Zrušit</button>
                    </div>
                </div>`;
            showModal('order-modal', html);
            addOrderItemField();
        }

        function addOrderItemField() {
            const container = document.getElementById('order-items-container');
            const newRow = document.createElement('div');
            newRow.className = 'order-item-row';
            const partOptions = '<option value="">Vyberte díl</option>' + state.parts.filter(p => p.warehouse !== null).map(p=>`<option value="${p.id}" data-price="${getLatestPrice(p)}">${p.name} (${p.inventoryNumber})</option>`).join('');
            newRow.innerHTML = `
                <select class="form-select order-part-select" onchange="updateOrderForm(this)">${partOptions}</select>
                <input type="number" class="form-input order-quantity-input" value="1" min="1" oninput="calculateOrderTotal()">
                <input type="number" class="form-input order-price-input" value="0" min="0" oninput="calculateOrderTotal()">
                <button class="remove-item-btn" onclick="this.parentElement.remove(); calculateOrderTotal();">×</button>`;
            container.appendChild(newRow);
        }

        function updateOrderForm(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const price = selectedOption.dataset.price || 0;
            const priceInput = selectElement.parentElement.querySelector('.order-price-input');
            priceInput.value = price;
            calculateOrderTotal();
        }

        function calculateOrderTotal() {
            let total = 0;
            document.querySelectorAll('.order-item-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.order-quantity-input').value) || 0;
                const price = parseFloat(row.querySelector('.order-price-input').value) || 0;
                total += quantity * price;
            });
            document.getElementById('order-total-price').textContent = `${total.toLocaleString('cs-CZ')} Kč`;
        }

        function saveOrder() {
            const orderData = {
                id: (Math.max(0, ...state.orders.map(o => o.id)) + 1),
                orderNumber: `OBJ-${Date.now().toString().slice(-5)}`,
                supplierId: parseInt(document.getElementById('order-supplierId').value),
                items: [],
                totalPrice: 0,
                status: 'Čeká na dodání',
                dateCreated: new Date()
            };
            if (!orderData.supplierId) return showAlert('Chyba', 'Vyberte prosím dodavatele.', 'error');

            document.querySelectorAll('.order-item-row').forEach(row => {
                const partId = parseInt(row.querySelector('.order-part-select').value);
                const quantity = parseInt(row.querySelector('.order-quantity-input').value);
                const price = parseFloat(row.querySelector('.order-price-input').value);
                const part = state.parts.find(p => p.id === partId);
                if(part && quantity > 0) {
                    orderData.items.push({ partId, partName: part.name, quantity, price });
                    orderData.totalPrice += quantity * price;
                }
            });
            if(orderData.items.length === 0) return showAlert('Chyba', 'Objednávka neobsahuje žádné platné položky.', 'error');
            state.orders.push(orderData);
            logAuditEvent('Vytvoření objednávky', `Vytvořena objednávka ${orderData.orderNumber} na ${orderData.items.length} položek.`);
            saveStateToLocalStorage();
            renderOrdersTable();
            hideModal('order-modal');
        }

        function receiveOrder(orderId) {
            const order = state.orders.find(o => o.id === orderId);
            if (!order) return;

            showAlert('Potvrzení', `Opravdu chcete přijmout všechny položky z objednávky ${order.orderNumber}? Tím se navýší stavy na skladě.`, 'confirm', () => {
                order.items.forEach(item => {
                    const partIndex = state.parts.findIndex(p => p.id === item.partId);
                    if (partIndex !== -1) {
                        state.parts[partIndex].currentStock += item.quantity;
                        const notes = `Z objednávky <a href="#" onclick="event.preventDefault(); viewOrderFromTransaction('${order.orderNumber}')">${order.orderNumber}</a>`;
                        createTransaction('prijem', state.parts[partIndex], item.quantity, notes);
                    }
                });
                order.status = 'Dokončeno';
                logAuditEvent('Příjem objednávky', `Přijata objednávka ${order.orderNumber}.`);
                saveStateToLocalStorage();
                renderAll();
            });
        }

        function deleteOrder(id) {
            showAlert('Potvrzení', 'Opravdu chcete smazat tuto objednávku?', 'confirm', () => {
                const orderToDelete = state.orders.find(o => o.id === id);
                logAuditEvent('Smazání objednávky', `Smazána objednávka ${orderToDelete.orderNumber}.`);
                state.orders = state.orders.filter(o => o.id !== id);
                saveStateToLocalStorage();
                renderOrdersTable();
            });
        }
        
        function generateAutoOrders() {
            const lowStockParts = state.parts.filter(p => p.warehouse !== null && p.currentStock < p.minStock);
            if(lowStockParts.length === 0) return showAlert('Info', 'Všechny díly jsou v dostatečném množství.');
            
            let generatedCount = 0;
            lowStockParts.forEach(part => {
                // pro automatickou objednávku použij optimální zásobu nebo dvojnásobek minima
                const quantityToOrder = (part.optimalStock || part.minStock * 2) - part.currentStock;
                if (quantityToOrder <= 0) return;

                const newOrder = {
                    id: (Math.max(0, ...state.orders.map(o => o.id)) + 1),
                    orderNumber: `AUTO-${Date.now().toString().slice(-5)}`,
                    supplierId: part.supplierId,
                    items: [{ partId: part.id, partName: part.name, quantity: quantityToOrder, price: getLatestPrice(part) }],
                    totalPrice: quantityToOrder * getLatestPrice(part),
                    status: 'Čeká na dodání',
                    dateCreated: new Date()
                };
                state.orders.push(newOrder);
                generatedCount++;
            });
            logAuditEvent('Auto-objednávky', `Vygenerováno ${generatedCount} automatických objednávek.`);
            saveStateToLocalStorage();
            renderOrdersTable();
            showAlert('Úspěch', `Bylo vygenerováno ${generatedCount} automatických objednávek.`, 'success');
        }

        function showCreateTransferModal() {
            const uniquePartNames = [...new Set(state.parts.filter(p => p.warehouse !== null).map(p => p.name))];
            
            const html = `
                <div class="modal">
                    <div class="modal-header"><h2 class="modal-title">Nový přesun dílu</h2><button class="modal-close" onclick="hideModal('transfer-modal')" aria-label="Zavřít">×</button></div>
                    <div class="form-group">
                        <label for="transfer-part-name">Vyberte díl *</label>
                        <select id="transfer-part-name" class="form-select" onchange="updateTransferForm()">
                            <option value="">Vyberte díl</option>
                            ${uniquePartNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transfer-from-warehouse">Ze skladu *</label>
                            <select id="transfer-from-warehouse" class="form-select" disabled><option>Nejprve vyberte díl</option></select>
                        </div>
                        <div class="form-group">
                            <label for="transfer-to-warehouse">Do skladu *</label>
                            <select id="transfer-to-warehouse" class="form-select" disabled><option>Nejprve vyberte díl</option></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="transfer-quantity">Množství k přesunu *</label>
                        <input type="number" id="transfer-quantity" class="form-input" value="1" min="1">
                    </div>
                     <div class="form-group">
                        <label for="transfer-notes">Poznámky</label>
                        <textarea id="transfer-notes" class="form-textarea" placeholder="Dodatečné poznámky k přesunu..."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="saveTransfer()">Odeslat požadavek na přesun</button>
                        <button class="btn btn-secondary" onclick="hideModal('transfer-modal')">Zrušit</button>
                    </div>
                </div>`;
            showModal('transfer-modal', html);
        }

        function updateTransferForm() {
            const partName = document.getElementById('transfer-part-name').value;
            const fromSelect = document.getElementById('transfer-from-warehouse');
            const toSelect = document.getElementById('transfer-to-warehouse');

            if (!partName) {
                fromSelect.innerHTML = '<option>Nejprve vyberte díl</option>';
                fromSelect.disabled = true;
                toSelect.innerHTML = '<option>Nejprve vyberte díl</option>';
                toSelect.disabled = true;
                return;
            }

            const partLocations = state.parts.filter(p => 
                p.name === partName && 
                p.warehouse !== null &&
                p.currentStock > p.minStock
            );
            
            if (partLocations.length > 0) {
                fromSelect.innerHTML = '<option value="">Vyberte zdrojový sklad</option>' + partLocations.map(p => `<option value="${p.id}">${state.warehouses[p.warehouse]} (Skladem: ${p.currentStock})</option>`).join('');
                fromSelect.disabled = false;
            } else {
                fromSelect.innerHTML = '<option value="">Žádný sklad nemá dostatek kusů</option>';
                fromSelect.disabled = true;
            }
            
            toSelect.innerHTML = '<option value="">Vyberte cílový sklad</option>' + Object.entries(state.warehouses).map(([key, value]) => `<option value="${key}">${value}</option>`).join('');
            toSelect.disabled = false;
        }

        function saveTransfer() {
            const sourcePartId = document.getElementById('transfer-from-warehouse').value;
            const toWarehouse = document.getElementById('transfer-to-warehouse').value;
            const quantity = parseInt(document.getElementById('transfer-quantity').value);
            const notes = document.getElementById('transfer-notes').value.trim();

            if (!sourcePartId || !toWarehouse || isNaN(quantity) || quantity <= 0) {
                return showAlert('Chyba', 'Vyplňte prosím všechna povinná pole.', 'error');
            }
            
            const sourcePart = state.parts.find(p => p.id == sourcePartId);
            if (!sourcePart) return showAlert('Chyba', 'Zdrojový díl nebyl nalezen.', 'error');
            if (sourcePart.warehouse === toWarehouse) return showAlert('Chyba', 'Zdrojový a cílový sklad nemohou být stejné.', 'error');
            if (sourcePart.currentStock < quantity) return showAlert('Chyba', `Nedostatečné množství na zdrojovém skladě. K dispozici: ${sourcePart.currentStock}`, 'error');
            
            const executeTransfer = () => {
                const newTransfer = {
                    id: (Math.max(0, ...state.transfers.map(t => t.id)) + 1),
                    transferNumber: `PRE-${Date.now().toString().slice(-5)}`,
                    partId: sourcePart.id,
                    partName: sourcePart.name,
                    fromWarehouse: sourcePart.warehouse,
                    toWarehouse,
                    quantity,
                    status: 'V procesu',
                    date: new Date(),
                    notes
                };
                state.transfers.push(newTransfer);
                logAuditEvent('Vytvoření přesunu', `Vytvořen přesun ${newTransfer.transferNumber} (${quantity}x ${sourcePart.name}) z ${state.warehouses[sourcePart.warehouse]} do ${state.warehouses[toWarehouse]}.`);
                saveStateToLocalStorage();
                renderTransfersTable();
                hideModal('transfer-modal');
            };

            if ((sourcePart.currentStock - quantity) < sourcePart.minStock) {
                showAlert('Potvrzení', `Po přesunu klesne stav pod minimum (${sourcePart.minStock} ks). Opravdu pokračovat?`, 'confirm', executeTransfer);
            } else {
                executeTransfer();
            }
        }

        function approveTransfer(id) {
            const transfer = state.transfers.find(t => t.id === id);
            if (!transfer) return;

            const sourcePartIndex = state.parts.findIndex(p => p.id === transfer.partId);
            if (sourcePartIndex === -1) return showAlert('Chyba', 'Původní díl pro přesun nebyl nalezen.', 'error');
            
            const sourcePart = state.parts[sourcePartIndex];
            if (sourcePart.currentStock < transfer.quantity) {
                transfer.status = 'Zrušeno (nedostatek)';
                logAuditEvent('Zrušení přesunu', `Zrušen přesun ${transfer.transferNumber} pro nedostatek dílů.`);
                saveStateToLocalStorage();
                renderAll();
                return showAlert('Chyba', `Přesun zrušen: Nedostatečný stav dílu na zdrojovém skladě.`, 'error');
            }

            let destPart = state.parts.find(p => p.code === sourcePart.code && p.warehouse === transfer.toWarehouse);
            
            sourcePart.currentStock -= transfer.quantity;
            const odeslaniNotes = `Do skladu ${state.warehouses[transfer.toWarehouse]} (<a href="#" onclick="event.preventDefault(); viewTransferFromTransaction('${transfer.transferNumber}')">${transfer.transferNumber}</a>)`;
            createTransaction('presun_odeslani', sourcePart, transfer.quantity, odeslaniNotes);

            const prijemNotes = `Ze skladu ${state.warehouses[transfer.fromWarehouse]} (<a href="#" onclick="event.preventDefault(); viewTransferFromTransaction('${transfer.transferNumber}')">${transfer.transferNumber}</a>)`;
            if (destPart) {
                destPart.currentStock += transfer.quantity;
                createTransaction('presun_prijem', destPart, transfer.quantity, prijemNotes);
            } else {
                const newId = (Math.max(0, ...state.parts.map(p => p.id)) + 1);
                const warehousePrefix = transfer.toWarehouse.toUpperCase();
                const warehouseParts = state.parts.filter(p => p.warehouse === transfer.toWarehouse && p.inventoryNumber);
                const maxInvNum = Math.max(0, ...warehouseParts.map(p => {
                    const num = p.inventoryNumber.split('-')[1];
                    return num ? parseInt(num) : 0;
                }));
                const inventoryNumber = `${warehousePrefix}-${String(maxInvNum + 1).padStart(4, '0')}`;

                const newStockedPart = {
                    ...sourcePart,
                    id: newId,
                    warehouse: transfer.toWarehouse,
                    currentStock: transfer.quantity,
                    umisteni: "Nové",
                    inventoryNumber: inventoryNumber
                };
                state.parts.push(newStockedPart);
                createTransaction('presun_prijem', newStockedPart, transfer.quantity, prijemNotes);
            }
            
            transfer.status = 'Dokončeno';
            logAuditEvent('Potvrzení přesunu', `Potvrzen příjem přesunu ${transfer.transferNumber}.`);
            saveStateToLocalStorage();
            renderAll();
        }

        function createTransaction(type, part, quantity, notes = '') {
            const transaction = {
                id: Date.now(),
                type,
                partId: part.id,
                partName: part.name,
                quantity,
                notes,
                date: new Date(),
                userId: state.currentUser.id,
                userName: state.currentUser.name
            };
            state.transactions.push(transaction);
            if (part.warehouse !== null && part.currentStock <= getLowStockThreshold(part)) {
                createNotification(`Nízký stav dílu: ${part.name} (${part.currentStock} ks).`, 'warning', { partId: part.id });
            }
        }

        function createNotification(message, type = 'info', data = {}) {
            const newNotification = {
                id: Date.now(), message, type, data, read: false, timestamp: new Date()
            };
            state.notifications.unshift(newNotification);
            if (state.notifications.length > 50) state.notifications.pop();
            renderNotifications();
        }

        function renderNotifications() {
            const list = document.getElementById('notifications-list');
            const badge = document.getElementById('notification-badge');
            const unreadCount = state.notifications.filter(n => !n.read).length;
            badge.textContent = unreadCount;
            badge.classList.toggle('hidden', unreadCount === 0);
            list.innerHTML = state.notifications.length > 0 ? state.notifications.map(n => `
                <div class="notification-item ${n.read ? '' : 'unread'}" onclick="readNotification(${n.id})">
                    ${n.message}<span class="time">${n.timestamp.toLocaleString('cs-CZ')}</span>
                </div>`).join('') : '<div class="notification-item">Žádná oznámení.</div>';
        }

        function toggleNotifications() { document.getElementById('notifications-panel').classList.toggle('hidden'); }
        function readNotification(id) {
            const notification = state.notifications.find(n => n.id === id);
            if (notification) notification.read = true;
            saveStateToLocalStorage();
            renderNotifications();
        }
        
        let charts = {};
        
        function renderDashboard() {
            const user = state.currentUser;
            const dashboardContainer = document.getElementById('personalized-dashboard');
            const pinnedContainer = document.getElementById('pinned-items-container');
            
            if (!user || (!user.dashboard.pinnedParts.length && !user.dashboard.pinnedCharts.length)) {
                dashboardContainer.classList.add('hidden');
                return;
            }

            dashboardContainer.classList.remove('hidden');
            pinnedContainer.innerHTML = '';

            user.dashboard.pinnedParts.forEach(partId => {
                const part = state.parts.find(p => p.id === partId);
                if (part) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.onclick = () => showPartDetailModal(part.id);
                    card.innerHTML = `
                        <div class="stat-icon stat-blue">🔩</div>
                        <div class="stat-content">
                            <h3>${part.name}</h3>
                            <p>${part.currentStock} ks</p>
                            <small>${state.warehouses[part.warehouse] || ''} / ${part.umisteni || ''}</small>
                        </div>
                    `;
                    pinnedContainer.appendChild(card);
                }
            });

            user.dashboard.pinnedCharts.forEach(chartId => {
                const reportCard = document.createElement('div');
                reportCard.className = 'report-card';
                reportCard.dataset.chartId = chartId;
                
                if (chartId === 'parts-by-category' || chartId === 'value-by-category') {
                    reportCard.innerHTML = `<h3>${chartId === 'parts-by-category' ? 'Díly podle kategorie' : 'Hodnota skladu podle kategorie'}</h3><canvas id="pinned-${chartId}-chart"></canvas>`;
                } else {
                    reportCard.innerHTML = `<h3>${chartId === 'top-used-parts' ? 'TOP 10 nejpoužívanějších dílů' : 'Skladové "ležáky"'}</h3><ul id="pinned-${chartId}-list" class="report-list"></ul>`;
                }
                pinnedContainer.appendChild(reportCard);
                renderSpecificReport(chartId, 'pinned-');
            });
        }

        function renderReports() {
            document.querySelectorAll('#reports-container .report-card').forEach(card => {
                const chartId = card.dataset.chartId;
                renderSpecificReport(chartId);
                
                const pinBtn = document.createElement('button');
                pinBtn.className = 'pin-btn';
                pinBtn.innerHTML = '📌';
                pinBtn.onclick = () => togglePinChart(chartId);
                if (state.currentUser.dashboard.pinnedCharts.includes(chartId)) {
                    pinBtn.classList.add('pinned');
                }
                if (!card.querySelector('.pin-btn')) {
                    card.appendChild(pinBtn);
                }
            });
        }

        function renderSpecificReport(chartId, prefix = '') {
            Object.values(charts).forEach(chart => { if(chart && chart.canvas.id.includes(chartId)) chart.destroy(); });
            const accessibleParts = getAccessible(state.parts).filter(p => p.warehouse !== null);

            if (chartId === 'parts-by-category' || chartId === 'value-by-category') {
                const data = accessibleParts.reduce((acc, part) => {
                    const categoryName = state.categories[part.category] || 'Neznámá';
                    acc[categoryName] = acc[categoryName] || { count: 0, value: 0 };
                    acc[categoryName].count++;
                    acc[categoryName].value += part.currentStock * getLatestPrice(part);
                    return acc;
                }, {});
                const labels = Object.keys(data);
                const categoryColors = ['#007aff', '#34c759', '#ff9500', '#ff3b30', '#af52de', '#5856d6'];
                
                if (chartId === 'parts-by-category') {
                     charts[prefix + chartId] = new Chart(document.getElementById(`${prefix}parts-by-category-chart`), {
                        type: 'doughnut',
                        data: { labels, datasets: [{ data: labels.map(l => data[l].count), backgroundColor: categoryColors }] },
                    });
                } else {
                    charts[prefix + chartId] = new Chart(document.getElementById(`${prefix}value-by-category-chart`), {
                        type: 'bar',
                        data: { labels, datasets: [{ label: 'Hodnota (Kč)', data: labels.map(l => data[l].value), backgroundColor: categoryColors }] },
                    });
                }
            } else {
                renderTurnoverReports(chartId, prefix);
            }
        }

        function renderTurnoverReports(chartId, prefix = '') {
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const recentTransactions = state.transactions.filter(t => new Date(t.date) > oneYearAgo);
            
            if (chartId === 'top-used-parts') {
                const dispensedParts = recentTransactions.filter(t => t.type === 'vydej');
                const usageCount = dispensedParts.reduce((acc, t) => {
                    acc[t.partId] = (acc[t.partId] || 0) + t.quantity;
                    return acc;
                }, {});
                const topUsed = Object.entries(usageCount).sort(([, a], [, b]) => b - a).slice(0, 10);
                const topUsedList = document.getElementById(`${prefix}top-used-parts-list`);
                topUsedList.innerHTML = topUsed.map(([partId, count]) => {
                    const part = state.parts.find(p => p.id === parseInt(partId));
                    return `<li><span>${part ? part.name : 'Neznámý díl'}</span> <strong>${count} ks</strong></li>`;
                }).join('') || '<li>Žádná data o výdejích za poslední rok.</li>';
            }

            if (chartId === 'shelf-warmers') {
                const dispensedParts = recentTransactions.filter(t => t.type === 'vydej');
                const stockedPartIds = new Set(state.parts.filter(p => p.warehouse !== null).map(p => p.id));
                const usedPartIds = new Set(dispensedParts.map(t => t.partId));
                const shelfWarmers = [...stockedPartIds].filter(id => !usedPartIds.has(id));
                const shelfWarmersList = document.getElementById(`${prefix}shelf-warmers-list`);
                shelfWarmersList.innerHTML = shelfWarmers.map(partId => {
                     const part = state.parts.find(p => p.id === partId);
                     return `<li><span>${part.name}</span> <strong>${part.currentStock} ks</strong></li>`;
                }).join('') || '<li>Nebyly nalezeny žádné "ležáky".</li>';
            }
        }

        function renderPriceHistoryChart(part) {
            const ctx = document.getElementById('price-history-chart').getContext('2d');
            if (charts.priceHistory) charts.priceHistory.destroy();
            if (!part.priceHistory || part.priceHistory.length < 2) {
                 document.getElementById('price-history-chart').style.display = 'none';
                 return;
            }
             document.getElementById('price-history-chart').style.display = 'block';

            charts.priceHistory = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Cena (Kč)',
                        data: part.priceHistory.map(entry => ({ x: new Date(entry.date), y: entry.price })),
                        borderColor: 'var(--accent-blue)',
                        tension: 0.1
                    }]
                },
                options: { scales: { x: { type: 'time', time: { unit: 'month' } } } }
            });
        }
        
        function togglePinPart(partId) {
            const pinnedParts = state.currentUser.dashboard.pinnedParts;
            const index = pinnedParts.indexOf(partId);
            if (index > -1) pinnedParts.splice(index, 1);
            else pinnedParts.push(partId);
            saveStateToLocalStorage();
            renderDashboard();
            hideModal('part-detail-modal');
            showPartDetailModal(partId);
        }

        function togglePinChart(chartId) {
            const pinnedCharts = state.currentUser.dashboard.pinnedCharts;
            const index = pinnedCharts.indexOf(chartId);
            if (index > -1) pinnedCharts.splice(index, 1);
            else pinnedCharts.push(chartId);
            saveStateToLocalStorage();
            renderDashboard();
            renderReports();
        }
        
        function viewOrderFromTransaction(orderNumber) {
            const order = state.orders.find(o => o.orderNumber === orderNumber);
            if (!order) return showAlert('Chyba', 'Objednávka nebyla nalezena.');
            const supplier = state.suppliers.find(s => s.id === order.supplierId);
            let itemsHtml = order.items.map(item => `<li>${item.quantity}x ${item.partName} @ ${item.price.toLocaleString('cs-CZ')} Kč</li>`).join('');
            let message = `
                <b>Dodavatel:</b> ${supplier ? supplier.name : 'Neznámý'}<br>
                <b>Datum:</b> ${new Date(order.dateCreated).toLocaleDateString('cs-CZ')}<br>
                <b>Stav:</b> ${order.status}<br>
                <b>Celkem:</b> ${order.totalPrice.toLocaleString('cs-CZ')} Kč<br>
                <b>Položky:</b><ul>${itemsHtml}</ul>
            `;
            showAlert(`Detail objednávky ${order.orderNumber}`, message);
        }

        function viewTransferFromTransaction(transferNumber) {
            const transfer = state.transfers.find(t => t.transferNumber === transferNumber);
            if (!transfer) return showAlert('Chyba', 'Přesun nebyl nalezen.');
             let message = `
                <b>Díl:</b> ${transfer.partName}<br>
                <b>Množství:</b> ${transfer.quantity} ks<br>
                <b>Z:</b> ${state.warehouses[transfer.fromWarehouse]}<br>
                <b>Do:</b> ${state.warehouses[transfer.toWarehouse]}<br>
                <b>Datum:</b> ${new Date(transfer.date).toLocaleDateString('cs-CZ')}<br>
                <b>Stav:</b> ${transfer.status}<br>
                <b>Poznámky:</b> ${transfer.notes || '-'}
            `;
            showAlert(`Detail přesunu ${transfer.transferNumber}`, message);
        }
        
        function renderSettings() {
            document.getElementById('setting-low-stock-threshold').value = state.settings.lowStockThreshold || 20;
            renderDispenseReasonsSettings();
            renderCoreDataSettings();
            renderDashboardSettings();
        }

        function renderDispenseReasonsSettings() {
            const container = document.getElementById('dispense-reasons-list');
            container.innerHTML = '';
            if (!state.dispenseReasons) state.dispenseReasons = {};
            for (const [key, value] of Object.entries(state.dispenseReasons)) {
                const div = document.createElement('div');
                div.className = 'reason-item';
                div.innerHTML = `
                    <input type="text" class="form-input" value="${key}" disabled>
                    <input type="text" class="form-input" value="${value}" onchange="updateDispenseReason('${key}', this.value)">
                    <button class="btn btn-danger" onclick="deleteDispenseReason('${key}')">🗑️</button>
                `;
                container.appendChild(div);
            }
        }

        function addDispenseReason() {
            const keyInput = document.getElementById('new-reason-key');
            const valueInput = document.getElementById('new-reason-value');
            const key = keyInput.value.trim();
            const value = valueInput.value.trim();

            if (!key || !value) return showAlert('Chyba', 'Klíč i text jsou povinné.', 'error');
            if (state.dispenseReasons[key]) return showAlert('Chyba', 'Tento klíč již existuje.', 'error');

            state.dispenseReasons[key] = value;
            logAuditEvent('Správa nastavení', `Přidán nový důvod výdeje: '${value}'.`);
            saveStateToLocalStorage();
            renderDispenseReasonsSettings();
            keyInput.value = '';
            valueInput.value = '';
        }

        function updateDispenseReason(key, newValue) {
            if (state.dispenseReasons[key]) {
                logAuditEvent('Správa nastavení', `Upraven důvod výdeje '${key}' na '${newValue}'.`);
                state.dispenseReasons[key] = newValue;
                saveStateToLocalStorage();
                showAlert('Úspěch', 'Důvod byl aktualizován.', 'success');
            }
        }

        function deleteDispenseReason(key) {
            if (key === 'jine') {
                return showAlert('Chyba', 'Důvod "Jiné" nelze smazat, je systémový.', 'error');
            }
            showAlert('Potvrzení', `Opravdu chcete smazat důvod "${state.dispenseReasons[key]}"?`, 'confirm', () => {
                logAuditEvent('Správa nastavení', `Smazán důvod výdeje: '${state.dispenseReasons[key]}'.`);
                delete state.dispenseReasons[key];
                saveStateToLocalStorage();
                renderDispenseReasonsSettings();
            });
        }
        
        function renderCoreDataSettings() {
            const renderList = (type) => {
                const container = document.getElementById(`${type}-settings-list`);
                container.innerHTML = '';
                if (!state[type]) state[type] = {};
                for (const [key, value] of Object.entries(state[type])) {
                    const div = document.createElement('div');
                    div.className = 'core-data-item';
                    div.innerHTML = `
                        <input type="text" class="form-input" value="${key}" disabled>
                        <input type="text" class="form-input" value="${value}" onchange="updateCoreDataItem('${type}', '${key}', this.value)">
                        <button class="btn btn-danger" onclick="deleteCoreDataItem('${type}', '${key}')">🗑️</button>
                    `;
                    container.appendChild(div);
                }
            };
            renderList('warehouses');
            renderList('categories');
            renderList('machines');
            renderList('priorities');
        }

        function addCoreDataItem(type) {
            const keyInput = document.getElementById(`new-${type}-key`);
            const valueInput = document.getElementById(`new-${type}-value`);
            const key = keyInput.value.trim().toLowerCase().replace(/\s+/g, '');
            const value = valueInput.value.trim();

            if (!key || !value) return showAlert('Chyba', 'Klíč i hodnota jsou povinné.', 'error');
            if (state[type][key]) return showAlert('Chyba', 'Tento klíč již existuje.', 'error');

            state[type][key] = value;
            logAuditEvent('Správa kmenových dat', `Přidána nová položka do '${type}': ${value}.`);
            saveStateToLocalStorage();
            renderCoreDataSettings();
            renderFilters();
             if (type === 'warehouses') {
                renderDashboardSettings();
            }
            keyInput.value = '';
            valueInput.value = '';
            showAlert('Úspěch', 'Položka byla úspěšně přidána.', 'success');
        }

        function updateCoreDataItem(type, key, newValue) {
            if (state[type][key]) {
                logAuditEvent('Správa kmenových dat', `Upravena položka '${key}' v '${type}' na '${newValue}'.`);
                state[type][key] = newValue;
                saveStateToLocalStorage();
                renderFilters();
                 if (type === 'warehouses') {
                    renderDashboardSettings();
                }
                showAlert('Úspěch', 'Položka byla aktualizována.', 'success');
            }
        }

        function deleteCoreDataItem(type, key) {
            const isInUse = {
                warehouses: state.parts.some(p => p.warehouse === key),
                categories: state.parts.some(p => p.category === key),
                priorities: state.parts.some(p => p.priority === key),
            };

            if (isInUse[type]) {
                return showAlert('Chyba', 'Tuto položku nelze smazat, protože je používána u jednoho nebo více dílů.', 'error');
            }

            showAlert('Potvrzení', `Opravdu chcete smazat položku "${state[type][key]}"?`, 'confirm', () => {
                logAuditEvent('Správa kmenových dat', `Smazána položka '${state[type][key]}' z '${type}'.`);
                delete state[type][key];
                saveStateToLocalStorage();
                renderCoreDataSettings();
                renderFilters();
                if (type === 'warehouses') {
                    renderDashboardSettings();
                }
            });
        }


        function saveSettings() {
            state.settings.lowStockThreshold = parseInt(document.getElementById('setting-low-stock-threshold').value) || 20;
            
            const userIndex = state.users.findIndex(u => u.id === state.currentUser.id);
            if (userIndex > -1) {
                state.users[userIndex].dashboard.dashboardScope = document.getElementById('dashboard-scope-select').value;
            }
            logAuditEvent('Uložení nastavení', 'Uložena obecná nastavení aplikace.');
            saveStateToLocalStorage();
            showAlert('Úspěch', 'Nastavení bylo uloženo.', 'success');
            updateStats();
        }
        
        function renderDashboardSettings() {
            const select = document.getElementById('dashboard-scope-select');
            const user = state.currentUser;
            const scope = user.dashboard.dashboardScope || 'all';
            
            let options = '<option value="all">Všechny dostupné sklady</option>';

            const accessibleWarehouses = user.warehouses || Object.keys(state.warehouses);
            
            accessibleWarehouses.forEach(whKey => {
                options += `<option value="${whKey}">${state.warehouses[whKey]}</option>`;
            });

            select.innerHTML = options;
            select.value = scope;
        }

        function backupData() {
            const dataStr = JSON.stringify(state, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `sklad_zaloha_v13_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            logAuditEvent('Záloha dat', 'Uživatel stáhl zálohu dat.');
        }

        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const restoredState = JSON.parse(e.target.result);
                    showAlert('Potvrzení', 'Opravdu chcete přepsat všechna stávající data daty ze zálohy? Tuto akci nelze vrátit zpět.', 'confirm', () => {
                        // Uložíme obnovený stav, ale bez currentUser, aby se vynutilo nové přihlášení
                        const { currentUser, ...stateToRestore } = restoredState;
                        localStorage.setItem('sparePartsState_v13', JSON.stringify(stateToRestore));
                        logAuditEvent('Obnova dat', `Data byla obnovena ze souboru ${file.name}.`);
                        location.reload();
                    });
                } catch (err) {
                    showAlert('Chyba', 'Soubor se zálohou je poškozený nebo v neplatném formátu.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            let csv = [];
            const rows = table.querySelectorAll("tr");
            
            for (const row of rows) {
                const cols = row.querySelectorAll("td, th");
                const rowData = [];
                for (const col of cols) {
                    if (!col.classList.contains('action-buttons')) {
                        rowData.push('"' + col.innerText.replace(/"/g, '""').replace(/\n/g, ' ') + '"');
                    }
                }
                csv.push(rowData.join(","));
            }

            const csvFile = new Blob([csv.join("\n")], {type: "text/csv"});
            const downloadLink = document.createElement("a");
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
        }
        
        function exportTableToXLSX(tableId, filename) {
            const table = document.getElementById(tableId);
            const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet JS" });
            XLSX.writeFile(wb, filename || 'export.xlsx');
        }

        function showAlert(title, message, type = 'info', onConfirm = null) {
            const modal = document.getElementById('alert-modal');
            const iconMap = {
                info: 'ℹ️', success: '✅', warning: '⚠️', error: '❌', confirm: '❓'
            };
            const html = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2 class="modal-title">${iconMap[type]} ${title}</h2>
                        <button class="modal-close" onclick="hideModal('alert-modal')" aria-label="Zavřít">×</button>
                    </div>
                    <div style="margin-top: 16px; line-height: 1.5;">${message.replace(/\n/g, '<br>')}</div>
                    <div class="modal-footer" style="justify-content: ${type === 'confirm' ? 'space-between' : 'flex-end'};">
                        ${type === 'confirm' ? `
                        <button class="btn btn-secondary" onclick="hideModal('alert-modal')">Zrušit</button>
                        <button class="btn btn-primary" id="confirm-alert-btn">Potvrdit</button>
                        ` : `
                        <button class="btn btn-primary" onclick="hideModal('alert-modal')">Rozumím</button>
                        `}
                    </div>
                </div>
            `;
            
            showModal('alert-modal', html);

            if (type === 'confirm' && onConfirm) {
                document.getElementById('confirm-alert-btn').onclick = () => {
                    hideModal('alert-modal');
                    onConfirm();
                };
            }
        }
        
        function showStartInventoryModal() {
            const warehouseOptions = Object.entries(state.warehouses).map(([id, name]) => `<option value="${id}">${name}</option>`).join('');
            const html = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">Zahájit novou inventuru</h2>
                        <button class="modal-close" onclick="hideModal('inventory-modal')" aria-label="Zavřít">×</button>
                    </div>
                    <div class="form-group">
                        <label for="inventory-warehouse">Vyberte sklad*</label>
                        <select id="inventory-warehouse" class="form-select">${warehouseOptions}</select>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="startInventory()">Zahájit</button>
                    </div>
                </div>
            `;
            showModal('inventory-modal', html);
        }

        function startInventory() {
            const warehouseId = document.getElementById('inventory-warehouse').value;
            if (!warehouseId) {
                return showAlert('Chyba', 'Musíte vybrat sklad.', 'error');
            }

            const partsInWarehouse = state.parts
                .filter(p => p.warehouse === warehouseId)
                .map(p => ({
                    partId: p.id,
                    name: p.name,
                    inventoryNumber: p.inventoryNumber,
                    expectedStock: p.currentStock,
                    actualStock: null
                }));

            const newSession = {
                id: Date.now(),
                warehouseId: warehouseId,
                startDate: new Date(),
                status: 'Probíhá',
                userId: state.currentUser.id,
                userName: state.currentUser.name,
                items: partsInWarehouse
            };

            state.inventorySessions.push(newSession);
            logAuditEvent('Zahájení inventury', `Zahájena inventura pro sklad ${state.warehouses[warehouseId]}.`);
            saveStateToLocalStorage();
            renderInventoryList();
            hideModal('inventory-modal');
            continueInventory(newSession.id);
        }

        function continueInventory(sessionId) {
            const session = state.inventorySessions.find(s => s.id === sessionId);
            if (!session) return;

            document.getElementById('inventory-start-view').classList.add('hidden');
            const sessionView = document.getElementById('inventory-session-view');
            sessionView.classList.remove('hidden');

            const isFinished = session.status === 'Dokončeno';

            let itemsHtml = session.items.map(item => {
                let discrepancy = '';
                if (item.actualStock !== null) {
                    const diff = item.actualStock - item.expectedStock;
                    if (diff > 0) discrepancy = `<span class="discrepancy-plus">+${diff}</span>`;
                    if (diff < 0) discrepancy = `<span class="discrepancy-minus">${diff}</span>`;
                }
                return `
                <div class="inventory-item">
                    <div>
                        <div class="font-medium">${item.name}</div>
                        <div class="text-gray-500">${item.inventoryNumber}</div>
                    </div>
                    <div>${item.expectedStock} ks</div>
                    <div><input type="number" class="form-input" data-part-id="${item.partId}" value="${item.actualStock !== null ? item.actualStock : ''}" ${isFinished ? 'disabled' : ''}></div>
                    <div>${discrepancy}</div>
                </div>
            `}).join('');

            sessionView.innerHTML = `
                <div class="table-container">
                    <div class="table-header">
                        <h3>Inventura skladu: ${state.warehouses[session.warehouseId]}</h3>
                        <button class="btn btn-secondary" onclick="showTab('inventory-module')">Zpět na seznam</button>
                    </div>
                    <div style="padding: 24px;">
                        <div class="inventory-item" style="font-weight: bold;">
                           <div>Název dílu</div>
                           <div>Očekáváno</div>
                           <div>Napočítáno</div>
                           <div>Rozdíl</div>
                        </div>
                        ${itemsHtml}
                        ${!isFinished ? `
                        <div class="modal-actions">
                            <button class="btn btn-primary" onclick="finishInventory(${sessionId})">Uložit a dokončit inventuru</button>
                        </div>
                        ` : `
                        <div class="modal-actions">
                             <p class="text-secondary-color">Inventura byla dokončena ${new Date(session.endDate).toLocaleString('cs-CZ')}.</p>
                        </div>
                        `}
                    </div>
                </div>
            `;
        }
        
        function finishInventory(sessionId) {
            const sessionIndex = state.inventorySessions.findIndex(s => s.id === sessionId);
            if (sessionIndex === -1) return;
            const session = state.inventorySessions[sessionIndex];

            const inputs = document.querySelectorAll('#inventory-session-view input[data-part-id]');
            inputs.forEach(input => {
                const partId = parseInt(input.dataset.partId);
                const actualStock = input.value !== '' ? parseInt(input.value) : null;
                const item = session.items.find(i => i.partId === partId);
                if (item) {
                    item.actualStock = actualStock;
                }
            });

            showAlert('Dokončení inventury', 'Opravdu chcete dokončit tuto inventuru? Budou zobrazeny rozdíly a budete mít možnost opravit stavy skladu.', 'confirm', () => {
                session.status = 'Dokončeno';
                session.endDate = new Date();
                logAuditEvent('Dokončení inventury', `Dokončena inventura pro sklad ${state.warehouses[session.warehouseId]}.`);
                saveStateToLocalStorage();
                showInventoryDiscrepancy(sessionId);
            });
        }

        function showInventoryDiscrepancy(sessionId) {
            const session = state.inventorySessions.find(s => s.id === sessionId);
            const discrepancies = session.items.filter(item => item.actualStock !== null && item.actualStock !== item.expectedStock);

            if (discrepancies.length === 0) {
                showAlert('Inventura dokončena', 'Nebyly nalezeny žádné rozdíly ve stavech skladu.', 'success');
                continueInventory(sessionId);
                return;
            }

            let discrepancyHtml = discrepancies.map(item => `
                <div class="inventory-item">
                    <div>${item.name}</div>
                    <div>${item.expectedStock}</div>
                    <div>${item.actualStock}</div>
                    <div>${item.actualStock - item.expectedStock}</div>
                </div>
            `).join('');

            const html = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">Protokol o rozdílech v inventuře</h2>
                        <button class="modal-close" onclick="hideModal('inventory-modal'); continueInventory(${sessionId});" aria-label="Zavřít">×</button>
                    </div>
                    <p>Následující položky se liší od evidovaného stavu. Chcete stavy na skladě opravit podle skutečnosti?</p>
                    <div style="margin-top: 20px;">
                        <div class="inventory-item" style="font-weight: bold;">
                           <div>Název dílu</div>
                           <div>Očekáváno</div>
                           <div>Napočítáno</div>
                           <div>Rozdíl</div>
                        </div>
                        ${discrepancyHtml}
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="hideModal('inventory-modal'); continueInventory(${sessionId});">Ne, nechat původní stavy</button>
                        <button class="btn btn-primary" onclick="applyInventoryCorrections(${sessionId})">Ano, opravit stavy</button>
                    </div>
                </div>
            `;
            showModal('inventory-modal', html);
        }

        function applyInventoryCorrections(sessionId) {
            const session = state.inventorySessions.find(s => s.id === sessionId);
            const discrepancies = session.items.filter(item => item.actualStock !== null && item.actualStock !== item.expectedStock);

            discrepancies.forEach(item => {
                const partIndex = state.parts.findIndex(p => p.id === item.partId);
                if (partIndex !== -1) {
                    const part = state.parts[partIndex];
                    const diff = item.actualStock - item.expectedStock;
                    part.currentStock = item.actualStock;
                    createTransaction('korekce', part, diff, `Inventura ze dne ${new Date(session.startDate).toLocaleDateString('cs-CZ')}`);
                }
            });
            logAuditEvent('Aplikace korekcí', `Aplikovány korekce z inventury pro sklad ${state.warehouses[session.warehouseId]}.`);
            saveStateToLocalStorage();
            hideModal('inventory-modal');
            renderAll();
            continueInventory(sessionId);
            showAlert('Úspěch', 'Stavy skladu byly úspěšně opraveny dle inventury.', 'success');
        }

        function debounce(func, delay = 300) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        function setupEventListeners() {
            document.getElementById('search-input').addEventListener('input', debounce(renderPartsTable, 300));
            document.getElementById('warehouse-filter').addEventListener('change', renderPartsTable);
            document.getElementById('category-filter').addEventListener('change', renderPartsTable);
            const mf = document.getElementById('machine-filter'); if (mf) mf.addEventListener('change', renderPartsTable);
        }

    </script>

<script>
  function editPartFromDetail(id){
    // Before opening the edit form, hide all open modals (including the part detail)
    // to ensure the edit modal appears above everything else.
    try { hideAllModals(); } catch(e) {}
    // Use a slight timeout to allow the DOM to update hidden states before rendering the new modal.
    setTimeout(function(){ showPartModal(id); }, 0);
  }

        // Alias for backward compatibility: some code still calls closeModal().
        // Ensure it maps to hideModal() to avoid undefined function errors.
        function closeModal(modalId) {
            hideModal(modalId);
        }
  window.editPartFromDetail = editPartFromDetail;
</script>


<script>
  function getPartsForMachine(machineId){
    return getAccessible(state.parts)
      .filter(p => p.warehouse !== null)
      .filter(p => p.machineId === machineId);
  }
  function computeMachineStats(machineId){
    const items = getPartsForMachine(machineId);
    let critical = 0, value = 0;
    items.forEach(part => {
      const low = getLowStockThreshold(part);
      if (part.currentStock === 0 || part.currentStock <= low) critical++;
      const price = getLatestPrice(part);
      value += (price * (part.currentStock || 0)) || 0;
    });
    const uniqueKey = p => (p.code || p.name || '').toLowerCase();
    const uniqueCount = Array.from(new Set(items.map(uniqueKey))).length;
    return { count: uniqueCount, critical, value };
  }
  function renderMachinesTable(){
    const tbody = document.getElementById('machines-table-body');
    const nores = document.getElementById('machines-no-results');
    const search = (document.getElementById('machine-search-input')?.value || '').toLowerCase();
    const entries = Object.entries(state.machines || {})
      .map(([id, name]) => ({ id, name }))
      .filter(m => !search || (m.name.toLowerCase().includes(search) || m.id.toLowerCase().includes(search)))
      .sort((a,b) => a.name.localeCompare(b.name,'cs'));
    if (!entries.length){ tbody.innerHTML = ''; nores.classList.remove('hidden'); return; }
    nores.classList.add('hidden');
    tbody.innerHTML = entries.map(m => {
      const {count, critical, value} = computeMachineStats(m.id);
      const badgeClass = critical > 0 ? 'badge-red' : 'badge-green';
      return `<tr>
        <td><span class="font-medium">${m.name}</span><div class="text-gray-500">${m.id}</div></td>
        <td>${count}</td>
        <td><span class="badge ${badgeClass}">${critical}</span></td>
        <td>${value ? value.toLocaleString('cs-CZ') + ' Kč' : '-'}</td>
        <td class="action-buttons"><button class="btn btn-secondary" onclick="showMachineDetail('${m.id}')">👁️</button></td>
      </tr>`;
    }).join('');
    const input = document.getElementById('machine-search-input');
    if (input && !input._bind){ input.addEventListener('input', debounce(renderMachinesTable, 250)); input._bind = true; }
  }
  
function showMachineDetail(machineId){
    const name = state.machines?.[machineId] || machineId;
    const items = getPartsForMachine(machineId);
    const rows = items.map(part => {
      const low = getLowStockThreshold(part);
      const dot = part.currentStock === 0 ? 'status-dot-red' : (part.currentStock <= low ? 'status-dot-yellow' : 'status-dot-green');
      const price = getLatestPrice(part);
      return `<tr>
        <td>${part.name}</td>
        <td>${part.code || ''}</td>
        <td>${state.warehouses[part.warehouse] || ''}<div class="text-gray-500">${part.umisteni || ''}</div></td>
        <td><div class="inventory-status"><div class="status-dot ${dot}"></div><span>${part.currentStock} ks</span></div></td>
        <td>${price ? price.toLocaleString('cs-CZ') + ' Kč' : '-'}</td>
      </tr>`;
    }).join('');
    const html = `
      <div class="modal" style="max-width: 900px;">
        <div class="modal-header">
          <h2 class="modal-title">${name}</h2>
          <button class="modal-close" onclick="hideModal('machine-detail-modal')" aria-label="Zavřít">×</button>
        </div>
        <div class="modal-content">
          <div class="stats-row">
            <div class="stat-card"><div class="stat-title">Počet dílů</div><div class="stat-value">${new Set(items.map(p=>p.code||p.name)).size}</div></div>
            <div class="stat-card"><div class="stat-title">Kritické</div><div class="stat-value">${items.filter(p=>p.currentStock===0 || p.currentStock<=getLowStockThreshold(p)).length}</div></div>
            <div class="stat-card"><div class="stat-title">Hodnota</div><div class="stat-value">${items.reduce((s,p)=>s+(getLatestPrice(p)*(p.currentStock||0)||0),0).toLocaleString('cs-CZ')} Kč</div></div>
          </div>
          <div class="table-container" style="margin-top:12px;">
            <table class="table">
              <thead><tr><th>Díl</th><th>SKU</th><th>Umístění</th><th>Stav</th><th>Cena/ks</th></tr></thead>
              <tbody>${rows || '<tr><td colspan="5" class="text-center text-gray-500">Žádné přiřazené díly.</td></tr>'}</tbody>
            </table>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-success" onclick="showAssignPartModal()">📥 Naskladnit</button>
          <button class="btn btn-outline" onclick="exportMachinesToCSV('${machineId}')">⬇️ Export</button>
        </div>
      </div>`;
    showModal('machine-detail-modal', html);
}

  /**
   * Aktualizuje optimální zásobu pro každý díl na základě počtu vydaných kusů
   * za poslední týden. Pro každý díl (master i skladový) spočítá součet
   * transakcí typu "vydej" v posledních sedmi dnech a nastaví vlastnost
   * `optimalStock` minimálně na hodnotu `minStock`. Díly bez historie
   * vydávání si ponechají minimální zásobu jako optimální.
   */
  function updateOptimalStock(){
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    state.parts.forEach(part => {
      // sečteme množství vydaných kusů za posledních 7 dní
      let weeklyUsage = 0;
      state.transactions.forEach(t => {
        try {
          const tDate = new Date(t.date);
          if (t.partId === part.id && t.type && String(t.type).toLowerCase().includes('vydej') && tDate >= oneWeekAgo) {
            weeklyUsage += (t.quantity || 0);
          }
        } catch(e) {}
      });
      const min = part.minStock || 0;
      const opt = Math.max(min, weeklyUsage);
      part.optimalStock = opt;
    });
  }

  function exportMachinesToCSV(machineId){
    let rows = [["Zařízení","Díl","SKU","Sklad","Umístění","Aktuální počet","Cena/ks"]];
    const list = machineId ? [{id: machineId, name: state.machines[machineId]}]
      : Object.entries(state.machines||{}).map(([id,name])=>({id,name}));
    list.forEach(m => {
      const items = getPartsForMachine(m.id);
      items.forEach(p => {
        rows.push([m.name, p.name, p.code||'', state.warehouses[p.warehouse]||'', p.umisteni||'', p.currentStock||0, getLatestPrice(p)||0]);
      });
    });
    const csv = rows.map(r => r.map(x => `${(x??'').toString().replace(/"/g,'""')}`).map(x=>`"${x}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = machineId ? `zarizeni_${machineId}.csv` : 'zarizeni_export.csv'; a.click();
  }
</script>


<script>
  function normalizeMachineId(s){
    return (s||'').toString().trim().toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/\s+/g,'').replace(/[^a-z0-9_-]/g,'');
  }
  function showCreateMachineModal(){
    const html = `
      <div class="modal" style="max-width:520px;">
        <div class="modal-header">
          <h2 class="modal-title">Nové zařízení</h2>
          <button class="modal-close" onclick="hideModal('machine-create-modal')" aria-label="Zavřít">×</button>
        </div>
        <div class="modal-content">
          <div class="form-group"><label>Kód (ID)*</label>
            <input id="machine-id" class="form-input" placeholder="např. dopA">
            <div class="text-gray-500" style="font-size:12px;">bez diakritiky, malá písmena, povolené znaky: a-z 0-9 _ -</div>
          </div>
          <div class="form-group"><label>Název*</label>
            <input id="machine-name" class="form-input" placeholder="např. Dopravník A">
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-primary" onclick="saveMachineFromModal()">Uložit</button>
        </div>
      </div>`;
    showModal('machine-create-modal', html);
    setTimeout(()=>document.getElementById('machine-id')?.focus(), 0);
  }
  function saveMachineFromModal(){
    const rawId = document.getElementById('machine-id')?.value || '';
    const id = normalizeMachineId(rawId);
    const name = (document.getElementById('machine-name')?.value || '').trim();
    if (!id || !name) return showAlert('Chyba', 'Vyplňte Kód i Název.', 'error');
    if (!state.machines) state.machines = {};
    if (state.machines[id]) return showAlert('Chyba', 'Zařízení s tímto kódem již existuje.', 'error');
    state.machines[id] = name;
    logAuditEvent('Zařízení', `Vytvořeno zařízení '${name}' (${id}).`);
    saveStateToLocalStorage();
    renderFilters();
    if (typeof renderMachinesTable === 'function') renderMachinesTable();
    closeModal('machine-create-modal');
    showAlert('Hotovo', 'Zařízení bylo vytvořeno.', 'success');
  }
</script>


<script>
(function(){
  if (!window.state) window.state = {};
  if (!state.ui) state.ui = {};
  if (!state.ui.smartFilter) state.ui.smartFilter = 'all';

  window.setSmartFilter = function(mode){
    state.ui.smartFilter = mode || 'all';
    try { renderPartsTable(); } catch(_){}
    updateSmartChips();
  };

  window.updateSmartChips = function(){
    const cont = document.getElementById('smart-chips');
    if (!cont) return;
    const mode = (state.ui && state.ui.smartFilter) || 'all';
    cont.querySelectorAll('.smart-chip').forEach(btn => {
      btn.classList.toggle('active', btn.getAttribute('data-mode') === mode);
    });
  };

  // Better search AND-token logic + include more fields
  const _origGetFiltered = window.getFilteredParts;
  window.getFilteredParts = function(){
    const si = document.getElementById('search-input');
    const searchRaw = (si ? si.value : '').toLowerCase().trim();
    const tokens = searchRaw ? searchRaw.split(/\s+/).filter(Boolean) : [];

    const warehouseFilter = (document.getElementById('warehouse-filter') ? document.getElementById('warehouse-filter').value : 'all');
    const categoryFilter = (document.getElementById('category-filter') ? document.getElementById('category-filter').value : 'all');
    const machineFilter = (document.getElementById('machine-filter') ? document.getElementById('machine-filter').value : 'all');
    const mode = (state.ui && state.ui.smartFilter) || 'all';

    return getAccessible(state.parts).filter(part => {
      const supplierName = (()=>{ try { const s = state.suppliers.find(x => x.id === part.supplierId); return (s && s.name) || ''; } catch(_) { return ''; } })();
      const categoryName = (state.categories && part.category && state.categories[part.category]) ? state.categories[part.category] : '';
      const warehouseName = (state.warehouses && part.warehouse && state.warehouses[part.warehouse]) ? state.warehouses[part.warehouse] : '';
      const searchIn = [part.name, part.code, part.description, part.inventoryNumber, part.manufacturerNumber, part.umisteni, supplierName, categoryName, warehouseName].join(' ').toLowerCase();

      // AND token search (every word must match)
      if (tokens.length && !tokens.every(t => searchIn.includes(t))) return false;

      if (warehouseFilter !== 'all' && part.warehouse !== warehouseFilter) return false;
      if (categoryFilter !== 'all' && part.category !== categoryFilter) return false;
      if (machineFilter !== 'all' && part.machineId !== machineFilter) return false;

      // Smart filters
      if (mode === 'missing') {
        const miss = [];
        if (!part.category) miss.push('Kategorie');
        if (!part.warehouse) miss.push('Sklad');
        if (!part.supplierId) miss.push('Dodavatel');
        if (part.minStock === null || part.minStock === undefined) miss.push('Min');
        if (part.maxStock === null || part.maxStock === undefined) miss.push('Max');
        if (!part.umisteni) miss.push('Umístění');
        if (miss.length === 0) return false;
      }
      if (mode === 'low') {
        let thr = 0;
        try { thr = getLowStockThreshold(part) || 0; } catch(_){ thr = 0; }
        if (!(part.currentStock === 0 || part.currentStock <= thr)) return false;
      }
      if (mode === 'recent') {
        const stamp = part.lastImportedAt || part.updatedAt || part.createdAt || null;
        if (!stamp) return false;
        const t = Date.parse(stamp);
        if (isNaN(t)) return false;
        if ((Date.now() - t) > 1000*60*60*48) return false; // last 48h
      }

      return true;
    });
  };

  // Reset sorting to default (Name A→Z)
  window.resetSorting = function(){
    if (!state.sortConfig) state.sortConfig = { key: 'name', direction: 'ascending' };
    else { state.sortConfig.key = 'name'; state.sortConfig.direction = 'ascending'; }
    try { renderPartsTable(); } catch(_){}
    try { showAlert('OK','Třídění vráceno na výchozí: Název (A→Z).','success'); } catch(_){}
  };

  document.addEventListener('DOMContentLoaded', function(){
    try { updateSmartChips(); } catch(_){}
  });
})();
</script>

<style>
#bulkWhBackdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;z-index:9998;}
#bulkWhModal{position:fixed;inset:12% 50% auto 50%;transform:translate(-50%,0);width:640px;max-width:94vw;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.2);display:none;z-index:9999;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
#bulkWhHeader{padding:12px 16px;background:#f6f7f9;border-bottom:1px solid #e8eaee;display:flex;justify-content:space-between;align-items:center}
#bulkWhBody{padding:16px;display:grid;gap:12px;}
#bulkWhFooter{padding:12px 16px;background:#fafbfc;border-top:1px solid #e8eaee;display:flex;justify-content:flex-end;gap:10px;}
.bulk-input{width:100%;padding:10px 12px;border:1px solid #d8dde4;border-radius:10px;outline:none;}
.bulk-input:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.15);}
.bulk-check{display:flex;gap:8px;align-items:center;font-size:13px;color:#333;}
.bulk-btn{padding:10px 14px;border-radius:10px;border:1px solid #d8dde4;background:#fff;cursor:pointer;}
.bulk-btn.primary{background:#4f46e5;border-color:#4f46e5;color:#fff;}
#bulkWhClose{cursor:pointer;border:none;background:transparent;font-size:22px;line-height:1;}
.bulk-note{font-size:12px;color:#555;}
</style>
<div id="bulkWhBackdrop"></div>
<div id="bulkWhModal" role="dialog" aria-modal="true" aria-labelledby="bulkWhTitle">
  <div id="bulkWhHeader">
    <div id="bulkWhTitle">Hromadně doplnit sklad</div>
    <button id="bulkWhClose" onclick="closeBulkWarehouse()">×</button>
  </div>
  <div id="bulkWhBody">
    <div>
      <label>Zvol sklad (existující nebo napiš nový)</label>
      <input id="bulkWarehouseInput" class="bulk-input" list="warehouse-datalist" placeholder="např. Brno">
      <datalist id="warehouse-datalist"></datalist>
    </div>
    <div class="bulk-check"><input type="checkbox" id="bulkApplyAll"><label for="bulkApplyAll">použít i na položky, které už sklad mají (jinak jen na ty bez skladu)</label></div>
    <div class="bulk-note" id="bulkWhCount">Vybráno: — položek</div>
  </div>
  <div id="bulkWhFooter">
    <button class="bulk-btn" onclick="closeBulkWarehouse()">Zrušit</button>
    <button class="bulk-btn primary" onclick="applyBulkWarehouse()">Použít</button>
  </div>
</div>
<script>
(function(){
  function listWarehouses(){
    try {
      const out = [];
      for (const [k,v] of Object.entries(state.warehouses||{})) out.push({key:k, name:String(v)});
      out.sort((a,b)=>a.name.localeCompare(b.name,'cs',{sensitivity:'base'}));
      return out;
    } catch(e){ return []; }
  }
  function ensureWarehouseKey(val){
    if (val==null) return null;
    const v = String(val).trim();
    if (!v) return null;
    // if exact key exists
    if (state.warehouses && state.warehouses.hasOwnProperty(v)) return v;
    // match by display value (case-insensitive)
    for (const [k,disp] of Object.entries(state.warehouses||{})) {
      if (String(disp).toLowerCase() === v.toLowerCase()) return k;
    }
    // create new key from name
    function slug5(txt){
      const t = String(txt).normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-zA-Z0-9]/g,'').toLowerCase();
      return (t||'novy').slice(0,5);
    }
    let key = slug5(v); let i = 1;
    while (state.warehouses && state.warehouses.hasOwnProperty(key)) {
      key = (slug5(v)+i).slice(0,5); i++;
    }
    if (!state.warehouses) state.warehouses = {};
    state.warehouses[key] = v;
    return key;
  }

  window.openBulkWarehouse = function(){
    try {
      // Fill datalist
      const dl = document.getElementById('warehouse-datalist');
      if (dl) {
        dl.innerHTML = (listWarehouses().map(w => `<option value="${w.name}"></option>`).join(''));
      }
      // Count candidates (current filtered set)
      const parts = (typeof getFilteredParts==='function' ? getFilteredParts() : (state.parts||[]));
      const onlyMissing = !document.getElementById('bulkApplyAll') || !document.getElementById('bulkApplyAll').checked;
      const candidates = parts.filter(p => onlyMissing ? !p.warehouse : true);
      const lbl = document.getElementById('bulkWhCount');
      if (lbl) lbl.textContent = 'Vybráno: ' + candidates.length + ' položek ' + (onlyMissing ? '(bez skladu)' : '(viditelné)');
    } catch(e){}
    document.getElementById('bulkWhBackdrop').style.display='block';
    document.getElementById('bulkWhModal').style.display='block';
  };

  window.closeBulkWarehouse = function(){
    document.getElementById('bulkWhBackdrop').style.display='none';
    document.getElementById('bulkWhModal').style.display='none';
  };

  window.applyBulkWarehouse = function(){
    const input = document.getElementById('bulkWarehouseInput');
    const name = input ? input.value.trim() : '';
    if (!name) { try { showAlert('Chybí název skladu','Zadej název skladu nebo vyber z nabídky.','warning'); } catch(_){ alert('Zadej název skladu.'); } return; }
    const key = ensureWarehouseKey(name);
    const parts = (typeof getFilteredParts==='function' ? getFilteredParts() : (state.parts||[]));
    const applyAll = document.getElementById('bulkApplyAll') && document.getElementById('bulkApplyAll').checked;
    let count = 0;
    for (const p of parts) {
      if (!applyAll && p.warehouse) continue;
      p.warehouse = key;
      count++;
    }
    try { saveStateToLocalStorage(); } catch(_){}
    try { renderPartsTable(); } catch(_){}
    try { updateStats(); } catch(_){}
    closeBulkWarehouse();
    try { showAlert('Hotovo', 'Sklad přiřazen u ' + count + ' položek.', 'success'); } catch(_){ alert('Sklad přiřazen u ' + count + ' položek.'); }
  };

  // Update count when toggling the checkbox
  document.addEventListener('change', function(ev){
    if (ev.target && ev.target.id === 'bulkApplyAll') {
      try {
        const parts = (typeof getFilteredParts==='function' ? getFilteredParts() : (state.parts||[]));
        const onlyMissing = !document.getElementById('bulkApplyAll').checked;
        const candidates = parts.filter(p => onlyMissing ? !p.warehouse : true);
        const lbl = document.getElementById('bulkWhCount');
        if (lbl) lbl.textContent = 'Vybráno: ' + candidates.length + ' položek ' + (onlyMissing ? '(bez skladu)' : '(viditelné)');
      } catch(e){}
    }
  });
})();
</script>

<script>
(function(){
  if (!state.ui) state.ui = {};
  if (!state.ui.missingFilter) state.ui.missingFilter = { warehouse:false, category:false, supplier:false, min:false, max:false, umisteni:false };

  // Show/hide panel based on smart filter mode
  function syncMissingPanelVisibility(){
    const panel = document.getElementById('missing-filter-panel');
    if (!panel) return;
    const mode = (state.ui && state.ui.smartFilter) || 'all';
    panel.classList.toggle('active', mode === 'missing');
  }
  window.syncMissingPanelVisibility = syncMissingPanelVisibility;

  // Wire checkboxes
  function readMissingSelection(){
    const sel = state.ui.missingFilter || { warehouse:false, category:false, supplier:false, min:false, max:false, umisteni:false };
    const ids = ['warehouse','category','supplier','min','max','umisteni'];
    ids.forEach(k => {
      const el = document.getElementById('mf-'+k);
      if (el) el.checked = !!sel[k];
    });
  }
  function saveMissingSelection(){
    if (!state.ui) state.ui = {};
    if (!state.ui.missingFilter) state.ui.missingFilter = {};
    const ids = ['warehouse','category','supplier','min','max','umisteni'];
    ids.forEach(k => {
      const el = document.getElementById('mf-'+k);
      state.ui.missingFilter[k] = el ? !!el.checked : false;
    });
    try { renderPartsTable(); } catch(_){}
  }
  function clearMissingSelection(){
    if (!state.ui) state.ui = {};
    state.ui.missingFilter = { warehouse:false, category:false, supplier:false, min:false, max:false, umisteni:false };
    readMissingSelection();
    try { renderPartsTable(); } catch(_){}
  }
  window.clearMissingSelection = clearMissingSelection;

  document.addEventListener('change', function(ev){
    if (ev.target && /^mf-(warehouse|category|supplier|min|max|umisteni)$/.test(ev.target.id)) {
      saveMissingSelection();
    }
  });
  document.addEventListener('click', function(ev){
    if (ev.target && ev.target.id === 'mf-clear') {
      clearMissingSelection();
    }
  });

  // Counts of missing per field
  function updateMissingCounts(){
    try {
      const parts = state.parts || [];
      let cWh=0,cCat=0,cSup=0,cMin=0,cMax=0,cUm=0;
      for (const p of parts) {
        if (!p.warehouse) cWh++;
        if (!p.category) cCat++;
        if (!p.supplierId) cSup++;
        if (p.minStock === null || p.minStock === undefined) cMin++;
        if (p.maxStock === null || p.maxStock === undefined) cMax++;
        if (!p.umisteni) cUm++;
      }
      const set = (id,val)=>{ const el=document.getElementById(id); if (el) el.textContent = val ? '('+val+')' : ''; };
      set('mf-warehouse-count', cWh);
      set('mf-category-count', cCat);
      set('mf-supplier-count', cSup);
      set('mf-min-count', cMin);
      set('mf-max-count', cMax);
      set('mf-umisteni-count', cUm);
    } catch(e){}
  }
  window.updateMissingCounts = updateMissingCounts;

  // Hook into existing render to keep panel in sync
  const _origRender = window.renderPartsTable;
  window.renderPartsTable = function(){
    if (typeof _origRender === 'function') _origRender();
    syncMissingPanelVisibility();
    readMissingSelection();
    updateMissingCounts();
  };

  // Override getFilteredParts to respect selected missing fields when mode === 'missing'
  const _origGet = window.getFilteredParts;
  window.getFilteredParts = function(){
    const mode = (state.ui && state.ui.smartFilter) || 'all';
    const parts = (typeof _origGet === 'function') ? _origGet() : (state.parts || []);
    if (mode !== 'missing') return parts;
    const sel = state.ui.missingFilter || {};
    const anySelected = !!(sel.warehouse || sel.category || sel.supplier || sel.min || sel.max || sel.umisteni);
    function isMissing(p, key){
      switch(key){
        case 'warehouse': return !p.warehouse;
        case 'category': return !p.category;
        case 'supplier': return !p.supplierId;
        case 'min': return p.minStock === null || p.minStock === undefined;
        case 'max': return p.maxStock === null || p.maxStock === undefined;
        case 'umisteni': return !p.umisteni;
      }
      return false;
    }
    return parts.filter(p => {
      if (!anySelected) {
        // No specific fields selected -> show items missing ANY of the tracked fields
        return ( !p.warehouse || !p.category || !p.supplierId || p.minStock==null || p.maxStock==null || !p.umisteni );
      } else {
        // At least one field selected -> show items missing ANY of the selected fields
        const keys = ['warehouse','category','supplier','min','max','umisteni'].filter(k => sel[k]);
        return keys.some(k => isMissing(p, k));
      }
    });
  };

  document.addEventListener('DOMContentLoaded', function(){
    syncMissingPanelVisibility();
    readMissingSelection();
    updateMissingCounts();
  });
})();
</script>

<style>
#qePopover{position:fixed;z-index:9999;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);display:none;width:520px;max-width:94vw;}
#qeHeader{padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f9fafb;font-weight:600;}
#qeBody{padding:12px;display:grid;gap:10px;}
#qeFooter{padding:10px 12px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:8px;}
.qe-input,.qe-select{width:100%;padding:8px 10px;border:1px solid #d8dde4;border-radius:8px;outline:none;}
.qe-input:focus,.qe-select:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.15);}
.qe-btn{padding:8px 12px;border-radius:8px;border:1px solid #d8dde4;background:#fff;cursor:pointer;}
.qe-btn.primary{background:#4f46e5;border-color:#4f46e5;color:#fff;}
</style>
<div id="qePopover">
  <div id="qeHeader">Rychlá úprava</div>
  <div id="qeBody">
    <div><label>Kategorie</label><input id="qeCategory" list="qeCatList" class="qe-input"><datalist id="qeCatList"></datalist></div>
    
    <div>
      <label>Dodavatel</label>
      <select id="qeSupplierSel" class="qe-select"></select>
      <div id="qeSupplierNewWrap" style="margin-top:8px; display:none;">
        <input id="qeSupplierNew" class="qe-input" placeholder="Nový dodavatel – zadej jméno">
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
      <div><label>Min</label><input id="qeMin" type="number" min="0" class="qe-input"></div>
      <div><label>Max</label><input id="qeMax" type="number" min="0" class="qe-input"></div>

      <div><label>Priorita</label>
        <select id="qePriority" class="qe-select">
          <option value="">—</option>
          <option value="a">A</option>
          <option value="b">B</option>
          <option value="c">C</option>
          <option value="d">D</option>
        </select>
      </div>

    </div>
    
    <div><label>Sklad</label><input id="qeWh" list="qeWhList" class="qe-input"><datalist id="qeWhList"></datalist></div>
    <div><label>Umístění</label><input id="qeUm" class="qe-input"></div>
  </div>
  <div id="qeFooter">
    <button class="qe-btn" onclick="qeClose()">Zavřít</button>
    <button class="qe-btn primary" onclick="qeSave()">Uložit</button>
  </div>
</div>
<script>
(function(){
  let qeCurrentId = null;
  function listCategories(){ const arr=[]; try{ for (const [k,v] of Object.entries(state.categories||{})) arr.push({key:k,name:String(v)});}catch(e){} arr.sort((a,b)=>a.name.localeCompare(b.name,'cs',{sensitivity:'base'})); return arr; }
  function listSuppliers(){ const arr=[]; try{ for (const s of (state.suppliers||[])) arr.push({id:s.id,name:s.name||('Dodavatel #'+s.id)});}catch(e){} arr.sort((a,b)=>a.name.localeCompare(b.name,'cs',{sensitivity:'base'})); return arr; }
  function fillSupplierSelect(selectedId){ const sel = document.getElementById('qeSupplierSel'); if (!sel) return; const list = listSuppliers(); sel.innerHTML = '<option value="">—</option>' + list.map(s=>`<option value="${s.id}">${s.name}</option>`).join('') + '<option value="__new__">+ Nový dodavatel…</option>'; sel.value = selectedId ? String(selectedId) : ''; const wrap = document.getElementById('qeSupplierNewWrap'); if (wrap) wrap.style.display = 'none'; }
  function listWarehouses(){ const arr=[]; try{ for (const [k,v] of Object.entries(state.warehouses||{})) arr.push({key:k,name:String(v)});}catch(e){} arr.sort((a,b)=>a.name.localeCompare(b.name,'cs',{sensitivity:'base'})); return arr; }
  function ensureWarehouseKey(val){ const v=String(val||'').trim(); if(!v) return null; if (state.warehouses && state.warehouses.hasOwnProperty(v)) return v; for (const [k,disp] of Object.entries(state.warehouses||{})) if (String(disp).toLowerCase()===v.toLowerCase()) return k; function slug5(t){ const x=String(t).normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-zA-Z0-9]/g,'').toLowerCase(); return (x||'novy').slice(0,5);} let key=slug5(v),i=1; while(state.warehouses && state.warehouses.hasOwnProperty(key)){ key=(slug5(v)+i).slice(0,5); i++; } if(!state.warehouses) state.warehouses={}; state.warehouses[key]=v; return key; }
  function ensureCategoryKey(val){
    const v=String(val||'').trim(); if(!v) return null;
    if (state.categories && state.categories.hasOwnProperty(v)) return v;
    for (const [k,disp] of Object.entries(state.categories||{})) if (String(disp).toLowerCase()===v.toLowerCase()) return k;
    // create
    function slugN(t,n){ const x=String(t).normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').replace(/[^a-zA-Z0-9]/g,'').toLowerCase(); return (x||'novy').slice(0,n)||'novy'; }
    let key=slugN(v,12),i=1; while(state.categories && state.categories.hasOwnProperty(key)){ key=(slugN(v,12)+i).slice(0,12); i++; }
    if (!state.categories) state.categories={}; state.categories[key]=v; return key;
  }
  function findOrCreateSupplierByName(nm){
    const name = String(nm||'').trim(); if (!name) return null;
    const ex = (state.suppliers||[]).find(s => (s.name||'').toLowerCase() === name.toLowerCase());
    if (ex) return ex.id;
    const newId = ((state.suppliers||[]).reduce((m,s)=>Math.max(m, s.id||0),0)||0) + 1;
    if (!state.suppliers) state.suppliers=[];
    state.suppliers.push({ id:newId, name, ico:'', contactPerson:'', email:'' });
    return newId;
  }
  function locateTableRows(){
    const tab = document.getElementById('tab-inventory');
    if (!tab) return [];
    let rows = Array.from(tab.querySelectorAll('table tbody tr'));
    if (rows.length) return rows;
    // fallback to any rows under a "table-body"-like container
    rows = Array.from(tab.querySelectorAll('tbody tr, .table-body .row'));
    return rows;
  }
  function mapRowsToParts(){
    const parts = (typeof getFilteredParts==='function' ? getFilteredParts() : (state.parts||[]));
    const rows = locateTableRows();
    const n = Math.min(parts.length, rows.length);
    for (let i=0;i<n;i++){
      const r = rows[i];
      r.setAttribute('data-part-id', parts[i].id);
      if (!r.getAttribute('data-qe-bound')) {
        r.setAttribute('data-qe-bound','1');
        r.addEventListener('dblclick', (ev)=>{
          const id = parseInt(r.getAttribute('data-part-id'),10);
          if (!isNaN(id)) openQuickEditorFor(id, ev.clientX, ev.clientY);
        });
      }
    }
  }
  window.openQuickEditorFor = function(id, x, y){
    const p = (state.parts||[]).find(pp => pp.id === id);
    if (!p) return;
    qeCurrentId = id;
    const catDL = document.getElementById('qeCatList'); if (catDL) catDL.innerHTML = listCategories().map(c=>`<option value="${c.name}"></option>`).join('');
    fillSupplierSelect(p.supplierId);
    const whDL = document.getElementById('qeWhList'); if (whDL) whDL.innerHTML = listWarehouses().map(w=>`<option value="${w.name}"></option>`).join('');
    document.getElementById('qeCategory').value = (p.category && state.categories && state.categories[p.category]) ? state.categories[p.category] : '';
    document.getElementById('qeSupplier').value = (function(){ const s=(state.suppliers||[]).find(s=>s.id===p.supplierId); return s && s.name ? s.name : ''; })();
    document.getElementById('qeMin').value = (p.minStock ?? '');
    document.getElementById('qeMax').value = (p.maxStock ?? '');
    const prSel = document.getElementById('qePriority'); if (prSel) prSel.value = (p.priority || '');
    const sel = document.getElementById('qeSupplierSel'); if (sel) sel.onchange = function(){ const wrap = document.getElementById('qeSupplierNewWrap'); if (!wrap) return; wrap.style.display = (this.value === '__new__') ? 'block' : 'none'; };
    document.getElementById('qeUm').value = (p.umisteni ?? '');
    document.getElementById('qeWh').value = (p.warehouse && state.warehouses && state.warehouses[p.warehouse]) ? state.warehouses[p.warehouse] : '';
    const box = document.getElementById('qePopover');
    box.style.display='block';
    // position near cursor with viewport bounds
    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
    const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
    const bx = Math.min(x+10, vw-540); const by = Math.min(y+10, vh-300);
    box.style.left = bx+'px'; box.style.top = by+'px';
  };
  window.qeClose = function(){ document.getElementById('qePopover').style.display='none'; qeCurrentId = null; };
  window.qeSave = function(){
    if (qeCurrentId == null) return;
    const p = (state.parts||[]).find(pp => pp.id === qeCurrentId); if (!p) return;
    const catName = document.getElementById('qeCategory').value.trim();
    const sel = document.getElementById('qeSupplierSel');
    const supSelVal = sel ? sel.value : '';
    const supNewName = (document.getElementById('qeSupplierNew') ? document.getElementById('qeSupplierNew').value.trim() : '');
    const minVal = document.getElementById('qeMin').value;
    const maxVal = document.getElementById('qeMax').value;
    const umiVal = document.getElementById('qeUm').value.trim();
    const whName = document.getElementById('qeWh').value.trim();

    if (catName) p.category = ensureCategoryKey(catName);
    if (supSelVal === '__new__' && supNewName) { p.supplierId = findOrCreateSupplierByName(supNewName); }
    else if (supSelVal) { const sid = parseInt(supSelVal,10); if (!isNaN(sid)) p.supplierId = sid; }
    if (minVal !== '') { const v=parseInt(minVal,10); if(!isNaN(v)) p.minStock=v; }
    if (maxVal !== '') { const v=parseInt(maxVal,10); if(!isNaN(v)) p.maxStock=v; }
    const prSel = document.getElementById('qePriority'); if (prSel) { const pv = prSel.value || null; p.priority = pv; }
    p.umisteni = umiVal;
    if (whName) p.warehouse = ensureWarehouseKey(whName);

    try { saveStateToLocalStorage(); } catch(_){}
    try { renderPartsTable(); } catch(_){}
    qeClose();
    try { showAlert('Uloženo','Řádek upraven.','success'); } catch(_){}
  };

  // Wrap renderPartsTable to map rows to parts after each render
  const _origRender = window.renderPartsTable;
  window.renderPartsTable = function(){
    if (typeof _origRender === 'function') _origRender();
    try { mapRowsToParts(); } catch(e){}
  };

  document.addEventListener('DOMContentLoaded', function(){
    try { mapRowsToParts(); } catch(e){}
  });
})();
</script>

<style>
#bulkEdBackdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;z-index:9998;}
#bulkEdModal{position:fixed;inset:8% 50% auto 50%;transform:translate(-50%,0);width:760px;max-width:96vw;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.2);display:none;z-index:9999;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
#bulkEdHeader{padding:12px 16px;background:#f6f7f9;border-bottom:1px solid #e8eaee;display:flex;justify-content:space-between;align-items:center}
#bulkEdBody{padding:16px;display:grid;gap:14px;}
#bulkEdFooter{padding:12px 16px;background:#fafbfc;border-top:1px solid #e8eaee;display:flex;justify-content:flex-end;gap:10px;}
.bulk-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.bulk-field{display:flex;flex-direction:column;gap:6px;}
.bulk-input,.bulk-select{width:100%;padding:10px 12px;border:1px solid #d8dde4;border-radius:10px;outline:none;}
.bulk-input:focus,.bulk-select:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.15);}
.bulk-btn{padding:10px 14px;border-radius:10px;border:1px solid #d8dde4;background:#fff;cursor:pointer;}
.bulk-btn.primary{background:#4f46e5;border-color:#4f46e5;color:#fff;}
.bulk-note{font-size:12px;color:#555;}
.inline-edit-hint{font-size:12px;color:#6b7280;}
</style>
<div id="bulkEdBackdrop"></div>
<div id="bulkEdModal" role="dialog" aria-modal="true" aria-labelledby="bulkEdTitle">
  <div id="bulkEdHeader">
    <div id="bulkEdTitle">Hromadný editor</div>
    <button class="bulk-btn" onclick="closeBulkEditor()">Zavřít</button>
  </div>
  <div id="bulkEdBody">
    <div class="bulk-grid">
      <div class="bulk-field">
        <label>Kategorie</label>
        <input id="bulkCategory" list="bulkCategoryList" class="bulk-input" placeholder="ponech prázdné pokud nechceš měnit">
        <datalist id="bulkCategoryList"></datalist>
        <div class="inline-edit-hint">Vyplň jméno kategorie (nová se automaticky založí).</div>
      </div>
      <div class="bulk-field">
        <label>Dodavatel</label>
        <input id="bulkSupplier" list="bulkSupplierList" class="bulk-input" placeholder="ponech prázdné pokud nechceš měnit">
        <datalist id="bulkSupplierList"></datalist>
        <div class="inline-edit-hint">Zadej jméno dodavatele (nový se založí).</div>
      </div>
      <div class="bulk-field">
        <label>Min</label>
        <input id="bulkMin" class="bulk-input" type="number" min="0" placeholder="—">
      </div>
      <div class="bulk-field">
        <label>Max</label>
        <input id="bulkMax" class="bulk-input" type="number" min="0" placeholder="—">
      </div>
      <div class="bulk-field" style="grid-column:1 / -1;">
        <label>Umístění</label>
        <input id="bulkUmisteni" class="bulk-input" placeholder="ponech prázdné pokud nechceš měnit">
      </div>
    </div>
    <label style="display:flex;gap:8px;align-items:center;"><input type="checkbox" id="bulkOnlyMissing"> Použít jen tam, kde hodnota chybí</label>
    <div class="bulk-note" id="bulkEdCount">Vybráno: — položek</div>
  </div>
  <div id="bulkEdFooter">
    <button class="bulk-btn" onclick="closeBulkEditor()">Zrušit</button>
    <button class="bulk-btn primary" onclick="applyBulkEditor()">Použít</button>
  </div>
</div>
<script>
(function(){
  function listCategories(){
    const arr=[]; try{ for (const [k,v] of Object.entries(state.categories||{})) arr.push({key:k,name:String(v)});}catch(e){}
    arr.sort((a,b)=>a.name.localeCompare(b.name,'cs',{sensitivity:'base'})); return arr;
  }
  function listSuppliers(){
    const arr=[]; try{ for (const s of (state.suppliers||[])) arr.push({id:s.id,name:s.name||('Dodavatel #'+s.id)});}catch(e){}
    arr.sort((a,b)=>a.name.localeCompare(b.name,'cs',{sensitivity:'base'})); return arr;
  }
  function slugN(t,n){ const x=String(t).normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').replace(/[^a-zA-Z0-9]/g,'').toLowerCase(); return (x||'novy').slice(0,n)||'novy'; }
  function ensureCategoryKey(val){
    if (val==null) return null; const v=String(val).trim(); if (!v) return null;
    if (state.categories && state.categories.hasOwnProperty(v)) return v;
    for (const [k,disp] of Object.entries(state.categories||{})) if (String(disp).toLowerCase()===v.toLowerCase()) return k;
    let key=slugN(v,12),i=1; while (state.categories && state.categories.hasOwnProperty(key)) { key=(slugN(v,12)+i).slice(0,12); i++; }
    if (!state.categories) state.categories={}; state.categories[key]=v; return key;
  }
  function findOrCreateSupplierByName(name){
    const nm = String(name||'').trim(); if (!nm) return null;
    const ex = (state.suppliers||[]).find(s => (s.name||'').toLowerCase() === nm.toLowerCase());
    if (ex) return ex.id;
    const newId = ((state.suppliers||[]).reduce((m,s)=>Math.max(m, s.id||0),0)||0) + 1;
    if (!state.suppliers) state.suppliers=[];
    state.suppliers.push({ id:newId, name:nm, ico:'', contactPerson:'', email:'' });
    return newId;
  }

  window.openBulkEditor = function(){
    // Fill datalists
    const catDL = document.getElementById('bulkCategoryList');
    const supDL = document.getElementById('bulkSupplierList');
    if (catDL) catDL.innerHTML = listCategories().map(c=>`<option value="${c.name}"></option>`).join('');
    if (supDL) supDL.innerHTML = listSuppliers().map(s=>`<option value="${s.name}"></option>`).join('');
    // Count candidates
    const parts = (typeof getFilteredParts==='function' ? getFilteredParts() : (state.parts||[]));
    document.getElementById('bulkEdCount').textContent = 'Vybráno: ' + parts.length + ' položek (aktuálně zobrazené)';
    document.getElementById('bulkEdBackdrop').style.display='block';
    document.getElementById('bulkEdModal').style.display='block';
  };
  window.closeBulkEditor = function(){
    document.getElementById('bulkEdBackdrop').style.display='none';
    document.getElementById('bulkEdModal').style.display='none';
  };
  window.applyBulkEditor = function(){
    const parts = (typeof getFilteredParts==='function' ? getFilteredParts() : (state.parts||[]));
    const onlyMissing = document.getElementById('bulkOnlyMissing').checked;

    const catName = (document.getElementById('bulkCategory').value||'').trim();
    const supName = (document.getElementById('bulkSupplier').value||'').trim();
    const minVal = document.getElementById('bulkMin').value;
    const maxVal = document.getElementById('bulkMax').value;
    const umiVal = (document.getElementById('bulkUmisteni').value||'').trim();

    const catKey = catName ? ensureCategoryKey(catName) : null;
    const supId  = supName ? findOrCreateSupplierByName(supName) : null;
    const hasMin = (minVal !== '');
    const hasMax = (maxVal !== '');
    const hasUmi = (umiVal !== '');

    let changed = 0;
    for (const p of parts) {
      if (catKey) {
        if (!onlyMissing || !p.category) { p.category = catKey; changed++; }
      }
      if (supId) {
        if (!onlyMissing || !p.supplierId) { p.supplierId = supId; changed++; }
      }
      if (hasMin) {
        const v = parseInt(minVal,10); if (!isNaN(v)) { if (!onlyMissing || p.minStock==null) { p.minStock = v; changed++; } }
      }
      if (hasMax) {
        const v = parseInt(maxVal,10); if (!isNaN(v)) { if (!onlyMissing || p.maxStock==null) { p.maxStock = v; changed++; } }
      }
      if (hasUmi) {
        if (!onlyMissing || !p.umisteni) { p.umisteni = umiVal;
    if (whName) p.warehouse = ensureWarehouseKey(whName); changed++; }
      }
    }
    try { saveStateToLocalStorage(); } catch(_){}
    try { renderPartsTable(); } catch(_){}
    try { updateStats(); } catch(_){}
    closeBulkEditor();
    try { showAlert('Hotovo', 'Upraveno hodnot: ' + changed + ' (napříč položkami).', 'success'); } catch(_){ alert('Upraveno: ' + changed); }
  };
})();
</script>
</body>
</html>
